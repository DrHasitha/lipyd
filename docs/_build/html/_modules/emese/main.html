<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>emese.main &#8212; emese 0.4.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for emese.main</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1">#</span>
<span class="c1">#  This file is part of the `emese` python module</span>
<span class="c1">#</span>
<span class="c1">#  Copyright (c) 2015-2017 - EMBL-EBI</span>
<span class="c1">#</span>
<span class="c1">#  File author(s): Dénes Türei (turei.denes@gmail.com)</span>
<span class="c1">#</span>
<span class="c1">#  This code is not for public use.</span>
<span class="c1">#  Please do not redistribute.</span>
<span class="c1">#  For permission please contact me.</span>
<span class="c1">#</span>
<span class="c1">#  Website: http://www.ebi.ac.uk/~denes</span>
<span class="c1">#</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">future.utils</span> <span class="k">import</span> <span class="n">iteritems</span>
<span class="kn">from</span> <span class="nn">past.builtins</span> <span class="k">import</span> <span class="n">xrange</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">reduce</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">timeit</span>

<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">xlrd</span>
<span class="kn">import</span> <span class="nn">openpyxl</span>
<span class="kn">import</span> <span class="nn">xlsxwriter</span>
<span class="kn">import</span> <span class="nn">lxml.etree</span>

<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="k">as</span> <span class="nn">hc</span>
<span class="kn">import</span> <span class="nn">sklearn.decomposition</span>
<span class="kn">import</span> <span class="nn">fastcluster</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.backends.backend_pdf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="c1">#import plotly.offline as pl</span>
<span class="c1">#import plotly.graph_objs as go</span>
<span class="c1">#import plotly.tools</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">altair</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No module `altair` available.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">rpy2.robjects.packages</span> <span class="k">as</span> <span class="nn">rpackages</span>
    <span class="n">rvcd</span> <span class="o">=</span> <span class="n">rpackages</span><span class="o">.</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;vcdExtra&#39;</span><span class="p">)</span>
    <span class="n">rbase</span> <span class="o">=</span> <span class="n">rpackages</span><span class="o">.</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>
    <span class="n">rutils</span> <span class="o">=</span> <span class="n">rpackages</span><span class="o">.</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;utils&#39;</span><span class="p">)</span>
    <span class="n">rstats</span> <span class="o">=</span> <span class="n">rpackages</span><span class="o">.</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;stats&#39;</span><span class="p">)</span>
    <span class="n">rococo</span> <span class="o">=</span> <span class="n">rpackages</span><span class="o">.</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;rococo&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Could not import rpy2 or some of the R packages.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># from this module:</span>
<span class="kn">import</span> <span class="nn">emese.mass</span> <span class="k">as</span> <span class="nn">mass</span>
<span class="kn">import</span> <span class="nn">emese.progress</span> <span class="k">as</span> <span class="nn">progress</span>
<span class="kn">import</span> <span class="nn">emese._curl</span> <span class="k">as</span> <span class="nn">_curl</span>
<span class="kn">from</span> <span class="nn">emese.common</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">rlcompleter</span><span class="o">,</span> <span class="nn">readline</span>
<span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;tab:complete&#39;</span><span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MolWeight"><a class="viewcode-back" href="../../index.html#emese.main.MolWeight">[docs]</a><span class="k">class</span> <span class="nc">MolWeight</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    Thanks for</span>
<span class="sd">    https://github.com/bsimas/molecular-weight/blob/master/chemweight.py</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            **kwargs: elements &amp; counts, e.g. c = 6, h = 12, o = 6...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="s1">&#39;massFirstIso&#39;</span><span class="p">):</span>
            <span class="n">mass</span><span class="o">.</span><span class="n">getMassFirstIso</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span><span class="o">.</span><span class="n">massFirstIso</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reform</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([A-Za-z][a-z]*)([0-9]*)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">num</span><span class="p">)</span> \
                <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_weight</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
    
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
    
    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
    
    <span class="k">def</span> <span class="nf">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
    
    <span class="k">def</span> <span class="nf">__itruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__float__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>
    
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">other</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mf">0.01</span>
    
    <span class="k">def</span> <span class="nf">calc_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reform</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span> <span class="ow">or</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span>
        <span class="n">w</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">mass</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="s1">&#39;electron&#39;</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotope</span> <span class="o">*</span> <span class="n">mass</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="s1">&#39;neutron&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">w</span>
    
    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">modname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span></div>

<span class="k">class</span> <span class="nc">AdductCalculator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reform</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([A-Za-z][a-z]*)([0-9]*)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_counts</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">init_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">formula2counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reform</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">formula</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">elem</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span> <span class="ow">or</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula2counts</span><span class="p">(</span><span class="n">formula</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="o">-</span><span class="n">num</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula2counts</span><span class="p">(</span><span class="n">formula</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span> <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">+</span> <span class="n">num</span>

<span class="k">class</span> <span class="nc">FattyFragment</span><span class="p">(</span><span class="n">MolWeight</span><span class="p">,</span> <span class="n">AdductCalculator</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hg</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hg</span> <span class="o">=</span> <span class="n">hg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_counts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsat</span> <span class="o">*</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="n">AdductCalculator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">formula</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plus</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
        <span class="n">MolWeight</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)</span><span class="si">%s%s</span><span class="s1">]</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unsat</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adduct_str</span><span class="p">(),</span>
            <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotope</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;i</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotope</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charge_str</span><span class="p">()</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">charge_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">))</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;+&#39;</span>
            <span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;NL&#39;</span>
    
    <span class="k">def</span> <span class="nf">adduct_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus</span>  <span class="k">else</span> \
                        <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minus</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plus</span>  <span class="k">else</span> \
                        <span class="s1">&#39;+</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plus</span><span class="p">))</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_fragline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;[M</span><span class="si">%s</span><span class="s1">]</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adduct_str</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge_str</span><span class="p">()),</span>
            <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hg</span><span class="p">)]</span>

<div class="viewcode-block" id="LysoPEAlkenyl"><a class="viewcode-back" href="../../index.html#emese.main.LysoPEAlkenyl">[docs]</a><span class="k">class</span> <span class="nc">LysoPEAlkenyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank.jp:</span>
<span class="sd">    [lyso PE(alkenyl-18:0,-)]- 464.3140997565 -417 C23H47NO6P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPEAlkenyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PE-alkenyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PE&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LysoPE"><a class="viewcode-back" href="../../index.html#emese.main.LysoPE">[docs]</a><span class="k">class</span> <span class="nc">LysoPE</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank.jp:</span>
<span class="sd">    [lyso PE(18:0,-)]- 480.3090143786 -476 C23H47NO7P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PE&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PE&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<span class="k">class</span> <span class="nc">LysoPEAlkyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPEAlkyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PE-alkyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PE&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LysoPCAlkenyl"><a class="viewcode-back" href="../../index.html#emese.main.LysoPCAlkenyl">[docs]</a><span class="k">class</span> <span class="nc">LysoPCAlkenyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank.jp:</span>
<span class="sd">    [lyso PC(alkenyl-18:0,-)]- 492.3453998849 -436 C25H51NO6P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPCAlkenyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PC-alkenyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PC&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LysoPCAlkyl"><a class="viewcode-back" href="../../index.html#emese.main.LysoPCAlkyl">[docs]</a><span class="k">class</span> <span class="nc">LysoPCAlkyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank.jp:</span>
<span class="sd">    [lyso PC(alkyl-18:0,-)]- 494.3610499491 -143 C25H53NO6P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPCAlkyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PC-alkyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PC&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<span class="k">class</span> <span class="nc">LysoPC</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="c1"># from massbank.jp:</span>
    <span class="c1"># [lyso PC(18:0,-)]- 508.340314507 -373 C25H51NO7P-</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPC</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PC&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PC&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LysoPS"><a class="viewcode-back" href="../../index.html#emese.main.LysoPS">[docs]</a><span class="k">class</span> <span class="nc">LysoPS</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank.jp:</span>
<span class="sd">    [lyso PS(18:0,-)]- 437.2668152129 -358 C21H42O7P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PS&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PS&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<span class="k">class</span> <span class="nc">LysoPSAlkenyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPSAlkenyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PS-alkenyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PS&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">LysoPSAlkyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPSAlkyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PS-alkyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PS&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<div class="viewcode-block" id="LysoPI"><a class="viewcode-back" href="../../index.html#emese.main.LysoPI">[docs]</a><span class="k">class</span> <span class="nc">LysoPI</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank:</span>
<span class="sd">    [lyso PI(-,18:0)]- 599.3196386444 -432 C27H52O12P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PI&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PI&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LysoPIAlkyl"><a class="viewcode-back" href="../../index.html#emese.main.LysoPIAlkyl">[docs]</a><span class="k">class</span> <span class="nc">LysoPIAlkyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank.jp:</span>
<span class="sd">    [lyso PI(alkyl-16:1,-)-H2O]- 537.2828592076 -228 C25H46O10P-</span>
<span class="sd">    from this, derived 18:0-:</span>
<span class="sd">    [lyso PI(alkyl-18:0,-)]- 585.3403740858 -228 C27H54O11P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPIAlkyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PI-alkyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PI&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LysoPG"><a class="viewcode-back" href="../../index.html#emese.main.LysoPG">[docs]</a><span class="k">class</span> <span class="nc">LysoPG</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank:</span>
<span class="sd">    [lyso PG(18:0,-)]- 511.3035946497 -495 C24H48O9P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPG</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PG&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PG&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LysoPGAlkyl"><a class="viewcode-back" href="../../index.html#emese.main.LysoPGAlkyl">[docs]</a><span class="k">class</span> <span class="nc">LysoPGAlkyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from massbank:</span>
<span class="sd">    [lyso PG(18:0,-)]- 511.3035946497 -495 C24H48O9P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPGAlkyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PG-alkyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PG&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LysoPA"><a class="viewcode-back" href="../../index.html#emese.main.LysoPA">[docs]</a><span class="k">class</span> <span class="nc">LysoPA</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from Characterization of Phospholipid </span>
<span class="sd">    Molecular Species by Means of HPLC-Tandem Mass Spectrometry:</span>
<span class="sd">    [lyso PA(18:1,-)]- 435.2 C21H40O7P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPA</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PA&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LysoPAAlkyl"><a class="viewcode-back" href="../../index.html#emese.main.LysoPAAlkyl">[docs]</a><span class="k">class</span> <span class="nc">LysoPAAlkyl</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from Characterization of Phospholipid </span>
<span class="sd">    Molecular Species by Means of HPLC-Tandem Mass Spectrometry:</span>
<span class="sd">    [lyso PA(18:1,-)]- 435.2 C21H40O7P-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LysoPAAlkyl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Lyso-PA-alkyl&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CerFA"><a class="viewcode-back" href="../../index.html#emese.main.CerFA">[docs]</a><span class="k">class</span> <span class="nc">CerFA</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    https://metlin.scripps.edu/metabo_info.php?molid=6214</span>
<span class="sd">    [Cer-FA(C8:0)]- 168.1382904 C8H14O1N1-</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CerFA</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CerFA&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cer&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<span class="k">class</span> <span class="nc">CerFAminusC2H5N</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="c1"># 209 at C14:0 FA, 263 at C18:1</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CerFAminusC2H5N</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CerFA-C2N&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cer&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">CerFAminusC</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="c1"># 226 at C14:0 FA, 280 at C18:1</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CerFAminusC</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CerFA-C&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cer&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">CerFAminusN</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="c1"># 227 at C14:0 FA, 281 at C18:1</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CerFAminusN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CerFA-N&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cer&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">CerSphiMinusN</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CerSphiMinusN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CerSphi-N&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cer&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">CerSphiMinusNO</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CerSphiMinusNO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CerSphi-N-H2O&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cer&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">CerSphi</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CerSphi</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;CerSphi&#39;</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cer&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">FAminusH</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FAminusH</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FA&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="FAAlkylminusH"><a class="viewcode-back" href="../../index.html#emese.main.FAAlkylminusH">[docs]</a><span class="k">class</span> <span class="nc">FAAlkylminusH</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    18:0 = 267.2693393</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FAAlkylminusH</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FA-alkyl&#39;</span><span class="p">)</span></div>

<span class="k">class</span> <span class="nc">NLFA</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NLFA</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;NL FA&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NLFAminusH2O</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NLFAminusH2O</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;NL FA&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NLFAplusOH</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NLFAplusOH</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;OH&#39;</span><span class="p">],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;NL FA&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NLFAplusNH3</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NLFAplusNH3</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NH3&#39;</span><span class="p">],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;NL FA&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FAminusO</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FAminusO</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FA&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FAplusGlycerol</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FAplusGlycerol</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span> <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FA+G&#39;</span><span class="p">,</span> <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;BMP&#39;</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">SphingosineBase</span><span class="p">(</span><span class="n">FattyFragment</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">isotope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Sphingosine&#39;</span><span class="p">,</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span> <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="n">hg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Sph&#39;</span><span class="p">,</span> <span class="s1">&#39;SM&#39;</span><span class="p">,</span> <span class="s1">&#39;Cer&#39;</span><span class="p">,</span> <span class="s1">&#39;HexCer&#39;</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">FAFragSeries</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">cmin</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">cmax</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="nb">locals</span><span class="p">()):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsatmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsatmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsatmin</span>
        <span class="k">for</span> <span class="n">unsat</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unsatmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsatmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">this_cmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmin</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">this_cmin</span> <span class="o">&lt;=</span> <span class="n">cmax</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cnum</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">this_cmin</span><span class="p">,</span> <span class="n">cmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">(</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cnum</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="n">unsat</span><span class="p">,</span>
                            <span class="n">minus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus</span><span class="p">,</span> <span class="n">plus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plus</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">fr</span>
    
    <span class="k">def</span> <span class="nf">iterweight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">fr</span><span class="o">.</span><span class="n">weight</span>
    
    <span class="k">def</span> <span class="nf">iterfraglines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">fr</span><span class="o">.</span><span class="n">get_fragline</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Mz</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sign</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">=</span> <span class="n">mz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tolerance</span>
    
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">mz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">mz</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;m/z = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span>
    
    <span class="k">def</span> <span class="nf">adduct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
    
    <span class="k">def</span> <span class="nf">remove_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="o">-</span><span class="n">mass</span><span class="o">.</span><span class="n">proton</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove_ac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;H3C2O2&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="o">-</span><span class="n">m</span> <span class="o">-</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove_fo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;HCO2&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="o">-</span><span class="n">m</span> <span class="o">-</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove_nh4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;NH4&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="o">-</span><span class="n">m</span> <span class="o">+</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove_oh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;OH&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="o">-</span><span class="n">m</span> <span class="o">-</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="n">mass</span><span class="o">.</span><span class="n">proton</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_2h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mass</span><span class="o">.</span><span class="n">proton</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_3h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">mass</span><span class="o">.</span><span class="n">proton</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_oh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;OH&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_fo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;HCO2&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_ac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;H3C2O2&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_nh4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;NH4&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_na</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;Na&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">remove_na</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">MolWeight</span><span class="p">(</span><span class="s1">&#39;Na&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct</span><span class="p">(</span><span class="o">-</span><span class="n">m</span> <span class="o">+</span> <span class="n">mass</span><span class="o">.</span><span class="n">electron</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">modname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

<span class="c1"># ##</span>

<div class="viewcode-block" id="Feature"><a class="viewcode-back" href="../../index.html#emese.main.Feature">[docs]</a><span class="k">class</span> <span class="nc">Feature</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides additional, more sophisticated methods</span>
<span class="sd">    for identification of a single feature.</span>
<span class="sd">    </span>
<span class="sd">    In the original concept all methods for identification</span>
<span class="sd">    based on MS1 and MS2 took place in class Screening(),</span>
<span class="sd">    as those could simply iterate through the arrays.</span>
<span class="sd">    </span>
<span class="sd">    Later more complex methods became necessary, so</span>
<span class="sd">    I created this class to group them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">oi</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @main : ltp.Screening() instance</span>
<span class="sd">            One Screening() instance with MS1 and MS2 processing already done.</span>
<span class="sd">        </span>
<span class="sd">        @protein : str</span>
<span class="sd">            Protein name</span>
<span class="sd">        </span>
<span class="sd">        @mode : str</span>
<span class="sd">            MS mode (`pos` or `neg`)</span>
<span class="sd">        </span>
<span class="sd">        @oi : int</span>
<span class="sd">            Original index of one feature.</span>
<span class="sd">        </span>
<span class="sd">        @log : bool</span>
<span class="sd">            Whether output verbose messages to logfile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protein</span> <span class="o">=</span> <span class="n">protein</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oi</span> <span class="o">=</span> <span class="n">oi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">fraction_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracsi</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                               <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifracs</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">oi2i</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans_fractions</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">tpl</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">tpl</span><span class="p">)),</span>
            <span class="n">uniqList</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="nb">tuple</span><span class="p">,</span>
                    <span class="c1"># scan ID, fraction ID</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ms2</span><span class="p">[:,[</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">]]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">,</span> <span class="s1">&#39;PC&#39;</span><span class="p">,</span> <span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;PS&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">,</span> <span class="s1">&#39;PC&#39;</span><span class="p">,</span> <span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;PS&#39;</span><span class="p">,</span> <span class="s1">&#39;PI&#39;</span><span class="p">,</span> <span class="s1">&#39;SM&#39;</span><span class="p">,</span> <span class="s1">&#39;Cer&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identities2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># get carbon counts from MS1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms1fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
        <span class="c1"># sorting by fractions/scans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">sc_fr</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="c1"># scan ID, fraction ID: key</span>
                        <span class="p">(</span><span class="n">sc_fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sc_fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="c1"># MS2 array slice: value</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ms2</span><span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ms2</span><span class="p">[:,</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="n">sc_fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ms2</span><span class="p">[:,</span><span class="mi">14</span><span class="p">]</span> <span class="o">==</span> <span class="n">sc_fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scans_fractions</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># sorting by intensity desc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],:]</span>
                    <span class="p">),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltart</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rtm&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span>
                    <span class="p">),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scans</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="c1"># i[0]: (scan ID, fraction ID)</span>
                        <span class="c1"># i[1]: MS2 array slice</span>
                        <span class="n">MS2Scan</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxins</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                    <span class="p">),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medins</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">2</span><span class="p">])</span>
                    <span class="p">),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_scans</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_best_scan</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">::: Analysing feature: </span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> :: index = </span><span class="si">%u</span><span class="s1"> ::&#39;</span>\
                <span class="s1">&#39; m/z = </span><span class="si">%.03f</span><span class="s1"> :: number of MS2 scans: </span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">],</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">::: Database lookup resulted &#39;</span>\
            <span class="s1">&#39;the following species: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_db_species</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">::: Intensities:</span><span class="se">\n</span><span class="si">%s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;          &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;A09&#39;</span><span class="p">,</span> <span class="s1">&#39;A10&#39;</span><span class="p">,</span> <span class="s1">&#39;A11&#39;</span><span class="p">,</span> <span class="s1">&#39;A12&#39;</span><span class="p">,</span> <span class="s1">&#39;B01&#39;</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">63</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    - absolute:  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;   &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%10.01f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,:]))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    - relative: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">xx</span><span class="p">:</span>
                        <span class="s1">&#39;</span><span class="si">%10.02f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xx</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">),</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,:]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">::: MS2 scans available (</span><span class="si">%u</span><span class="s1">):</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">print_scan</span><span class="p">()</span>
    
<div class="viewcode-block" id="Feature.sort_scans"><a class="viewcode-back" href="../../index.html#emese.main.Feature.sort_scans">[docs]</a>    <span class="k">def</span> <span class="nf">sort_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Groups the scans in 3 groups: highest consists of those from the</span>
<span class="sd">        fractions with the highest protein level (there might be more than</span>
<span class="sd">        one the highest, because the fraction offset limits); the secondary</span>
<span class="sd">        contains scans from other protein containing fractions; while the</span>
<span class="sd">        other contains the scans from non protein containing fractions.</span>
<span class="sd">        Within the groups the scans are sorted from lowest to highest</span>
<span class="sd">        deltaRT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highest</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">with_protein</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">protein_containing_fractions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scan_num</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">fr_name</span> <span class="o">=</span> <span class="s1">&#39;a</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fr</span> <span class="k">if</span> <span class="n">fr</span> <span class="o">!=</span> <span class="mi">13</span> <span class="ow">and</span> <span class="n">fr</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;b1&#39;</span>
            <span class="k">if</span> <span class="n">fr_name</span> <span class="ow">in</span> <span class="n">with_protein</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fr_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">fracs_orderL</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="n">fr_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">fracs_orderU</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">protein</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">highest</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">scan_num</span><span class="p">,</span> <span class="n">fr</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">scan_num</span><span class="p">,</span> <span class="n">fr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">scan_num</span><span class="p">,</span> <span class="n">fr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highest</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highest</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">sc</span><span class="p">]</span><span class="o">.</span><span class="n">deltart</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">sc</span><span class="p">]</span><span class="o">.</span><span class="n">deltart</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">sc</span><span class="p">]</span><span class="o">.</span><span class="n">deltart</span><span class="p">))</span></div>
    
    <span class="k">def</span> <span class="nf">select_best_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_scan</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">highest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highest</span><span class="p">)</span> <span class="k">else</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondary</span><span class="p">)</span> <span class="k">else</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">other</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other</span><span class="p">)</span> <span class="k">else</span> \
            <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">print_db_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">hg</span> \
                            <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">]</span> \
                            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">])</span> \
                            <span class="k">else</span> \
                        <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">fa</span><span class="p">:</span>
                                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span> \
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">])</span> \
        <span class="k">else</span> <span class="s1">&#39;none&#39;</span>
    
    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">modname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">hgfas</span><span class="p">:</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">fa</span><span class="p">:</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hgfas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fa</span><span class="p">),</span>
                            <span class="n">hgfas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_header_div</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;div class=&quot;ms2hdr&quot;&gt;</span><span class="se">\n\t\t</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;MS2 scans of feature </span><span class="si">%.04f</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">|&lt;span class=&quot;scansbutton morescans1&quot;&#39;</span>\
                <span class="s1">&#39; title=&quot;Show/hide scans from fractions with &#39;</span>\
                <span class="s1">&#39;highest protein concentration&quot;&gt;scans+&lt;/span&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">|&lt;span class=&quot;scansbutton morescans2&quot;&#39;</span>\
                <span class="s1">&#39; title=&quot;Show/hide scans from other protein &#39;</span>\
                <span class="s1">&#39;containing fractions&quot;&gt;scans++&lt;/span&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">|&lt;span class=&quot;scansbutton morescans3&quot;&#39;</span>\
                <span class="s1">&#39; title=&quot;Show/hide scans from non protein &#39;</span>\
                <span class="s1">&#39;containing fractions&quot;&gt;scans+++&lt;/span&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">|&lt;span class=&quot;scansbutton morefrags&quot;&#39;</span>\
                <span class="s1">&#39; title=&quot;Show/hide fragments after 5 highest&#39;</span>\
                <span class="s1">&#39;&quot;&gt;frags+&lt;/span&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">|&lt;span class=&quot;scansbutton remove&quot;&#39;</span>\
                <span class="s1">&#39; title=&quot;Remove scans of this feature&#39;</span>\
                <span class="s1">&#39;&quot;&gt;remove&lt;/span&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;/div&gt;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">html_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">container</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;div id=&quot;</span><span class="si">%s</span><span class="s1">&quot; class=&quot;ms2tblcontainer&quot;&gt;</span><span class="se">\n</span><span class="si">%s%s</span><span class="se">\n\t</span><span class="s1">&lt;/div&gt;&#39;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_header_div</span><span class="p">()</span>
        <span class="n">html</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_scan</span><span class="p">]</span><span class="o">.</span><span class="n">html_table</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;noscans&quot;&gt;No scans &#39;</span>\
                <span class="s1">&#39;from fractions with highest protein concentration.&lt;/div&gt;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">deltart</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">in_primary</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">scan_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_scan</span><span class="p">:</span>
                <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">html_table</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">deltart</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">in_primary</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">scan_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_scan</span><span class="p">:</span>
                <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">html_table</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sc</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">deltart</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">in_primary</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">in_secondary</span><span class="p">:</span>
                <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">html_table</span><span class="p">())</span>
        <span class="n">html</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">container</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ms2c_</span><span class="si">%u</span><span class="s1">_</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">oi</span><span class="p">),</span> <span class="n">header</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">html_table_b64</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">encodestring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html_table</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">ms2log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_any_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">:: Calling method </span><span class="si">%s</span><span class="s1">() on scan #</span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&gt;&gt;&gt; Attempting to identify </span><span class="si">%s</span><span class="s1"> in all scans</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_scan</span><span class="p">(</span><span class="s1">&#39;is_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;&lt;&lt; Result: identified as </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;&lt;&lt; Result: not </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">identify2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&gt;&gt;&gt; Attempting to identify </span><span class="si">%s</span><span class="s1"> in all scans</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identities2</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">identified</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">scanid</span><span class="p">,</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scans</span><span class="p">):</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">identities2</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">method</span><span class="p">)())</span>
                    <span class="n">identified</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">identities2</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">identified</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;&lt;&lt; Result: identified as </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;&lt;&lt; Result: not </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">)</span></div>

<div class="viewcode-block" id="MS2Scan"><a class="viewcode-back" href="../../index.html#emese.main.MS2Scan">[docs]</a><span class="k">class</span> <span class="nc">MS2Scan</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents one MS2 scan and provides methods for its analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span> <span class="o">=</span> <span class="n">scan_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">deltart</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">fracsi</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">ms2files</span>\
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">protein</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mode</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">frac_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_name</span> <span class="ow">in</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">fracs_order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;prim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_secondary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_name</span> <span class="ow">in</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">fracs_order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;sec&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">tbl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*[^0-9]([0-9]{1,2}):([0-9]).*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_by_i</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_fa_list</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">modname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ms1mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Frag. m/z</span><span class="se">\t</span><span class="s1">Intensity</span><span class="se">\t</span><span class="s1">Identity</span><span class="si">%s</span><span class="s1">NL mass</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">26</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">73</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">sc</span><span class="p">:</span>
                    <span class="s1">&#39;</span><span class="si">%9.4f</span><span class="se">\t</span><span class="si">%10.2f</span><span class="se">\t</span><span class="si">%s%s%9.4f</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sc</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">]])</span> <span class="o">+</span> \
                            <span class="p">[</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sc</span><span class="p">[</span><span class="mi">7</span><span class="p">])),</span> <span class="n">ms1mz</span> <span class="o">-</span> <span class="n">sc</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scan</span>
            <span class="p">)</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Scan </span><span class="si">%u</span><span class="s1"> (fraction </span><span class="si">%s</span><span class="s1">(#</span><span class="si">%u</span><span class="s1">); </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">; &#39;</span>\
            <span class="s1">&#39;intensity = </span><span class="si">%.01f</span><span class="s1"> (</span><span class="si">%.02f%%</span><span class="s1">)):</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">frac_name</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span><span class="p">,</span>
             <span class="s1">&#39;contains&#39;</span> \
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ifracs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">frac_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> \
                <span class="k">else</span> <span class="s1">&#39;does not contain&#39;</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span><span class="p">]</span> \
                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span><span class="p">]</span> \
                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">/</span> \
                 <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span>
             <span class="n">header</span><span class="p">,</span>
             <span class="n">table</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">html_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;table id=&quot;</span><span class="si">%s</span><span class="s1">&quot; class=&quot;scantbl </span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\t\t</span><span class="s1">&lt;/table&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">th</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="s1">&lt;th&gt;</span><span class="se">\n\t\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;tr class=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="s1">&lt;th colspan=&quot;4&quot;&gt;</span><span class="se">\n\t\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;tr class=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">td</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="s1">&lt;td&gt;</span><span class="se">\n\t\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">ms1mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">ttl</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s1">&#39;scantitle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Scan </span><span class="si">%u</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">; &#39;</span>\
            <span class="s1">&#39;intensity = </span><span class="si">%.01f</span><span class="s1"> (</span><span class="si">%.02f%%</span><span class="s1">); dRT = </span><span class="si">%.03f</span><span class="s1"> min)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frac_name</span><span class="p">,</span>
                <span class="s1">&#39;the highest fraction&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_primary</span> \
                    <span class="k">else</span> <span class="s1">&#39;not the highest, but contains </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">protein</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_secondary</span> \
                    <span class="k">else</span> <span class="s1">&#39;does not contain </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span><span class="p">]</span> \
                    <span class="k">if</span> <span class="n">fri</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_id</span><span class="p">]</span> \
                    <span class="k">if</span> <span class="n">fri</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deltart</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">rows</span> <span class="o">+=</span> <span class="n">tr</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s1">&#39;scanhdr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">cname</span><span class="p">:</span>
                        <span class="n">th</span> <span class="o">%</span> <span class="n">cname</span><span class="p">,</span>
                    <span class="p">[</span><span class="s1">&#39;Frag m/z&#39;</span><span class="p">,</span> <span class="s1">&#39;Intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;Identity&#39;</span><span class="p">,</span> <span class="s1">&#39;NL mass&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">rn</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">+=</span> <span class="n">tr</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s1">&#39;fragrow </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;first5&#39;</span> <span class="k">if</span> <span class="n">rn</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;after5&#39;</span><span class="p">),</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="n">td</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">td</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%.02f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="n">td</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                    <span class="n">td</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms1mz</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="p">])</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">table</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">_</span><span class="si">%u</span><span class="s1">_</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s1">&#39;best&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">best_scan</span> \
                <span class="k">else</span> <span class="s1">&#39;primary&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_primary</span> \
                <span class="k">else</span> <span class="s1">&#39;secondary&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_secondary</span> \
                <span class="k">else</span> <span class="s1">&#39;noprotein&#39;</span><span class="p">,</span>
            <span class="n">rows</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_by_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">min_mz</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="n">this_rank</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">return_next</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">prev_mz</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_mz</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prev_mz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
                <span class="n">prev_mz</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">this_rank</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">this_rank</span> <span class="o">==</span> <span class="n">rank</span><span class="p">:</span>
                <span class="n">return_next</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1">(</span><span class="si">%u</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%.03f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">this_rank</span> <span class="o">!=</span> <span class="n">rank</span> <span class="ow">and</span> <span class="n">return_next</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">intensity</span><span class="p">,</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">full_list_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prev_mz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>  <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%.03f</span><span class="s1">) (</span><span class="si">%u</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">))),</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">intensity</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%u</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">))),</span> <span class="n">intensity</span><span class="p">))</span>
                <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">prev_mz</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%u</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">))),</span> <span class="n">intensity</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">most_abundant_mz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- Most abundant m/z is </span><span class="si">%.03f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">mz_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz_detected</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mz_detected</span> <span class="o">-</span> <span class="n">mz</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">ms2_tlr</span>
    
    <span class="k">def</span> <span class="nf">sort_by_mz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),:]</span>
    
    <span class="k">def</span> <span class="nf">sort_by_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_order</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">order</span><span class="p">,:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">order</span><span class="p">,:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_order</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">order</span>
    
<div class="viewcode-block" id="MS2Scan.mz_lookup"><a class="viewcode-back" href="../../index.html#emese.main.MS2Scan.mz_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">mz_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the index of the closest m/z value</span>
<span class="sd">        detected in the scan if it is within the</span>
<span class="sd">        range of tolerance, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">du</span> <span class="o">=</span> <span class="mf">999.0</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="mf">999.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_by_mz</span><span class="p">()</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ui</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">du</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">ui</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span>
        <span class="k">if</span> <span class="n">ui</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ui</span> <span class="k">if</span> <span class="n">du</span> <span class="o">&lt;</span> <span class="n">dl</span> <span class="k">else</span> <span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mz</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_by_i</span><span class="p">(</span><span class="n">return_order</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sort</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">i</span></div>
    
    <span class="k">def</span> <span class="nf">has_mz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_lookup</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- m/z </span><span class="si">%.03f</span><span class="s1"> occures in this scan? -- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">has_nl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nl</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">nl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- neutral loss of </span><span class="si">%.03f</span><span class="s1"> occures in &#39;</span>\
            <span class="s1">&#39;this scan? Looked up m/z </span><span class="si">%.03f</span><span class="s1"> - </span><span class="si">%.03f</span><span class="s1"> = </span><span class="si">%.03f</span><span class="s1"> -- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">nl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">i</span><span class="p">],</span> <span class="n">nl</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">nl</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">most_abundant_mz_is</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">most_abundant_mz</span><span class="p">(),</span> <span class="n">mz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- m/z </span><span class="si">%.03f</span><span class="s1"> is the most abundant? -- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">mz_among_most_abundant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mz</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- m/z </span><span class="si">%.03f</span><span class="s1"> is among the </span><span class="si">%u</span><span class="s1"> most abundant? -- &#39;</span>\
            <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">nl_among_most_abundant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">nl</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mz</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- neutral loss </span><span class="si">%.03f</span><span class="s1"> is among &#39;</span>\
            <span class="s1">&#39;the </span><span class="si">%u</span><span class="s1"> most abundant? -- &#39;</span>\
            <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nl</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">mz_percent_of_most_abundant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="mf">80.0</span><span class="p">):</span>
        <span class="n">insmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_match</span><span class="p">(</span><span class="n">frag</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mz</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">frag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">insmax</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="n">percent</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- m/z </span><span class="si">%.03f</span><span class="s1"> has abundance at least </span><span class="si">%.01f</span><span class="s1"> </span><span class="si">%%</span><span class="s1"> of&#39;</span>\
            <span class="s1">&#39; the highest abundance? -- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">percent</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">fa_type_is</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fa_type</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">fa_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span> <span class="ow">or</span> <span class="n">fa_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span> \
            <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sphingo</span> <span class="ow">or</span> <span class="s1">&#39;Sphingosine&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- Fragment #</span><span class="si">%u</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">): fatty acid type &#39;</span>\
            <span class="s1">&#39;is </span><span class="si">%s</span><span class="s1">?  -- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">fa_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">is_fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;FA&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Lyso&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">sphingo</span> <span class="ow">and</span> <span class="s1">&#39;Sphi&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- Fragment #</span><span class="si">%u</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">): is fatty acid? &#39;</span>\
            <span class="s1">&#39;-- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">most_abundant_fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fa_type</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">head</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="n">sphingo</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fa_type</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="n">sphingo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- Having fatty acid </span><span class="si">%s</span><span class="s1"> among </span><span class="si">%u</span><span class="s1"> most abundant &#39;</span>\
            <span class="s1">&#39;features? -- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fa_type</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">fa_among_most_abundant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fa_type</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">min_mass</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fa_frags</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="n">sphingo</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">min_mass</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_mass</span>
                <span class="p">):</span>
                
                <span class="n">fa_frags</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">min_mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">-- Fragment #</span><span class="si">%u</span><span class="s1"> having mass larger &#39;</span>\
                        <span class="s1">&#39;than </span><span class="si">%.01f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">min_mass</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fa_type</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="n">sphingo</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">fa_frags</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">break</span>
            
            <span class="k">elif</span> <span class="n">min_mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">-- Fragment #</span><span class="si">%u</span><span class="s1"> having mass lower &#39;</span>\
                        <span class="s1">&#39;than </span><span class="si">%.01f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">min_mass</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- Having fatty acid fragment </span><span class="si">%s</span><span class="s1"> among </span><span class="si">%u</span><span class="s1"> most &#39;</span>\
            <span class="s1">&#39;abundant -- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fa_type</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">fa_percent_of_most_abundant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fa_type</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="mf">80.0</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="n">sphingo</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fa_type</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="n">sphingo</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">insmax</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="n">percent</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">mz_most_abundant_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">fold</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_abundant_mz_is</span><span class="p">(</span><span class="n">mz</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">fold</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- m/z </span><span class="si">%.03f</span><span class="s1"> is at least </span><span class="si">%u</span><span class="s1"> times higher than &#39;</span>\
            <span class="s1">&#39;any other? -- </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">fold</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">sum_cc_is</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc2str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_cc</span><span class="p">([</span><span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">]))</span> <span class="o">==</span> <span class="n">cc</span>
    
    <span class="k">def</span> <span class="nf">cer_fa_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frag1</span><span class="p">,</span> <span class="n">frag2</span><span class="p">):</span>
        <span class="k">return</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="n">frag1</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="s1">&#39;CerFA(&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="n">frag2</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="s1">&#39;CerSphi-N(&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="n">frag1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">fa_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span><span class="p">[</span><span class="n">hg</span><span class="p">]):</span>
            <span class="n">ccs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span><span class="p">[</span><span class="n">hg</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_fa_list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">ccs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">frag1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">frag2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="o">==</span> <span class="s1">&#39;Cer&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cer_fa_test</span><span class="p">(</span><span class="n">frag1</span><span class="p">,</span> <span class="n">frag2</span><span class="p">):</span>
                        <span class="c1"># where not the &#39;CerFA&#39; is the most intensive</span>
                        <span class="c1"># those are clearly false</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                        <span class="p">(</span><span class="n">frag1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> \
                        <span class="p">(</span><span class="n">frag2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> \
                        <span class="p">(</span><span class="ow">not</span> <span class="n">sphingo</span> <span class="ow">or</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">or</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_cc_is</span><span class="p">(</span><span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cc</span><span class="p">):</span>
                            <span class="n">ether_1</span> <span class="o">=</span> <span class="s1">&#39;O-&#39;</span> <span class="k">if</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">ether_2</span> <span class="o">=</span> <span class="s1">&#39;O-&#39;</span> <span class="k">if</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">fa_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ether_1</span><span class="p">,</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">fa_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ether_2</span><span class="p">,</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                                <span class="n">fa_1</span> <span class="o">=</span> <span class="s1">&#39;d</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fa_1</span>
                            <span class="k">elif</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                                <span class="n">sph</span> <span class="o">=</span> <span class="s1">&#39;d</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fa_2</span>
                                <span class="n">fa_2</span> <span class="o">=</span> <span class="n">fa_1</span>
                                <span class="n">fa_1</span> <span class="o">=</span> <span class="n">sph</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                                <span class="n">fa</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">fa_1</span><span class="p">,</span> <span class="n">fa_2</span><span class="p">]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fa</span> <span class="o">=</span> <span class="p">(</span><span class="n">fa_1</span><span class="p">,</span> <span class="n">fa_2</span><span class="p">)</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fa</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    
<div class="viewcode-block" id="MS2Scan.matching_fa_frags_of_type"><a class="viewcode-back" href="../../index.html#emese.main.MS2Scan.matching_fa_frags_of_type">[docs]</a>    <span class="k">def</span> <span class="nf">matching_fa_frags_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">return_details</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns carbon counts of those fragments which are of the given type</span>
<span class="sd">        and have complement fatty acid fragment of any type.</span>
<span class="sd">        </span>
<span class="sd">        Details is a dict with carbon counts as keys</span>
<span class="sd">        and fragment names as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span><span class="p">[</span><span class="n">hg</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span><span class="p">[</span><span class="n">hg</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build_fa_list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">frag1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">frag2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                            <span class="n">frag2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">frag1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">frag2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="ow">not</span> <span class="n">sphingo</span> <span class="ow">or</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="n">frag1</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">typ</span><span class="p">)</span> <span class="ow">and</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">sum_cc_is</span><span class="p">(</span><span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frag2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cc</span><span class="p">):</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
                                        <span class="n">details</span><span class="p">[</span><span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                                    <span class="n">details</span><span class="p">[</span><span class="n">frag1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">frag2</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="mi">7</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">return_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span></div>
    
    <span class="k">def</span> <span class="nf">cer_matching_fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cer_fa</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;Cer&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span><span class="p">:</span>
            <span class="n">cer_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cc</span><span class="p">(</span><span class="n">cer_fa</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span><span class="p">[</span><span class="s1">&#39;Cer&#39;</span><span class="p">]:</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cc</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                <span class="n">carb</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cer_cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">unsat</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cer_cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span>
                    <span class="s1">&#39;[FA-alkyl(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-H]-&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">carb</span><span class="p">,</span> <span class="n">unsat</span><span class="p">)):</span>
                    <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">carb</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cer_cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="n">unsat</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cer_cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span>
                    <span class="s1">&#39;[FA-alkyl(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-H]-&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">carb</span><span class="p">,</span> <span class="n">unsat</span><span class="p">)):</span>
                    <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">score</span>
    
<div class="viewcode-block" id="MS2Scan.build_fa_list"><a class="viewcode-back" href="../../index.html#emese.main.MS2Scan.build_fa_list">[docs]</a>    <span class="k">def</span> <span class="nf">build_fa_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rebuild</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns list with elements:</span>
<span class="sd">            carbon count, headgroups (set or None),</span>
<span class="sd">            esther (False) or ether (True),</span>
<span class="sd">            sphingosine (True) or fatty acid (False),</span>
<span class="sd">            fragment intensity and row index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rebuild</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fa_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">frag</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cc</span><span class="p">(</span><span class="n">frag</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                    <span class="n">hgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hg</span><span class="p">(</span><span class="n">frag</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                    <span class="n">is_ether</span> <span class="o">=</span> <span class="s1">&#39;alk&#39;</span> <span class="ow">in</span> <span class="n">frag</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                    <span class="n">is_sphingo</span> <span class="o">=</span> <span class="s1">&#39;Sphi&#39;</span> <span class="ow">in</span> <span class="n">frag</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fa_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cc</span><span class="p">,</span> <span class="n">hgs</span><span class="p">,</span> <span class="n">is_ether</span><span class="p">,</span> <span class="n">is_sphingo</span><span class="p">,</span> <span class="n">frag</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">i</span><span class="p">])</span></div>
    
    <span class="k">def</span> <span class="nf">get_hg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frag_name</span><span class="p">):</span>
        <span class="n">hgfrags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">nHgfrags</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">pHgfrags</span>
        <span class="k">return</span> <span class="n">hgfrags</span><span class="p">[</span><span class="n">frag_name</span><span class="p">]</span> \
            <span class="k">if</span> <span class="n">frag_name</span> <span class="ow">in</span> <span class="n">hgfrags</span> <span class="ow">and</span> \
                <span class="nb">len</span><span class="p">(</span><span class="n">hgfrags</span><span class="p">[</span><span class="n">frag_name</span><span class="p">])</span> \
            <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">get_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fa</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()))</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">most_abundant_fa_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fa_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">fa_cc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">head</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">fa_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fa_type</span><span class="p">)</span>
                <span class="p">):</span>
                
                <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cc</span><span class="p">(</span><span class="n">frag</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fa_cc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cc</span><span class="p">,</span> <span class="n">frag</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        
        <span class="k">return</span> <span class="n">fa_cc</span>
    
    <span class="k">def</span> <span class="nf">cc2str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cc</span>
    
    <span class="k">def</span> <span class="nf">sum_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccs</span><span class="p">):</span>
        <span class="k">return</span> \
            <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">reduce</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">cu1</span><span class="p">,</span> <span class="n">cu2</span><span class="p">:</span>
                        <span class="c1"># here `cu`: carbon count and unsaturation</span>
                        <span class="p">(</span><span class="n">cu1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cu2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cu1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cu2</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">ccs</span>
                <span class="p">)</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">sum_cc2str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccs</span><span class="p">):</span>
        <span class="k">return</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">cc2str</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">reduce</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">cu1</span><span class="p">,</span> <span class="n">cu2</span><span class="p">:</span>
                            <span class="p">(</span><span class="n">cu1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cu2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cu1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cu2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="n">ccs</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_fa1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">hg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fa1</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fa1</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">fai</span><span class="p">:</span>
                            <span class="n">fai</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">fa</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">fastr</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">fai</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cc2str</span><span class="p">(</span><span class="n">fai</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">fa</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- Adding fatty acids </span><span class="si">%s</span><span class="s1"> at headgroup &#39;</span>\
                <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fastr</span><span class="p">,</span> <span class="n">hg</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">fa_ccs_agree_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">,</span> <span class="n">fa_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">fa_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_abundant_fa_cc</span><span class="p">(</span><span class="n">fa_type</span> <span class="o">=</span> <span class="n">fa_type</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fa_cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_cc2str</span><span class="p">([</span><span class="n">fa_cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">agr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_cc_agrees_ms1</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">hg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">agr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_fa1</span><span class="p">(</span><span class="n">fa_cc</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">hg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fa_cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_cc2str</span><span class="p">(</span><span class="n">fa_cc</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">agr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_cc_agrees_ms1</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">hg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">agr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_fa1</span><span class="p">(</span><span class="n">fa_cc</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">hg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span>
    
    <span class="k">def</span> <span class="nf">fa_cc_agrees_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">hg</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span> <span class="ow">and</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span><span class="p">[</span><span class="n">hg</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">fa</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  -- Carbon count from MS2: </span><span class="si">%s</span><span class="s1">; from databases &#39;</span>\
            <span class="s1">&#39;lookup: </span><span class="si">%s</span><span class="s1"> -- Any of these matches: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span>
                    <span class="n">cc</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span><span class="p">[</span><span class="n">hg</span><span class="p">])</span> \
                        <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">ms1fa</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">frag_name_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">pe_neg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">140.0118206</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;PE&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">196.0380330</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="n">fa_h_ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_fa_frags_of_type</span><span class="p">(</span><span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fa_h_cc</span> <span class="ow">in</span> <span class="n">fa_h_ccs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fa_other</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;[Lyso-PE(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;[Lyso-PE-alkyl(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-H2O]-&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;[Lyso-PE-alkyl(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;[FA(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-H-CO2]-&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span><span class="n">fa_other</span> <span class="o">%</span> <span class="n">fa_h_cc</span><span class="p">):</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">pc_neg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">168.0431206</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;PC&#39;</span><span class="p">)</span>
            <span class="n">fa_h_ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_fa_frags_of_type</span><span class="p">(</span><span class="s1">&#39;PC&#39;</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fa_h_cc</span> <span class="ow">in</span> <span class="n">fa_h_ccs</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span><span class="s1">&#39;[Lyso-PC(c</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span> <span class="o">%</span> <span class="n">fa_h_cc</span><span class="p">):</span>
                    <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">pi_neg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">241.0118779</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">152.9958366</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">78.95905658</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;PI&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hgfrag_mz</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">96.96962158</span><span class="p">,</span> <span class="mf">259.0224425</span><span class="p">,</span> <span class="mf">297.0380926</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="n">hgfrag_mz</span><span class="p">):</span>
                    <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fa_h_ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_fa_frags_of_type</span><span class="p">(</span><span class="s1">&#39;PI&#39;</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fa_h_cc</span> <span class="ow">in</span> <span class="n">fa_h_ccs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fa_other</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;[Lyso-PI(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;[Lyso-PI(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-H2O]-]&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span><span class="n">fa_other</span> <span class="o">%</span> <span class="n">fa_h_cc</span><span class="p">):</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">ps_neg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">152.9958366</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;PS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">87.03202840</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fa_h_ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_fa_frags_of_type</span><span class="p">(</span><span class="s1">&#39;PS&#39;</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fa_h_cc</span> <span class="ow">in</span> <span class="n">fa_h_ccs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fa_other</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;[Lyso-PS(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;[Lyso-PA(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span><span class="n">fa_other</span> <span class="o">%</span> <span class="n">fa_h_cc</span><span class="p">):</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">pg_neg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fa</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_type_is</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">152.9958366</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;PG&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">171.0064016</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fa_h_ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_fa_frags_of_type</span><span class="p">(</span><span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fa_h_cc</span> <span class="ow">in</span> <span class="n">fa_h_ccs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fa_other</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;Lyso-PG(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Lyso-PG(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-H2O]-&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span><span class="n">fa_other</span> <span class="o">%</span> <span class="n">fa_h_cc</span><span class="p">):</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">sm_neg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_among_most_abundant</span><span class="p">(</span><span class="mf">168.0431206</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_nl</span><span class="p">(</span><span class="mf">60.02113</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">cer_neg_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_among_most_abundant</span><span class="p">(</span><span class="s1">&#39;CerFA&#39;</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;Cer&#39;</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">fa_h_ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_fa_frags_of_type</span><span class="p">(</span><span class="s1">&#39;Cer&#39;</span><span class="p">,</span> <span class="s1">&#39;CerFA(&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fa_h_cc</span> <span class="ow">in</span> <span class="n">fa_h_ccs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fa_other</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;[CerFA-N(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;[CerFA-C2N(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-]-&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span><span class="n">fa_other</span> <span class="o">%</span> <span class="n">fa_h_cc</span><span class="p">):</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">pc_pos_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_abundant_mz_is</span><span class="p">(</span><span class="mf">184.073323</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">86.096425</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;PC&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">104.106990</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">124.999822</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">pe_pos_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nl_among_most_abundant</span><span class="p">(</span><span class="mf">141.019097</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;PE&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">cer_pos_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_among_most_abundant</span><span class="p">(</span><span class="s1">&#39;-H2O-H2O+]+&#39;</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="n">fattya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_combinations</span><span class="p">(</span><span class="s1">&#39;Cer&#39;</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">sph_ccs</span><span class="p">,</span> <span class="n">fa_frags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matching_fa_frags_of_type</span><span class="p">(</span><span class="s1">&#39;Cer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-H2O-H2O+]+&#39;</span><span class="p">,</span> <span class="n">sphingo</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_details</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cc</span><span class="p">,</span> <span class="n">fa_frag_names</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">fa_frags</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fa_frag_name</span> <span class="ow">in</span> <span class="n">fa_frag_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;+H]+&#39;</span> <span class="ow">in</span> <span class="n">fa_frag_name</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s1">&#39;-O]+&#39;</span> <span class="ow">in</span> <span class="n">fa_frag_name</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s1">&#39;NL&#39;</span> <span class="ow">in</span> <span class="n">fa_frag_name</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">sph_cc</span> <span class="ow">in</span> <span class="n">sph_ccs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fa_other</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;[Sphingosine(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-C-H2O-H2O+]+&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;[Sphingosine(C</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)-H2O+]+&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frag_name_present</span><span class="p">(</span><span class="n">fa_other</span> <span class="o">%</span> <span class="n">sph_cc</span><span class="p">):</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">mz</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="n">mz</span><span class="p">),</span>
                        <span class="p">[</span><span class="mf">58.065126</span><span class="p">,</span> <span class="mf">104.106990</span><span class="p">,</span> <span class="mf">124.999822</span><span class="p">,</span> <span class="mf">184.073323</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">mz</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="n">mz</span><span class="p">),</span>
                        <span class="p">[</span><span class="mf">60.0443902</span><span class="p">,</span> <span class="mf">70.0651257</span><span class="p">,</span> <span class="mf">82.0651257</span><span class="p">,</span> <span class="mf">96.0807757</span><span class="p">,</span>
                        <span class="mf">107.072951</span><span class="p">,</span> <span class="mf">121.088601</span><span class="p">,</span> <span class="mf">135.104251</span><span class="p">,</span> <span class="mf">149.119901</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">sm_pos_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">mz</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="n">mz</span><span class="p">),</span>
                <span class="p">[</span><span class="mf">60.080776</span><span class="p">,</span> <span class="mf">86.096425</span><span class="p">,</span> <span class="mf">104.106990</span><span class="p">,</span>
                    <span class="mf">124.999822</span><span class="p">,</span> <span class="mf">184.073323</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">vd_pos_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fattya</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;fattya&#39;</span><span class="p">:</span> <span class="n">fattya</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">is_pe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa_pe_ps_pg_pos</span><span class="p">(</span><span class="s1">&#39;PE&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe_pc_pg_neg</span><span class="p">(</span><span class="s1">&#39;PE&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_pc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pc_pos</span><span class="p">(</span><span class="s1">&#39;PC&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe_pc_pg_neg</span><span class="p">(</span><span class="s1">&#39;PC&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_pa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa_pe_ps_pg_pos</span><span class="p">(</span><span class="s1">&#39;PA&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa_ps_neg</span><span class="p">(</span><span class="s1">&#39;PA&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_ps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa_pe_ps_pg_pos</span><span class="p">(</span><span class="s1">&#39;PS&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa_ps_neg</span><span class="p">(</span><span class="s1">&#39;PS&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_pg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa_pe_ps_pg_pos</span><span class="p">(</span><span class="s1">&#39;PG&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe_pc_pg_neg</span><span class="p">(</span><span class="s1">&#39;PG&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pa_pe_ps_pg_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_among_most_abundant</span><span class="p">(</span><span class="mf">141.0191</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_among_most_abundant</span><span class="p">(</span><span class="s1">&#39;-O]+&#39;</span><span class="p">,</span> <span class="n">min_mass</span> <span class="o">=</span> <span class="mf">140.0</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_ccs_agree_ms1</span><span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;-O]+&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pa_ps_neg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">152.9958366</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_mz</span><span class="p">(</span><span class="mf">78.95905658</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_abundant_fa</span><span class="p">(</span><span class="s1">&#39;-H]-&#39;</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_ccs_agree_ms1</span><span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pe_pc_pg_neg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">most_abundant_fa</span><span class="p">(</span><span class="s1">&#39;-H]-&#39;</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_ccs_agree_ms1</span><span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;-H]-&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pc_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_most_abundant_fold</span><span class="p">(</span><span class="mf">184.0733</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa_ccs_agree_ms1</span><span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">head</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span></div>

<span class="c1"># ##</span>

<div class="viewcode-block" id="Screening"><a class="viewcode-back" href="../../index.html#emese.main.Screening">[docs]</a><span class="k">class</span> <span class="nc">Screening</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Currently this is the main class in this module.</span>
<span class="sd">    Accepts dozens of parameters as keyword arguments.</span>
<span class="sd">    To see all these check the ``defaults`` dict in the code of the</span>
<span class="sd">    ``__init__()`` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># The absolute root directory.</span>
            <span class="c1"># This should not be necessary, why is it here?</span>
            <span class="s1">&#39;path_root&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
            <span class="c1"># The basedir for every files and directories in the followings.</span>
            <span class="s1">&#39;basedir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
            <span class="c1"># If None will be the same as ``basedir``.</span>
            <span class="s1">&#39;data_basedir&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="c1"># List of the shared directories containing most of the data.</span>
            <span class="c1"># Due to their large size these are kept on separate partition.</span>
            <span class="c1"># Lists are joined by `os.path.join`.</span>
            <span class="c1"># E.g. two shared folders can be defined as</span>
            <span class="c1"># `[[&#39;my&#39;, &#39;huge&#39;, &#39;partition&#39;], [`another`, `huge`, `disk`]]`.</span>
            <span class="s1">&#39;datadirs&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;share&#39;</span><span class="p">]],</span>
            <span class="s1">&#39;fractionsf&#39;</span><span class="p">:</span> <span class="s1">&#39;LTPsceenprogres_v07.xlsx&#39;</span><span class="p">,</span>
            <span class="c1"># File with offsets of fractions from SEC in ml.</span>
            <span class="c1"># This we used at Antonella, but at Enric, these values</span>
            <span class="c1"># are different for each protein, and contained by the</span>
            <span class="c1"># individual SEC profile files.</span>
            <span class="s1">&#39;ppfracf&#39;</span><span class="p">:</span> <span class="s1">&#39;fractions.csv&#39;</span><span class="p">,</span>
            <span class="c1"># Directory with the SEC absorbance profiles for each protein.</span>
            <span class="s1">&#39;ppsecdir&#39;</span><span class="p">:</span> <span class="s1">&#39;SEC_profiles&#39;</span><span class="p">,</span>
            <span class="c1"># Directory with the SDS PAGE protein quantities for some</span>
            <span class="c1"># proteins.</span>
            <span class="s1">&#39;gelprofdir&#39;</span><span class="p">:</span> <span class="s1">&#39;gel_profiles&#39;</span><span class="p">,</span>
            <span class="c1"># The directory containing the standards in mzML format.</span>
            <span class="c1"># These are used for calculation of recalibration.</span>
            <span class="s1">&#39;stddir&#39;</span><span class="p">:</span> <span class="s1">&#39;Standards_mzML format&#39;</span><span class="p">,</span>
            <span class="c1"># Directory with manually processed files. These are originally</span>
            <span class="c1"># output of this module, then have been manually processed, and</span>
            <span class="c1"># can be read again and compared/further analysed.</span>
            <span class="s1">&#39;manualdir&#39;</span><span class="p">:</span> <span class="s1">&#39;Processed_files&#39;</span><span class="p">,</span>
            <span class="c1"># For recalibration we read the dates of runs from here.</span>
            <span class="s1">&#39;seqfile&#39;</span><span class="p">:</span> <span class="s1">&#39;Sequence_list_LTP_screen_2015.csv&#39;</span><span class="p">,</span>
            <span class="c1"># This is an output file to export the absorbance based</span>
            <span class="c1"># protein quantities for all proteins and fractions.</span>
            <span class="s1">&#39;pptablef&#39;</span><span class="p">:</span> <span class="s1">&#39;proteins_by_fraction.csv&#39;</span><span class="p">,</span>
            <span class="c1"># Defines abbreviations of each lipid names and the keywords</span>
            <span class="c1"># to identify these in SwissLipids and LipidMaps.</span>
            <span class="s1">&#39;lipnamesf&#39;</span><span class="p">:</span> <span class="s1">&#39;lipid_names_v2.csv&#39;</span><span class="p">,</span>
            <span class="c1"># Literature curated data about known binding properties of LTPs.</span>
            <span class="s1">&#39;bindpropf&#39;</span><span class="p">:</span> <span class="s1">&#39;binding_properties.csv&#39;</span><span class="p">,</span>
            <span class="c1"># The file with recalibration values from Marco.</span>
            <span class="s1">&#39;recalfile&#39;</span><span class="p">:</span> <span class="s1">&#39;Recalibration_values_LTP.csv&#39;</span><span class="p">,</span>
            <span class="c1"># If the recalibration performed by this module, we read the</span>
            <span class="c1"># expected values of the standards from this file.</span>
            <span class="s1">&#39;metabsf&#39;</span><span class="p">:</span> <span class="s1">&#39;Metabolites.xlsx&#39;</span><span class="p">,</span>
            <span class="c1"># Simple list with lipid binding domains, names and UniProt</span>
            <span class="c1"># IDs of all lipid transfer proteins.</span>
            <span class="s1">&#39;ltplistf&#39;</span><span class="p">:</span> <span class="s1">&#39;ltplist.csv&#39;</span><span class="p">,</span>
            <span class="c1"># Tolerate numpy warnings, or raise them as errors.</span>
            <span class="c1"># Useful for debugging.</span>
            <span class="s1">&#39;tolerate_numpy_warnings&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># URLs of external databases.</span>
            <span class="c1"># SwissLipids: calculated masses of hundreds of thousands</span>
            <span class="c1"># of lipid species.</span>
            <span class="s1">&#39;swisslipids_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.swisslipids.org/php/&#39;</span>\
                <span class="s1">&#39;export.php?action=get&amp;file=lipids.csv&#39;</span><span class="p">,</span>
            <span class="c1"># Experimentally verified masses of few tens of thousands lipids.</span>
            <span class="s1">&#39;lipidmaps_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.lipidmaps.org/resources/downloads/&#39;</span>\
                <span class="s1">&#39;LMSDFDownload28Jun15.tar.gz&#39;</span><span class="p">,</span>
            <span class="c1"># The filename to use after extracting the archice above.</span>
            <span class="s1">&#39;lipidmaps_fname&#39;</span><span class="p">:</span> <span class="s1">&#39;LMSDFDownload28Jun15/&#39;</span>\
                <span class="s1">&#39;LMSDFDownload28Jun15FinalAll.sdf&#39;</span><span class="p">,</span>
            <span class="c1"># ComPPI: protein subcellular localization data.</span>
            <span class="s1">&#39;comppi_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://comppi.linkgroup.hu/downloads&#39;</span><span class="p">,</span>
            <span class="c1"># Gene Ontology.</span>
            <span class="s1">&#39;goa_url&#39;</span><span class="p">:</span> <span class="s1">&#39;ftp://ftp.ebi.ac.uk/pub/databases/GO/goa/</span><span class="si">%s</span><span class="s1">/&#39;</span>\
                <span class="s1">&#39;goa_</span><span class="si">%s</span><span class="s1">.gaf.gz&#39;</span><span class="p">,</span>
            <span class="c1"># Gene Ontology.</span>
            <span class="s1">&#39;quickgo_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.ebi.ac.uk/QuickGO/GAnnotation?format=tsv&amp;&#39;</span>\
                <span class="s1">&#39;limit=-1</span><span class="si">%s</span><span class="s1">&amp;termUse=</span><span class="si">%s</span><span class="s1">&amp;tax=</span><span class="si">%u</span><span class="s1">&amp;col=proteinID,goID,goName,aspect&#39;</span><span class="p">,</span>
            <span class="c1"># Manually curated data by Charlotte about localization</span>
            <span class="c1"># and membrane composition.</span>
            <span class="s1">&#39;localizationf&#39;</span><span class="p">:</span> <span class="s1">&#39;subcellular_localisation_and_binding.xlsx&#39;</span><span class="p">,</span>
            <span class="s1">&#39;membranesf&#39;</span><span class="p">:</span> <span class="s1">&#39;membranes_lipid_composition.xlsx&#39;</span><span class="p">,</span>
            <span class="c1"># Original MS2 fragment lists manually compiled by Marco.</span>
            <span class="c1"># One for positive and one for negative mode.</span>
            <span class="s1">&#39;pfragmentsfile&#39;</span><span class="p">:</span> <span class="s1">&#39;lipid_fragments_positive_mode_v10d</span><span class="si">%s</span><span class="s1">.txt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nfragmentsfile&#39;</span><span class="p">:</span> <span class="s1">&#39;lipid_fragments_negative_mode_v10d.txt&#39;</span><span class="p">,</span>
            <span class="c1"># This is a file to output protein profiles to.</span>
            <span class="c1"># Serves only the purpose of checking for errors.</span>
            <span class="s1">&#39;pptable_file&#39;</span><span class="p">:</span> <span class="s1">&#39;protein_profiles.txt&#39;</span><span class="p">,</span>
            <span class="c1"># Cache files. At certain points this module saves and reloads</span>
            <span class="c1"># data from pickles, so it don&#39;t need to reprocess everything</span>
            <span class="c1"># every time. Although if something changed, or something</span>
            <span class="c1"># goes wrong, you might need to delete these to ensure</span>
            <span class="c1"># everything processed by the most recent code.</span>
            <span class="s1">&#39;featurescache&#39;</span><span class="p">:</span> <span class="s1">&#39;features.pickle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pprofcache&#39;</span><span class="p">:</span> <span class="s1">&#39;pprofiles_raw.pickle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;abscache&#39;</span><span class="p">:</span> <span class="s1">&#39;absorbances.pickle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flimcache&#39;</span><span class="p">:</span> <span class="s1">&#39;fraclims.pickle&#39;</span><span class="p">,</span>
            <span class="c1"># The directory with all MS2 MGF files. If not set, the MGF files</span>
            <span class="c1"># will be searched under the directory of each protein.</span>
            <span class="s1">&#39;ms2dir&#39;</span><span class="p">:</span> <span class="s1">&#39;MGFfiles&#39;</span><span class="p">,</span>
            <span class="c1"># Directory with manually processed `golden standards`</span>
            <span class="c1"># from Marco.</span>
            <span class="s1">&#39;marco_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;marco&#39;</span><span class="p">,</span>
            <span class="s1">&#39;manual_ppratios_xls&#39;</span><span class="p">:</span> <span class="s1">&#39;Proteins_Overview_05.xlsx&#39;</span><span class="p">,</span>
            <span class="c1"># Columns to read from the manual ppratios XLS file.</span>
            <span class="c1"># These were different at Antonella and Enric, so we</span>
            <span class="c1"># need to set them here.</span>
            <span class="c1">#&#39;manual_ppratios_xls_cols&#39;: [2, 4, 8, 9], # 03b</span>
            <span class="s1">&#39;manual_ppratios_xls_cols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="c1"># 05</span>
            <span class="s1">&#39;auxcache&#39;</span><span class="p">:</span> <span class="s1">&#39;save.pickle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stdcachefile&#39;</span><span class="p">:</span> <span class="s1">&#39;calibrations.pickle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;validscache&#39;</span><span class="p">:</span> <span class="s1">&#39;valids.pickle&#39;</span><span class="p">,</span>
            <span class="c1"># Write a log about MS2 processing to this file.</span>
            <span class="s1">&#39;ms2log&#39;</span><span class="p">:</span> <span class="s1">&#39;ms2identities.log&#39;</span><span class="p">,</span>
            <span class="c1"># use the items only of these levels from SwissLipids.</span>
            <span class="c1"># Useful to avoid flooding data with redundant subspecies.</span>
            <span class="s1">&#39;swl_levels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Species&#39;</span><span class="p">],</span>
            <span class="c1"># the source of recalibration: either from Marco, or calculated</span>
            <span class="c1"># by this software by processing raw data from the standards.</span>
            <span class="s1">&#39;recal_source&#39;</span><span class="p">:</span> <span class="s1">&#39;marco&#39;</span><span class="p">,</span>
            <span class="c1"># at Antonella, these proteins come before our fractions, or</span>
            <span class="c1"># maybe in A9, so the further fractions we can consider void</span>
            <span class="c1"># and we can use their average to reduce the background of the</span>
            <span class="c1"># absorbances of the same fractions of other proteins.</span>
            <span class="s1">&#39;background_proteins&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;BNIPL&#39;</span><span class="p">,</span> <span class="s1">&#39;OSBP&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC14L1&#39;</span><span class="p">]),</span>
            <span class="c1"># the minimum total intensities (average areas) of MS1 features</span>
            <span class="c1"># in negative and positive mode. Below these values features are</span>
            <span class="c1"># not highlighted and not included on the `best` sheet in the</span>
            <span class="c1"># output tables unless they have MS2 data.</span>
            <span class="s1">&#39;aa_threshold&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="mf">30000.0</span><span class="p">,</span>
                <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="mf">150000.0</span>
            <span class="p">},</span>
            <span class="s1">&#39;fr_offsets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>          <span class="c1"># at Enric this is [0.0],</span>
                                          <span class="c1"># at Antonella [0.010, 0.045]</span>
            <span class="s1">&#39;abs_cols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># this can be [1, 3, 5] if we want to read</span>
                             <span class="c1"># also the 260 and 215 nm UV profiles...</span>
            <span class="s1">&#39;fraclims_from_sec&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># read the fraction limits from</span>
                                       <span class="c1"># the same files as SEC profiles</span>
                                       <span class="c1"># or simply from `fractions.csv`</span>
            <span class="s1">&#39;pp_do_correction&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># bypass corrections</span>
            <span class="s1">&#39;pcont_fracs_from_abs&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># determine protein containing</span>
                                          <span class="c1"># fractions from the absorbances</span>
                                          <span class="c1"># or read from separate file</span>
            <span class="c1"># allow features to have missing values in first or last</span>
            <span class="c1"># protein containing fractions</span>
            <span class="s1">&#39;permit_profile_end_nan&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;peak_ratio_score_bandwidth&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
            <span class="s1">&#39;use_manual_ppratios&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># omg, I don&#39;t remember what it is</span>
            <span class="s1">&#39;use_last_ratio&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># for calculation of peak ratio score, take all intensity ratios</span>
            <span class="c1"># within this range of tolerance around the protein ratio.</span>
            <span class="c1"># E.g if the protein ratio is 0.6, then the lower threshold</span>
            <span class="c1"># will be 0.6 * 0.5 = 0.3, and the upper 1 / 0.5 * 0.6 = 1.2;</span>
            <span class="c1"># Then the standard deviation of all intensity ratios within</span>
            <span class="c1"># this range is calculated from both positive and negative</span>
            <span class="c1"># features, and for each feature and for each pairs of fractions</span>
            <span class="c1"># the difference between its intensity ratio divided by the SD</span>
            <span class="c1"># results the `peak ratio score`. This is calculated for all</span>
            <span class="c1"># pairs of protein containing fractions, and we take their</span>
            <span class="c1"># mean if more than 2 fractions are available.</span>
            <span class="s1">&#39;peak_ratio_range&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="c1"># The threshold below the peak ratio scores considered good.</span>
            <span class="c1"># We set a cut-off e.g. for highlighting with green in the</span>
            <span class="c1"># output tables, but otherwise it is a continuous measure</span>
            <span class="c1"># of goodness.</span>
            <span class="s1">&#39;peak_ratio_score_threshold&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="c1"># constant fraction layout in Antonella&#39;s screening</span>
            <span class="c1"># not used at Enric, is kind of &quot;deprecated&quot;</span>
            <span class="s1">&#39;fracs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a9&#39;</span><span class="p">,</span> <span class="s1">&#39;a10&#39;</span><span class="p">,</span> <span class="s1">&#39;a11&#39;</span><span class="p">,</span> <span class="s1">&#39;a12&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">],</span>
            <span class="c1"># constant fraction layout in Antonella&#39;s screening</span>
            <span class="c1"># not used at Enric, is kind of &quot;deprecated&quot;</span>
            <span class="c1"># uppercase version with leading zeros</span>
            <span class="s1">&#39;fracsU&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A09&#39;</span><span class="p">,</span> <span class="s1">&#39;A10&#39;</span><span class="p">,</span> <span class="s1">&#39;A11&#39;</span><span class="p">,</span> <span class="s1">&#39;A12&#39;</span><span class="p">,</span> <span class="s1">&#39;B01&#39;</span><span class="p">],</span>
            <span class="s1">&#39;pp_minratio&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="c1"># at Antonella&#39;s screening a fraction which is considered</span>
            <span class="c1"># void, so adjusting the zero of the absorbance profiles</span>
            <span class="c1"># to this fraction</span>
            <span class="c1"># see method ``pp_baseline_correction()``</span>
            <span class="s1">&#39;basefrac&#39;</span><span class="p">:</span> <span class="s1">&#39;a5&#39;</span><span class="p">,</span>
            <span class="c1"># the tolerance when looking up MS1 m/z values in databases</span>
            <span class="c1"># (Daltons)</span>
            <span class="s1">&#39;ms1_tolerance&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="c1"># the tolerance when looking up MS2 fragment masses (Daltons)</span>
            <span class="s1">&#39;ms2_tolerance&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="c1"># the tolerance at identifying features in standards (Daltons)</span>
            <span class="s1">&#39;std_tolerance&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="c1"># MS2 precursors must have their charges determined</span>
            <span class="s1">&#39;ms2_precursor_charge&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="c1"># use only fragments from Marco&#39;s lists (note: the series)</span>
            <span class="c1"># are still programmatically generated and their m/z values</span>
            <span class="c1"># calculated automatically), or use an extended fragment list</span>
            <span class="c1"># constructed by Denes (note: this might contain more false</span>
            <span class="c1"># positives, i.e. fragments which do not occure, or are iso-</span>
            <span class="c1"># baric with others, resulting unnecessary noise; but some-</span>
            <span class="c1"># times these annotations still might help to have a clue</span>
            <span class="c1"># what is there in cases where otherwise you would see only</span>
            <span class="c1"># unknown fragments)</span>
            <span class="s1">&#39;only_marcos_fragments&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># Expect only certain adducts at certain lipid categories</span>
            <span class="c1"># or assume any lipid may form any type of adduct.</span>
            <span class="s1">&#39;adducts_constraints&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># In output tables construct the lipid names programmatically</span>
            <span class="c1"># or copy the ones from the database.</span>
            <span class="s1">&#39;marco_lipnames_from_db&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># use the average area values from the `PEAK` software</span>
            <span class="c1"># output, or recalculate them here using the intensity</span>
            <span class="c1"># values of features across all fractions</span>
            <span class="s1">&#39;use_original_average_area&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># overwrite UV absorbance based protein quantities with</span>
            <span class="c1"># those manually acquired from SDS PAGE when these are</span>
            <span class="c1"># available</span>
            <span class="s1">&#39;use_gel_profiles&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># use Enric&#39;s method for the final selection of profiles</span>
            <span class="s1">&#39;enric_profile_selection&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># in the profile filtering method suggested by Enric, if</span>
            <span class="c1"># there are 2 highest fractions with approximately equal</span>
            <span class="c1"># protein content, we use this range of tolerance to filter</span>
            <span class="c1"># the intensity ratios between them. E.g if this number is</span>
            <span class="c1"># 0.75, ratios between 0.75 and 1.33 will be accepted.</span>
            <span class="s1">&#39;enric_equal_fractions_ratio&#39;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
            <span class="c1"># the MS2 retention time values must be within the RT</span>
            <span class="c1"># range of the feature detected in MS1, otherwise</span>
            <span class="c1"># will be dropped</span>
            <span class="s1">&#39;ms2_rt_within_range&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># consider the MS2 scans from only those fractions</span>
            <span class="c1"># containing the protein, or from all available fractions</span>
            <span class="s1">&#39;ms2_only_protein_fractions&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;uniprots&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="c1"># method names to convert between adduct and exact masses</span>
            <span class="s1">&#39;ad2ex&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;[M+H]+&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_h&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;[M+NH4]+&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_nh4&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;[M+Na]+&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_na&#39;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;[M-H]-&#39;</span><span class="p">:</span> <span class="s1">&#39;add_h&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_fo&#39;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;[M-2H]2-&#39;</span><span class="p">:</span> <span class="s1">&#39;add_2h&#39;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;[M-3H]3-&#39;</span><span class="p">:</span> <span class="s1">&#39;add_3h&#39;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="c1"># method names to convert between exact and adduct masses</span>
            <span class="s1">&#39;ex2ad&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;[M+H]+&#39;</span><span class="p">:</span> <span class="s1">&#39;add_h&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;[M+NH4]+&#39;</span><span class="p">:</span> <span class="s1">&#39;add_nh4&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;[M+Na]+&#39;</span><span class="p">:</span> <span class="s1">&#39;add_na&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;[M-H]-&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_h&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">:</span> <span class="s1">&#39;add_fo&#39;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;[M-2H]2-&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_2h&#39;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;[M-3H]3-&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_3h&#39;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="c1"># metrics to use for determining similarity of protein</span>
            <span class="c1"># and intensity profiles; these were attempts, and not</span>
            <span class="c1"># used any more, are &quot;deprecated&quot;</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;Kendall</span><span class="se">\&#39;</span><span class="s1">s tau&#39;</span><span class="p">,</span> <span class="s1">&#39;ktv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Spearman corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;spv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Pearson corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;pev&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Euclidean dist.&#39;</span><span class="p">,</span> <span class="s1">&#39;euv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Robust corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;rcv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Goodman-Kruskal</span><span class="se">\&#39;</span><span class="s1">s gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;gkv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;dfv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">in_basedir</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fractionsf&#39;</span><span class="p">,</span> <span class="s1">&#39;ppfracf&#39;</span><span class="p">,</span> <span class="s1">&#39;seqfile&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pptablef&#39;</span><span class="p">,</span> <span class="s1">&#39;lipnamesf&#39;</span><span class="p">,</span> <span class="s1">&#39;bindpropf&#39;</span><span class="p">,</span> <span class="s1">&#39;metabsf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pfragmentsfile&#39;</span><span class="p">,</span> <span class="s1">&#39;nfragmentsfile&#39;</span><span class="p">,</span> <span class="s1">&#39;featurescache&#39;</span><span class="p">,</span>
            <span class="s1">&#39;auxcache&#39;</span><span class="p">,</span> <span class="s1">&#39;stdcachefile&#39;</span><span class="p">,</span> <span class="s1">&#39;validscache&#39;</span><span class="p">,</span> <span class="s1">&#39;marco_dir&#39;</span><span class="p">,</span>
            <span class="s1">&#39;abscache&#39;</span><span class="p">,</span> <span class="s1">&#39;pptable_file&#39;</span><span class="p">,</span> <span class="s1">&#39;recalfile&#39;</span><span class="p">,</span> <span class="s1">&#39;manual_ppratios_xls&#39;</span><span class="p">,</span>
            <span class="s1">&#39;manualdir&#39;</span><span class="p">,</span> <span class="s1">&#39;ltplistf&#39;</span><span class="p">,</span> <span class="s1">&#39;flimcache&#39;</span><span class="p">,</span> <span class="s1">&#39;ppsecdir&#39;</span><span class="p">,</span> <span class="s1">&#39;gelprofdir&#39;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pfragmentsfile</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">pfragmentsfile</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;m&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_marcos_fragments</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">))</span> \
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span>
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_basedir</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">charTypes</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data_basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_basedir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_basedir</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">datadirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data_basedir</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">))</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">p</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datadirs</span>
        <span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stddir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadirs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">stddir</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">paths_exist</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span><span class="p">)</span> <span class="ow">in</span> <span class="n">charTypes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_tlr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_tlr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_tolerance</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">nAdducts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pAdducts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_zeroed</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">aaa_threshold</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="mf">30000.0</span><span class="p">,</span>
            <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="mf">150000.0</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">recount1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\(([Odt]?)-?([0-9]{1,2}):([0-9]{1,2})\)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recount2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\(([Odt]?)-?([0-9]{1,2}):([0-9]{1,2})/&#39;</span>
                                   <span class="sa">r</span><span class="s1">&#39;([Odt]?)-?([0-9]{1,2}):([0-9]{1,2})/?&#39;</span>
                                   <span class="sa">r</span><span class="s1">&#39;([Odt]?)-?([0-9]{0,2}):?([0-9]{0,2})\)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readd</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[M[-\+][-\)\)\+A-Za-z0-9]*\][0-9]?[\-+])&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;fonts.css&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;fonts.css&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">fonts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">html_table_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;!DOCTYPE html&gt;</span>
<span class="s2">            &lt;html lang=&quot;en&quot;&gt;</span>
<span class="s2">            &lt;head&gt;</span>
<span class="s2">                &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="s2">                &lt;title&gt;</span><span class="si">%s</span><span class="s2">&lt;/title&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span> \
            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                &lt;style type=&quot;text/css&quot;&gt;</span>
<span class="s2">                    </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                    html {</span>
<span class="s2">                        font-family: di;</span>
<span class="s2">                        color: #333333;</span>
<span class="s2">                        padding-top: 40px;</span>
<span class="s2">                    }</span>
<span class="s2">                    table {</span>
<span class="s2">                        border-width: 0px;</span>
<span class="s2">                    }</span>
<span class="s2">                    table, tr, th, td {</span>
<span class="s2">                        border: 1px solid #777777;</span>
<span class="s2">                        border-collapse: collapse;</span>
<span class="s2">                    }</span>
<span class="s2">                    th, .rowname {</span>
<span class="s2">                        font-weight: bold;</span>
<span class="s2">                    }</span>
<span class="s2">                    .positive {</span>
<span class="s2">                        background-color: #E25C49;</span>
<span class="s2">                        color: #FFFFFF;</span>
<span class="s2">                    }</span>
<span class="s2">                    .negative, .ms2tbl tr th {</span>
<span class="s2">                        background-color: #49969A;</span>
<span class="s2">                        color: #FFFFFF;</span>
<span class="s2">                    }</span>
<span class="s2">                    .both {</span>
<span class="s2">                        background: linear-gradient(120deg, #E25C49, #49969A);</span>
<span class="s2">                        background: -moz-linear-gradient(120deg, #E25C49, #49969A);</span>
<span class="s2">                        /*background: -webkit-linear-gradient(120deg, #E25C49, #49969A);</span>
<span class="s2">                        background: -o-linear-gradient(120deg, #E25C49, #49969A);*/</span>
<span class="s2">                        color: #FFFFFF;</span>
<span class="s2">                    }</span>
<span class="s2">                    .matching {</span>
<span class="s2">                        background-color: #03928C;</span>
<span class="s2">                        color: #FFFFFF;</span>
<span class="s2">                    }</span>
<span class="s2">                    .nothing {</span>
<span class="s2">                        background-color: #FFFFFF;</span>
<span class="s2">                        color: #000000;</span>
<span class="s2">                        font-weight: normal;</span>
<span class="s2">                    }</span>
<span class="s2">                    .clickable {</span>
<span class="s2">                        cursor: pointer;</span>
<span class="s2">                    }</span>
<span class="s2">                    td, th {</span>
<span class="s2">                        border: 1px solid #CCCCCC;</span>
<span class="s2">                    }</span>
<span class="s2">                    #ms2main {</span>
<span class="s2">                        position: fixed;</span>
<span class="s2">                        display: none;</span>
<span class="s2">                        top: 0px;</span>
<span class="s2">                    }</span>
<span class="s2">                    h1, h2, h3, strong, th {</span>
<span class="s2">                        font-weight: normal;</span>
<span class="s2">                    }</span>
<span class="s2">                    #ms2spectra {</span>
<span class="s2">                        display: none;</span>
<span class="s2">                        width: auto;</span>
<span class="s2">                        max-height: 60vh;</span>
<span class="s2">                        overflow-y: scroll;</span>
<span class="s2">                        overflow-x: hidden;</span>
<span class="s2">                        font-size: small;</span>
<span class="s2">                        background-color: #FFFFFF;</span>
<span class="s2">                        color: #333333;</span>
<span class="s2">                        padding: 5px 20px 5px 5px;</span>
<span class="s2">                        cursor: default;</span>
<span class="s2">                        position: relative;</span>
<span class="s2">                    }</span>
<span class="s2">                    .close {</span>
<span class="s2">                        cursor: pointer;</span>
<span class="s2">                        display: inline-block;</span>
<span class="s2">                        position: relative;</span>
<span class="s2">                        float: right;</span>
<span class="s2">                    }</span>
<span class="s2">                    .ms2cell {</span>
<span class="s2">                        cursor: pointer;</span>
<span class="s2">                    }</span>
<span class="s2">                    #shade {</span>
<span class="s2">                        position: fixed;</span>
<span class="s2">                        top: 0;</span>
<span class="s2">                        left: 0;</span>
<span class="s2">                        background: rgba(1,1,1,0.6);</span>
<span class="s2">                        z-index: 5;</span>
<span class="s2">                        width: 100</span><span class="si">%%%%</span><span class="s2">;</span>
<span class="s2">                        height: 100</span><span class="si">%%%%</span><span class="s2">;</span>
<span class="s2">                        display: none;</span>
<span class="s2">                    }</span>
<span class="s2">                    .after5 {</span>
<span class="s2">                        display: none;</span>
<span class="s2">                    }</span>
<span class="s2">                    .ms2hdr {</span>
<span class="s2">                        font-size: larger;</span>
<span class="s2">                        color: #FFFFFF;</span>
<span class="s2">                        background-color: #333333;</span>
<span class="s2">                        padding: 3px;</span>
<span class="s2">                    }</span>
<span class="s2">                    #ms2button {</span>
<span class="s2">                        position: fixed;</span>
<span class="s2">                        top: 0px;</span>
<span class="s2">                        left: 0px;</span>
<span class="s2">                        display: inline-block;</span>
<span class="s2">                        padding: 7px;</span>
<span class="s2">                        font-size: larger;</span>
<span class="s2">                        background-color: #6EA945;</span>
<span class="s2">                        color: #FFFFFF;</span>
<span class="s2">                        cursor: pointer;</span>
<span class="s2">                        max-height: 70vh;</span>
<span class="s2">                    }</span>
<span class="s2">                    .scansbutton {</span>
<span class="s2">                        display: inline-block;</span>
<span class="s2">                        color: #333333;</span>
<span class="s2">                        background-color: #FFFFFF;</span>
<span class="s2">                        padding: 3px;</span>
<span class="s2">                        margin: 3px;</span>
<span class="s2">                        cursor: pointer;</span>
<span class="s2">                    }</span>
<span class="s2">                    #heighthelper {</span>
<span class="s2">                        height: 100vh;</span>
<span class="s2">                        overflow: auto;</span>
<span class="s2">                        max-height: 60vh;</span>
<span class="s2">                    }</span>
<span class="s2">                    .scantbl {</span>
<span class="s2">                        width: 100</span><span class="si">%%%%</span><span class="s2">;</span>
<span class="s2">                        margin-bottom: 5px;</span>
<span class="s2">                    }</span>
<span class="s2">                    .scantbl table tr td,th:nth-child(2){</span>
<span class="s2">                        width: 100px;</span>
<span class="s2">                    }</span>
<span class="s2">                    .scantbl table tr td,th:nth-child(1){</span>
<span class="s2">                        width: 100px;</span>
<span class="s2">                    }</span>
<span class="s2">                    .scantbl table tr td,th:nth-child(4){</span>
<span class="s2">                        width: 100px;</span>
<span class="s2">                    }</span>
<span class="s2">                    .ms2hdr {</span>
<span class="s2">                        width: 650px;</span>
<span class="s2">                    }</span>
<span class="s2">                    .primary {</span>
<span class="s2">                        display: none;</span>
<span class="s2">                    }</span>
<span class="s2">                    .secondary {</span>
<span class="s2">                        display: none;</span>
<span class="s2">                    }</span>
<span class="s2">                    .noprotein {</span>
<span class="s2">                        display: none;</span>
<span class="s2">                    }</span>
<span class="s2">                    .ms2tblcontainer {</span>
<span class="s2">                        margin-bottom: 5px;</span>
<span class="s2">                    }</span>
<span class="s2">                &lt;/style&gt;</span>
<span class="s2">                &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s2">                    function showTooltip(e) {</span>
<span class="s2">                        e = e || window.event;</span>
<span class="s2">                        var targ = e.target || e.srcElement;</span>
<span class="s2">                        if (targ.nodeType == 3) targ = targ.parentNode;</span>
<span class="s2">                        text = targ.getAttribute(&#39;title&#39;)</span>
<span class="s2">                        if (text !== undefined) alert(text);</span>
<span class="s2">                    }</span>
<span class="s2">                &lt;/script&gt;</span>
<span class="s2">                &lt;script type=&quot;text/javascript&quot; src=&quot;https://code.jquery.com/jquery-2.2.4.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="s2">                &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s2">                    function SortScans(){</span>
<span class="s2">                        $(&quot;div[id^=ms2c_]&quot;).sort(function(a, b){</span>
<span class="s2">                            return ~~a.id.split(&quot;_&quot;)[1] &lt; ~~b.id.split(&quot;_&quot;)[1]</span>
<span class="s2">                        }).appendTo(&quot;#ms2spectra&quot;);</span>
<span class="s2">                    }</span>
<span class="s2">                    $(document).on(&quot;click.ms2cell&quot;, &quot;.ms2cell&quot;, $(this).attr(&quot;ms2spectra&quot;), function(e){</span>
<span class="s2">                        $(&quot;#ms2spectra&quot;).append(</span>
<span class="s2">                            decodeURIComponent(</span>
<span class="s2">                                escape(</span>
<span class="s2">                                    window.atob(</span>
<span class="s2">                                        $(e.target).attr(&quot;ms2spectra&quot;)</span>
<span class="s2">                                    )</span>
<span class="s2">                                )</span>
<span class="s2">                            )</span>
<span class="s2">                        );</span>
<span class="s2">                        $(&quot;#ms2spectra&quot;).fadeIn();</span>
<span class="s2">                        SortScans();</span>
<span class="s2">                    });</span>
<span class="s2">                    $(document).on(&quot;click.ms2button&quot;, &quot;#ms2button&quot;, function(e){</span>
<span class="s2">                        if(e.target.id == &quot;ms2button&quot;){</span>
<span class="s2">                            $(&quot;#ms2spectra&quot;).toggle();</span>
<span class="s2">                        }</span>
<span class="s2">                    });</span>
<span class="s2">                    $(document).on(&quot;click.morefrags&quot;, &quot;.morefrags&quot;, function(e){</span>
<span class="s2">                        e.stopPropagation();</span>
<span class="s2">                        $(&quot;.after5&quot;).toggle();</span>
<span class="s2">                    });</span>
<span class="s2">                    $(document).on(&quot;click.remove&quot;, &quot;.remove&quot;, function(e){</span>
<span class="s2">                        e.stopPropagation();</span>
<span class="s2">                        $(this).closest(&quot;.ms2tblcontainer&quot;).remove();</span>
<span class="s2">                        if(! $(&quot;.ms2tblcontainer&quot;).length ){</span>
<span class="s2">                            $(&quot;#ms2spectra&quot;).fadeOut();</span>
<span class="s2">                        }</span>
<span class="s2">                    });</span>
<span class="s2">                    $(document).on(&quot;click.scansp&quot;, &quot;.morescans1&quot;, function(e){</span>
<span class="s2">                        e.stopPropagation();</span>
<span class="s2">                        $(this).closest(&quot;.ms2tblcontainer&quot;).children(&quot;.primary&quot;).toggle();</span>
<span class="s2">                    });</span>
<span class="s2">                    $(document).on(&quot;click.scansp&quot;, &quot;.morescans2&quot;, function(e){</span>
<span class="s2">                        e.stopPropagation();</span>
<span class="s2">                        $(this).closest(&quot;.ms2tblcontainer&quot;).children(&quot;.secondary&quot;).toggle();</span>
<span class="s2">                    });</span>
<span class="s2">                    $(document).on(&quot;click.scansp&quot;, &quot;.morescans3&quot;, function(e){</span>
<span class="s2">                        e.stopPropagation();</span>
<span class="s2">                        $(this).closest(&quot;.ms2tblcontainer&quot;).children(&quot;.noprotein&quot;).toggle();</span>
<span class="s2">                    });</span>
<span class="s2">                &lt;/script&gt;</span>
<span class="s2">            &lt;/head&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fonts</span><span class="p">)</span> \
        <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                &lt;div id=&quot;ms2button&quot;&gt;MS2 spectra&lt;br /&gt;</span>
<span class="s2">                    &lt;div id=&quot;ms2spectra&quot;&gt;&lt;/div&gt;</span>
<span class="s2">                &lt;/div&gt;</span>
<span class="s2">                &lt;h1&gt;</span><span class="si">%s</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">                &lt;table id=&quot;features&quot; border=&quot;0&quot;&gt;</span>
<span class="s2">                    </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                &lt;/table&gt;</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;#B81466&#39;</span><span class="p">,</span> <span class="c1"># blue maguerite</span>
            <span class="s1">&#39;#C441B3&#39;</span><span class="p">,</span> <span class="c1"># slate blue</span>
            <span class="s1">&#39;#D6708B&#39;</span><span class="p">,</span> <span class="c1"># pale violet red</span>
            <span class="s1">&#39;#69B3D6&#39;</span><span class="p">,</span> <span class="c1"># viking</span>
            <span class="s1">&#39;#49969A&#39;</span><span class="p">,</span> <span class="c1"># chetwode blue</span>
            <span class="s1">&#39;#608784&#39;</span><span class="p">,</span> <span class="c1"># gothic</span>
            <span class="s1">&#39;#03928C&#39;</span><span class="p">,</span> <span class="c1"># java</span>
            <span class="s1">&#39;#CF5836&#39;</span><span class="p">,</span> <span class="c1"># mandy</span>
            <span class="s1">&#39;#B3443D&#39;</span><span class="p">,</span> <span class="c1"># blush</span>
            <span class="s1">&#39;#65B9B9&#39;</span><span class="p">,</span> <span class="c1"># seagull</span>
            <span class="s1">&#39;#009BB9&#39;</span><span class="p">,</span> <span class="c1"># pelorous</span>
            <span class="s1">&#39;#D88776&#39;</span><span class="p">,</span> <span class="c1"># my pink</span>
            <span class="s1">&#39;#755987&#39;</span><span class="p">,</span> <span class="c1"># kimberly</span>
            <span class="s1">&#39;#6F3940&#39;</span><span class="p">,</span> <span class="c1"># sanguine brown</span>
            <span class="s1">&#39;#A09255&#39;</span><span class="p">,</span> <span class="c1"># teak</span>
            <span class="s1">&#39;#7C997B&#39;</span><span class="p">,</span> <span class="c1"># avocado</span>
            <span class="s1">&#39;#582E5E&#39;</span><span class="p">,</span> <span class="c1"># minsk</span>
            <span class="s1">&#39;#224A7A&#39;</span><span class="p">,</span> <span class="c1"># fun blue</span>
            <span class="s1">&#39;#FE2E08&#39;</span><span class="p">,</span> <span class="c1"># orange red</span>
            <span class="s1">&#39;#2D16E2&#39;</span><span class="p">,</span> <span class="c1"># medium blue</span>
            <span class="s1">&#39;#CBE216&#39;</span><span class="p">,</span> <span class="c1"># fuego</span>
            <span class="s1">&#39;#14B866&#39;</span><span class="p">,</span> <span class="c1"># medium sea green</span>
            <span class="s1">&#39;#987B99&#39;</span>  <span class="c1"># london hue</span>
        <span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerate_numpy_warnings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numpy_warnings_as_errors</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">paths_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_basedir</span>
        <span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadirs</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Missing input file/path: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">modname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">numpy_warnings_as_errors</span><span class="p">():</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span> <span class="o">=</span> <span class="s1">&#39;raise&#39;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">showwarning</span> <span class="o">=</span> <span class="n">warn_with_traceback</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">numpy_warnings_as_warnings</span><span class="p">():</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span> <span class="o">=</span> <span class="s1">&#39;warn&#39;</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># read standards data</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="Screening.which_day"><a class="viewcode-back" href="../../index.html#emese.main.Screening.which_day">[docs]</a>    <span class="k">def</span> <span class="nf">which_day</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Which day the fractions for a given LTP have been run?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;seq&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_seq</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">date_fr</span><span class="p">:</span>
            <span class="n">date_fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">date_fr</span><span class="p">:</span>
                <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">date_fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Screening.standards_theoretic_masses"><a class="viewcode-back" href="../../index.html#emese.main.Screening.standards_theoretic_masses">[docs]</a>    <span class="k">def</span> <span class="nf">standards_theoretic_masses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the exact masses and most abundant ion masses of</span>
<span class="sd">        the lipid standards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabsf</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">)]:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">pn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">pn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;exact&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="s1">&#39;ion&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">3</span><span class="p">])):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">5</span><span class="p">])):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                        <span class="p">}</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="n">pn</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">pn</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">lstd</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">dd</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;diff_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> \
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdmasses</span> <span class="o">=</span> <span class="n">result</span></div>

    <span class="c1">#</span>
    <span class="c1"># obtaining lipid data from SwissLipids</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">dct</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">dct</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">dct</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_lipidmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lipidmaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lm_id&#39;</span><span class="p">,</span> <span class="s1">&#39;systematic_name&#39;</span><span class="p">,</span> <span class="s1">&#39;synonyms&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span>
            <span class="s1">&#39;main_class&#39;</span><span class="p">,</span> <span class="s1">&#39;exact_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="s1">&#39;inchi_key&#39;</span><span class="p">,</span> <span class="s1">&#39;pubchem_sid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pubchem_cid&#39;</span><span class="p">,</span> <span class="s1">&#39;common_name&#39;</span><span class="p">]</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">expect</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_curl</span><span class="o">.</span><span class="n">Curl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipidmaps_url</span><span class="p">,</span> <span class="n">large</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">files_needed</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lipidmaps_fname</span><span class="p">])</span>
        <span class="n">lmapsf</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">result</span>
        
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">lmapsf</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span>
            
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expect</span><span class="p">:</span>
                <span class="n">record</span><span class="p">[</span><span class="n">expect</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> \
                    <span class="k">if</span> <span class="n">expect</span> <span class="o">!=</span> <span class="s1">&#39;exact_mass&#39;</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">expect</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                    <span class="n">expect</span> <span class="o">=</span> <span class="n">label</span>
            <span class="k">elif</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$&#39;</span><span class="p">:</span>
                <span class="n">lipidmaps</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">record</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">record</span> <span class="k">else</span> <span class="kc">None</span> \
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">lipidmaps</span>

    <span class="k">def</span> <span class="nf">lipidmaps_adducts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_nAdducts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_pAdducts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lipidmaps&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_lipidmaps</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipidmaps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_pAdducts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])]),</span> <span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                    <span class="s1">&#39;[M+H]+&#39;</span><span class="p">,</span> <span class="n">Mz</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">add_h</span><span class="p">()])</span>
                <span class="n">_pAdducts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])]),</span> <span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                    <span class="s1">&#39;[M+NH4]+&#39;</span><span class="p">,</span> <span class="n">Mz</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">add_nh4</span><span class="p">()])</span>
                <span class="n">_nAdducts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])]),</span> <span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                    <span class="s1">&#39;[M-H]-&#39;</span><span class="p">,</span> <span class="n">Mz</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">remove_h</span><span class="p">()])</span>
                <span class="n">_nAdducts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])]),</span> <span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                    <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">,</span> <span class="n">Mz</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">add_fo</span><span class="p">()])</span>
        <span class="n">_pAdducts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_pAdducts</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
        <span class="n">_nAdducts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_nAdducts</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pAdducts</span> <span class="o">=</span> <span class="n">_pAdducts</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pAdducts</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pAdducts</span><span class="p">,</span> <span class="n">_pAdducts</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pAdducts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pAdducts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pAdducts</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nAdducts</span> <span class="o">=</span> <span class="n">_nAdducts</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nAdducts</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">nAdducts</span><span class="p">,</span> <span class="n">_nAdducts</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nAdducts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nAdducts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nAdducts</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">lipidmaps_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">_exacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lipidmaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lipidmaps</span><span class="p">()</span>
        
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lipidmaps</span><span class="p">),</span> <span class="s1">&#39;Processing LipidMaps&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lipidmaps</span><span class="p">:</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_exacts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> \
                    <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])]),</span> <span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
        
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        
        <span class="n">_exacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">_exacts</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="o">=</span> <span class="n">_exacts</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">,</span> <span class="n">_exacts</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
    
    <span class="k">def</span> <span class="nf">export_lipidmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;lipidmaps.tab&#39;</span><span class="p">,</span> <span class="n">one_name</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">one_name</span><span class="p">:</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;Name1&#39;</span><span class="p">,</span> <span class="s1">&#39;Name2&#39;</span><span class="p">,</span> <span class="s1">&#39;Name3&#39;</span><span class="p">])</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;Constitution&#39;</span><span class="p">,</span> <span class="s1">&#39;MonoisotopicMass&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hdr</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">one_name</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
                                <span class="k">break</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span> <span class="n">names</span><span class="p">))</span>
                    <span class="n">seq</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%.06f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="n">formula</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%.06f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                            <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">export_swisslipids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;swisslipids.tab&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Constitution&#39;</span><span class="p">,</span> <span class="s1">&#39;MonoisotopicMass&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Species&#39;</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%.06f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
    
<div class="viewcode-block" id="Screening.get_swisslipids"><a class="viewcode-back" href="../../index.html#emese.main.Screening.get_swisslipids">[docs]</a>    <span class="k">def</span> <span class="nf">get_swisslipids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adducts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exact_mass</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Downloads the total SwissLipids lipids dataset.</span>
<span class="sd">        Returns numpy array with all queried adducts and optionally exact</span>
<span class="sd">        masses, calculates the formate adduct m/z&#39;s on demand.</span>
<span class="sd">        Please note, for a number of lipids some adduct m/z&#39;s are missing</span>
<span class="sd">        from SL, while the exact masses are given for all the lipids. Also</span>
<span class="sd">        storing masses of many adducts of the same lipid in an array results</span>
<span class="sd">        extensive memory usage (couple of hundreds MB).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">adduct_method</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;[M+OAc]-&#39;</span><span class="p">:</span> <span class="s1">&#39;add_ac&#39;</span><span class="p">,</span>
            <span class="s1">&#39;[M+H]+&#39;</span><span class="p">:</span> <span class="s1">&#39;add_h&#39;</span><span class="p">,</span>
            <span class="s1">&#39;[M-H]-&#39;</span><span class="p">:</span> <span class="s1">&#39;remove_h&#39;</span><span class="p">,</span>
            <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">:</span> <span class="s1">&#39;add_fo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;[M+NH4]+&#39;</span><span class="p">:</span> <span class="s1">&#39;add_nh4&#39;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">adducts</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">adducts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">adducts</span><span class="p">)</span>
        <span class="n">readd</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*(\[.*)&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_curl</span><span class="o">.</span><span class="n">Curl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swisslipids_url</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">compr</span> <span class="o">=</span> <span class="s1">&#39;gz&#39;</span><span class="p">,</span> <span class="n">large</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">swl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">result</span>
        <span class="n">swl</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ucsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">swl</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">swl</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">swl</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">positives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">negatives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exact_masses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="n">ucsize</span><span class="p">,</span> <span class="s1">&#39;Processing SwissLipids&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">swl</span><span class="p">:</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">23</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">add</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">13</span> <span class="k">else</span> <span class="n">readd</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">adducts</span> <span class="ow">or</span> <span class="n">add</span> <span class="ow">in</span> <span class="n">adducts</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">13</span> <span class="ow">and</span> \
                            <span class="n">exact_mass</span> <span class="ow">or</span> <span class="n">formiate</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                            <span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">formiate</span><span class="p">:</span>
                                    <span class="n">mzfo</span> <span class="o">=</span> <span class="n">Mz</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span><span class="o">.</span><span class="n">add_fo</span><span class="p">()</span>
                                    <span class="n">foline</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                        <span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">,</span> <span class="n">mzfo</span><span class="p">]</span>
                                    <span class="n">negatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">foline</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">exact_mass</span><span class="p">:</span>
                                    <span class="n">exact_masses</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                        <span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">add</span><span class="p">,</span> <span class="n">mz</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
                                <span class="n">positives</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                    <span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">add</span><span class="p">,</span> <span class="n">mz</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="n">hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
                                <span class="n">negatives</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                    <span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">add</span><span class="p">,</span> <span class="n">mz</span><span class="p">])</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">swl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">positives</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">positives</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">positives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positives</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
        <span class="n">negatives</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">negatives</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">negatives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">negatives</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">positives</span><span class="p">,</span> <span class="n">negatives</span></div>

<div class="viewcode-block" id="Screening.get_swisslipids_exact"><a class="viewcode-back" href="../../index.html#emese.main.Screening.get_swisslipids_exact">[docs]</a>    <span class="k">def</span> <span class="nf">get_swisslipids_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Downloads the total SwissLipids lipids dataset.</span>
<span class="sd">        Returns numpy array with only exact mass values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">readd</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*(\[.*)&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_curl</span><span class="o">.</span><span class="n">Curl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swisslipids_url</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">compr</span> <span class="o">=</span> <span class="s1">&#39;gz&#39;</span><span class="p">,</span> <span class="n">large</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">swl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">result</span>
        <span class="n">swl</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ucsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">swl</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">swl</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">swl</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">_exacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="n">ucsize</span><span class="p">,</span> <span class="s1">&#39;Processing SwissLipids&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">swl</span><span class="p">:</span>
            
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">:</span>
                <span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span>
                <span class="n">add</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">_exacts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">add</span><span class="p">,</span> <span class="n">mz</span> <span class="ow">or</span> <span class="mf">0.0</span><span class="p">])</span>
        
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">swl</span><span class="o">.</span><span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">swl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">del</span> <span class="n">swl</span>
        <span class="n">_exacts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">_exacts</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">_exacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_exacts</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="o">=</span> <span class="n">_exacts</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">,</span> <span class="n">_exacts</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span></div>
        
    
<div class="viewcode-block" id="Screening.add_nonidet"><a class="viewcode-back" href="../../index.html#emese.main.Screening.add_nonidet">[docs]</a>    <span class="k">def</span> <span class="nf">add_nonidet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds mass values of Nonidet P-40 to the mass database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonidet_mzs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">528.37402</span><span class="p">,</span> <span class="mf">484.34353</span><span class="p">,</span> <span class="mf">572.39251</span><span class="p">,</span>
                            <span class="mf">616.36121</span><span class="p">,</span> <span class="mf">660.44410</span><span class="p">]</span>
        <span class="n">nonidet</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonidet_mzs</span><span class="p">:</span>
            <span class="n">nonidet</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;SLM:999999999&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="s1">&#39;Nonidet P-40&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mz</span><span class="p">])</span>
        <span class="n">nonidet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nonidet</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="o">=</span> <span class="n">nonidet</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">,</span> <span class="n">nonidet</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span></div>

    <span class="k">def</span> <span class="nf">database_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exacts</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Species&#39;</span><span class="p">]):</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">levels</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">]</span> <span class="k">else</span> <span class="n">levels</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">levels</span><span class="p">])</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">levels</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">unicode</span><span class="p">]</span> <span class="k">else</span> <span class="n">names</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exacts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="n">exacts</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span>
    
    <span class="k">def</span> <span class="nf">process_db_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwdstr</span><span class="p">):</span>
        <span class="k">return</span> \
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">kwdset</span><span class="p">:</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;neg&#39;</span><span class="p">:</span>
                                <span class="nb">list</span><span class="p">(</span>
                                    <span class="nb">map</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">kwd</span><span class="p">:</span>
                                            <span class="n">kwd</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                                        <span class="nb">list</span><span class="p">(</span>
                                            <span class="nb">filter</span><span class="p">(</span>
                                                <span class="k">lambda</span> <span class="n">kwd</span><span class="p">:</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">kwd</span><span class="p">)</span> <span class="ow">and</span> \
                                                    <span class="n">kwd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span>
                                                <span class="n">kwdset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">),</span>
                            <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
                                <span class="nb">list</span><span class="p">(</span>
                                    <span class="nb">filter</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">kwd</span><span class="p">:</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="n">kwd</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kwd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span>
                                        <span class="n">kwdset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                        <span class="p">},</span>
                    <span class="n">kwdstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">binders_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">):</span>
        <span class="k">return</span> \
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                            <span class="n">hg</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">,</span>
                        <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bindprop</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># reading the SEC absorption values and calculating the protein </span>
    <span class="c1"># profiles in the fractions</span>
    <span class="c1">#</span>
    
    <span class="k">def</span> <span class="nf">_GLTPD1_profile_correction_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">):</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="s1">&#39;GLTPD1&#39;</span><span class="p">][</span><span class="s1">&#39;a11&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="s1">&#39;GLTPD1&#39;</span><span class="p">][</span><span class="s1">&#39;a12&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="s1">&#39;GLTPD1&#39;</span><span class="p">][</span><span class="s1">&#39;a11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="s1">&#39;GLTPD1&#39;</span><span class="p">][</span><span class="s1">&#39;a12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq</span>
    
    <span class="k">def</span> <span class="nf">_GLTP1_profile_correction_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">):</span>
        <span class="n">a11</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="s1">&#39;GLTPD1&#39;</span><span class="p">][</span><span class="s1">&#39;a11&#39;</span><span class="p">]</span>
        <span class="n">a12</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="s1">&#39;GLTPD1&#39;</span><span class="p">][</span><span class="s1">&#39;a12&#39;</span><span class="p">]</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="s1">&#39;GLTPD1&#39;</span><span class="p">][</span><span class="s1">&#39;a11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a12</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="s1">&#39;GLTPD1&#39;</span><span class="p">][</span><span class="s1">&#39;a12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a11</span>
    
    <span class="k">def</span> <span class="nf">pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secfracs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pp</span><span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
<div class="viewcode-block" id="Screening.raw_sec_absorbances"><a class="viewcode-back" href="../../index.html#emese.main.Screening.raw_sec_absorbances">[docs]</a>    <span class="k">def</span> <span class="nf">raw_sec_absorbances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fraclim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the SEC absorbance curves into numpy arrays.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refrac</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[0-9]*([A-Z][0-9]{1,2})&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_zeroed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abscache</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="ow">not</span> <span class="n">fraclim</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flimcache</span><span class="p">)):</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abscache</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">absorb</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">fraclim</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flimcache</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fraclim</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">reprotein</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*?[\s_-]?([A-Za-z0-9]{3,})_?[A-Za-z0-9]+?\.[a-z]</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absorb</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">secdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppsecdir</span><span class="p">)</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">secdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fraclim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fraclim</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">protein_name</span> <span class="o">=</span> <span class="n">reprotein</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;xls&#39;</span> <span class="ow">or</span> <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">secdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))[</span><span class="mi">3</span><span class="p">:]</span>
                <span class="k">except</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">biffh</span><span class="o">.</span><span class="n">XLRDError</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Error reading XLS:</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">absorb</span><span class="p">[</span><span class="n">protein_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                    <span class="nb">list</span><span class="p">(</span>
                                        <span class="nb">map</span><span class="p">(</span>
                                            <span class="k">lambda</span> <span class="n">num</span><span class="p">:</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">num</span><span class="p">),</span>
                                            <span class="n">l</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
                                        <span class="p">)</span>
                                    <span class="p">),</span>
                                <span class="n">tbl</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">secdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    
                    <span class="n">sec</span> <span class="o">=</span> \
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">filter</span><span class="p">(</span>
                                <span class="nb">len</span><span class="p">,</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                        <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">absorb</span><span class="p">[</span><span class="n">protein_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                        <span class="p">[</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                                        <span class="p">],</span>
                                    <span class="n">sec</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">fraclim</span><span class="p">:</span>
                        
                        <span class="n">fraclims</span> <span class="o">=</span> \
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                        <span class="p">(</span>
                                            <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                                        <span class="p">),</span>
                                    <span class="nb">filter</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">,</span>
                                        <span class="n">sec</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">fraclim</span><span class="p">[</span><span class="n">protein_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> \
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                                        <span class="p">(</span>
                                            <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># the lower boundary</span>
                                            <span class="n">fraclims</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># the upper</span>
                                            <span class="n">refrac</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># the fraction label</span>
                                        <span class="p">),</span>
                                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">fraclims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># last one is the Waste</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abscache</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorb</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fraclim</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flimcache</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fraclim</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.pp2"><a class="viewcode-back" href="../../index.html#emese.main.Screening.pp2">[docs]</a>    <span class="k">def</span> <span class="nf">pp2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the complete workflow of all protein and</span>
<span class="sd">        intensity profile related calculations.</span>
<span class="sd">        This includes:</span>
<span class="sd">        - reading the UV absorbances</span>
<span class="sd">        - taking the mean absorbance for each fraction</span>
<span class="sd">        with multiple offsets if necessary</span>
<span class="sd">        - doing corrections for baseline and background</span>
<span class="sd">        - getting a mean from different offsets</span>
<span class="sd">        - optionally determining the protein containing</span>
<span class="sd">        fractions from the absorbances</span>
<span class="sd">        - reading manually defined protein ratios if</span>
<span class="sd">        ``use_manual_ppratios`` is ``True``</span>
<span class="sd">        - determining measured fractions for each protein</span>
<span class="sd">        - listing those proteins measured only in one</span>
<span class="sd">        fraction</span>
<span class="sd">        - setting the protein content values of all non</span>
<span class="sd">        protein containing fractions to zero</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_sec_absorbances</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absorbances_by_fractions</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_do_correction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_baseline_correction</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_background</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_background_correction</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_pp</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcont_fracs_from_abs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protein_containing_fractions_from_absorbances</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fractions_upper&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_marco</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_measured</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_onepfraction</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_controls</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="Screening.absorbances_by_fractions"><a class="viewcode-back" href="../../index.html#emese.main.Screening.absorbances_by_fractions">[docs]</a>    <span class="k">def</span> <span class="nf">absorbances_by_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates mean absorbances by fractions at</span>
<span class="sd">        all offsets in `fr_offsets`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">def</span> <span class="nf">get_segment</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">absorb</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="p">,</span>
                                                     <span class="n">a</span><span class="p">[:,</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lo</span><span class="p">)),</span><span class="n">c</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fraclim&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_fraction_limits</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">absorb</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># whether we have uniform limits,</span>
            <span class="c1"># or different for each protein</span>
            <span class="n">fraclim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraclim</span> \
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fraclim</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> \
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraclim</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">lim</span> <span class="ow">in</span> <span class="n">fraclim</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">lim</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_cols</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">lim</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_do_correction</span><span class="p">:</span>
                        <span class="n">abs_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorb</span><span class="p">[</span><span class="n">protein</span><span class="p">][:,</span><span class="n">c</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">abs_min</span> <span class="o">=</span> <span class="mf">0.0</span>
                    
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">lim</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">get_segment</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="p">,</span> <span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="p">)</span> <span class="o">-</span> \
                                <span class="n">abs_min</span>
                        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span> <span class="o">=</span> <span class="n">result</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">gel_protein_quantification</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="Screening.gel_protein_quantification"><a class="viewcode-back" href="../../index.html#emese.main.Screening.gel_protein_quantification">[docs]</a>    <span class="k">def</span> <span class="nf">gel_protein_quantification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For proteins with various issues with UV absorbances,</span>
<span class="sd">        this method reads quantifications based on manual</span>
<span class="sd">        processing of SDS PAGE images. The UV absorbance values</span>
<span class="sd">        in attribute `abs_by_frac` will be replaced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gel_profiles</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">fnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_gel</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gelprofdir</span><span class="p">):</span>
            
            <span class="n">fnames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gelprofdir</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Warning: using SDS PAGE based protein &#39;</span>\
                <span class="s1">&#39;profiles turned on,</span><span class="se">\n</span><span class="s1">&#39;</span>\
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">   but directory `</span><span class="si">%s</span><span class="s1">` either &#39;</span>\
                <span class="s1">&#39;does not exist or is empty.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gelprofdir</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gelprofdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                
                <span class="n">protein</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="k">continue</span>
                    
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fr</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">continue</span>
                    
                    <span class="n">profile</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                
                <span class="n">missing_sec</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span>
                               <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                
                <span class="n">missing_gel</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span>
                               <span class="nb">set</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_gel</span><span class="p">):</span>
                    
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1"> -- These fractions at protein &#39;</span>\
                        <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">` are not available from SDS PAGE: </span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>\
                        <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">    Setting them to zero.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">protein</span><span class="p">,</span>
                            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_fracs_str</span><span class="p">(</span><span class="n">missing_gel</span><span class="p">))</span>
                        <span class="p">))</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_sec</span><span class="p">):</span>
                    
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1"> -- These fractions at protein &#39;</span>\
                        <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">` present on SDS PAGE but missing from the &#39;</span>\
                        <span class="s1">&#39;SEC profile file: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">. &#39;</span>\
                        <span class="s1">&#39;Discarding them.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">protein</span><span class="p">,</span>
                            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_fracs_str</span><span class="p">(</span><span class="n">missing_sec</span><span class="p">))</span>
                        <span class="p">))</span>
                
                <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">profile</span><span class="p">):</span>
                    
                    <span class="c1"># sometimes we have more columns</span>
                    <span class="c1"># if we read the 215 &amp; 260 nm absorbances</span>
                    <span class="c1"># although we don&#39;t use them</span>
                    <span class="c1"># but let&#39;s keep the column count</span>
                    <span class="c1"># by default we use 280 nm absorbances</span>
                    <span class="n">plen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
                    
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">*</span> <span class="n">plen</span>
                
                <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">missing_gel</span><span class="p">:</span>
                    
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">plen</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">missing_gel</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_gel</span></div>
    
<div class="viewcode-block" id="Screening.check_missing_gel"><a class="viewcode-back" href="../../index.html#emese.main.Screening.check_missing_gel">[docs]</a>    <span class="k">def</span> <span class="nf">check_missing_gel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether any of the protein containing fractions has been</span>
<span class="sd">        zeroed due to missing from the SDS PAGE based quantification.</span>
<span class="sd">        Prints warning if this happened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gel_profiles</span><span class="p">:</span>
            
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">missing</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_gel</span><span class="p">):</span>
                
                <span class="n">with_protein</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protein_containing_fractions</span><span class="p">(</span><span class="n">protein</span><span class="p">))</span>
                <span class="n">zeroed</span> <span class="o">=</span> <span class="n">missing</span> <span class="o">&amp;</span> <span class="n">with_protein</span>
                
                <span class="k">if</span> <span class="n">zeroed</span><span class="p">:</span>
                    
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Warning: at protein `</span><span class="si">%s</span><span class="s1">` fraction&#39;</span>\
                        <span class="s1">&#39;(s) have been set to zero because they are missing &#39;</span>\
                        <span class="s1">&#39;from the SDS PAGE.</span><span class="se">\n\t</span><span class="s1">   But these are marked as pr&#39;</span>\
                        <span class="s1">&#39;otein containing fractions: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">protein</span><span class="p">,</span>
                            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_fracs_str</span><span class="p">(</span><span class="n">zeroed</span><span class="p">))</span>
                        <span class="p">))</span></div>
    
<div class="viewcode-block" id="Screening.pp_baseline_correction"><a class="viewcode-back" href="../../index.html#emese.main.Screening.pp_baseline_correction">[docs]</a>    <span class="k">def</span> <span class="nf">pp_baseline_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subtracts the value of the `base` frabction from the values</span>
<span class="sd">        of each fraction. The `base` considered to be void.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">{}),</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basefrac</span> <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">base</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac</span><span class="p">):</span>
            
            <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">d2</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span>
                                <span class="p">(</span>
                                    <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="nb">list</span><span class="p">(</span>
                                        <span class="nb">map</span><span class="p">(</span>
                                            <span class="k">lambda</span> <span class="n">ab</span><span class="p">:</span>
                                                <span class="n">ab</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="n">base</span><span class="p">][</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ab</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                            <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">),</span>
                            <span class="n">iteritems</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_b</span> <span class="o">=</span> <span class="n">result</span></div>
    
    <span class="k">def</span> <span class="nf">pp_background_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_c</span> <span class="o">=</span> \
            <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">prot</span><span class="p">:</span>
                        <span class="p">(</span>
                            <span class="n">prot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="nb">dict</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                                        <span class="p">(</span>
                                            <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="nb">dict</span><span class="p">(</span>
                                                <span class="nb">map</span><span class="p">(</span>
                                                    <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span>
                                                        <span class="p">(</span>
                                                            <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                            <span class="nb">map</span><span class="p">(</span>
                                                                <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span>
                                <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_background</span><span class="p">[</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                                                <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                                            <span class="p">)</span>
                                                        <span class="p">),</span>
                                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                                <span class="p">)</span>
                                            <span class="p">)</span>
                                        <span class="p">),</span>
                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">prot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_b</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pp_background</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_background</span> <span class="o">=</span> \
            <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                        <span class="p">(</span>
                            <span class="n">fr</span><span class="p">,</span>
                            <span class="nb">dict</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span>
                                        <span class="p">(</span>
                                            <span class="n">c</span><span class="p">,</span>
                                            <span class="nb">map</span><span class="p">(</span>
                                                <span class="k">lambda</span> <span class="n">o</span><span class="p">:</span>
                                                    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                                                        <span class="nb">map</span><span class="p">(</span>
                                                            <span class="k">lambda</span> <span class="n">pra</span><span class="p">:</span>
                                                                <span class="n">pra</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">fr</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">o</span><span class="p">],</span>
                                                            <span class="nb">filter</span><span class="p">(</span>
                                                                <span class="k">lambda</span> <span class="n">pra</span><span class="p">:</span>
                                                                    <span class="n">pra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_proteins</span><span class="p">,</span>
                                                                <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_b</span><span class="p">)</span>
                                                            <span class="p">)</span>
                                                        <span class="p">)</span>
                                                    <span class="p">),</span>
                                                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                                            <span class="p">)</span>
                                        <span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_b</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_b</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">mean_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pprofsL</span> <span class="o">=</span>  <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pprofsU</span> <span class="o">=</span>  <span class="p">{}</span>
        <span class="k">def</span> <span class="nf">get_mean</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">get_val</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                                <span class="p">(</span>
                                    <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                                        <span class="nb">list</span><span class="p">(</span>
                                            <span class="nb">map</span><span class="p">(</span>
                                                <span class="k">lambda</span> <span class="n">vals</span><span class="p">:</span>
                                                    <span class="n">get_val</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span>
                                                <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">),</span>
                            <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_c</span><span class="p">):</span>
            <span class="n">get_mean</span><span class="p">(</span><span class="s1">&#39;pprofs&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">)</span>
            <span class="n">get_mean</span><span class="p">(</span><span class="s1">&#39;pprofsL&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">get_mean</span><span class="p">(</span><span class="s1">&#39;pprofsU&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">read_fraction_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppfracf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fraclim</span> <span class="o">=</span> \
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">),</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">correct_GLTPD1</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">GLTPD_correction</span> <span class="o">=</span> <span class="s1">&#39;eq&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each protein, for each fraction, calculates the mean of</span>
<span class="sd">        absorptions of all the measurements belonging to one fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cachefile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">.pickle&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pprofcache</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">propname</span> <span class="o">=</span> <span class="s1">&#39;pprofs</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cachefile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">cachefile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">correct_GLTPD1</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="s1">&#39;_GLTPD1_profile_correction_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">GLTPD_correction</span><span class="p">)(</span><span class="n">propname</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">reprotein</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*[\s_-]([A-Za-z0-9]{3,})\.xls&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">secdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppsecdir</span><span class="p">)</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">secdir</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppfracf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> \
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">),</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secfracs</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)]</span> <span class="o">=</span> <span class="n">frac</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">protein_name</span> <span class="o">=</span> <span class="n">reprotein</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">frac_abs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">frac</span><span class="p">)</span>
            <span class="n">gfrac</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">frac</span><span class="p">)</span>
            <span class="n">fr</span> <span class="o">=</span> <span class="n">gfrac</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">secdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">except</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">biffh</span><span class="o">.</span><span class="n">XLRDError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Error reading XLS:</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">minabs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                <span class="c1"># l[4]: volume (ml)</span>
                <span class="n">ml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">ml</span> <span class="o">&lt;</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">ml</span> <span class="o">&gt;=</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fr</span> <span class="o">=</span> <span class="n">gfrac</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="c1"># l[5] mAU UV3 215nm</span>
                <span class="n">frac_abs</span><span class="p">[</span><span class="n">fr</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">-</span> <span class="n">minabs</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">protein_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">fnum</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> \
                <span class="k">for</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">frac_abs</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">cachefile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">correct_GLTPD1</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="s1">&#39;_GLTPD1_profile_correction_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">GLTPD_correction</span><span class="p">)(</span><span class="n">propname</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">protein_profile_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein_name</span><span class="p">,</span> <span class="n">prof</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">propname</span><span class="p">)):</span>
            <span class="n">basefrac</span> <span class="o">=</span> <span class="n">prof</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">basefrac</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">frac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">:</span>
                <span class="n">prof</span><span class="p">[</span><span class="n">frac</span><span class="p">]</span> <span class="o">-=</span> <span class="n">basefrac</span>
            <span class="n">cmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="n">prof</span><span class="p">[</span><span class="n">fr</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">frac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">:</span>
                <span class="n">prof</span><span class="p">[</span><span class="n">frac</span><span class="p">]</span> <span class="o">-=</span> <span class="n">cmin</span>
    
<div class="viewcode-block" id="Screening.zero_controls"><a class="viewcode-back" href="../../index.html#emese.main.Screening.zero_controls">[docs]</a>    <span class="k">def</span> <span class="nf">zero_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For protein profiles with offsets 0, 15 and 45</span>
<span class="sd">        it calls protein_profile_correction() to</span>
<span class="sd">        make the baseline correction, saves a copy</span>
<span class="sd">        to pprof_original&lt;offset&gt; property, and</span>
<span class="sd">        after sets the values for non LTP conatining</span>
<span class="sd">        fractions to zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_zeroed</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Looks like controls already set to zero, &#39;</span>\
                <span class="s1">&#39;please set `pp_zeroed` to False to override.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">offset</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">]):</span>
            <span class="n">propname</span> <span class="o">=</span> <span class="s1">&#39;pprofs</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_do_correction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">protein_profile_correction</span><span class="p">(</span><span class="n">propname</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pprofs_original</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">,</span>
                <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">protein_name</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">)[</span><span class="n">protein_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_zeroed</span> <span class="o">=</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="Screening.protein_containing_fractions_from_absorbances"><a class="viewcode-back" href="../../index.html#emese.main.Screening.protein_containing_fractions_from_absorbances">[docs]</a>    <span class="k">def</span> <span class="nf">protein_containing_fractions_from_absorbances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abscol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the protein containing fractions (`fractions`) based on</span>
<span class="sd">        the UV absorbances, considering protein containing those whit a</span>
<span class="sd">        value higher than the maximum / minratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="p">{}),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_c</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">ab</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_c</span><span class="p">):</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># the UV profile IDs,</span>
                                                     <span class="c1"># e.g. 3 = 260 nm</span>
            <span class="n">abs_max</span> <span class="o">=</span> \
                <span class="nb">max</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">abscol</span><span class="p">]),</span>
                        <span class="n">ab</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span>
                            <span class="p">(</span>
                                <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">abscol</span><span class="p">])</span> <span class="o">&gt;</span> \
                                    <span class="n">abs_max</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_minratio</span><span class="p">)</span>
                            <span class="p">),</span>
                        <span class="n">iteritems</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">frs</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractions</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">frs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">fr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></div>
    
    <span class="k">def</span> <span class="nf">fractions_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;fractions_absorption.csv&#39;</span><span class="p">):</span>
        <span class="n">fracs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a5&#39;</span><span class="p">,</span> <span class="s1">&#39;a6&#39;</span><span class="p">,</span> <span class="s1">&#39;a7&#39;</span><span class="p">,</span> <span class="s1">&#39;a8&#39;</span><span class="p">,</span> <span class="s1">&#39;a9&#39;</span><span class="p">,</span> <span class="s1">&#39;a10&#39;</span><span class="p">,</span> <span class="s1">&#39;a11&#39;</span><span class="p">,</span> <span class="s1">&#39;a12&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fracs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">protein</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                                           <span class="s1">&#39;</span><span class="si">%.08f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">values</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">],</span>
                                        <span class="n">fracs</span><span class="p">)))</span>
                <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">protein_containing_fractions_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;proteins_in_fractions.csv&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">protein</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
                            <span class="n">xrange</span><span class="p">(</span><span class="mi">5</span><span class="p">))))</span>
                <span class="p">)</span>
    
<div class="viewcode-block" id="Screening.protein_containing_fractions"><a class="viewcode-back" href="../../index.html#emese.main.Screening.protein_containing_fractions">[docs]</a>    <span class="k">def</span> <span class="nf">protein_containing_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of those fractions containing the protein,</span>
<span class="sd">        sorted by the order of measurement (their position on the plate).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_fractions</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.all_fractions"><a class="viewcode-back" href="../../index.html#emese.main.Screening.all_fractions">[docs]</a>    <span class="k">def</span> <span class="nf">all_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of all fractions for one protein,</span>
<span class="sd">        sorted by the order of measurement (their position on the plate).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># removing the SEC buffer control</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfracs</span><span class="p">[</span><span class="n">protein</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="Screening.fraction_indices"><a class="viewcode-back" href="../../index.html#emese.main.Screening.fraction_indices">[docs]</a>    <span class="k">def</span> <span class="nf">fraction_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dict with column indices for all fractions</span>
<span class="sd">        and a boolean value whether if it contains protein.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> \
            <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                        <span class="p">(</span>
                            <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
                        <span class="p">),</span>
                    <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_fractions</span><span class="p">(</span><span class="n">protein</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.pcont_indices"><a class="viewcode-back" href="../../index.html#emese.main.Screening.pcont_indices">[docs]</a>    <span class="k">def</span> <span class="nf">pcont_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the indices of protein containing fraction columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                            <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="nb">filter</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                                <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction_indices</span><span class="p">(</span><span class="n">protein</span><span class="p">))</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.pcont_columns"><a class="viewcode-back" href="../../index.html#emese.main.Screening.pcont_columns">[docs]</a>    <span class="k">def</span> <span class="nf">pcont_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;fe&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the protein containing fraction columns</span>
<span class="sd">        from the features x fractions array `attr`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="n">attr</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">pcont_indices</span><span class="p">(</span><span class="n">protein</span><span class="p">)]</span></div>
    
<div class="viewcode-block" id="Screening.fractions_by_protein_amount"><a class="viewcode-back" href="../../index.html#emese.main.Screening.fractions_by_protein_amount">[docs]</a>    <span class="k">def</span> <span class="nf">fractions_by_protein_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orders the fractions by the amount of protein.</span>
<span class="sd">        Considers fraction offsets if those are assumed,</span>
<span class="sd">        and creates dicts `fracs_orderL` and fracs_orderU`</span>
<span class="sd">        (these are identical if no offset assumed).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">with_protein</span><span class="p">,</span> <span class="n">pprofs</span><span class="p">):</span>
            <span class="k">return</span> \
                <span class="nb">sorted</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                            <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">with_protein</span><span class="p">,</span>
                        <span class="n">iteritems</span><span class="p">(</span><span class="n">pprofs</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span>
                    <span class="p">),</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderL</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderU</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pprofsL</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfracs</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">with_protein</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_containing_fractions</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderL</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">order</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">with_protein</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pprofsL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderU</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">order</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">with_protein</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pprofsU</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.primary_fractions"><a class="viewcode-back" href="../../index.html#emese.main.Screening.primary_fractions">[docs]</a>    <span class="k">def</span> <span class="nf">primary_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selects the fraction with highest protein amount (primary),</span>
<span class="sd">        all the others considered secondary. There might be more</span>
<span class="sd">        than one primary fractions if at different fraction offsets</span>
<span class="sd">        different fractions have the highest amount of protein.</span>
<span class="sd">        Creates dict `fracs_order`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fracs_order</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;prim&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([]),</span> <span class="s1">&#39;sec&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([])}),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fracs_order</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfracs</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;prim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderL</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;prim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderU</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderL</span><span class="p">[</span><span class="n">protein</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">fr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;prim&#39;</span><span class="p">]:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderU</span><span class="p">[</span><span class="n">protein</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">fr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;prim&#39;</span><span class="p">]:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.protein_peak_ratios"><a class="viewcode-back" href="../../index.html#emese.main.Screening.protein_peak_ratios">[docs]</a>    <span class="k">def</span> <span class="nf">protein_peak_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the expected minimum and maximum values for</span>
<span class="sd">        protein peak ratios.</span>
<span class="sd">        The result contains empty dicts for proteins with only</span>
<span class="sd">        one fraction, one ratio for those with 2 fractions, and</span>
<span class="sd">        2 ratios for those with 3 fractions.</span>
<span class="sd">        Creates dict `ppratios`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfracs</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">ratios</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">pprofL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pprofsL</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="n">pprofU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pprofsU</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ref</span> <span class="o">=</span> <span class="n">frac</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ratio1</span> <span class="o">=</span> <span class="n">pprofL</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">/</span> <span class="n">pprofL</span><span class="p">[</span><span class="n">frac</span><span class="p">]</span>
                        <span class="n">ratio2</span> <span class="o">=</span> <span class="n">pprofU</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">/</span> <span class="n">pprofU</span><span class="p">[</span><span class="n">frac</span><span class="p">]</span>
                        <span class="n">ratios</span><span class="p">[(</span><span class="n">ref</span><span class="p">,</span> <span class="n">frac</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">ratio1</span><span class="p">,</span> <span class="n">ratio2</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratios</span></div>
    
    <span class="k">def</span> <span class="nf">read_manual_ppratios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">refracs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*([AB])([0-9]{1,2})-([AB])([0-9]{1,2}).*&#39;</span><span class="p">)</span>
        <span class="n">nondigit</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\d\.-]+&#39;</span><span class="p">)</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manual_ppratios_xls</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual_ppratios_xls_cols</span>
        <span class="n">ppratios</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">first</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fractions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Reading manual ppratios</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">logf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;fractions&#39;</span><span class="p">,</span> <span class="s1">&#39;old_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;old_upper&#39;</span><span class="p">,</span> <span class="s1">&#39;new_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;new_upper&#39;</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
            <span class="n">protein</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">frm</span> <span class="o">=</span> <span class="n">refracs</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">frm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">fr1l</span><span class="p">,</span> <span class="n">fr1n</span><span class="p">,</span> <span class="n">fr2l</span><span class="p">,</span> <span class="n">fr2n</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frm</span><span class="p">):</span>
                    <span class="n">fr1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fr1l</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr1n</span><span class="p">))</span>
                    <span class="n">fr2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fr2l</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr2n</span><span class="p">))</span>
                    <span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fr1</span><span class="p">)</span>
                    <span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fr2</span><span class="p">)</span>
                    <span class="n">lower</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nondigit</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">upper</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">upper</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span><span class="p">:</span>
                        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">upper</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nondigit</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">upper</span><span class="p">))</span>
                    <span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][(</span><span class="n">fr1</span><span class="p">,</span> <span class="n">fr2</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                    <span class="n">old_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][(</span><span class="n">fr1</span><span class="p">,</span> <span class="n">fr2</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">old_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][(</span><span class="n">fr1</span><span class="p">,</span> <span class="n">fr2</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Setting </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> to &#39;</span>\
                            <span class="s1">&#39;</span><span class="si">%.02f</span><span class="s1">-</span><span class="si">%.02f</span><span class="s1"> (was </span><span class="si">%.02f</span><span class="s1">-</span><span class="si">%.02f</span><span class="s1"> before).</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">fr1</span><span class="p">,</span> <span class="n">fr2</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span>
                             <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span>
                             <span class="n">old_lower</span><span class="p">,</span> <span class="n">old_upper</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">logf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                            <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">old_lower</span> <span class="o">==</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">old_upper</span> <span class="o">==</span> <span class="n">upper</span> <span class="k">else</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span>
                            <span class="n">protein</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fr1</span><span class="p">,</span> <span class="n">fr2</span><span class="p">),</span>
                            <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">old_lower</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">old_upper</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">lower</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">upper</span>
                        <span class="p">])))</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">first</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fr1</span><span class="p">,</span> <span class="n">fr2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Could not read &#39;</span>\
                        <span class="s1">&#39;fraction IDs for </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">frm</span><span class="p">)</span> <span class="ow">and</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fr</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protein_containing_fractions</span><span class="p">(</span><span class="n">protein</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Protein </span><span class="si">%s</span><span class="s1"> present &#39;</span>\
                    <span class="s1">&#39;only in fraction </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">fr</span><span class="p">))</span>
                <span class="n">logf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">fr</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppratios_manual</span> <span class="o">=</span> <span class="n">ppratios</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio_manual</span> <span class="o">=</span> <span class="n">first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_manual</span> <span class="o">=</span> <span class="n">fractions</span>
    
    <span class="k">def</span> <span class="nf">ppratios_replace_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.0000000000001</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">pprs</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppratios_manual</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">ratios</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">pprs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratios</span>
                <span class="n">frr</span> <span class="o">=</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ratiosr</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">),</span>
                           <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratios</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">frr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratiosr</span>
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio_manual</span><span class="p">:</span>
                <span class="n">fr1i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_ratio_manual</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">fr2i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_ratio_manual</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr1i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fr2i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio_manual</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
    
<div class="viewcode-block" id="Screening.fractions_marco"><a class="viewcode-back" href="../../index.html#emese.main.Screening.fractions_marco">[docs]</a>    <span class="k">def</span> <span class="nf">fractions_marco</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads manually defined protein peak ratios and protein containing</span>
<span class="sd">        fractions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_original</span> <span class="o">=</span> \
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span>
                          <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fractions_upper&#39;</span><span class="p">)</span>
                          <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_manual_ppratios</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">refrac</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([AB])([0-9]{1,2})&#39;</span><span class="p">)</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manual_ppratios_xls</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual_ppratios_xls_cols</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
            <span class="n">protein</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">protein</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">fracs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                    <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                <span class="n">refrac</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">fracs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Setting fraction </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> to 1, &#39;</span>\
                            <span class="s1">&#39;this was </span><span class="si">%s</span><span class="s1"> before</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Setting fraction </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> to 0, &#39;</span>\
                        <span class="s1">&#39;this was </span><span class="si">%s</span><span class="s1"> before</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>
    
<div class="viewcode-block" id="Screening.protein_peak_ratios2"><a class="viewcode-back" href="../../index.html#emese.main.Screening.protein_peak_ratios2">[docs]</a>    <span class="k">def</span> <span class="nf">protein_peak_ratios2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the expected minimum and maximum values for</span>
<span class="sd">        protein peak ratios.</span>
<span class="sd">        The result contains empty dicts for proteins with only</span>
<span class="sd">        one fraction, one ratio for those with 2 fractions, and</span>
<span class="sd">        2 ratios for those with 3 fractions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">ratio_tuple</span><span class="p">(</span><span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span><span class="p">,</span> <span class="n">ifracs</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                        <span class="nb">sorted</span><span class="p">([</span><span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span><span class="p">],</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="n">ifracs</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">first_ratioL</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_ratioL</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_ratioU</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_ratioU</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_ratio</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">def</span> <span class="nf">get_ratio</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
            <span class="k">return</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_c</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">ref</span><span class="p">][</span><span class="n">w</span><span class="p">][</span><span class="n">o</span><span class="p">]</span> <span class="o">/</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">abs_by_frac_c</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">frac</span><span class="p">][</span><span class="n">w</span><span class="p">][</span><span class="n">o</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">abs_cols</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfracs</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">fracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_containing_fractions</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            <span class="n">ifracs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fracs</span><span class="p">)))</span>
            
            <span class="n">ratios</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frac1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fracs</span><span class="p">):</span>
                
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">frac2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fracs</span><span class="p">):</span>
                    
                    <span class="k">if</span> <span class="n">frac1</span> <span class="o">!=</span> <span class="n">frac2</span><span class="p">:</span>
                        
                        <span class="n">ratios</span><span class="p">[(</span><span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span><span class="p">)]</span> <span class="o">=</span> \
                            <span class="nb">tuple</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span>
                                        <span class="n">get_ratio</span><span class="p">(</span>
                                            <span class="n">protein</span><span class="p">,</span>
                                            <span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span>
                                    <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">))</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratios</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderL</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                
                <span class="n">highestL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderL</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">secondL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderL</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lowestL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderL</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">highestU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderU</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">secondU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderU</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lowestU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs_orderU</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">first_ratioL</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">ratio_tuple</span><span class="p">(</span><span class="n">highestL</span><span class="p">,</span> <span class="n">secondL</span><span class="p">,</span> <span class="n">ifracs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_ratioL</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">ratio_tuple</span><span class="p">(</span><span class="n">highestL</span><span class="p">,</span> <span class="n">lowestL</span><span class="p">,</span> <span class="n">ifracs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">first_ratioU</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">ratio_tuple</span><span class="p">(</span><span class="n">highestU</span><span class="p">,</span> <span class="n">secondU</span><span class="p">,</span> <span class="n">ifracs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_ratioU</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">ratio_tuple</span><span class="p">(</span><span class="n">highestU</span><span class="p">,</span> <span class="n">lowestU</span><span class="p">,</span> <span class="n">ifracs</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_ratioL</span><span class="p">[</span><span class="n">protein</span><span class="p">],</span>
                                 <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ratioL</span><span class="p">[</span><span class="n">protein</span><span class="p">],</span>
                                 <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))))</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">first_ratioL</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_ratioL</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>  <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">first_ratioU</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_ratioU</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>  <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>  <span class="o">=</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="Screening.intensity_peak_ratios"><a class="viewcode-back" href="../../index.html#emese.main.Screening.intensity_peak_ratios">[docs]</a>    <span class="k">def</span> <span class="nf">intensity_peak_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the intensity peak ratios which are to be</span>
<span class="sd">        compared with the protein peak ratios.</span>
<span class="sd">        For each protein for each mode a new array named `ipr`</span>
<span class="sd">        will be created with one row for each feature and</span>
<span class="sd">        0, 1 or 2 columns depending on the number of protein</span>
<span class="sd">        containing fractions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="n">fracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_containing_fractions</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            <span class="n">ifracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_indices</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">ratios</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="k">for</span> <span class="n">fe</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">]:</span>
                    <span class="n">ratio</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fracs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fracs</span><span class="p">)):</span>
                            
                            <span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fracs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            
                            <span class="n">f1</span> <span class="o">=</span> <span class="n">fe</span><span class="p">[</span><span class="n">ifracs</span><span class="p">[</span><span class="n">frac1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">f2</span> <span class="o">=</span> <span class="n">fe</span><span class="p">[</span><span class="n">ifracs</span><span class="p">[</span><span class="n">frac2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">f1</span> <span class="o">==</span> <span class="mf">0.0</span> \
                                <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">f2</span> <span class="o">==</span> <span class="mf">0.0</span> \
                                <span class="k">else</span> <span class="n">f1</span> <span class="o">/</span> <span class="n">f2</span>
                            
                            <span class="n">ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                            
                            <span class="n">indices</span><span class="p">[(</span><span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    
                    <span class="n">ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">]:</span>
                    <span class="n">fi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]]</span>
                    <span class="n">hi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]]</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipr&#39;</span><span class="p">][:,</span><span class="n">fi</span><span class="p">]</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipr&#39;</span><span class="p">][:,</span><span class="n">hi</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="Screening.ratios_in_range"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ratios_in_range">[docs]</a>    <span class="k">def</span> <span class="nf">ratios_in_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new boolean attribute `ppr`, which tells if the intensity</span>
<span class="sd">        peak ratios are in the range expected based on the fractions offset,</span>
<span class="sd">        or if we assume no offset, then a custom interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">ppr1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ratio</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_last_ratio</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span>
        <span class="n">iprvar</span> <span class="o">=</span> <span class="s1">&#39;iprh&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_last_ratio</span> <span class="k">else</span> <span class="s1">&#39;iprf&#39;</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="n">fracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_containing_fractions</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="c1"># only if we have more than one fraction:</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="n">iprvar</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    
                    <span class="n">in_range</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fracs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fracs</span><span class="p">)):</span>
                            
                            <span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fracs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">fkey</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span><span class="p">)</span>
                            <span class="n">ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fkey</span><span class="p">]</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">][</span><span class="n">fkey</span><span class="p">]</span>
                            
                            <span class="c1"># no fraction offsets:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">ppr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_ratio_range</span><span class="p">,</span>
                                    <span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_ratio_range</span><span class="p">)</span>
                            
                            <span class="n">in_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipr&#39;</span><span class="p">][:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipr&#39;</span><span class="p">][:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">in_range</span><span class="p">)</span>
                    <span class="n">fi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]]</span>
                    <span class="n">hi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">last_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]]</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prrf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prra&#39;</span><span class="p">][:,</span><span class="n">fi</span><span class="p">]</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prrh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prra&#39;</span><span class="p">][:,</span><span class="n">hi</span><span class="p">]</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prrv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prra&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prrf&#39;</span><span class="p">]</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prrf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prrv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prrh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="Screening.write_pptable"><a class="viewcode-back" href="../../index.html#emese.main.Screening.write_pptable">[docs]</a>    <span class="k">def</span> <span class="nf">write_pptable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes protein profiles in a table, so we don&#39;t need to read</span>
<span class="sd">        all the 60 XLS files every time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pptablef</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            
            <span class="n">allfr</span> <span class="o">=</span> \
                <span class="nb">sorted</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span>
                        <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                            <span class="o">*</span><span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="p">)</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allfr</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                    <span class="nb">map</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span>
                                            <span class="s1">&#39;</span><span class="si">%.20f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                        <span class="n">allfr</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                        <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.read_pptable"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_pptable">[docs]</a>    <span class="k">def</span> <span class="nf">read_pptable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads protein profiles from table.</span>
<span class="sd">        </span>
<span class="sd">        This method has not been updated for new fraction layout!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pptablef</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">float_lst</span><span class="p">(</span><span class="n">ll</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))))</span> \
                <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Screening.read_xls"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_xls">[docs]</a>    <span class="k">def</span> <span class="nf">read_xls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xls_file</span><span class="p">,</span> <span class="n">sheet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csv_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_table</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic function to read MS Excel XLS file, and convert one sheet</span>
<span class="sd">        to CSV, or return as a list of lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">xls_file</span><span class="p">,</span> <span class="n">on_demand</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">sheet</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sheet</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">sheet_by_name</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">biffh</span><span class="o">.</span><span class="n">XLRDError</span><span class="p">:</span>
                <span class="n">sheet</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[[</span><span class="n">unicode</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> \
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> \
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">nrows</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No such file: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">xls_file</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">book</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">xls_file</span><span class="p">,</span>
                    <span class="n">read_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Could not open xls: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">xls_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xls_file</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">File does not exist.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">sheet</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">worksheets</span><span class="p">[</span><span class="n">sheet</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sheet</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="n">sheet</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sheet</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">worksheets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">get_squared_range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">sheet</span><span class="o">.</span><span class="n">max_column</span><span class="p">,</span> <span class="n">sheet</span><span class="o">.</span><span class="n">max_row</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">unicode</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                    <span class="n">row</span>
                <span class="p">),</span>
                <span class="n">cells</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv</span><span class="p">:</span>
                <span class="n">csv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">table</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_table</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;book&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">book</span><span class="p">,</span> <span class="s1">&#39;release_resources&#39;</span><span class="p">):</span>
            <span class="n">book</span><span class="o">.</span><span class="n">release_resources</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">table</span></div>
    
    <span class="k">def</span> <span class="nf">mz2oi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="n">protein</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_name_upper2mixed</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">[</span><span class="n">mode</span><span class="p">]][</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span>
        <span class="n">du</span> <span class="o">=</span> <span class="mf">999.0</span> <span class="k">if</span> <span class="n">ui</span> <span class="o">==</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">ui</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="mf">999.0</span> <span class="k">if</span> <span class="n">ui</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">du</span><span class="p">,</span> <span class="n">dl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">oi</span> <span class="o">=</span> <span class="n">ui</span> <span class="k">if</span> <span class="n">du</span> <span class="o">&lt;</span> <span class="n">dl</span> <span class="k">else</span> <span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">oi</span>
    

    <span class="k">def</span> <span class="nf">read_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">refrac</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[AB][9120]{1,2}&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seqfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;2606&#39;</span><span class="p">,</span> <span class="s1">&#39;0626&#39;</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;2627&#39;</span><span class="p">,</span> <span class="s1">&#39;0627&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Bracke&#39;</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Sample&#39;</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;neg&#39;</span> <span class="k">if</span> <span class="s1">&#39;neg&#39;</span> <span class="ow">in</span> <span class="n">l</span> \
                        <span class="k">else</span> <span class="s1">&#39;pos&#39;</span> <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">l</span> \
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">seq</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">mode</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">seq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="ow">and</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                        <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">seq</span> <span class="o">==</span> <span class="s1">&#39;A9&#39;</span><span class="p">:</span> <span class="n">seq</span> <span class="o">=</span> <span class="s1">&#39;A09&#39;</span>
                    <span class="k">if</span> <span class="n">seq</span> <span class="o">==</span> <span class="s1">&#39;B1&#39;</span><span class="p">:</span> <span class="n">seq</span> <span class="o">=</span> <span class="s1">&#39;B01&#39;</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;extracted&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;SEC&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">protein</span> <span class="o">=</span> <span class="s1">&#39;#BUF&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;Std1&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">protein</span> <span class="o">=</span> <span class="s1">&#39;#STD&#39;</span>
                    <span class="k">elif</span> <span class="n">refrac</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="n">refrac</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">protein</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                        <span class="c1"># fix typo in filename</span>
                        <span class="k">if</span> <span class="n">protein</span> <span class="o">==</span> <span class="s1">&#39;ORP9STARD15&#39;</span><span class="p">:</span>
                            <span class="n">protein</span> <span class="o">=</span> <span class="n">protein</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">protein</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">seq</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;150330&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;150331&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">recalibration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recal_source</span> <span class="o">==</span> <span class="s1">&#39;marco&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drifts_from_marco</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">standards_filenames</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_seq</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">standards_theoretic_masses</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_standards</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drifts_by_standard</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drifts_by_date</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drifts2proteins</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recalibrate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">standards_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stddir</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Seq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="n">_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stddir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="n">lFname</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">lFname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span> <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">lFname</span> <span class="k">else</span> <span class="s1">&#39;neg&#39;</span>
                <span class="n">seq</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">mode</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="ow">and</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="n">date</span><span class="p">][(</span><span class="s1">&#39;#STD&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">seq</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdfiles</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">is_recalibrated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="s1">&#39;recalibrated&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span>\
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">recalibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_recalibrated</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Looks recalibration &#39;</span>\
                    <span class="s1">&#39;already has been done.</span><span class="se">\n</span><span class="s1">&#39;</span>\
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">   Set `recalibrated` &#39;</span>\
                    <span class="s1">&#39;values to `False` and call this method</span><span class="se">\n</span><span class="s1">&#39;</span>\
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">   again if you really want to repeat it.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Recalibration already done.</span><span class="se">\n</span><span class="s1">&#39;</span>\
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">   Looking for missing LTP/mode cases, and &#39;</span>\
                    <span class="s1">&#39;doing only those.</span><span class="se">\n</span><span class="s1">&#39;</span>\
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">   If you want to recalibrate everything &#39;</span>\
                    <span class="s1">&#39;again,</span><span class="se">\n</span><span class="s1">&#39;</span>\
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">   reload the original data.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;recalibrated&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">missing</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span><span class="n">protein</span><span class="p">]:</span>
                            <span class="n">ppm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppm2ratio</span><span class="p">(</span><span class="n">ppm</span><span class="p">)</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratio</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: No drift value &#39;</span>\
                                <span class="s1">&#39;for </span><span class="si">%s</span><span class="s1"> in mode </span><span class="si">%s</span><span class="s1"> :(</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: No drift values&#39;</span>\
                            <span class="s1">&#39; for </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> :(</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">read_standards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdcachefile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">std_measured</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdcachefile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">date</span><span class="p">:</span>
            <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdfiles</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">))</span>
        <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">fractions</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdfiles</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">fractions</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#STD&#39;</span><span class="p">:</span>
                    <span class="n">time</span><span class="p">,</span> <span class="n">scans</span><span class="p">,</span> <span class="n">centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mzml</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>
                    <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_peaks</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>
                    <span class="n">stdmeasured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standards_lookup</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdmeasured</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: Results saved to file </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">stdcachefile</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdcachefile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_measured</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">drifts_by_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_table</span> <span class="o">=</span> <span class="s1">&#39;drifts_ppm.tab&#39;</span><span class="p">):</span>
        <span class="n">drifts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">date_fr</span><span class="p">:</span>
            <span class="p">(</span><span class="n">date_fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">lipids</span><span class="p">:</span>
                <span class="p">(</span><span class="n">lipids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">lipid</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">lipid</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="n">lipids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="p">),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="p">),</span>
            <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std_measured</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;lipid&#39;</span><span class="p">,</span> <span class="s1">&#39;theoretical&#39;</span><span class="p">,</span>
            <span class="s1">&#39;measured&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;ppm&#39;</span><span class="p">]</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std_measured</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">fractions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_measured</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fractions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">lipids</span> <span class="o">=</span> <span class="n">fractions</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">lipid</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lipids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">mmz</span> <span class="o">=</span> <span class="n">lipids</span><span class="p">[</span><span class="n">lipid</span><span class="p">]</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">tmz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdmasses</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">lipid</span><span class="p">][</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span>
                    <span class="n">ratio</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">mmz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tmz</span> <span class="o">/</span> <span class="n">mmz</span>
                    <span class="n">ppm</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">ratio</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio2ppm</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                    <span class="n">drifts</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">sample</span><span class="p">][</span><span class="n">lipid</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppm</span>
                    <span class="n">tab</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                        <span class="s1">&#39;20</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span>
                        <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span>
                        <span class="n">lipid</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%.06f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tmz</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%.06f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mmz</span> <span class="k">if</span> <span class="n">mmz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%.09f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ratio</span> <span class="k">if</span> <span class="n">ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ppm</span> <span class="k">if</span> <span class="n">ppm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span>
                    <span class="p">])</span>
        <span class="k">if</span> <span class="n">write_table</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">write_table</span><span class="p">)</span> <span class="ow">in</span> <span class="n">charTypes</span><span class="p">:</span>
            <span class="n">tab</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span>
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">),</span>
                <span class="n">tab</span>
            <span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write_table</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drifts</span> <span class="o">=</span> <span class="n">drifts</span>

    <span class="k">def</span> <span class="nf">drifts_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;drifts_ppm.tab&#39;</span><span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;lipid&#39;</span><span class="p">,</span> <span class="s1">&#39;ppm&#39;</span><span class="p">]</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">fractions</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drifts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">lipids</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">fractions</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">lipid</span><span class="p">,</span> <span class="n">ppm</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">lipids</span><span class="p">):</span>
                    <span class="n">tab</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                        <span class="s1">&#39;20</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span>
                        <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span>
                        <span class="n">lipid</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ppm</span> <span class="k">if</span> <span class="n">ppm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span>
                    <span class="p">])</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">),</span>
            <span class="n">tab</span>
        <span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drifts_by_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">drifts2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">date_fr</span><span class="p">:</span>
            <span class="p">(</span><span class="n">date_fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span>
                <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">date_fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="p">),</span>
            <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drifts</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">fractions</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drifts</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">lipids</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">fractions</span><span class="p">):</span>
                <span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">lipids</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">sample</span><span class="p">]):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: No values in </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span> <span class="o">=</span> <span class="n">drifts2</span>

    <span class="k">def</span> <span class="nf">drifts2proteins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_table</span> <span class="o">=</span> <span class="s1">&#39;LTPs_drifts.tab&#39;</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Setting recalibration data via cache, from previously processed MzMLs</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c1"># before doing anything, fix some inconsistencies:</span>
        <span class="n">stard10fractions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A09&#39;</span><span class="p">,</span> <span class="s1">&#39;A10&#39;</span><span class="p">,</span> <span class="s1">&#39;A11&#39;</span><span class="p">,</span> <span class="s1">&#39;A12&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span>
                    <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span>
                        <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STARD10&#39;</span><span class="p">,</span>
                        <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="s1">&#39;150310&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">stard10fractions</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="s1">&#39;150310&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="s1">&#39;150310&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="s1">&#39;150310&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">proteins_drifts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LTP&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;ppm&#39;</span><span class="p">]</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">standard_indices</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">se</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#STD&#39;</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">mode</span><span class="p">,</span>
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">def</span> <span class="nf">add_row</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">protein</span><span class="p">,</span>
                <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span>
                <span class="n">fr</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="si">%.09f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppm2ratio</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
                <span class="s1">&#39;</span><span class="si">%.06f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span>
            <span class="p">])</span>
            <span class="k">return</span> <span class="n">tab</span>
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
            <span class="n">stdi</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lastbuf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">stdi</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standard_indices</span><span class="p">(</span><span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="n">se</span><span class="p">)</span>
            <span class="n">stdi</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standard_indices</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">se</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">se</span><span class="p">):</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s1">&#39;#STD&#39;</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ui</span> <span class="o">=</span> <span class="n">stdi</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ui</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">std1i</span> <span class="o">=</span> <span class="n">stdi</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">std1i</span> <span class="o">=</span> <span class="n">stdi</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ui</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stdi</span><span class="p">[</span><span class="n">mode</span><span class="p">]):</span>
                        <span class="n">std2i</span> <span class="o">=</span> <span class="n">stdi</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">std2i</span> <span class="o">=</span> <span class="n">stdi</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">ui</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std1i</span><span class="p">]]):</span>
                        <span class="n">std1i</span> <span class="o">=</span> <span class="n">std2i</span>
                    <span class="k">if</span> <span class="n">std1i</span> <span class="o">==</span> <span class="n">std2i</span> <span class="ow">or</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std2i</span><span class="p">]]):</span>
                        <span class="n">std2i</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">std2i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std1i</span><span class="p">]]</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: For </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> only one standard&#39;</span>\
                            <span class="s1">&#39; available</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">std1i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std1i</span><span class="p">]])</span> <span class="ow">and</span> <span class="n">std2i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std2i</span><span class="p">]]</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: For </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> only one standard&#39;</span>\
                            <span class="s1">&#39; available</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">std2i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std2i</span><span class="p">]])</span> <span class="ow">and</span> <span class="n">std1i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std1i</span><span class="p">]]</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: For </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> only one standard&#39;</span>\
                            <span class="s1">&#39; available</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">o1</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">std1i</span>
                        <span class="n">o2</span> <span class="o">=</span> <span class="n">std2i</span> <span class="o">-</span> <span class="n">i</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std1i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">o2</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">drifts2</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">se</span><span class="p">[</span><span class="n">std2i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">o1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">o1</span> <span class="o">+</span> <span class="n">o2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;#BUF&#39;</span><span class="p">:</span>
                        <span class="n">lastbuf</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">typ</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins_drifts</span><span class="p">:</span>
                            <span class="n">proteins_drifts</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins_drifts</span><span class="p">[</span><span class="n">typ</span><span class="p">]:</span>
                            <span class="n">proteins_drifts</span><span class="p">[</span><span class="n">typ</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">prev</span> <span class="o">!=</span> <span class="n">typ</span><span class="p">:</span>
                            <span class="n">proteins_drifts</span><span class="p">[</span><span class="n">typ</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;ctrl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastbuf</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
                            <span class="n">tab</span> <span class="o">=</span> <span class="n">add_row</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;CTL&#39;</span><span class="p">,</span> <span class="n">lastbuf</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>
                        <span class="n">proteins_drifts</span><span class="p">[</span><span class="n">typ</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">d</span>
                        <span class="n">tab</span> <span class="o">=</span> <span class="n">add_row</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">)</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="k">if</span> <span class="n">write_table</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">write_table</span><span class="p">)</span> <span class="ow">in</span> <span class="n">charTypes</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">write_table</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span>
                        <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">),</span>
                        <span class="n">tab</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: Table written to file </span><span class="si">%s</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">write_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span> <span class="o">=</span>  <span class="n">proteins_drifts</span>
    
    <span class="k">def</span> <span class="nf">drifts_from_marco</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Reading recalibration data from Marco`s table</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recalfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">null</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="n">neg_ppm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">pos_ppm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">frac</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ctrl&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracsU</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">frac</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_ppm</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="n">frac</span><span class="p">]</span> <span class="o">=</span> <span class="n">neg_ppm</span>

    <span class="k">def</span> <span class="nf">remove_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">&lt;</span> \
            <span class="n">m</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">data</span><span class="p">))]</span>

    <span class="k">def</span> <span class="nf">ratio2ppm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0e06</span>

    <span class="k">def</span> <span class="nf">ppm2ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppm</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">ppm</span> <span class="o">/</span> <span class="mf">1.0e06</span>

    <span class="k">def</span> <span class="nf">standards_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">measured</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">lipid</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdmasses</span><span class="p">[</span><span class="n">mode</span><span class="p">]):</span>
            <span class="n">_mz</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span>
            <span class="n">ui</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">_mz</span><span class="p">)</span>
            <span class="n">ud</span> <span class="o">=</span> <span class="mf">999.0</span> <span class="k">if</span> <span class="n">ui</span> <span class="o">&gt;=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">peaks</span><span class="p">[</span><span class="n">ui</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">_mz</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="mf">999.0</span> <span class="k">if</span> <span class="n">ui</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">_mz</span> <span class="o">-</span> <span class="n">peaks</span><span class="p">[</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">ui</span> <span class="k">if</span> <span class="n">ud</span> <span class="o">&lt;</span> <span class="n">ld</span> <span class="k">else</span> <span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">mz</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">_mz</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_tlr</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">measured</span><span class="p">[</span><span class="n">lipid</span><span class="p">]</span> <span class="o">=</span> <span class="n">mz</span>
        <span class="k">return</span> <span class="n">measured</span>

    <span class="k">def</span> <span class="nf">_process_binary_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binaryarray</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;{http://psi.hupo.org/ms/mzml}&#39;</span>
        <span class="n">cvparam</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">cvParam&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">_binary</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">binary&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">binaryarray</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">cvparam</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;ssion&#39;</span><span class="p">:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;zlib&#39;</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="n">binaryarray</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">_binary</span><span class="p">)</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">decodestring</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
        <span class="c1"># length is stated in the spectrum tag, but knowing the data type</span>
        <span class="c1"># we can also calculate:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">length</span>
        <span class="c1"># float or double:</span>
        <span class="n">_typ</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span> <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;64&#39;</span> <span class="k">else</span> <span class="s1">&#39;f&#39;</span>
        <span class="c1"># mzml binary data must be always little endian:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">_typ</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dt</span><span class="p">)</span>
        <span class="c1"># this does the same:</span>
        <span class="c1"># arr = struct.unpack(&#39;&lt;%u%s&#39; % (length, _typ), decoded)</span>
        <span class="c1"># arr = np.array(arr, dtype = np.float32)</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">arr</span>

    <span class="k">def</span> <span class="nf">_centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a Gauss fit to centroid the peaks for the property</span>
<span class="sd">        Code from http://pymzml.github.io/_modules/spec.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;m/z&#39;</span> <span class="ow">in</span> <span class="n">raw</span> <span class="ow">and</span> <span class="s1">&#39;intensity&#39;</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span>
            <span class="n">mz</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="s1">&#39;m/z&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ins</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intensity</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ins</span> <span class="o">&gt;</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">mz</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="n">mz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">x3</span> <span class="o">=</span> <span class="n">mz</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">y2</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">y3</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="ow">or</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">y3</span> <span class="o">==</span> <span class="n">y1</span><span class="p">:</span>
                        <span class="n">lower</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="n">upper</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y2</span> <span class="o">&gt;</span> <span class="n">y3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> \
                            <span class="n">y1</span> <span class="o">==</span> <span class="n">y3</span> <span class="ow">and</span> <span class="n">upper</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">-</span> <span class="n">lower</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">i_lower</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">i_lower</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">lower</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">upper</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mz</span><span class="p">):</span>
                                <span class="n">i_upper</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">i_upper</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">upper</span>
                            <span class="n">x1</span> <span class="o">=</span> <span class="n">mz</span><span class="p">[</span><span class="n">i_lower</span><span class="p">]</span>
                            <span class="n">x3</span> <span class="o">=</span> <span class="n">mz</span><span class="p">[</span><span class="n">i_upper</span><span class="p">]</span>
                            <span class="n">y1</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i_lower</span><span class="p">]</span>
                            <span class="n">y3</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i_upper</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">lower</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">upper</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">lower</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y2</span> <span class="o">&gt;</span> <span class="n">y3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">y1</span> <span class="o">==</span> <span class="n">y3</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">logratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y2</span> <span class="o">/</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y3</span> <span class="o">/</span> <span class="n">y1</span><span class="p">)</span>
                        <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">logratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logratio</span><span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x1</span><span class="p">))</span>
                        <span class="n">csquared</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">+</span> \
                                <span class="mi">2</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y1</span> <span class="o">/</span> <span class="n">y2</span><span class="p">))</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">csquared</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">mu</span><span class="p">,</span> <span class="n">a</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<div class="viewcode-block" id="Screening.find_peaks"><a class="viewcode-back" href="../../index.html#emese.main.Screening.find_peaks">[docs]</a>    <span class="k">def</span> <span class="nf">find_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scans</span><span class="p">,</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">dope</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds peaks detected in consecutive scans.</span>
<span class="sd">        Returns list of dicts with centroid m/z,</span>
<span class="sd">        cumulative intensity and RT range for</span>
<span class="sd">        each peak.</span>
<span class="sd">        Returns array with </span>
<span class="sd">        m/z, rt_min, rt_max, area, scan count</span>
<span class="sd">        as coulumns.</span>
<span class="sd">        </span>
<span class="sd">        accuracy : int, float</span>
<span class="sd">            Instrument accuracy in ppm.</span>
<span class="sd">            The difference over we consider 2</span>
<span class="sd">            m/z values to be distinct.</span>
<span class="sd">        </span>
<span class="sd">        # values order: (rt, mz, int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">1000000.0</span> <span class="o">/</span> <span class="n">accuracy</span>
        <span class="k">for</span> <span class="n">scan</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">centroids</span><span class="p">):</span>
            <span class="n">centroids</span><span class="p">[</span><span class="n">scan</span><span class="p">][</span><span class="s1">&#39;centroids&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">c</span><span class="p">[</span><span class="s1">&#39;centroids&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;centroids&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),:]</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">consecutive</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">def</span> <span class="nf">get_id</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">i</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">_peakid</span> <span class="o">=</span> <span class="n">get_id</span><span class="p">()</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">),</span> <span class="s1">&#39;Processing scans&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">centroids</span><span class="p">:</span>
                <span class="n">_scan</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="n">scan</span><span class="p">][</span><span class="s1">&#39;centroids&#39;</span><span class="p">]</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="n">centroids</span><span class="p">[</span><span class="n">scan</span><span class="p">][</span><span class="s1">&#39;rt&#39;</span><span class="p">]</span>
                <span class="n">added</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">peakid</span><span class="p">,</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">consecutive</span><span class="p">):</span>
                    <span class="n">ld</span> <span class="o">=</span> <span class="n">ud</span> <span class="o">=</span> <span class="mf">999.0</span>
                    <span class="n">cons_mz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cons</span><span class="p">))</span>
                    <span class="n">cons_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cons</span><span class="p">))</span>
                    <span class="n">cons_centroid_mz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cons_mz</span> <span class="o">*</span> <span class="n">cons_in</span><span class="p">)</span> <span class="o">/</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cons_in</span><span class="p">)</span>
                    <span class="n">ui</span> <span class="o">=</span> <span class="n">_scan</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cons_centroid_mz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ui</span> <span class="o">&lt;</span> <span class="n">_scan</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">ud</span> <span class="o">=</span> <span class="n">_scan</span><span class="p">[</span><span class="n">ui</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cons_centroid_mz</span>
                    <span class="k">if</span> <span class="n">ui</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ld</span> <span class="o">=</span> <span class="n">cons_centroid_mz</span> <span class="o">-</span> <span class="n">_scan</span><span class="p">[</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">ci</span> <span class="o">=</span> <span class="n">ui</span> <span class="k">if</span> <span class="n">ud</span> <span class="o">&lt;</span> <span class="n">ld</span> <span class="k">else</span> <span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">dope</span> <span class="ow">and</span> <span class="n">_dope</span><span class="p">(</span><span class="n">cons_centroid_mz</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: This mz looks DOPE: </span><span class="si">%f</span><span class="s1">, closest in&#39;</span>\
                            <span class="s1">&#39; this scan (</span><span class="si">%u</span><span class="s1">): </span><span class="si">%f</span><span class="s1">; accuracy: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">cons_centroid_mz</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">_scan</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                <span class="n">cons_centroid_mz</span> <span class="o">/</span> <span class="n">accuracy</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_scan</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cons_centroid_mz</span><span class="p">)</span> <span class="o">&lt;=</span> \
                        <span class="n">cons_centroid_mz</span> <span class="o">/</span> <span class="n">accuracy</span><span class="p">:</span>
                        <span class="c1"># same m/z detected in another consecutive scan:</span>
                        <span class="n">consecutive</span><span class="p">[</span><span class="n">peakid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">_scan</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">_scan</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">dope</span> <span class="ow">and</span> <span class="n">_dope</span><span class="p">(</span><span class="n">_scan</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: DOPE found in next scan, &#39;</span>\
                                <span class="s1">&#39;appended to consecutive series: </span><span class="si">%u</span><span class="s1">, </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">_scan</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="c1"># this index won&#39;t initiate a new consecutive series:</span>
                        <span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ci</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># this consecutive series interrupted here,</span>
                        <span class="c1"># so move it to the peaks stack:</span>
                        <span class="n">cons_rt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cons</span><span class="p">))</span>
                        <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                            <span class="n">cons_centroid_mz</span><span class="p">,</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">cons_rt</span><span class="p">),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">cons_rt</span><span class="p">),</span>
                            <span class="n">cons_in</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">cons</span><span class="p">)</span>
                        <span class="p">])</span>
                        <span class="k">if</span> <span class="n">dope</span> <span class="ow">and</span> <span class="n">_dope</span><span class="p">(</span><span class="n">cons_centroid_mz</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: DOPE series interrupted, moved to &#39;</span>\
                                <span class="s1">&#39;peaks stack: </span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="n">cons_centroid_mz</span><span class="p">,</span> <span class="n">cons_in</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
                        <span class="n">to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">peakid</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">peakid</span> <span class="ow">in</span> <span class="n">to_remove</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">consecutive</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">del</span> <span class="n">consecutive</span><span class="p">[</span><span class="n">peakid</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">ins</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_scan</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">added</span><span class="p">:</span>
                        <span class="n">peakid</span> <span class="o">=</span> <span class="n">_peakid</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                        <span class="n">consecutive</span><span class="p">[</span><span class="n">peakid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">rt</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">ins</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">dope</span> <span class="ow">and</span> <span class="n">_dope</span><span class="p">(</span><span class="n">mz</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: New DOPE found, &#39;</span>\
                                <span class="s1">&#39;new consecutive series started&#39;</span>\
                                <span class="s1">&#39;: scan </span><span class="si">%u</span><span class="s1">, m/z = </span><span class="si">%f</span><span class="s1">, peakid = </span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">peakid</span><span class="p">))</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="n">peaks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),:]</span>
        <span class="k">return</span> <span class="n">peaks</span></div>

    <span class="k">def</span> <span class="nf">_dope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mz</span> <span class="o">&lt;</span> <span class="mf">742.5331</span> <span class="ow">and</span> <span class="n">mz</span> <span class="o">&gt;</span> <span class="mf">742.530</span>

    <span class="k">def</span> <span class="nf">filter_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">min_scans</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">min_area</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">peaks</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_scans</span><span class="p">,</span>
                <span class="n">peaks</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_area</span>
            <span class="p">)</span>
        <span class="p">)]</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="n">peaks</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">(),:]</span>
        <span class="k">return</span> <span class="n">peaks</span>

    <span class="k">def</span> <span class="nf">read_mzml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;{http://psi.hupo.org/ms/mzml}&#39;</span>
        <span class="n">run</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">run&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">spectrum&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">cvparam</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">cvParam&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">binarraylist</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">binaryDataArrayList&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">binarray</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">binaryDataArray&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">scanlist</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">scanList&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">scan&#39;</span> <span class="o">%</span> <span class="n">prefix</span>
        <span class="n">mslevel</span> <span class="o">=</span> <span class="s1">&#39;ms level&#39;</span>
        <span class="n">basepeakmz</span> <span class="o">=</span> <span class="s1">&#39;base peak m/z&#39;</span>
        <span class="n">basepeakin</span> <span class="o">=</span> <span class="s1">&#39;base peak intensity&#39;</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="s1">&#39;scan start time&#39;</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">centroids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Reading file `</span><span class="si">%s</span><span class="s1">`</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">mzml</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,))</span>
            <span class="n">ms1</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ev</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">mzml</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">run</span><span class="p">:</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;startTimeStamp&#39;</span><span class="p">]</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                            <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">:</span>
                        <span class="n">ms1</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;defaultArrayLength&#39;</span><span class="p">]</span>
                        <span class="n">scanid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">cvp</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">cvparam</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">cvp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mslevel</span><span class="p">:</span>
                                <span class="n">level</span> <span class="o">=</span> <span class="n">cvp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">level</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">ms1</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">cvp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">basepeakmz</span><span class="p">:</span>
                                <span class="n">mz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cvp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">cvp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">basepeakin</span><span class="p">:</span>
                                <span class="n">intensity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cvp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">ms1</span><span class="p">:</span>
                            <span class="n">_scan</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">scanlist</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">cvp</span> <span class="ow">in</span> <span class="n">_scan</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">cvparam</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">cvp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">starttime</span><span class="p">:</span>
                                    <span class="n">rt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cvp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                            <span class="n">raw</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">bda</span> <span class="ow">in</span> <span class="n">elem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">binarraylist</span><span class="p">)</span><span class="o">.</span>\
                                <span class="n">findall</span><span class="p">(</span><span class="n">binarray</span><span class="p">):</span>
                                <span class="n">name</span><span class="p">,</span> <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_binary_array</span><span class="p">(</span><span class="n">bda</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                                <span class="n">raw</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
                            <span class="n">_centroids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_centroid</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                            <span class="n">scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scanid</span><span class="p">)</span>
                            <span class="n">centroids</span><span class="p">[</span><span class="n">scanid</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="p">{</span><span class="s1">&#39;rt&#39;</span><span class="p">:</span> <span class="n">rt</span><span class="p">,</span> <span class="s1">&#39;centroids&#39;</span><span class="p">:</span> <span class="n">_centroids</span><span class="p">}</span>
            <span class="k">except</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">XMLSyntaxError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">WARNING: XML processing error: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">scans</span><span class="p">,</span> <span class="n">centroids</span>

<div class="viewcode-block" id="Screening.dope"><a class="viewcode-back" href="../../index.html#emese.main.Screening.dope">[docs]</a>    <span class="k">def</span> <span class="nf">dope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tells whether if a series of m/z&#39;s might be DOPE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">c</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">742.52</span><span class="p">,</span> <span class="n">c</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">742.54</span><span class="p">))</span></div>

    <span class="c1">#</span>
    <span class="c1"># scanning the directory tree and collecting the MS data csv files</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="Screening.get_filenames"><a class="viewcode-back" href="../../index.html#emese.main.Screening.get_filenames">[docs]</a>    <span class="k">def</span> <span class="nf">get_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Files are placed in 2 root directories, in specific subdirectories,</span>
<span class="sd">        positive and negative MS mode in separate files.</span>
<span class="sd">        This function collects all the file paths and returns them </span>
<span class="sd">        in a dict of dicts. Keys are LTP names, and &#39;pos&#39;/&#39;neg&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redirname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(^[0-9a-zA-Z]+)[ _]&#39;</span><span class="p">)</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">datadlsts</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dd</span><span class="p">)),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">datadirs</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">datadlsts</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Please mount the shared folder!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fnames</span>
        
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">proteindl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadirs</span><span class="p">,</span> <span class="n">datadlsts</span><span class="p">):</span>
            
            <span class="k">for</span> <span class="n">proteind</span> <span class="ow">in</span> <span class="n">proteindl</span><span class="p">:</span>
                
                <span class="n">protein</span> <span class="o">=</span> <span class="n">redirname</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">proteind</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span> <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">proteind</span> \
                    <span class="k">else</span> <span class="s1">&#39;neg&#39;</span> <span class="k">if</span> <span class="s1">&#39;neg&#39;</span> <span class="ow">in</span> <span class="n">proteind</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">protein</span> <span class="o">=</span> <span class="n">protein</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="p">[</span><span class="n">proteind</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">fpath</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="s1">&#39;LABELFREE&#39;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="s1">&#39;features&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">fpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">fpath</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
                            <span class="n">fpath</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
                        <span class="n">fnames</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">or</span> <span class="n">proteind</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">):</span>
                        <span class="n">fnames</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datafiles</span> <span class="o">=</span> <span class="n">fnames</span></div>

<div class="viewcode-block" id="Screening.read_file_np"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_file_np">[docs]</a>    <span class="k">def</span> <span class="nf">read_file_np</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">read_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Normalized Area&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads one MS file, returns numpy array,</span>
<span class="sd">        with void mask.</span>
<span class="sd">        Column order:</span>
<span class="sd">        quality, m/z, significance,</span>
<span class="sd">        rt-min, rt-max, charge, rtmean, avg.area,</span>
<span class="sd">        control, a9, a10, a11, a12, b1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># typos in the headers what need to be fixed</span>
        <span class="n">typos</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Sample 5&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Sample 6&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_ &#39;</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span>
        <span class="p">}</span>
        <span class="n">rehdr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([_0-9a-zA-Z]+)[_\s]([/0-9a-zA-Z\s]+)&#39;</span><span class="p">)</span>
        <span class="n">refra</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*_[0-9]??([a-zA-Z]?)([0-9]{1,2}).*&#39;</span><span class="p">)</span>
        <span class="n">retyp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">typos</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="c1"># order of fractions (fractions)</span>
        <span class="n">prows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">]</span>
        <span class="c1"># variable names</span>
        <span class="n">vname</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;m/z&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;RT mean&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;Normalized Area&#39;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">}</span>
        <span class="c1"># the dict which will be returned contains the</span>
        <span class="c1"># variables to be read, and the annotations</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">vname</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;annot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#</span>
        <span class="n">rtmkey</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;RT&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="n">rtmcol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">retyp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                    <span class="n">typos</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">()],</span>
                <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hdr</span><span class="p">):</span>
                <span class="n">this_hdr</span> <span class="o">=</span> <span class="n">rehdr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">this_hdr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">this_hdr</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">rtmkey</span><span class="p">:</span>
                    <span class="n">rtmcol</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">rtmcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Could not find RT mean&#39;</span>
                                    <span class="s1">&#39; column in file </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> \
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">rehdr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="mi">0</span><span class="p">))])</span> \
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">7</span><span class="p">])]</span>
            
            <span class="n">fracs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">prow_prev</span><span class="p">,</span> <span class="n">pcol_prev</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;ctrl&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;ctlr&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;secbuffer&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">prow</span><span class="p">,</span> <span class="n">pcol</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prow</span><span class="p">,</span> <span class="n">pcol</span> <span class="o">=</span> <span class="n">refra</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">prow</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">pcol_prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">pcol_prev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pcol</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">prow</span> <span class="o">=</span> <span class="n">prow_prev</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">prow</span> <span class="o">=</span> <span class="n">prows</span><span class="p">[</span><span class="n">prows</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">prow_prev</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">prow_prev</span><span class="p">,</span> <span class="n">pcol_prev</span> <span class="o">=</span> <span class="n">prow</span><span class="p">,</span> <span class="n">pcol</span>
                <span class="n">fracs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prow</span><span class="p">,</span> <span class="n">pcol</span><span class="p">))</span>
            
            <span class="c1"># col nums for each variable, for each fraction</span>
            <span class="n">scols</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fracs</span><span class="p">]))</span> \
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vname</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            
            <span class="c1"># testing if order of columns is always</span>
            <span class="c1"># m/z, RT, norm area; all files passed</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">!=</span> <span class="n">vname</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]]:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;erroneous column order: col </span><span class="si">%u</span><span class="s1"> &#39;</span>\
                        <span class="s1">&#39;with header </span><span class="si">%s</span><span class="se">\n\t</span><span class="s1">in file </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fname</span><span class="p">))</span>
                <span class="n">fnum</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># assigning columns to variable-&gt;fraction slots</span>
                <span class="c1"># col offsets from 6</span>
                <span class="n">scols</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="n">fnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
            
            <span class="c1"># now sorting fractions:</span>
            <span class="n">fracs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fracs</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># removing first column</span>
                <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c1"># reading annotations</span>
                <span class="n">annot</span> <span class="o">=</span> \
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="p">]</span> <span class="o">+</span> \
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span> <span class="o">+</span> \
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">rtmcol</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="p">]</span>
                
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;annot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>
                
                <span class="n">ldata</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">fracs</span><span class="p">:</span>
                    <span class="c1"># number of columns depends on which variables we need</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">read_vars</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ldata</span><span class="p">:</span>
                            <span class="n">ldata</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        
                        <span class="n">cnum</span> <span class="o">=</span> <span class="n">scols</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">fr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        
                        <span class="k">if</span> <span class="n">cnum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ldata</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># col offset is 6 !</span>
                            <span class="n">ldata</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">cnum</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]))</span>
                
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">read_vars</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ldata</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">mzsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;annot&#39;</span><span class="p">][:,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">datalen</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;annot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> \
            <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mzsort</span><span class="p">]),</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">datalen</span><span class="p">,</span>
                        <span class="n">iteritems</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">fracs</span></div>
    
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Screening.sort_fracs_str"><a class="viewcode-back" href="../../index.html#emese.main.Screening.sort_fracs_str">[docs]</a>    <span class="k">def</span> <span class="nf">sort_fracs_str</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">frs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sorts fraction labels in a standard way, i.e. first by</span>
<span class="sd">        their letter code, after their number as numeric value.</span>
<span class="sd">        Accepts list of strings, returns list of strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                        <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">sort_fracs_tuple</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                                <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                            <span class="n">frs</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>
    
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Screening.sort_fracs_tuple"><a class="viewcode-back" href="../../index.html#emese.main.Screening.sort_fracs_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">sort_fracs_tuple</span><span class="p">(</span><span class="n">frs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sorts fraction labels in a standard way, i.e. first by</span>
<span class="sd">        their letter code, after their number as numeric value.</span>
<span class="sd">        Accepts list of tuples, returns list of tuples.</span>
<span class="sd">        Numbers can be either string or integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">frs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">frs</span><span class="p">),</span>
                      <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span></div>
    
<div class="viewcode-block" id="Screening.read_data"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates through dict of dicts with file paths, reads</span>
<span class="sd">        each file, and makes array view and masks to make it easy</span>
<span class="sd">        to handle missing data, and access m/z values of fractions </span>
<span class="sd">        and controls, and other values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">get_indices</span><span class="p">(</span><span class="n">sfracs</span><span class="p">,</span> <span class="n">cfracs</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
            <span class="k">return</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span>
                                <span class="n">fr</span> <span class="o">!=</span> <span class="s1">&#39;X0&#39;</span> <span class="ow">and</span> <span class="n">fun</span><span class="p">(</span><span class="n">cfracs</span><span class="p">[</span><span class="n">fr</span><span class="p">]),</span>
                            <span class="n">sfracs</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="n">pfracs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafiles</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="s1">&#39;Reading features (MS1 data)&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">_protein</span><span class="p">,</span> <span class="n">pos_neg</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafiles</span><span class="p">):</span>
            
            <span class="n">protein</span> <span class="o">=</span> <span class="n">_protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fractions&#39;</span><span class="p">):</span>
                <span class="n">cfracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cfracs</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">pos_neg</span><span class="p">):</span>
                
                <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                
                <span class="c1">#try:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># this returns an array and the fraction sequence:</span>
                <span class="n">pdata</span><span class="p">,</span> <span class="n">fracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_file_np</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="n">ifracs</span><span class="p">,</span> <span class="n">sfracs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_fracs_tuple</span><span class="p">(</span><span class="n">fracs</span><span class="p">))</span>
                <span class="n">sfracs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fr</span><span class="p">,</span> <span class="n">sfracs</span><span class="p">))</span>
                <span class="n">pfracs</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sfracs</span><span class="p">)</span>
                <span class="c1"># rearrange columns according to fraction sequence:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">pdata</span><span class="p">[</span><span class="s1">&#39;Normalized Area&#39;</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ifracs</span><span class="p">)]</span>
                <span class="c1">#</span>
                <span class="c1"># another thing we need are the annotations:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ann&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[</span><span class="s1">&#39;annot&#39;</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="c1"># making a view with the intensities:</span>
                <span class="c1"># (this would not be necessary any more,</span>
                <span class="c1"># it was when these were in the same array</span>
                <span class="c1"># as annotations)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;int&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span>
                <span class="c1">#</span>
                
                <span class="k">if</span> <span class="n">cfracs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># making a view with measured:</span>
                    <span class="n">imes</span> <span class="o">=</span> <span class="n">get_indices</span><span class="p">(</span><span class="n">sfracs</span><span class="p">,</span> <span class="n">cfracs</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                    
                    <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;mes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;int&#39;</span><span class="p">][:,</span><span class="n">imes</span><span class="p">]</span>
                    <span class="c1">#</span>
                    <span class="c1"># making a view with the controls:</span>
                    <span class="n">ictr</span> <span class="o">=</span> <span class="n">get_indices</span><span class="p">(</span><span class="n">sfracs</span><span class="p">,</span> <span class="n">cfracs</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    
                    <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ctr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;int&#39;</span><span class="p">][:,</span><span class="n">ictr</span><span class="p">]</span>
                    <span class="c1">#</span>
                    <span class="c1"># fractions with lipids:</span>
                    
                    <span class="n">ilip</span> <span class="o">=</span> <span class="n">get_indices</span><span class="p">(</span><span class="n">sfracs</span><span class="p">,</span> <span class="n">cfracs</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    
                    <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;lip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;int&#39;</span><span class="p">][:,</span><span class="n">ilip</span><span class="p">]</span>
                    <span class="c1">#</span>
                    <span class="c1"># all fractions except blank control:</span>
                    <span class="k">if</span> <span class="n">sfracs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;X0&#39;</span><span class="p">:</span>
                        <span class="n">imes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    
                    <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;smp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;int&#39;</span><span class="p">][:,</span><span class="n">imes</span><span class="p">]</span>
                
                <span class="c1"># average area:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;aa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ann&#39;</span><span class="p">][:,</span><span class="mi">7</span><span class="p">]</span>
        
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pfracs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfracs</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfracs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pfracs</span><span class="p">)</span></div>
    
    <span class="c1">#</span>
    <span class="c1"># Generic helper functions</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="Screening.to_float"><a class="viewcode-back" href="../../index.html#emese.main.Screening.to_float">[docs]</a>    <span class="k">def</span> <span class="nf">to_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts float from string, or returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">renum</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([-]?[0-9]*[\.]?[0-9]+[eE]?[-\+]?[0-9]*)&#39;</span><span class="p">)</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">renum</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fnum</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">fnum</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;-inf&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Screening.to_int"><a class="viewcode-back" href="../../index.html#emese.main.Screening.to_int">[docs]</a>    <span class="k">def</span> <span class="nf">to_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts int from string or returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">renum</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([-]?[0-9]+[\.]?[0-9]*)&#39;</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">renum</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">num</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span></div>

<div class="viewcode-block" id="Screening.float_lst"><a class="viewcode-back" href="../../index.html#emese.main.Screening.float_lst">[docs]</a>    <span class="k">def</span> <span class="nf">float_lst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts elements of a list to floats.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filtering functions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">quality_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">charge_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">charge</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">rt1_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtmin</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rtm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][:,</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rtm&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rtmin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">area_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">):</span>
        <span class="n">area</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_original_average_area</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">area</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">area</span>

    <span class="k">def</span> <span class="nf">peaksize_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peakmin</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">peakmax</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="c1"># minimum and maximum of all intensities over all proteins:</span>
        
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Peak size filter&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">mini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">,:],</span> <span class="mi">1</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                
                <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">])</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim02&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
                                    <span class="n">mini</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxi</span> <span class="o">-</span> <span class="n">mini</span><span class="p">))</span> <span class="o">*</span>
                        <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">peakmin</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim05&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
                                    <span class="n">mini</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxi</span> <span class="o">-</span> <span class="n">mini</span><span class="p">)</span> <span class="o">*</span>
                        <span class="p">(</span><span class="mf">5.0</span> <span class="o">-</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">peakmin</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim10&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
                                    <span class="n">mini</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxi</span> <span class="o">-</span> <span class="n">mini</span><span class="p">))</span> <span class="o">*</span>
                        <span class="p">(</span><span class="mf">10.0</span> <span class="o">-</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">peakmin</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim510&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
                                     <span class="n">mini</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxi</span> <span class="o">-</span> <span class="n">mini</span><span class="p">))</span> <span class="o">*</span>
                        <span class="p">(</span><span class="mf">10.0</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="c1"># the peaksize:</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> \
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>
                    <span class="c1"># must be larger:</span>
                    <span class="o">&gt;</span>
                    <span class="c1"># than the min peaksize as a function of intensity:</span>
                    <span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">mini</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxi</span> <span class="o">-</span> <span class="n">mini</span><span class="p">))</span> <span class="o">*</span>
                        <span class="p">(</span><span class="n">peakmax</span> <span class="o">-</span> <span class="n">peakmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">peakmin</span><span class="p">)</span>
                <span class="p">)</span>
        
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">cprofile_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">profile_filter</span><span class="p">(</span><span class="n">prfx</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">profile_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prfx</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">frs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;a9&#39;</span><span class="p">,</span> <span class="s1">&#39;a10&#39;</span><span class="p">,</span> <span class="s1">&#39;a11&#39;</span><span class="p">,</span> <span class="s1">&#39;a12&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">]</span>
        <span class="n">notf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="s1">&#39;smp&#39;</span> <span class="k">if</span> <span class="n">prfx</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="k">else</span> <span class="s1">&#39;lip&#39;</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Profile filter&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span><span class="p">:</span>
                    <span class="n">notf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># i != 0 : we always drop the blank control</span>
                <span class="n">ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span><span class="p">[</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">frs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> \
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span> \
                        <span class="k">if</span> <span class="n">fr</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_profile</span><span class="p">(</span><span class="n">ppr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">prr</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">ppr</span><span class="p">)</span>
                <span class="n">pranks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prr</span><span class="p">)),</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="n">cols</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">flatp</span> <span class="o">=</span> <span class="n">ppr</span><span class="p">[</span><span class="n">pranks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">ppr</span><span class="p">[</span><span class="n">pranks</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&lt;</span> \
                        <span class="n">ppr</span><span class="p">[</span><span class="n">pranks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mf">0.1</span>
                <span class="c1"># 0 if have only one fraction in sample</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">prf&#39;</span><span class="o">%</span><span class="n">prfx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_profiles</span><span class="p">(</span><span class="n">ppr</span><span class="p">,</span> <span class="n">norm_profile</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
                        <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>
                <span class="c1"># all True if have only one fraction in sample</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">rpr&#39;</span><span class="o">%</span><span class="n">prfx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">tbl</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_profiles</span><span class="p">(</span><span class="n">ppr</span><span class="p">,</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">norm_profile</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">prr</span><span class="p">,</span> <span class="n">flatp</span><span class="p">),</span>
                        <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No protein profiles found for </span><span class="si">%s</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notf</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">diff_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
        <span class="c1"># profiles are numpy arrays</span>
        <span class="c1"># of equal length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_comp_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
        <span class="n">p1r</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
        <span class="n">pranks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p1r</span><span class="p">)),</span> 
            <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">flatp</span> <span class="o">=</span> <span class="n">p1r</span><span class="p">[</span><span class="n">pranks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">p1r</span><span class="p">[</span><span class="n">pranks</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&lt;</span> \
            <span class="n">p1r</span><span class="p">[</span><span class="n">pranks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_profiles</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p1r</span><span class="p">,</span> <span class="n">flatp</span><span class="p">),</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">comp_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p1r</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">flatp</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">highest</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hollow</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">p2r</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p1r</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">p1r</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
        <span class="n">highest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">p1r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p2r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">p2ranks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p2r</span><span class="p">)),</span> 
            <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">hollow</span> <span class="o">=</span> <span class="n">p1r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">p2r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">highest</span><span class="p">:</span>
            <span class="n">flat</span> <span class="o">=</span> <span class="n">flatp</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> \
                <span class="n">p2</span><span class="p">[</span><span class="n">p2ranks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="n">p2ranks</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&lt;</span> \
                    <span class="n">p2</span><span class="p">[</span><span class="n">p2ranks</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">hollow</span> <span class="ow">and</span> <span class="p">(</span><span class="n">highest</span> <span class="ow">or</span> <span class="n">flat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">norm_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">profile</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)))</span> <span class="o">/</span> \
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">norm_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span> <span class="o">/</span> \
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ubiquity_filter_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">only_valid</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Ubiquity filter&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">protein1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proteins</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">protein2</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">protein1s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="n">protein2s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pn</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">protein1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">pn</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">protein2</span><span class="p">]:</span>
                        <span class="n">protein1t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein1</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span>
                        <span class="n">protein2t</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein2</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;ubi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein1t</span><span class="p">:</span>
                            <span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">],</span> \
                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;ubi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein2t</span><span class="p">:</span>
                            <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">],</span> \
                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">mz1</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">i2u</span> <span class="o">=</span> <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz1</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">i2u</span> <span class="o">&lt;</span> <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                                <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="n">i2u</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">i1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein1s</span><span class="p">:</span>
                                    <span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">protein1s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i1</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">i2u</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein2s</span><span class="p">:</span>
                                    <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">i2u</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">protein2s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i2u</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">mz1</span> <span class="o">-</span> <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="n">i2u</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">i1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein1s</span><span class="p">:</span>
                                    <span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">protein1s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i1</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">i2u</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein2s</span><span class="p">:</span>
                                    <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">i2u</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="n">protein2s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i2u</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ubiquity_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">only_valid</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Ubiquity filter&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">protein1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">proteins</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">protein2</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">protein1s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="n">protein2s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">pn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein2</span><span class="p">]:</span>
                        <span class="n">protein1t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein1</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span>
                        <span class="n">protein2t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein2</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;ubi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein1t</span><span class="p">:</span>
                            <span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;ubi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein2t</span><span class="p">:</span>
                            <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">mz1</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;cpv&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_valid</span><span class="p">:</span>
                                <span class="n">i2u</span> <span class="o">=</span> <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz1</span><span class="p">)</span>
                                <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">i2u</span> <span class="o">+</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                                        <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i2u</span> <span class="o">+</span> <span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz1</span> <span class="o">&lt;=</span> \
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;cpv&#39;</span><span class="p">][</span><span class="n">i2u</span> <span class="o">+</span> <span class="n">u</span><span class="p">]</span> <span class="ow">or</span> \
                                            <span class="ow">not</span> <span class="n">only_valid</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">i1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein1s</span><span class="p">:</span>
                                                <span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                                <span class="n">protein1s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i1</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">i2u</span> <span class="o">+</span> <span class="n">u</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein2s</span><span class="p">:</span>
                                                <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">i2u</span> <span class="o">+</span> <span class="n">u</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                                <span class="n">protein2s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i2u</span> <span class="o">+</span> <span class="n">u</span><span class="p">)</span>
                                        <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">break</span>
                                <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">i2u</span> <span class="o">-</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> \
                                        <span class="n">mz1</span> <span class="o">-</span> <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i2u</span> <span class="o">-</span> <span class="n">l</span><span class="p">]</span> <span class="o">&lt;=</span> \
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;cpv&#39;</span><span class="p">][</span><span class="n">i2u</span> <span class="o">-</span> <span class="n">l</span><span class="p">]</span> <span class="ow">or</span> \
                                            <span class="ow">not</span> <span class="n">only_valid</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">i1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein1s</span><span class="p">:</span>
                                                <span class="n">protein1t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                                <span class="n">protein1s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i1</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">i2u</span> <span class="o">-</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protein2s</span><span class="p">:</span>
                                                <span class="n">protein2t</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">i2u</span> <span class="o">-</span> <span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                                <span class="n">protein2s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i2u</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
                                        <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">break</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    
<div class="viewcode-block" id="Screening.remove_filter"><a class="viewcode-back" href="../../index.html#emese.main.Screening.remove_filter">[docs]</a>    <span class="k">def</span> <span class="nf">remove_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes the result of a previously done filtering.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">tbl</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="Screening.rprofile_filter"><a class="viewcode-back" href="../../index.html#emese.main.Screening.rprofile_filter">[docs]</a>    <span class="k">def</span> <span class="nf">rprofile_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dummy function for eval_filter()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
    <span class="k">class</span> <span class="nc">get_hits</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span>
        
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">empty_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">]):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No profile info for </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">()</span><span class="se">\n</span><span class="s1">&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">class</span> <span class="nc">combine_filters</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span>
        
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
        
        <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">instance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">owner</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span>
    
    <span class="k">class</span> <span class="nc">count_hits</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span>
        
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">empty_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">phits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">empty_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">hits</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">phits</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">/</span> \
                            <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]))</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">return</span> <span class="n">hits</span><span class="p">,</span> <span class="n">phits</span>
        
        <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">instance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">owner</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span>
    
    <span class="nd">@get_hits</span>
    <span class="k">def</span> <span class="nf">val_ubi_prf_rpr_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">ubiquity</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">treshold</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
        <span class="n">tresholdB</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">profile_best</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Column order:</span>
<span class="sd">        quality, m/z, rt_min, rt_max, charge, control, a9, a10, a11, a12, b1,</span>
<span class="sd">        profile_score, control_profile_score, rank_profile_boolean,</span>
<span class="sd">        ubiquity_score, ubiquity_score,</span>
<span class="sd">        original_index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prf</span> <span class="o">=</span> <span class="s1">&#39;cprf&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;prf&#39;</span>
        <span class="n">_treshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">treshold</span><span class="p">,</span> <span class="n">tresholdB</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># dict of profile matching score values and their indices</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span>
                            <span class="p">),</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rpr&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ubiquity</span>
            <span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">])</span>
                <span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cprf&#39;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">prf_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">selected</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">][</span><span class="n">selected</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cprf&#39;</span><span class="p">][</span><span class="n">selected</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">profile_best</span><span class="p">:</span>
            <span class="c1"># select the best scoring records</span>
            <span class="n">prf_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prf_values</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">score_treshold</span> <span class="o">=</span> <span class="n">prf_values</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">profile_best</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">prf_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">prf_values</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># comments?</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">score_treshold</span><span class="p">,</span> <span class="n">prf_values</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># or select the records with profile</span>
            <span class="c1"># match less then or equal to treshold</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">prf_values</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">_treshold</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">,:],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cprf&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rpr&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;uby&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;uby&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span> <span class="n">indices</span><span class="p">)</span>

    <span class="nd">@get_hits</span>
    <span class="k">def</span> <span class="nf">pass_through</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">ubiquity</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">treshold</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
        <span class="n">tresholdB</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">profile_best</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Column order:</span>
<span class="sd">        quality, m/z, rt_min, rt_max, charge, control, a9, a10, a11, a12, b1,</span>
<span class="sd">        profile_score, control_profile_score, rank_profile_boolean,</span>
<span class="sd">        ubiquity_score, ubiquity_score</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prf</span> <span class="o">=</span> <span class="s1">&#39;cprf&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;prf&#39;</span>
        <span class="n">_treshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">treshold</span><span class="p">,</span> <span class="n">tresholdB</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prf</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># dict of profile matching score values and their indices</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">])</span>
            <span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cprf&#39;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">prf_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">selected</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">][</span><span class="n">selected</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cprf&#39;</span><span class="p">][</span><span class="n">selected</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">profile_best</span><span class="p">:</span>
            <span class="c1"># select the best scoring records</span>
            <span class="n">prf_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prf_values</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">score_treshold</span> <span class="o">=</span> <span class="n">prf_values</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">profile_best</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">prf_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">prf_values</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># comments?</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">score_treshold</span><span class="p">,</span> <span class="n">prf_values</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># or select the records with profile</span>
            <span class="c1"># match less then or equal to treshold</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">prf_values</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">_treshold</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selected: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cprf&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cprf&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">,:],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cprf&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">],</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rpr&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;uby&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span> \
                <span class="k">if</span> <span class="s1">&#39;uby&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)))</span>
    
    <span class="nd">@combine_filters</span>
    <span class="k">def</span> <span class="nf">validity_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">):</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">],</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="nd">@combine_filters</span>
    <span class="k">def</span> <span class="nf">val_ubi_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">ubiquity</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">],</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ubiquity</span>
        <span class="p">)</span>
    
    <span class="nd">@combine_filters</span>
    <span class="k">def</span> <span class="nf">val_prf_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">treshold</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">):</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vpr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">],</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">treshold</span>
        <span class="p">)</span>
    
    <span class="nd">@combine_filters</span>
    <span class="k">def</span> <span class="nf">val_rpr_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">):</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vrp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">],</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rpr&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    
    <span class="nd">@combine_filters</span>
    <span class="k">def</span> <span class="nf">val_ubi_prf_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">ubiquity</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">treshold</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">):</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">],</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">treshold</span>
            <span class="p">),</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ubiquity</span>
        <span class="p">)</span>

    <span class="nd">@combine_filters</span>
    <span class="k">def</span> <span class="nf">val_ubi_prf_rprf_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">ubiquity</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">treshold</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">):</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">],</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span>
                            <span class="p">),</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rpr&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">treshold</span>
            <span class="p">),</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ubiquity</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">apply_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;peaksize&#39;</span><span class="p">,</span> <span class="s1">&#39;rt1&#39;</span><span class="p">],</span>
        <span class="n">param</span> <span class="o">=</span> <span class="p">{}):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_filter&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">fun</span><span class="p">(</span><span class="o">**</span><span class="n">p</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">empty_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">eval_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filtr</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">runtime</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">hit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_filter&#39;</span> <span class="o">%</span> <span class="n">filtr</span><span class="p">]</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;quality&#39;</span><span class="p">:</span> <span class="s1">&#39;qly&#39;</span><span class="p">,</span>
                <span class="s1">&#39;charge&#39;</span><span class="p">:</span> <span class="s1">&#39;crg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;peaksize&#39;</span><span class="p">:</span> <span class="s1">&#39;pks&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ubiquity&#39;</span><span class="p">:</span> <span class="s1">&#39;ubi&#39;</span><span class="p">,</span>
                <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="s1">&#39;are&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span> <span class="s1">&#39;prf&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rprofile&#39;</span><span class="p">:</span> <span class="s1">&#39;rpr&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cprofile&#39;</span><span class="p">:</span> <span class="s1">&#39;cprf&#39;</span><span class="p">,</span>
                <span class="s1">&#39;validity&#39;</span><span class="p">:</span> <span class="s1">&#39;vld&#39;</span><span class="p">,</span>
                <span class="s1">&#39;val_ubi&#39;</span><span class="p">:</span> <span class="s1">&#39;vub&#39;</span><span class="p">,</span>
                <span class="s1">&#39;val_prf&#39;</span><span class="p">:</span> <span class="s1">&#39;vpr&#39;</span><span class="p">,</span>
                <span class="s1">&#39;val_ubi_prf&#39;</span><span class="p">:</span> <span class="s1">&#39;vup&#39;</span><span class="p">,</span>
                <span class="s1">&#39;val_ubi_prf_rprf&#39;</span><span class="p">:</span> <span class="s1">&#39;vur&#39;</span><span class="p">,</span>
                <span class="s1">&#39;val_rpr&#39;</span><span class="p">:</span> <span class="s1">&#39;vrp&#39;</span>
            <span class="p">}</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="n">filtr</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">runtime</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timeit</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">))</span><span class="o">.</span>\
                <span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="n">number</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="nd">@count_hits</span>
        <span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">hit</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
        <span class="n">hits</span><span class="p">,</span> <span class="n">phits</span> <span class="o">=</span> <span class="n">counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">nums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="n">hits</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">pcts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="n">phits</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="n">phits</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">nums</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">nums</span><span class="p">)),</span> \
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">pcts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">pcts</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">combined_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
        <span class="n">ubiquity</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="nd">@count_hits</span>
        <span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">],</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">]</span>
                            <span class="p">),</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">profile</span>
                <span class="p">),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ubiquity</span>
            <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="n">counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">protein</span><span class="se">\t\t</span><span class="s1">+</span><span class="se">\t</span><span class="s1">-</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">30</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hits</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">protein</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hits</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save and reload functions</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Screening.save_data"><a class="viewcode-back" href="../../index.html#emese.main.Screening.save_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the raw data into pickle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurescache</span><span class="p">)</span> \
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Saving data to </span><span class="si">%s</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
        
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Data has been saved to </span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurescache</span><span class="p">)</span> \
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Loading data from </span><span class="si">%s</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

<div class="viewcode-block" id="Screening.save"><a class="viewcode-back" href="../../index.html#emese.main.Screening.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actually this does not save anything important,</span>
<span class="sd">        it was useful only some time before.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxcache</span><span class="p">)</span> \
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Saving auxiliary data to </span><span class="si">%s</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">datafiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">),</span> <span class="n">fp</span><span class="p">)</span>
        
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Some annotations has been saved to </span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auxcache</span><span class="p">)</span> \
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Loading auxiliary data &#39;</span>\
            <span class="s1">&#39;from </span><span class="si">%s</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datafiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> \
                <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    END: save &amp; reload</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lipid databases lookup functions</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Screening.find_lipids"><a class="viewcode-back" href="../../index.html#emese.main.Screening.find_lipids">[docs]</a>    <span class="k">def</span> <span class="nf">find_lipids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hits</span><span class="p">,</span> <span class="n">lipnames</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Column order:</span>
<span class="sd">        </span>
<span class="sd">        in:</span>
<span class="sd">        [0] quality, m/z, rt_min, rt_max, charge, control, a9, a10, a11, a12, b1</span>
<span class="sd">        [1] profile_score</span>
<span class="sd">        [2] control_profile_score</span>
<span class="sd">        [3] rank_profile_boolean</span>
<span class="sd">        [4] ubiquity_score</span>
<span class="sd">        [5] ubiquity_score</span>
<span class="sd">        </span>
<span class="sd">        out:</span>
<span class="sd">        protein_name, m/z, </span>
<span class="sd">        profile_score, control_profile_score,</span>
<span class="sd">        rank_profile_boolean, ubiquity_score,</span>
<span class="sd">        ubiquity_score, swisslipids_ac, level,</span>
<span class="sd">        lipid_name, lipid_formula, adduct, </span>
<span class="sd">        adduct_m/z</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># levels: &#39;Structural subspecies&#39;, &#39;Isomeric subspecies&#39;,</span>
        <span class="c1"># &#39;Species&#39;, &#39;Molecular subspecies&#39;</span>
        <span class="n">lipids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">hits</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">hits</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">adducts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pAdducts</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nAdducts</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">swlipids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct_lookup</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">adducts</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">swlipids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">lip</span> <span class="ow">in</span> <span class="n">swlipids</span><span class="p">:</span>
                                <span class="n">hg</span><span class="p">,</span> <span class="n">p_add</span><span class="p">,</span> <span class="n">n_add</span><span class="p">,</span> <span class="n">ether</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">headgroup_from_lipid_name</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                                <span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fattyacid_from_lipid_name</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                    <span class="c1"># tbl[1] and tbl[2] are the profile </span>
                                    <span class="c1"># and cprofile scores</span>
                                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span>
                                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">),</span>
                                    <span class="n">lip</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)),</span>
                                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">lipids</span><span class="p">[</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">pn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lipids</span> <span class="o">=</span> <span class="n">lipids</span></div>

<div class="viewcode-block" id="Screening.headgroup_from_lipid_name"><a class="viewcode-back" href="../../index.html#emese.main.Screening.headgroup_from_lipid_name">[docs]</a>    <span class="k">def</span> <span class="nf">headgroup_from_lipid_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For one database record attempts to identify the lipid class</span>
<span class="sd">        by looking up keywords.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;lmp&#39;</span> <span class="k">if</span> <span class="n">lip</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span> <span class="k">else</span> <span class="s1">&#39;swl&#39;</span>
        <span class="k">for</span> <span class="n">shortname</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kwset</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="n">db</span><span class="p">]:</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="p">[</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">lip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">kwset</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwset</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span> <span class="ow">and</span> \
                    <span class="nb">sum</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="p">[</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">lip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">kwset</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ether</span> <span class="o">=</span> <span class="s1">&#39;(O-&#39;</span> <span class="ow">in</span> <span class="n">lip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">return</span> <span class="n">shortname</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;pos_adduct&#39;</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;neg_adduct&#39;</span><span class="p">],</span> <span class="n">ether</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">fattyacid_from_lipid_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lip</span><span class="p">,</span> <span class="n">_sum</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">refa</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([dl]?)([0-9]+:[0-9]{1,2})\(?([,0-9EZ]+)?\)?&#39;</span><span class="p">)</span>
        <span class="n">_fa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">lip</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">lip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">fa</span> <span class="o">=</span> <span class="n">refa</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">_fa</span> <span class="o">=</span> <span class="n">fa</span>
                    <span class="k">break</span>
        <span class="k">elif</span> <span class="n">lip</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
            <span class="n">fa</span> <span class="o">=</span> <span class="n">refa</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lip</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_fa</span> <span class="o">=</span> <span class="n">fa</span>
        <span class="k">if</span> <span class="n">_fa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_sum</span><span class="p">:</span>
            <span class="n">_fa</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span> \
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">_fa</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">_fa</span>

<div class="viewcode-block" id="Screening.find_lipids_exact"><a class="viewcode-back" href="../../index.html#emese.main.Screening.find_lipids_exact">[docs]</a>    <span class="k">def</span> <span class="nf">find_lipids_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks up lipids by m/z among database entries in</span>
<span class="sd">        `exacts`, and stores the result in dict under key</span>
<span class="sd">        `lip`, where keys are the original indices (`i`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adduct_lookup_exact</span><span class="p">(</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">pn</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outfile</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Screening.adduct_lookup"><a class="viewcode-back" href="../../index.html#emese.main.Screening.adduct_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">adduct_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">adducts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks up m/z values in the table containing the reference database</span>
<span class="sd">        already converted to a pool of all possible adducts.</span>
<span class="sd">        (Does not convert the m/z to other adducts.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iu</span> <span class="o">=</span> <span class="n">adducts</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adducts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">iu</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">adducts</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adducts</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adducts</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,:])</span>
                    <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iu</span> <span class="o">-</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">adducts</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adducts</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adducts</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,:])</span>
                    <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="Screening.adduct_lookup_exact"><a class="viewcode-back" href="../../index.html#emese.main.Screening.adduct_lookup_exact">[docs]</a>    <span class="k">def</span> <span class="nf">adduct_lookup_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks up m/z values in the table containing the reference database</span>
<span class="sd">        casting the m/z to specific adducts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">adducts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ad2ex</span><span class="p">[</span><span class="n">charge</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">addName</span><span class="p">,</span> <span class="n">addFun</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">adducts</span><span class="p">):</span>
            <span class="n">addMz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Mz</span><span class="p">(</span><span class="n">mz</span><span class="p">),</span> <span class="n">addFun</span><span class="p">)()</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Searching for </span><span class="si">%s</span><span class="s1"> adducts.</span><span class="se">\n\t</span><span class="s1"> &#39;</span>\
                    <span class="s1">&#39;-- Adduct mass (measured): &#39;</span>\
                    <span class="s1">&#39;</span><span class="si">%.08f</span><span class="s1">, exact mass (calculated): </span><span class="si">%.08f</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">addName</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="n">addMz</span><span class="p">))</span>
            <span class="n">iu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">addMz</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">iu</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">addMz</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span><span class="p">:</span>
                            <span class="n">lip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,:]</span>
                            <span class="n">hg</span><span class="p">,</span> <span class="n">p_add</span><span class="p">,</span> <span class="n">n_add</span><span class="p">,</span> <span class="n">ether</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">headgroup_from_lipid_name</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                            <span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fattyacid_from_lipid_name</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                            <span class="n">lip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lip</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">addMz</span><span class="p">,</span> <span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">ether</span><span class="p">],</span>
                                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)),</span>
                                <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">lip</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">addName</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Found: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lip</span><span class="p">)))</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">iu</span> <span class="o">-</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">addMz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">swl_levels</span><span class="p">:</span>
                            <span class="n">lip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,:]</span>
                            <span class="c1"># headgroup and fatty acid guess from lipid name</span>
                            <span class="c1"># happens here!</span>
                            <span class="n">hg</span><span class="p">,</span> <span class="n">p_add</span><span class="p">,</span> <span class="n">n_add</span><span class="p">,</span> <span class="n">ether</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">headgroup_from_lipid_name</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                            <span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fattyacid_from_lipid_name</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                            <span class="n">lip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lip</span><span class="p">,</span> 
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">addMz</span><span class="p">,</span> <span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">ether</span><span class="p">],</span>
                                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)),</span>
                                <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">lip</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">addName</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Found: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lip</span><span class="p">)))</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                        <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="Screening.negative_positive"><a class="viewcode-back" href="../../index.html#emese.main.Screening.negative_positive">[docs]</a>    <span class="k">def</span> <span class="nf">negative_positive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_col</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">mz_col</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">swl_col</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Column order:</span>
<span class="sd">        </span>
<span class="sd">        in:</span>
<span class="sd">        ltp_name, m/z,</span>
<span class="sd">        profile_score, control_profile_score,</span>
<span class="sd">        rank_profile_boolean, ubiquity_score, ubiquity_score,</span>
<span class="sd">        original_index,</span>
<span class="sd">        swisslipids_ac, level, lipid_name, lipid_formula, adduct, adduct_m/z</span>
<span class="sd">        </span>
<span class="sd">        out:</span>
<span class="sd">        [0] pos_m/z, pos_profile_score,</span>
<span class="sd">        [2] pos_control_profile_score, pos_rank_profile_boolean,</span>
<span class="sd">        [4] pos_ubiquity_score, pos_ubiquity_score,</span>
<span class="sd">        [6] pos_original_index, pos_swisslipids_ac, pos_level,</span>
<span class="sd">        [9] pos_lipid_name, pos_lipid_formula, pos_adduct, pos_adduct_m/z</span>
<span class="sd">        [13] neg_m/z, neg_profile_score, neg_control_profile_score,</span>
<span class="sd">        [16] neg_rank_profile_boolean,</span>
<span class="sd">        [17] neg_ubiquity_score, neg_ubiquity_score, neg_original_index,</span>
<span class="sd">        [18] neg_swisslipids_ac, neg_level,</span>
<span class="sd">        [22] neg_lipid_name, neg_lipid_formula, neg_adduct, neg_adduct_m/z</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="s1">&#39;Matching positive &amp; negative&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipids</span><span class="p">):</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;neg&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="ow">and</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">neg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                    <span class="n">adds</span> <span class="o">=</span> <span class="p">[</span><span class="n">neg</span><span class="p">[</span><span class="n">add_col</span><span class="p">]]</span> \
                        <span class="k">if</span> <span class="n">neg</span><span class="p">[</span><span class="n">add_col</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Unknown&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;[M-H]-&#39;</span><span class="p">,</span> <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">add</span> <span class="ow">in</span> <span class="n">adds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">add</span> <span class="o">==</span> <span class="s1">&#39;[M-H]-&#39;</span><span class="p">:</span>
                            <span class="n">poshmz</span> <span class="o">=</span> <span class="n">Mz</span><span class="p">(</span><span class="n">Mz</span><span class="p">(</span><span class="n">neg</span><span class="p">[</span><span class="n">mz_col</span><span class="p">])</span><span class="o">.</span><span class="n">add_h</span><span class="p">())</span><span class="o">.</span><span class="n">add_h</span><span class="p">()</span>
                            <span class="n">posnh3mz</span> <span class="o">=</span> <span class="n">Mz</span><span class="p">(</span><span class="n">Mz</span><span class="p">(</span><span class="n">neg</span><span class="p">[</span><span class="n">mz_col</span><span class="p">])</span><span class="o">.</span><span class="n">add_h</span><span class="p">())</span><span class="o">.</span><span class="n">add_nh4</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">add</span> <span class="o">==</span> <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">:</span>
                            <span class="n">poshmz</span> <span class="o">=</span> <span class="n">Mz</span><span class="p">(</span><span class="n">Mz</span><span class="p">(</span><span class="n">neg</span><span class="p">[</span><span class="n">mz_col</span><span class="p">])</span><span class="o">.</span><span class="n">remove_fo</span><span class="p">())</span><span class="o">.</span><span class="n">add_h</span><span class="p">()</span>
                            <span class="n">posnh3mz</span> <span class="o">=</span> <span class="n">Mz</span><span class="p">(</span><span class="n">Mz</span><span class="p">(</span><span class="n">neg</span><span class="p">[</span><span class="n">mz_col</span><span class="p">])</span><span class="o">.</span>\
                                <span class="n">remove_fo</span><span class="p">())</span><span class="o">.</span><span class="n">add_nh4</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">iu</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][:,</span><span class="n">mz_col</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">poshmz</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">iu</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]):</span>
                            <span class="k">while</span> <span class="n">iu</span> <span class="o">+</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="n">mz_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">poshmz</span> <span class="o">&lt;=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="n">swl_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="n">neg</span><span class="p">[</span><span class="n">swl_col</span><span class="p">]</span> <span class="ow">and</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="n">add_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="s1">&#39;[M+H]+&#39;</span> <span class="ow">or</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="n">add_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>
                                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                            <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                                                <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
                                        <span class="p">))</span>
                                    <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">while</span> <span class="n">iu</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">poshmz</span> <span class="o">-</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="n">mz_col</span><span class="p">]</span> <span class="o">&lt;=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="n">swl_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="n">neg</span><span class="p">[</span><span class="n">swl_col</span><span class="p">]</span> <span class="ow">and</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="n">add_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="s1">&#39;[M+H]+&#39;</span> <span class="ow">or</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="n">add_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>
                                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                            <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                                            <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
                                        <span class="p">))</span>
                                    <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">break</span>
                        <span class="n">iu</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">posnh3mz</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">iu</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]):</span>
                            <span class="k">while</span> <span class="n">iu</span> <span class="o">+</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="n">mz_col</span><span class="p">]</span> <span class="o">-</span> \
                                    <span class="n">posnh3mz</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="n">swl_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="n">neg</span><span class="p">[</span><span class="n">swl_col</span><span class="p">]</span> <span class="ow">and</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="n">add_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="s1">&#39;[M+NH4]+&#39;</span> <span class="ow">or</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="n">add_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>
                                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                            <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                                            <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
                                        <span class="p">))</span>
                                    <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">while</span> <span class="n">iu</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">posnh3mz</span> <span class="o">-</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="n">mz_col</span><span class="p">]</span> \
                                    <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="n">swl_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="n">neg</span><span class="p">[</span><span class="n">swl_col</span><span class="p">]</span> <span class="ow">and</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="n">add_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="s1">&#39;[M+NH4]+&#39;</span> <span class="ow">or</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="n">add_col</span><span class="p">]</span> \
                                            <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>
                                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                            <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">neg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                                            <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
                                        <span class="p">))</span>
                                    <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Screening.negative_positive2"><a class="viewcode-back" href="../../index.html#emese.main.Screening.negative_positive2">[docs]</a>    <span class="k">def</span> <span class="nf">negative_positive2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Results in dicts [&#39;pos&#39;][&#39;neg&#39;] and [&#39;neg&#39;][&#39;pos&#39;].</span>
<span class="sd">        </span>
<span class="sd">        Values in each array: assumed positive adduct, assumed negative adduct,</span>
<span class="sd">            measured positive m/z, measured negative m/z</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ad2ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ad2ex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ex2ad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex2ad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_alll</span><span class="p">(</span><span class="s1">&#39;mz&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;neg_lip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;pos_lip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">),</span>
            <span class="s1">&#39;Matching positive &amp; negative&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pi</span><span class="p">,</span> <span class="n">poi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                <span class="n">measured_pos_mz</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">pi</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pos_add</span><span class="p">,</span> <span class="n">pos_add_fun</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ad2ex</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]):</span>
                    <span class="n">calculated_exact</span> <span class="o">=</span> \
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">Mz</span><span class="p">(</span><span class="n">measured_pos_mz</span><span class="p">),</span> <span class="n">pos_add_fun</span><span class="p">)()</span>
                    <span class="k">for</span> <span class="n">neg_add</span><span class="p">,</span> <span class="n">neg_add_fun</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ex2ad</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]):</span>
                        <span class="n">calculated_neg_mz</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Mz</span><span class="p">(</span><span class="n">calculated_exact</span><span class="p">),</span>
                            <span class="n">neg_add_fun</span><span class="p">)()</span>
                        <span class="n">iu</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">calculated_neg_mz</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">iu</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                            <span class="k">while</span> <span class="n">iu</span> <span class="o">+</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">]</span> <span class="o">-</span> \
                                    <span class="n">calculated_neg_mz</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                    <span class="n">noi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">]</span>
                                    <span class="n">match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos_add</span><span class="p">,</span> <span class="n">neg_add</span><span class="p">,</span>
                                        <span class="n">measured_pos_mz</span><span class="p">,</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">]],</span>
                                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="n">poi</span><span class="p">][</span><span class="n">noi</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">][</span><span class="n">poi</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">negative_positive_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">poi</span><span class="p">,</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">],</span>
                                        <span class="n">pos_add</span><span class="p">,</span> <span class="n">neg_add</span><span class="p">)</span>
                                    <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">while</span> <span class="n">iu</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">calculated_neg_mz</span> <span class="o">-</span> \
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                                    <span class="n">noi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">]</span>
                                    <span class="n">match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos_add</span><span class="p">,</span> <span class="n">neg_add</span><span class="p">,</span>
                                        <span class="n">measured_pos_mz</span><span class="p">,</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">]],</span>
                                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="n">poi</span><span class="p">][</span><span class="n">noi</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">][</span><span class="n">poi</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">negative_positive_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">poi</span><span class="p">,</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">],</span>
                                        <span class="n">pos_add</span><span class="p">,</span> <span class="n">neg_add</span><span class="p">)</span>
                                    <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">break</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div>

<div class="viewcode-block" id="Screening.negative_positive_lipids"><a class="viewcode-back" href="../../index.html#emese.main.Screening.negative_positive_lipids">[docs]</a>    <span class="k">def</span> <span class="nf">negative_positive_lipids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">poi</span><span class="p">,</span> <span class="n">noi</span><span class="p">,</span> <span class="n">pos_add</span><span class="p">,</span> <span class="n">neg_add</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Result columns:</span>
<span class="sd">        database id positive, database id negative,</span>
<span class="sd">        lipid name positive, lipid name negative,</span>
<span class="sd">        adduct positive, adduct negative,</span>
<span class="sd">        database m/z positive, database m/z negative,</span>
<span class="sd">        measured m/z positive, measured m/z negative,</span>
<span class="sd">        headgroup positive, headgroup negative,</span>
<span class="sd">        fatty acids positive, fatty acids negative,</span>
<span class="sd">        dominant adduct positive, dominant adduct negative</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">poi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">plip</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">poi</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">plip</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">pos_add</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">nlip</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">plip</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                            <span class="n">nlip</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">neg_add</span> <span class="ow">and</span> <span class="n">plip</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">plip</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">plip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plip</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">plip</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                <span class="n">nlip</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">plip</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">plip</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                                <span class="n">plip</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">plip</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">nlip</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span><span class="p">[</span><span class="n">plip</span><span class="p">[</span><span class="mi">7</span><span class="p">]][</span><span class="s1">&#39;pos_adduct&#39;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span><span class="p">[</span><span class="n">nlip</span><span class="p">[</span><span class="mi">7</span><span class="p">]][</span><span class="s1">&#39;neg_adduct&#39;</span><span class="p">]],</span>
                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;neg_lip&#39;</span><span class="p">][</span><span class="n">poi</span><span class="p">][</span><span class="n">noi</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;pos_lip&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">][</span><span class="n">poi</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span></div>
    
    <span class="k">def</span> <span class="nf">average_area_5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_marco</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_by_protein_amount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_fractions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_nans</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average_area_5</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protein_peak_ratios2</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_manual_ppratios</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_manual_ppratios</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ppratios_replace_manual</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity_peak_ratios</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratios_in_range</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_ratio_score</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combine_peak_ratio_scores</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_ratio_score_bool</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lipid_lookup_exact</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms1_headgroups</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negative_positive2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headgroups_negative_positive</span><span class="p">(</span><span class="s1">&#39;ms1&#39;</span><span class="p">)</span>
        <span class="c1"># self.marco_standards()</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    END: lipid databases lookup</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functions for MS2</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Screening.ms2"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2">[docs]</a>    <span class="k">def</span> <span class="nf">ms2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls all methods in the MS2 pipeline. This involves</span>
<span class="sd">        </span>
<span class="sd">        - reading and autogenerating the fragment lists</span>
<span class="sd">        </span>
<span class="sd">        - identifying the MS2 mgf files</span>
<span class="sd">        </span>
<span class="sd">        - mapping mgf file offsets to scans</span>
<span class="sd">        </span>
<span class="sd">        - identifying detected fragments using the lists</span>
<span class="sd">        </span>
<span class="sd">        - identifying the features based on charecteristic</span>
<span class="sd">           fragments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_metabolites</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_filenames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_map</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_main</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_headgroups</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headgroups_by_fattya</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity_combined</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_scans_identify</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_headgroups2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consensus_identity</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="Screening.ms2_onebyone"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_onebyone">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_onebyone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="s1">&#39;std_layout_tables_xlsx&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does the same as `ms2()`, but after doing it for one</span>
<span class="sd">        entity, it calls a callback, typically to export all</span>
<span class="sd">        important outcome, and after deletes the objects to</span>
<span class="sd">        free up memory. This is useful when working with so</span>
<span class="sd">        large data that it would require many gigs of memory</span>
<span class="sd">        otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_metabolites</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_filenames</span><span class="p">()</span>
        
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">),</span>
                                <span class="s1">&#39;Reading &amp; analysing MS2&#39;</span><span class="p">,</span>
                                <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">ms2_oneprotein</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
                
                <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">)(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">ms2_cleanup</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="Screening.ms2_oneprotein"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_oneprotein">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_oneprotein</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the whole MS2 workflow for only one protein.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_map</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_main</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_headgroups</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headgroups_by_fattya</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity_combined</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_scans_identify</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_headgroups2</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consensus_identity</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">])</span></div>
    
    <span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headgroups_by_fattya</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headgroups_negative_positive</span><span class="p">(</span><span class="s1">&#39;ms2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity_combined</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity_combined_ms2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_identity_table</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">ms2_metabolites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pFragments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pHgfrags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pHeadgroups</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">ms2_read_metabolites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfragmentsfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nFragments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nHgfrags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nHeadgroups</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">ms2_read_metabolites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfragmentsfile</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">export_auto_fraglist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;lipid_fragments_</span><span class="si">%s</span><span class="s1">_mode_ext.txt&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39;negative&#39;</span> <span class="k">if</span> <span class="s1">&#39;negative&#39;</span> <span class="ow">in</span> <span class="n">infile</span> <span class="k">else</span> <span class="s1">&#39;positive&#39;</span><span class="p">)</span> \
            <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">outfile</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_read_metabolites</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">extra_fragments</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">return_fraglines</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="s1">&#39;</span><span class="si">%.07f</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span>\
                                <span class="nb">tuple</span><span class="p">(</span><span class="n">l</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">]),</span>
                        <span class="n">lst</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
    
<div class="viewcode-block" id="Screening.ms2_read_metabolites"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_read_metabolites">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_read_metabolites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">extra_fragments</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_fraglines</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In part from Toby Hodges.</span>
<span class="sd">        Reads metabolite fragments data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Metabolites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Hgroupfrags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rehg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*\(([\+;A-Z]+)\).*&#39;</span><span class="p">)</span>
        <span class="n">rehgsep</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[;\+]&#39;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">Handle</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> \
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                                        <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="nb">enumerate</span><span class="p">(</span>
                                        <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                        <span class="n">Handle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">extra_fragments</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="s1">&#39;negative&#39;</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_marcos_fragments</span><span class="p">:</span>
                    
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">FAminusH</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FA&#39;</span><span class="p">)</span>
                    <span class="c1"># fatty acid -CO2- fragments:</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                        <span class="n">FattyFragment</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">],</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FA&#39;</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">FAAlkylminusH</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;PC&#39;</span><span class="p">,</span> <span class="s1">&#39;PS&#39;</span><span class="p">,</span> <span class="s1">&#39;PI&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">):</span>
                        
                        <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                            <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;Lyso</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="p">)</span>
                        
                        <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                            <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;Lyso</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">hg</span> <span class="o">!=</span> <span class="s1">&#39;PA&#39;</span> <span class="ow">and</span> <span class="n">hg</span> <span class="o">!=</span> <span class="s1">&#39;PG&#39;</span><span class="p">:</span>
                            <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                                <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;Lyso</span><span class="si">%s</span><span class="s1">Alkyl&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="p">)</span>
                            <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                                <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;Lyso</span><span class="si">%s</span><span class="s1">Alkyl&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">]</span>
                            <span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">hg</span> <span class="o">==</span> <span class="s1">&#39;PI&#39;</span><span class="p">:</span>
                            <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                                <span class="n">LysoPI</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;C6H10O5&#39;</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                                <span class="n">LysoPI</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">]</span>
                            <span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">hg</span> <span class="o">==</span> <span class="s1">&#39;PE&#39;</span><span class="p">:</span>
                            <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                                <span class="n">LysoPE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">]</span>
                            <span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">hg</span> <span class="o">==</span> <span class="s1">&#39;PC&#39;</span><span class="p">:</span>
                            <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                                <span class="n">LysoPC</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CH3&#39;</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span>
                                <span class="n">LysoPC</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CH3&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">]</span>
                            <span class="p">)</span>
                    
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">CerFA</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">CerFAminusC</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">CerFAminusN</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">CerFAminusC2H5N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">CerSphi</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">CerSphiMinusN</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">CerSphiMinusNO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">FAminusH</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">LysoPA</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">CerFA</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;positive&#39;</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_marcos_fragments</span><span class="p">:</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">NLFAminusH2O</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">NLFA</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H5&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">NLFAplusOH</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">FAplusGlycerol</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">NLFAplusNH3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">FAminusO</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_marcos_fragments</span><span class="p">:</span>
                    
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
                    <span class="n">lst</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fragment_list</span><span class="p">(</span><span class="n">SphingosineBase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">cmin</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">cmax</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                   <span class="n">minus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">return_fraglines</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lst</span>
        
        <span class="k">for</span> <span class="n">Line</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">MetabMass</span><span class="p">,</span> <span class="n">MetabType</span><span class="p">,</span> <span class="n">MetabCharge</span> <span class="o">=</span> <span class="n">Line</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Wrongly formatted fragment line:&#39;</span>\
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">  </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Line</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">hgm</span> <span class="o">=</span> <span class="n">rehg</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">Line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Line</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="ow">or</span> <span class="n">hgm</span><span class="p">:</span>
                
                <span class="n">Hgroupfrags</span><span class="p">[</span><span class="n">MetabType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">Hgroupfrags</span><span class="p">[</span><span class="n">MetabType</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hgroupfrags</span><span class="p">[</span><span class="n">MetabType</span><span class="p">]</span> <span class="o">|</span> \
                        <span class="nb">set</span><span class="p">(</span><span class="n">rehgsep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Line</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                
                <span class="k">if</span> <span class="n">hgm</span><span class="p">:</span>
                    <span class="n">Hgroupfrags</span><span class="p">[</span><span class="n">MetabType</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hgroupfrags</span><span class="p">[</span><span class="n">MetabType</span><span class="p">]</span> <span class="o">|</span> \
                        <span class="nb">set</span><span class="p">(</span><span class="n">rehgsep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hgm</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
            
            <span class="n">Metabolites</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">MetabMass</span><span class="p">,</span> <span class="n">MetabType</span><span class="p">,</span> <span class="n">MetabCharge</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MetabCharge</span> <span class="ow">and</span> <span class="s1">&#39;-&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MetabCharge</span> \
                <span class="ow">and</span> <span class="s1">&#39;NL&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MetabCharge</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WARNING: fragment </span><span class="si">%s</span><span class="s1"> has no &#39;</span>\
                    <span class="s1">&#39;valid charge information!</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="n">MetabType</span><span class="p">)</span>
        
        <span class="n">Headgroups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">frag</span><span class="p">,</span> <span class="n">hgs</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">Hgroupfrags</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">hgs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hg</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Headgroups</span><span class="p">:</span>
                        <span class="n">Headgroups</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="n">Headgroups</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span>
        
        <span class="n">Metabolites</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="n">Metabolites</span><span class="p">,</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Metabolites</span><span class="p">,</span> <span class="n">Hgroupfrags</span><span class="p">,</span> <span class="n">Headgroups</span></div>
    
<div class="viewcode-block" id="Screening.auto_fragment_list"><a class="viewcode-back" href="../../index.html#emese.main.Screening.auto_fragment_list">[docs]</a>    <span class="k">def</span> <span class="nf">auto_fragment_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">cmin</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">cmax</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">plus</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a series of fragments of a given type, iterating</span>
<span class="sd">        over a range of carbon counts and unsaturated bond counts.</span>
<span class="sd">        In addition, certain groups can be added or deduced from the</span>
<span class="sd">        fragment mass, e.g. -H2O for a water loss.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">FAFragSeries</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">cmin</span> <span class="o">=</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">unsatmin</span> <span class="o">=</span> <span class="n">unsatmin</span><span class="p">,</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="n">cmax</span><span class="p">,</span> <span class="n">unsatmax</span> <span class="o">=</span> <span class="n">unsatmax</span><span class="p">,</span> <span class="n">minus</span> <span class="o">=</span> <span class="n">minus</span><span class="p">,</span> <span class="n">plus</span> <span class="o">=</span> <span class="n">plus</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">iterfraglines</span><span class="p">())</span></div>

<div class="viewcode-block" id="Screening.ms2_filenames"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_filenames">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Files are placed in 2 root directories, in specific subdirectories,</span>
<span class="sd">        positive and negative MS mode in separate files.</span>
<span class="sd">        This function collects all the file paths and returns them </span>
<span class="sd">        in a dict of dicts. Keys are LTP names, and &#39;pos&#39;/&#39;neg&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redirname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(^[0-9a-zA-Z]+)[ _](pos|neg)&#39;</span><span class="p">)</span>
        <span class="n">remgfname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(^[0-9a-zA-Z_]+)_([a-zA-Z0-9]{3,})_(pos|neg)&#39;</span>\
            <span class="sa">r</span><span class="s1">&#39;_([A-Z][0-9]{1,2})\.mgf&#39;</span><span class="p">)</span>
        <span class="n">refractio</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*_([A-Z][0-9]{1,2}).*&#39;</span><span class="p">)</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadirs</span><span class="p">:</span>
            
            <span class="n">proteindd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2dir</span> <span class="ow">in</span> <span class="n">proteindd</span><span class="p">:</span>
                
                <span class="n">proteindd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ms2dir</span><span class="p">]</span>
                <span class="n">ms2dir</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proteindd</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">proteindd</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">))]</span>
                <span class="n">ms2dir</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteindd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Please mount the shared folder!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="k">for</span> <span class="n">proteind</span> <span class="ow">in</span> <span class="n">proteindd</span><span class="p">:</span>
                
                <span class="n">dirname</span> <span class="o">=</span> <span class="n">redirname</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">proteind</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                    
                    <span class="n">proteinname</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">proteinname</span> <span class="o">=</span> <span class="n">proteinname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">ms2dir</span><span class="p">:</span>
                    <span class="c1"># other dirs are irrelevant:</span>
                    <span class="k">continue</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ms2dir</span><span class="p">:</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="p">[</span><span class="n">proteind</span><span class="p">,</span> <span class="s1">&#39;Results&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fpath</span> <span class="o">=</span> <span class="p">[</span><span class="n">proteind</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">fpath</span><span class="p">)):</span>
                    
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">fpath</span><span class="p">)):</span>
                        
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;mgf&#39;</span><span class="p">)</span> \
                            <span class="ow">and</span> <span class="s1">&#39;buffer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span> \
                            <span class="ow">and</span> <span class="s1">&#39;TLC_STD&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span> \
                            <span class="ow">and</span> <span class="s1">&#39;MeOH&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                            
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">fr</span> <span class="o">=</span> <span class="n">refractio</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">fr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="s1">&#39;could not determine &#39;</span>\
                                    <span class="s1">&#39;fraction number: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                            
                            <span class="k">if</span> <span class="n">ms2dir</span><span class="p">:</span>
                                <span class="n">null</span><span class="p">,</span> <span class="n">proteinname</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> \
                                    <span class="n">remgfname</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                                
                                <span class="n">fr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                            
                            <span class="n">fr</span> <span class="o">=</span> <span class="s1">&#39;B1&#39;</span> <span class="k">if</span> <span class="n">fr</span> <span class="o">==</span> <span class="s1">&#39;B01&#39;</span> \
                                <span class="k">else</span> <span class="s1">&#39;A9&#39;</span> <span class="k">if</span> <span class="n">fr</span> <span class="o">==</span> <span class="s1">&#39;A09&#39;</span> \
                                <span class="k">else</span> <span class="n">fr</span>
                            
                            <span class="k">if</span> <span class="n">proteinname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
                                <span class="n">fnames</span><span class="p">[</span><span class="n">proteinname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            
                            <span class="k">if</span> <span class="n">pos</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">[</span><span class="n">proteinname</span><span class="p">]</span> \
                                <span class="ow">or</span> <span class="n">proteind</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">):</span>
                                
                                <span class="n">fnames</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            
                            <span class="n">fnames</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pos</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">fpath</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="p">]))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2files</span> <span class="o">=</span> <span class="n">fnames</span></div>
    
<div class="viewcode-block" id="Screening.ms2_map"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_map">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maps offsets of the beginning of each scan in MS2 mgf files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stRpos</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span>
        <span class="n">stRneg</span> <span class="o">=</span> <span class="s1">&#39;neg&#39;</span>
        <span class="n">refrac</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([A-Z])([\d]{1,2})$&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;ms2files&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{}}})</span> \
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms2files</span><span class="p">))</span>
        
        <span class="n">missing_ms1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;missing_ms1&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">missing_ms1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        
        <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms2files</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Indexing MS2 data&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms2files</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                                    <span class="s1">&#39;Indexing MS2 data&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms2files</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">pFeatures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nFeatures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">uprotein</span> <span class="o">=</span> <span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            
            <span class="n">ifrac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_indices</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                
                <span class="n">features</span> <span class="o">=</span> <span class="n">pFeatures</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">stRpos</span> <span class="k">else</span> <span class="n">nFeatures</span>
                <span class="c1">#fractions = set([])</span>
                <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                    
                    <span class="n">fr</span> <span class="o">=</span> <span class="n">refrac</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="n">fr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">frnum</span> <span class="o">=</span> <span class="n">ifrac</span><span class="p">[</span><span class="n">fr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">missing_ms1</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">missing_ms1</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fr</span><span class="p">))</span>
                        <span class="k">continue</span>
                    
                    <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_index</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">frnum</span><span class="p">,</span>
                                        <span class="n">charge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_precursor_charge</span><span class="p">)</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
                    <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">uprotein</span><span class="p">][</span><span class="s1">&#39;ms2files&#39;</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="n">fl</span>
            
            <span class="n">pFeatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">pFeatures</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">nFeatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">nFeatures</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">uprotein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pFeatures</span>
            <span class="n">result</span><span class="p">[</span><span class="n">uprotein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nFeatures</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">missing_ms1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: Warning: for certain MS2 files &#39;</span>\
                <span class="s1">&#39;no MS1 data available. See them in `missing_ms1`.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2map</span> <span class="o">=</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Screening.ms2_index"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_index">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looking up offsets in one MS2 mgf file.</span>
<span class="sd">        </span>
<span class="sd">        Columns:</span>
<span class="sd">            -- pepmass</span>
<span class="sd">            -- intensity</span>
<span class="sd">            -- retention time</span>
<span class="sd">            -- scan num</span>
<span class="sd">            -- offset in file</span>
<span class="sd">            -- fraction num</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stRrtinseconds</span> <span class="o">=</span> <span class="s1">&#39;RTINSECONDS&#39;</span>
        <span class="n">stRtitle</span> <span class="o">=</span> <span class="s1">&#39;TITLE&#39;</span>
        <span class="n">stRbe</span> <span class="o">=</span> <span class="s1">&#39;BE&#39;</span>
        <span class="n">stRen</span> <span class="o">=</span> <span class="s1">&#39;EN&#39;</span>
        <span class="n">stRch</span> <span class="o">=</span> <span class="s1">&#39;CH&#39;</span>
        <span class="n">stRpepmass</span> <span class="o">=</span> <span class="s1">&#39;PEPMASS&#39;</span>
        <span class="n">stRempty</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">reln</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^([A-Z]+).*=([\d\.]+)[\s]?([\d\.]*)[&quot;]?$&#39;</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cap_next</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="mi">8192</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
                
                <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="n">l</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">stRbe</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">l</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">stRen</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">stRch</span><span class="p">:</span>
                        
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="n">reln</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                            <span class="k">continue</span>
                        
                        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stRtitle</span><span class="p">:</span>
                            <span class="n">scan</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        
                        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stRrtinseconds</span><span class="p">:</span>
                            <span class="n">rtime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">60.0</span>
                        
                        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">stRpepmass</span><span class="p">:</span>
                            <span class="n">pepmass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">intensity</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">stRempty</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">charge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">cap_next</span> <span class="o">=</span> <span class="kc">True</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="n">charge</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">_charge</span> <span class="o">==</span> <span class="n">charge</span><span class="p">:</span>
                            <span class="n">cap_next</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">elif</span> <span class="n">cap_next</span><span class="p">:</span>
                    
                    <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pepmass</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span>
                        <span class="n">rtime</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">fr</span><span class="p">])</span>
                    <span class="n">scan</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">rtime</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">pepmass</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">_charge</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">cap_next</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="Screening.ms2_main"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_main">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For all LTPs and modes obtains the MS2 data from original files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ms2map columns: pepmass, intensity, rtime, scan, offset, fraction</span>
        
        <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span>
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;Looking up MS2 fragments&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">)</span> <span class="k">else</span> \
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                    
                    <span class="c1"># we look up the real measured MS1 m/z&#39;s in MS2,</span>
                    <span class="c1"># so will divide recalibrated values by the drift ratio</span>
                    <span class="n">drift</span> <span class="o">=</span> <span class="mf">1.0</span> \
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;proteins_drifts&#39;</span><span class="p">)</span> \
                        <span class="ow">or</span> <span class="s1">&#39;recalibrated&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span> \
                        <span class="ow">or</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span> \
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppm2ratio</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span>
                                    <span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="p">))</span>
                    
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Recalibrated m/z: &#39;</span>\
                        <span class="s1">&#39;</span><span class="si">%.08f</span><span class="s1">; drift = </span><span class="si">%.08f</span><span class="s1">; measured m/z: </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">drift</span><span class="p">,</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">drift</span><span class="p">))</span>
                    
                    <span class="n">ms2matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_match</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">],</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span>
                        <span class="n">protein</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="n">drift</span> <span class="o">=</span> <span class="n">drift</span><span class="p">,</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="p">)</span>
                    
                    <span class="c1"># this already returns final result, from protein containing</span>
                    <span class="c1"># fractions and with the relevant retention times</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_lookup</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="n">ms2matches</span><span class="p">,</span>
                                                 <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
                                                 <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="p">)</span>
                    
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_result</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2&#39;</span><span class="p">])</span>
                    <span class="c1">#if verbose:</span>
                        <span class="c1">#print(&#39;\n&#39;)</span>
                        <span class="c1">#print(&#39;number of positive mzs:&#39;, len(posMzs))</span>
                        <span class="c1">#print(&#39;negative matching:&#39;, len(pos_matches))</span>
                        <span class="c1">#print(&#39;number of negative mzs:&#39;, len(negMzs))</span>
                        <span class="c1">#print(&#39;negative matching:&#39;, len(neg_matches))</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outfile</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div>

<div class="viewcode-block" id="Screening.ms2_result"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_result">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms2matches</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the most relevant information from the MS2</span>
<span class="sd">        result arrays, throwing away the rest.</span>
<span class="sd">        </span>
<span class="sd">        Columns in output arrays (6):</span>
<span class="sd">            # MS2 fragment name, MS2 adduct name, (0-1)</span>
<span class="sd">            # MS2 fragment m/z, MS2 fragment intensity (2-3)</span>
<span class="sd">            # fraction number, scan number (4-5)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">oi</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">ms2matches</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2s</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ms2matches</span><span class="p">):</span>
            
            <span class="k">for</span> <span class="n">ms2i</span> <span class="ow">in</span> <span class="n">ms2s</span><span class="p">:</span>
                
                <span class="n">result</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ms2i</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">ms2i</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                    <span class="n">ms2i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ms2i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ms2i</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">ms2i</span><span class="p">[</span><span class="mi">12</span><span class="p">]],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2s</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            
            <span class="n">result</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ms2s</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">result</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">oi</span><span class="p">]),</span> <span class="mi">6</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Screening.ms2_match"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_match">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms1Mzs</span><span class="p">,</span> <span class="n">ms1Rts</span><span class="p">,</span> <span class="n">ms1is</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drift</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">rt_tolerance</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks up matching pepmasses for a list of MS1 m/z&#39;s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opened_here</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span>
        <span class="k">elif</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">opened_here</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ms2tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2map</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># iterating over MS1 m/z, MS1 original index, and retention time</span>
        <span class="k">for</span> <span class="n">ms1Mz</span><span class="p">,</span> <span class="n">ms1i</span><span class="p">,</span> <span class="n">rt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ms1Mzs</span><span class="p">,</span> <span class="n">ms1is</span><span class="p">,</span> <span class="n">ms1Rts</span><span class="p">):</span>
            <span class="c1"># drift is the ratio</span>
            <span class="c1"># we divide here to have the original measured MS1 m/z,</span>
            <span class="c1"># not the recalibrated one:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Recalibrated m/z: </span><span class="si">%.08f</span><span class="s1">; drift = </span><span class="si">%.08f</span><span class="s1">; m&#39;</span>\
                    <span class="s1">&#39;easured m/z: </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms1Mz</span><span class="p">,</span> <span class="n">drift</span><span class="p">,</span> <span class="n">ms1Mz</span> <span class="o">/</span> <span class="n">drift</span><span class="p">))</span>
            <span class="n">ms1Mz</span> <span class="o">=</span> <span class="n">ms1Mz</span> <span class="o">/</span> <span class="n">drift</span>
            <span class="c1"># if error comes here, probably MS2 files are missing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">iu</span> <span class="o">=</span> <span class="n">ms2tbl</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">ms1Mz</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Missing MS2 files for </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">?</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Looking up MS1 m/z </span><span class="si">%.08f</span><span class="s1">. &#39;</span>\
                    <span class="s1">&#39;Closest values found: </span><span class="si">%.08f</span><span class="s1"> and </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">ms1Mz</span><span class="p">,</span>
                    <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">iu</span> <span class="o">&lt;</span> <span class="n">ms2tbl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">rt_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">rt_mean</span> <span class="o">-</span> <span class="n">rt_tolerance</span><span class="p">,</span> <span class="n">rt_mean</span> <span class="o">+</span> <span class="n">rt_tolerance</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">iu</span> <span class="o">&lt;</span> <span class="n">ms2tbl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">while</span> <span class="n">iu</span> <span class="o">+</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="n">ms2tbl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ms1Mz</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Next value within &#39;</span>\
                                <span class="s1">&#39;range of tolerance: </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_rt_within_range</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Not checking RT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                                 <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Retention time OK, &#39;</span>\
                                    <span class="s1">&#39;accept this match</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Retention time is </span><span class="si">%.02f</span><span class="s1">&#39;</span>\
                                    <span class="s1">&#39;, should be in range </span><span class="si">%.02f</span><span class="s1">-</span><span class="si">%.02f</span><span class="s1"> to&#39;</span>\
                                    <span class="s1">&#39; match.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Retention time not OK, &#39;</span>\
                                    <span class="s1">&#39;drop this match</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="c1"># checking retention time</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_rt_within_range</span> <span class="ow">or</span> <span class="p">(</span>
                            <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rt</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- value found at index </span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">))</span>
                            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ms1Mz</span><span class="p">,</span> <span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="n">ms1i</span><span class="p">))</span>
                        <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">iu</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ms1Mz</span> <span class="o">-</span> <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_tlr</span><span class="p">:</span>
                        <span class="c1"># checking retention time</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Next value within &#39;</span>\
                                <span class="s1">&#39;range of tolerance: </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_rt_within_range</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Not checking RT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                                 <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rt</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Retention time OK, &#39;</span>\
                                    <span class="s1">&#39;accept this match</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Retention time is </span><span class="si">%.02f</span><span class="s1">&#39;</span>\
                                    <span class="s1">&#39;, should be in range </span><span class="si">%.02f</span><span class="s1">-</span><span class="si">%.02f</span><span class="s1"> to&#39;</span>\
                                    <span class="s1">&#39; match.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Retention time not OK, &#39;</span>\
                                    <span class="s1">&#39;drop this match</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_rt_within_range</span> <span class="ow">or</span> <span class="p">(</span>
                            <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">ms2tbl</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rt</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- value found at index </span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">))</span>
                            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ms1Mz</span><span class="p">,</span> <span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span> <span class="n">ms1i</span><span class="p">))</span>
                        <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="n">opened_here</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="ow">is</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">outfile</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">uniqList</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">ms2_verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms2_main</span><span class="p">(</span><span class="n">proteins</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="p">)</span>

<div class="viewcode-block" id="Screening.ms2_lookup"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ms1matches</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For the matching MS2 m/z&#39;s given, reads and identifies</span>
<span class="sd">        the list of fragments.</span>
<span class="sd">        </span>
<span class="sd">        Columns in output arrays (15):</span>
<span class="sd">            # MS1 m/z, MS2 fragment m/z, MS2 fragment intensity, (0-2)</span>
<span class="sd">            # MS2 table index, direct/inverted match, fraction number, (3-5)</span>
<span class="sd">            # MS2 fragment m/z in annotation, MS2 fragment name, (6-7)</span>
<span class="sd">            # MS2 adduct name, (8)</span>
<span class="sd">            # MS1 pepmass, MS1 intensity, rtime, MS2 scan, (9-12)</span>
<span class="sd">            # MS2 file offset, fraction number (13-14)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">fragments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pFragments</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nFragments</span>
        <span class="n">ms2map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2map</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
        <span class="n">ms2files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2map</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;ms2files&#39;</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
        <span class="c1"># indices of fraction numbers</span>
        <span class="n">ifracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_indices</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
        <span class="n">fracsi</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="p">(</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ifracs</span><span class="p">)))</span>
        
        <span class="n">sample_i</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">9</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
        <span class="n">stRcharge</span> <span class="o">=</span> <span class="s1">&#39;CHARGE&#39;</span>
        
        <span class="c1"># opening all files to have file pointers ready</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">fr</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span> \
            <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ms2files</span><span class="p">))</span>
        
        <span class="c1"># Initializing dict with original indices</span>
        <span class="n">ms2matches</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ms1matches</span><span class="p">)</span>
        
        <span class="c1"># iterating over MS1 m/z, MS2 table index, MS1 original index</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> :: MS2 lookup starts</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ms1mz</span><span class="p">,</span> <span class="n">ms2i</span><span class="p">,</span> <span class="n">ms1oi</span> <span class="ow">in</span> <span class="n">ms1matches</span><span class="p">:</span>
            
            <span class="c1"># ms2map columns: pepmass, intensity, rtime, scan, offset, fraction</span>
            <span class="n">ms2item</span> <span class="o">=</span> <span class="n">ms2map</span><span class="p">[</span><span class="n">ms2i</span><span class="p">,:]</span>
            <span class="n">fr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ms2item</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">frlab</span> <span class="o">=</span> <span class="n">fracsi</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Looking up </span><span class="si">%.08f</span><span class="s1"> in fraction </span><span class="si">%s</span><span class="s1"> (#</span><span class="si">%u</span><span class="s1">), &#39;</span>\
                    <span class="s1">&#39;line </span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms1mz</span><span class="p">,</span> <span class="n">frlab</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">ms2i</span><span class="p">))</span>
            
            <span class="c1"># only fractions with the protein</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">frlab</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Have file for fraction </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">frlab</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Do not have file for fraction </span><span class="si">%s</span><span class="s1">; files: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">frlab</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_only_protein_fractions</span> <span class="ow">or</span> \
                <span class="n">fractions</span><span class="p">[</span><span class="n">sample_i</span><span class="p">[</span><span class="n">fr</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">frlab</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                
                <span class="n">fp</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">frlab</span><span class="p">]</span>
                
                <span class="c1"># jumping to offset</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ms2item</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Reading from file </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                
                <span class="c1"># zero means no clue about charge</span>
                <span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="n">l</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="n">stRcharge</span><span class="p">:</span>
                        <span class="c1"># one chance to obtain the charge</span>
                        <span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="c1"># finish at next section</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># reading fragment masses</span>
                        <span class="n">mi</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        
                        <span class="n">intensity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="c1"># matching fragment --- direct</span>
                        <span class="n">ms2hit1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_identify</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">fragments</span><span class="p">,</span>
                            <span class="n">compl</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="c1"># matching fragment --- inverted</span>
                        <span class="n">ms2hit2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_identify</span><span class="p">(</span><span class="n">ms2item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mass</span><span class="p">,</span>
                            <span class="n">fragments</span><span class="p">,</span> <span class="n">compl</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># matched fragment --- direct</span>
                        <span class="c1"># columns (14):</span>
                        <span class="c1"># MS1 m/z, MS2 fragment m/z, MS2 fragment intensity,</span>
                        <span class="c1"># MS2 table index, direct/inverted match, </span>
                        <span class="c1"># fraction number,</span>
                        <span class="c1"># MS2 fragment m/z in annotation, MS2 fragment name,</span>
                        <span class="c1"># MS2 adduct name,</span>
                        <span class="c1"># MS1 pepmass, MS1 intensity, rtime, MS2 scan,</span>
                        <span class="c1"># MS2 file offset, fraction number</span>
                        <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">ms2hit1</span><span class="p">:</span>
                            <span class="n">ms2matches</span><span class="p">[</span><span class="n">ms1oi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ms1mz</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span>
                                    <span class="n">intensity</span><span class="p">,</span> <span class="n">ms2i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fr</span><span class="p">]),</span>
                                <span class="n">frag</span><span class="p">,</span> <span class="n">ms2item</span><span class="p">)</span>
                            <span class="p">))</span>
                        <span class="c1"># matched fragment --- inverted</span>
                        <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">ms2hit2</span><span class="p">:</span>
                            <span class="n">ms2matches</span><span class="p">[</span><span class="n">ms1oi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ms1mz</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span>
                                    <span class="n">intensity</span><span class="p">,</span> <span class="n">ms2i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fr</span><span class="p">]),</span>
                                <span class="n">frag</span><span class="p">,</span> <span class="n">ms2item</span><span class="p">)</span>
                            <span class="p">))</span>
                        <span class="c1"># no fragment matched --- unknown fragment</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2hit1</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2hit2</span><span class="p">):</span>
                            <span class="n">thisRow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ms1mz</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span>
                                    <span class="n">intensity</span><span class="p">,</span> <span class="n">ms2i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fr</span><span class="p">],</span>
                                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">],</span>
                                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">),</span>
                                <span class="n">ms2item</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">thisRow</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
                            <span class="n">ms2matches</span><span class="p">[</span><span class="n">ms1oi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisRow</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- </span><span class="si">%u</span><span class="s1"> lines have been read</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2matches</span><span class="p">[</span><span class="n">ms1oi</span><span class="p">]))</span>
        
        <span class="c1"># removing file pointers</span>
        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2match</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ms2matches</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ms2matches</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">ms2match</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ms2matches</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
                <span class="n">ms2matches</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">ms2matches</span></div>

<div class="viewcode-block" id="Screening.ms2_identify"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_identify">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">fragments</span><span class="p">,</span> <span class="n">compl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks up one MS2 m/z value in list of known fragments masses.</span>
<span class="sd">        Either with matching between MS2 m/z and fragment m/z within</span>
<span class="sd">        a given tolerance, or between the fragment mass and the</span>
<span class="sd">        residual mass after substracting MS2 m/z from MS1 m/z.</span>
<span class="sd">        Returns the fragment&#39;s mass, name and adduct type, or None</span>
<span class="sd">        in case of no match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">du</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">iu</span> <span class="o">=</span> <span class="n">fragments</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iu</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="p">((</span><span class="n">compl</span> <span class="ow">and</span> <span class="s1">&#39;NL&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="ow">not</span> <span class="n">compl</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> \
            <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="s1">&#39;NL&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span><span class="p">,</span><span class="mi">2</span><span class="p">])):</span>
            <span class="n">du</span> <span class="o">=</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mass</span>
        <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> \
            <span class="p">((</span><span class="n">compl</span> <span class="ow">and</span> <span class="s1">&#39;NL&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="ow">not</span> <span class="n">compl</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> \
            <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> \
            <span class="ow">and</span> <span class="s1">&#39;NL&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])):</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">-</span> <span class="n">fragments</span><span class="p">[</span><span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">du</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">du</span> <span class="o">&lt;</span> <span class="n">dl</span><span class="p">)</span> <span class="ow">and</span> <span class="n">du</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_tlr</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">iu</span>
            <span class="n">st</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">dl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">du</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dl</span> <span class="o">&lt;</span> <span class="n">du</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dl</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_tlr</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">st</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">compl</span> <span class="ow">and</span> <span class="s1">&#39;NL&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="ow">not</span> <span class="n">compl</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> \
                <span class="ow">and</span> <span class="s1">&#39;NL&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragments</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="n">st</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Screening.ms2_collect"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_collect">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms2matches</span><span class="p">,</span> <span class="n">ms1mz</span><span class="p">,</span> <span class="n">unknown</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deprecated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fragments</span> <span class="o">=</span> <span class="n">ms2matches</span><span class="p">[</span><span class="n">ms2matches</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ms1mz</span><span class="p">,:]</span>
        <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">uniqList</span><span class="p">(</span><span class="n">fragments</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">frag</span> <span class="o">!=</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">:</span>
                <span class="n">thisFrag</span> <span class="o">=</span> <span class="n">fragments</span><span class="p">[</span><span class="n">fragments</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">frag</span><span class="p">,:]</span>
                <span class="n">maxInt</span> <span class="o">=</span> <span class="n">thisFrag</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">thisFragMass</span> <span class="o">=</span> <span class="n">thisFrag</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frag</span><span class="p">,</span> <span class="n">maxInt</span><span class="p">,</span> <span class="n">thisFragMass</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">unknown</span><span class="p">:</span>
            <span class="n">unknowns</span> <span class="o">=</span> <span class="n">fragments</span><span class="p">[</span><span class="n">fragments</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,:]</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;Unknown&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">unknowns</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="Screening.ms2_headgroups2"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_headgroups2">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_headgroups2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This collects the possible headgroups from the</span>
<span class="sd">        advanced MS2 identification (done by ms2_scans_identify()).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2i</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">]):</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">hgssc</span><span class="p">:</span>
                                <span class="n">hgssc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="nb">filter</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">hgssc</span><span class="p">:</span>
                                    <span class="n">hgssc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">hgsca</span><span class="p">:</span>
                                        <span class="p">(</span><span class="n">hgsca</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="nb">sum</span><span class="p">(</span>
                                                <span class="nb">map</span><span class="p">(</span>
                                                    <span class="k">lambda</span> <span class="n">scan</span><span class="p">:</span>
                                                        <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span>
                                                    <span class="n">hgsca</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="p">)</span>
                                            <span class="p">)</span>
                                        <span class="p">),</span>
                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">consensus_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">ids</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2i</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">]):</span>
                    <span class="n">this_id</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">hg</span><span class="p">,</span> <span class="n">ms2ii</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ms2i</span><span class="p">):</span>
                        <span class="n">fa_level_id</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">hg_in_ms2</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">ms2iii</span> <span class="ow">in</span> <span class="n">ms2ii</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">ms2iii</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">hg_in_ms2</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">for</span> <span class="n">ms2fa</span> <span class="ow">in</span> <span class="n">ms2iii</span><span class="p">[</span><span class="s1">&#39;fattya&#39;</span><span class="p">]:</span>
                                    <span class="n">sumcc</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">cc1</span><span class="p">,</span> <span class="n">cc2</span><span class="p">:</span>
                                            <span class="p">(</span><span class="n">cc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cc1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cc2</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                        <span class="nb">map</span><span class="p">(</span>
                                            <span class="k">lambda</span> <span class="n">cc</span><span class="p">:</span>
                                                <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
                                            <span class="n">ms2fa</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;O-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                                    <span class="n">sumccstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sumcc</span>
                                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">and</span> \
                                        <span class="n">sumccstr</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]:</span>
                                            <span class="n">this_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">ms2fa</span><span class="p">))</span>
                                            <span class="n">fa_level_id</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">hg_in_ms2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fa_level_id</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                                <span class="k">for</span> <span class="n">ms1fa</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]:</span>
                                    <span class="n">this_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">ms1fa</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                                <span class="n">this_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
                    <span class="n">ids</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_id</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ids</span>
    
<div class="viewcode-block" id="Screening.ms2_headgroups"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_headgroups">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_headgroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates dictionaries named ms2hg having the</span>
<span class="sd">        original IDs as keys and the sets of the</span>
<span class="sd">        identified possible headgroups as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fai&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">hgfrags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pHgfrags</span> \
                    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nHgfrags</span>
                <span class="n">headgroups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pHeadgroups</span> \
                    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nHeadgroups</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2r</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2r&#39;</span><span class="p">]):</span>
                    <span class="n">hgroups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_headgroup2</span><span class="p">(</span><span class="n">ms2r</span><span class="p">,</span> <span class="n">hgfrags</span><span class="p">,</span> <span class="n">headgroups</span><span class="p">)</span>
                    <span class="n">ms2fa</span><span class="p">,</span> <span class="n">ms2fai</span><span class="p">,</span> <span class="n">ms2fas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2_fattya</span><span class="p">(</span><span class="n">ms2r</span><span class="p">)</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgroups</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms2fa</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fai&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms2fai</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms2fas</span></div>

<div class="viewcode-block" id="Screening.ms2_headgroup"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_headgroup">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_headgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms2r</span><span class="p">,</span> <span class="n">hgfrags</span><span class="p">,</span> <span class="n">headgroups</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies headgroups from MS2 results for one</span>
<span class="sd">        feature, based on dictionary of fragments and</span>
<span class="sd">        the characteristic combinations of fragments</span>
<span class="sd">        identifying headgroups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hgroups</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">frags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="c1"># collecting all possible headgroups for</span>
        <span class="c1"># each fragment into `hgroups` and all</span>
        <span class="c1"># fragments into `frags`</span>
        <span class="k">for</span> <span class="n">ms2item</span> <span class="ow">in</span> <span class="n">ms2r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ms2item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">hgfrags</span><span class="p">:</span>
                <span class="n">hgroups</span> <span class="o">=</span> <span class="n">hgfrags</span><span class="p">[</span><span class="n">ms2item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">hgroups</span> <span class="ow">is</span> <span class="kc">None</span> \
                    <span class="k">else</span> <span class="n">hgroups</span> <span class="o">&amp;</span> <span class="n">hgfrags</span><span class="p">[</span><span class="n">ms2item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">frags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ms2item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># if any headgroup related fragment found</span>
        <span class="k">if</span> <span class="n">hgroups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hgroups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">missingFrags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">hgroups</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">headgroups</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span> <span class="o">-</span> <span class="n">frags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">missingFrags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
            <span class="n">hgroups</span> <span class="o">=</span> <span class="n">hgroups</span> <span class="o">-</span> <span class="n">missingFrags</span> <span class="k">if</span> \
                <span class="nb">len</span><span class="p">(</span><span class="n">hgroups</span> <span class="o">-</span> <span class="n">missingFrags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">hgroups</span>
        <span class="k">return</span> <span class="n">hgroups</span></div>

<div class="viewcode-block" id="Screening.ms2_headgroup2"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_headgroup2">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_headgroup2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms2r</span><span class="p">,</span> <span class="n">hgfrags</span><span class="p">,</span> <span class="n">headgroups</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies headgroups from MS2 results for one</span>
<span class="sd">        feature, based on dictionary of fragments and</span>
<span class="sd">        the characteristic combinations of fragments</span>
<span class="sd">        identifying headgroups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_hgroups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_hgroups2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hgroups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">frags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="c1"># collecting all possible headgroups for</span>
        <span class="c1"># each fragment into `hgroups` and all</span>
        <span class="c1"># fragments into `frags`</span>
        <span class="k">for</span> <span class="n">ms2item</span> <span class="ow">in</span> <span class="n">ms2r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ms2item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">hgfrags</span><span class="p">:</span>
                <span class="n">_hgroups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hgfrags</span><span class="p">[</span><span class="n">ms2item</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">frags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ms2item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># if any headgroup related fragment found</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_hgroups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hgs</span> <span class="ow">in</span> <span class="n">_hgroups</span><span class="p">:</span>
                <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hgs2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_hgroups2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hgs</span> <span class="o">&amp;</span> <span class="n">hgs2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_hgroups2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgs</span> <span class="o">&amp;</span> <span class="n">hgs2</span>
                        <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">added</span><span class="p">:</span>
                    <span class="n">_hgroups2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hgs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hgs</span> <span class="ow">in</span> <span class="n">_hgroups2</span><span class="p">:</span>
            <span class="n">hgroups</span> <span class="o">=</span> <span class="n">hgroups</span> <span class="o">|</span> <span class="n">hgs</span>
        <span class="k">return</span> <span class="n">hgroups</span></div>

<div class="viewcode-block" id="Screening.headgroups_negative_positive"><a class="viewcode-back" href="../../index.html#emese.main.Screening.headgroups_negative_positive">[docs]</a>    <span class="k">def</span> <span class="nf">headgroups_negative_positive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates dictionaries named ms1hg_pos, ms1hg_neg,</span>
<span class="sd">        ms2hg_pos or ms2hg_neg with the original</span>
<span class="sd">        IDs of the given mode as keys, with dicts as</span>
<span class="sd">        values having the original IDs of the other mode</span>
<span class="sd">        as keys and the combined set of headgroups as </span>
<span class="sd">        values. The combined set is the intersection of</span>
<span class="sd">        those detected in the 2 modes, or the union, if</span>
<span class="sd">        there is no intersection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg_neg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg_pos&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">poi</span><span class="p">,</span> <span class="n">nois</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">poi</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">][</span><span class="n">poi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">noi</span> <span class="ow">in</span> <span class="n">nois</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">noi</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">][</span><span class="n">noi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">poi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg_neg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">]:</span>
                                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg_neg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">][</span><span class="n">poi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="k">if</span> <span class="n">noi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg_pos&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">]:</span>
                                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg_pos&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">][</span><span class="n">noi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="n">poshg</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">][</span><span class="n">poi</span><span class="p">]</span>
                                    <span class="n">neghg</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">][</span><span class="n">noi</span><span class="p">]</span>
                                    <span class="n">combined</span> <span class="o">=</span> <span class="n">poshg</span> <span class="o">&amp;</span> <span class="n">neghg</span> \
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">poshg</span> <span class="o">&amp;</span> <span class="n">neghg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                                        <span class="k">else</span> <span class="n">poshg</span> <span class="o">|</span> <span class="n">neghg</span>
                                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg_neg&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">][</span><span class="n">poi</span><span class="p">][</span><span class="n">noi</span><span class="p">]</span> <span class="o">=</span> \
                                        <span class="n">combined</span>
                                    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">hg_pos&#39;</span><span class="o">%</span><span class="n">ms</span><span class="p">][</span><span class="n">noi</span><span class="p">][</span><span class="n">poi</span><span class="p">]</span> <span class="o">=</span> \
                                        <span class="n">combined</span></div>

<div class="viewcode-block" id="Screening.ms2_fattya"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_fattya">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_fattya</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms2r</span><span class="p">,</span> <span class="n">highest</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies the fatty acids with highest intensities.</span>
<span class="sd">        Returns only number of `highest` fatty acids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recnum</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*[^0-9]([0-9]+:[0-9]+).*&#39;</span><span class="p">)</span>
        <span class="c1"># reverse sort by intensities</span>
        <span class="n">ms2fa</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">ms2fai</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ms2fas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># if we have MS2 data at all:</span>
        <span class="k">if</span> <span class="n">ms2r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ms2r</span> <span class="o">=</span> <span class="n">ms2r</span><span class="p">[</span><span class="n">ms2r</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],:]</span>
            <span class="n">fanum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ms2f</span> <span class="ow">in</span> <span class="n">ms2r</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;FA&#39;</span> <span class="ow">in</span> <span class="n">ms2f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Lyso&#39;</span> <span class="ow">in</span> <span class="n">ms2f</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">fa</span> <span class="o">=</span> <span class="n">recnum</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ms2f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">fa</span> <span class="o">=</span> <span class="n">fa</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">fa</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ms2fa</span><span class="p">:</span>
                        <span class="c1"># a set with fatty std formulas</span>
                        <span class="c1"># [carbon count]:[unsaturated count]</span>
                        <span class="n">ms2fa</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span>
                        <span class="c1"># a list with intensities decreasing</span>
                        <span class="n">ms2fai</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fa</span><span class="p">,</span> <span class="n">ms2f</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                        <span class="n">fanum</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">fanum</span> <span class="o">==</span> <span class="n">highest</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="c1"># sum formula</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2fa</span><span class="p">)</span> <span class="o">==</span> <span class="n">highest</span><span class="p">:</span>
                <span class="n">carbs</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">unsats</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="n">ms2fa</span><span class="p">:</span>
                    <span class="n">carb</span><span class="p">,</span> <span class="n">unsat</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">fa</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span>
                    <span class="n">carbs</span> <span class="o">+=</span> <span class="n">carb</span>
                    <span class="n">unsats</span> <span class="o">+=</span> <span class="n">unsat</span>
                <span class="n">ms2fas</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">carbs</span><span class="p">,</span> <span class="n">unsats</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ms2fa</span><span class="p">,</span> <span class="n">ms2fai</span><span class="p">,</span> <span class="n">ms2fas</span></div>
    
<div class="viewcode-block" id="Screening.ms2_cleanup"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all MS2 related objects for all proteins or</span>
<span class="sd">        only those in list `proteins` in order to free up</span>
<span class="sd">        memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2fa&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2f&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;ms2fai&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2r&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2i&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;ms2fas&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2fai&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2i2&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;ms2hg2&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2i3&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2&#39;</span><span class="p">]</span>
        
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">proteins</span>
        
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
            
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms2map</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">tbl</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    END: MS2 functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    BEGIN: New identification methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">ms2_scans_identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;Analysing MS2 scans and identifying features&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="n">logdir</span> <span class="o">=</span> <span class="s1">&#39;ms2log_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">logdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">logdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span><span class="n">f</span><span class="p">)),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">logdir</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ms2log</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2&#39;</span><span class="p">]:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">oi</span><span class="p">)</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">identify</span><span class="p">()</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">identify2</span><span class="p">()</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">identities</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">identities2</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">ms2_get_hgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2results</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">]):</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i3&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="k">for</span> <span class="n">hg</span><span class="p">,</span> <span class="n">ms2res</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ms2results</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">ms2res</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i3&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    END: New identification methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pipeline elements</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="Screening.write_out"><a class="viewcode-back" href="../../index.html#emese.main.Screening.write_out">[docs]</a>    <span class="k">def</span> <span class="nf">write_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In:</span>
<span class="sd">        [0] pos_m/z, pos_profile_score, </span>
<span class="sd">        [2] pos_control_profile_score, pos_rank_profile_boolean,</span>
<span class="sd">        [4] pos_ubiquity_score, pos_ubiquity_score,</span>
<span class="sd">        [6] pos_original_index, pos_swisslipids_ac, pos_level, </span>
<span class="sd">        [9] pos_lipid_name, pos_lipid_formula, pos_adduct, pos_adduct_m/z</span>
<span class="sd">        [13] neg_m/z, neg_profile_score, neg_control_profile_score,</span>
<span class="sd">        [16] neg_rank_profile_boolean,</span>
<span class="sd">        [17] neg_ubiquity_score, neg_ubiquity_score, neg_original_index,</span>
<span class="sd">        [20] neg_swisslipids_ac, neg_level,</span>
<span class="sd">        [22] neg_lipid_name, neg_lipid_formula, neg_adduct, neg_adduct_m/z</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LTP&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Positive_m/z&#39;</span><span class="p">,</span> <span class="s1">&#39;Positive_m/z_in_SwissLipids&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Positive_adduct&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Negative_m/z&#39;</span><span class="p">,</span> <span class="s1">&#39;Negative_m/z_in_SwissLipids&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;Negative_adduct&#39;</span><span class="p">,</span>
                <span class="s1">&#39;SwissLipids_AC&#39;</span><span class="p">,</span> <span class="s1">&#39;SwissLipids_formula&#39;</span><span class="p">,</span> <span class="s1">&#39;SwissLipids_name&#39;</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ltp</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%08f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;</span><span class="si">%08f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">l</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%08f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">l</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
                        <span class="s1">&#39;</span><span class="si">%08f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">l</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">9</span><span class="p">])])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">counts_redundancy_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lipids</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;unique_features_counts.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;LTP-mode&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown_features&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;lipid_matching_features&#39;</span><span class="p">,</span> <span class="s1">&#39;lipids&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%u</span><span class="se">\t</span><span class="si">%u</span><span class="se">\t</span><span class="si">%u</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span> \
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">unknowns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">unknowns</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">uniqList</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">7</span><span class="p">])))</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lipids</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> \
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> 
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">uniqList</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">7</span><span class="p">])))</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">unknowns</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> \
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]))</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lipids</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> \
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">values</span><span class="p">()])))</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    These are the highest level methods for reading all data and annotations,</span>
<span class="sd">    making sure everything is ready to run the analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="Screening.init_from_scratch"><a class="viewcode-back" href="../../index.html#emese.main.Screening.init_from_scratch">[docs]</a>    <span class="k">def</span> <span class="nf">init_from_scratch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does all the initial preprocessing.</span>
<span class="sd">        Saves intermediate data, so it can be loaded faster </span>
<span class="sd">        for next sessions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_filenames</span><span class="p">()</span>
        <span class="c1"># at first run, after reading from saved textfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_annotations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_pptable</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;ctrl&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datafiles</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">datafiles</span><span class="p">[</span><span class="s1">&#39;ctrl&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_missing_gel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="Screening.init_reinit"><a class="viewcode-back" href="../../index.html#emese.main.Screening.init_reinit">[docs]</a>    <span class="k">def</span> <span class="nf">init_reinit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializing from preprocessed and dumped data.</span>
<span class="sd">        Pickle file has a 2.0GB size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_annotations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp2</span><span class="p">()</span></div>
    
    <span class="c1">#</span>
    <span class="c1"># Reading annotations</span>
    <span class="c1">#</span>
    
<div class="viewcode-block" id="Screening.read_annotations"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_annotations">[docs]</a>    <span class="k">def</span> <span class="nf">read_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads all additional annotations necessary for data processing.</span>
<span class="sd">        These are:</span>
<span class="sd">        - fractions: which fraction is protein containing,</span>
<span class="sd">        control, or have not been measured</span>
<span class="sd">        - lipid names: short notations, database keywords and most</span>
<span class="sd">        abundant adducts for lipid classes</span>
<span class="sd">        - binding properties: known binders of lipid </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_fractions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper_fractions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_lipid_names</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_binding_properties</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="Screening.read_fractions"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_fractions">[docs]</a>    <span class="k">def</span> <span class="nf">read_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads from file sample/control annotations</span>
<span class="sd">        for each proteins.</span>
<span class="sd">        Also reads the highest fractions which is used if we use</span>
<span class="sd">        the profile evaluation method from Enric.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">refr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([A-Z])([0-9]{1,2})-?([A-Z]?)([0-9]{0,2})&#39;</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">get_names</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            
            <span class="k">return</span> \
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span>
                        <span class="n">n</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">n</span><span class="p">,</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span>
                            <span class="n">n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                        <span class="n">names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">get_fractions</span><span class="p">(</span><span class="n">frlist</span><span class="p">):</span>
            
            <span class="k">return</span> \
                <span class="nb">list</span><span class="p">(</span>
                    <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                        <span class="o">*</span><span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">num</span><span class="p">:</span>
                                        <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num</span><span class="p">),</span>
                                    <span class="n">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">else</span> \
                                <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                            <span class="n">refr</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">frlist</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">get_hpeak</span><span class="p">(</span><span class="n">hfracs</span><span class="p">):</span>
            
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">hf</span><span class="p">:</span>
                            <span class="n">hf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">),</span>
                        <span class="n">hfracs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcont_fracs_from_abs</span><span class="p">:</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractionsf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                
                <span class="n">null</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
                    
                    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    
                    <span class="n">data</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">to_int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="p">])</span>
                    <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="n">data</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractionsf</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;xlsx&#39;</span><span class="p">):</span>
                
                <span class="n">tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractionsf</span><span class="p">,</span> <span class="n">sheet</span> <span class="o">=</span> <span class="s1">&#39;status&#39;</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_fractions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpeak</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">tuple</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="nb">dict</span><span class="p">,</span>
                            <span class="nb">zip</span><span class="p">(</span>
                                <span class="o">*</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                                    <span class="o">*</span><span class="nb">map</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                            <span class="nb">list</span><span class="p">(</span>
                                                <span class="nb">map</span><span class="p">(</span>
                                                    <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span>
                                                        <span class="p">[</span>
                                                            <span class="p">(</span>
                                                                <span class="n">n</span><span class="p">,</span> <span class="c1"># protein name</span>
                                                                <span class="n">get_fractions</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
                                                            <span class="p">),</span>
                                                            <span class="p">(</span>
                                                                <span class="n">n</span><span class="p">,</span> <span class="c1"># protein name</span>
                                                                <span class="n">get_hpeak</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">18</span><span class="p">])</span>
                                                            <span class="p">)</span>
                                                        <span class="p">],</span>
                                                    <span class="n">get_names</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                <span class="p">)</span>
                                            <span class="p">),</span>
                                        <span class="nb">filter</span><span class="p">(</span>
                                            <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                                <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span> <span class="ow">and</span> \
                                                    <span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;NA&#39;</span> <span class="ow">and</span> <span class="p">(</span>
                                                        <span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span>
                                                        <span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                                                    <span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()),</span>
                                            <span class="n">tab</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractionsf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fractions</span> <span class="o">=</span> \
                        <span class="nb">dict</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                    <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                        <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">),</span>
                                    <span class="nb">filter</span><span class="p">(</span>
                                        <span class="nb">len</span><span class="p">,</span>
                                        <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.set_measured"><a class="viewcode-back" href="../../index.html#emese.main.Screening.set_measured">[docs]</a>    <span class="k">def</span> <span class="nf">set_measured</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a dict of arrays with value 1 if the fracion is either</span>
<span class="sd">        protein containing or control (i.e. measured), or `None` otherwise.</span>
<span class="sd">        </span>
<span class="sd">        The result is stored in `measured` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measured</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span>
                <span class="n">k</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">))</span></div>

<div class="viewcode-block" id="Screening.upper_fractions"><a class="viewcode-back" href="../../index.html#emese.main.Screening.upper_fractions">[docs]</a>    <span class="k">def</span> <span class="nf">upper_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the dict ``fractions_upper`` of fractions with</span>
<span class="sd">        uppercase LTP names, with same content as ``fractions``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fractions&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span> <span class="o">=</span> \
                <span class="nb">dict</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="Screening.set_onepfraction"><a class="viewcode-back" href="../../index.html#emese.main.Screening.set_onepfraction">[docs]</a>    <span class="k">def</span> <span class="nf">set_onepfraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a list of those proteins present only in one fraction.</span>
<span class="sd">        Abundance ratio for these can not be calculated.</span>
<span class="sd">        </span>
<span class="sd">        The result stored in ``onepfraction`` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onepfraction</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">sum</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="Screening.read_lipid_names"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_lipid_names">[docs]</a>    <span class="k">def</span> <span class="nf">read_lipid_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads annotations for lipid classes:</span>
<span class="sd">        - full names</span>
<span class="sd">        - short notations</span>
<span class="sd">        - database keywords</span>
<span class="sd">        (to process long names from SwissLipids and LipidMaps)</span>
<span class="sd">        - most abundant adducts</span>
<span class="sd">        </span>
<span class="sd">        The input file is given by the ``lipnamesf`` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipnamesf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nul</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;full_name&#39;</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;swl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_db_keywords</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s1">&#39;lmp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_db_keywords</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="s1">&#39;pos_adduct&#39;</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ND&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">adducts_constraints</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;neg_adduct&#39;</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ND&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">adducts_constraints</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span> <span class="o">=</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Screening.read_binding_properties"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_binding_properties">[docs]</a>    <span class="k">def</span> <span class="nf">read_binding_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the known binders for each lipid class.</span>
<span class="sd">        The input file name is provided by `bindpropf` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bindpropf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> \
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">),</span>
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">),</span>
                                <span class="n">f</span>
                            <span class="p">)</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">lip</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">lip</span> <span class="o">!=</span> <span class="s1">&#39;ND&#39;</span> <span class="ow">and</span> <span class="n">lip</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">bindprop</span> <span class="o">=</span> <span class="n">result</span></div>
    
    <span class="c1">#</span>
    <span class="c1"># END: Reading annotations</span>
    <span class="c1">#</span>
    
<div class="viewcode-block" id="Screening.basic_filters"><a class="viewcode-back" href="../../index.html#emese.main.Screening.basic_filters">[docs]</a>    <span class="k">def</span> <span class="nf">basic_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_treshold</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">ubiquity_treshold</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deprecated with new data structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_filters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validity_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_filter</span><span class="p">(</span><span class="n">prfx</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubiquity_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_ubi_filter</span><span class="p">(</span><span class="n">ubiquity</span> <span class="o">=</span> <span class="n">ubiquity_treshold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rprofile_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_prf_filter</span><span class="p">(</span><span class="n">treshold</span> <span class="o">=</span> <span class="n">profile_treshold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_rpr_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_ubi_prf_filter</span><span class="p">(</span><span class="n">treshold</span> <span class="o">=</span> <span class="n">profile_treshold</span><span class="p">,</span>
            <span class="n">ubiquity</span> <span class="o">=</span> <span class="n">ubiquity_treshold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_ubi_prf_rprf_filter</span><span class="p">(</span><span class="n">treshold</span> <span class="o">=</span> <span class="n">profile_treshold</span><span class="p">,</span>
            <span class="n">ubiquity</span> <span class="o">=</span> <span class="n">ubiquity_treshold</span><span class="p">)</span></div>

<div class="viewcode-block" id="Screening.basic_filters_with_evaluation"><a class="viewcode-back" href="../../index.html#emese.main.Screening.basic_filters_with_evaluation">[docs]</a>    <span class="k">def</span> <span class="nf">basic_filters_with_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">profile_treshold</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">ubiquity_treshold</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deprecated with new data structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filtr_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;peaksize&#39;</span><span class="p">,</span> <span class="s1">&#39;validity&#39;</span><span class="p">]:</span>
            <span class="n">filtr_results</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_filter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;ubiquity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;ubiquity&#39;</span><span class="p">,</span>
        <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;only_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">ubiquity_treshold</span><span class="p">)</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;val_ubi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;val_ubi&#39;</span><span class="p">,</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ubiquity&#39;</span><span class="p">:</span> <span class="n">ubiquity_treshold</span><span class="p">})</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;profile025&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prfx&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
            <span class="n">hit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">profile_treshold</span><span class="p">)</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;cprofile025&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;cprofile&#39;</span><span class="p">,</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
            <span class="n">hit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">profile_treshold</span><span class="p">)</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;rprofile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;rprofile&#39;</span><span class="p">,</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;val_prf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;val_prf&#39;</span><span class="p">,</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;treshold&#39;</span><span class="p">:</span> <span class="n">profile_treshold</span><span class="p">})</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;val_rpr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;val_rpr&#39;</span><span class="p">)</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;val_ubi_prf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;val_ubi_prf&#39;</span><span class="p">,</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;treshold&#39;</span><span class="p">:</span> <span class="n">profile_treshold</span><span class="p">,</span>
                     <span class="s1">&#39;ubiquity&#39;</span><span class="p">:</span> <span class="n">ubiquity_treshold</span><span class="p">})</span>
        <span class="n">filtr_results</span><span class="p">[</span><span class="s1">&#39;val_ubi_prf_rprf&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_filter</span><span class="p">(</span><span class="s1">&#39;val_ubi_prf_rprf&#39;</span><span class="p">,</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;treshold&#39;</span><span class="p">:</span> <span class="n">profile_treshold</span><span class="p">,</span>
                     <span class="s1">&#39;ubiquity&#39;</span><span class="p">:</span> <span class="n">ubiquity_treshold</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_results</span> <span class="o">=</span> <span class="n">filtr_results</span></div>

    <span class="k">def</span> <span class="nf">positive_negative_runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;negative_positive(lipids)&#39;</span><span class="p">,</span> 
            <span class="n">setup</span> <span class="o">=</span> <span class="s1">&#39;from __main__ import negative_positive, lipids&#39;</span><span class="p">,</span>
            <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Screening.valid_features"><a class="viewcode-back" href="../../index.html#emese.main.Screening.valid_features">[docs]</a>    <span class="k">def</span> <span class="nf">valid_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates new dict of arrays with only valid features.</span>
<span class="sd">        Keys:</span>
<span class="sd">        - &#39;fe&#39;: features</span>
<span class="sd">        - &#39;mz&#39;: m/z values</span>
<span class="sd">        - &#39;i&#39;: original index</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_marco</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validscache</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validscache</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_filters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validity_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{}})</span> \
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            
            <span class="n">protein</span> <span class="o">=</span> <span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;fe&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;smp&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">]])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;qua&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">],</span> <span class="mi">5</span><span class="p">])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;rt&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;aa&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">]])</span>
                
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">,</span> <span class="s1">&#39;pslim02&#39;</span><span class="p">,</span> <span class="s1">&#39;pslim05&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;pslim10&#39;</span><span class="p">,</span> <span class="s1">&#39;pslim510&#39;</span><span class="p">,</span> <span class="s1">&#39;rtm&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;vld&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_area</span><span class="p">()</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validscache</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">get_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: WARNING: Could not&#39;</span>\
                        <span class="s1">&#39; calculate area: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">data2valids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein_l</span><span class="p">,</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbld</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">dd</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tbld</span><span class="p">:</span>
                    <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_l</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">mode</span><span class="p">]</span>
                    <span class="n">valids_array</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                        <span class="n">valids_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbld</span><span class="p">[</span><span class="n">key</span><span class="p">][(</span><span class="n">oi</span><span class="p">,)])</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valids_array</span><span class="p">)</span>
    
<div class="viewcode-block" id="Screening.delete_array"><a class="viewcode-back" href="../../index.html#emese.main.Screening.delete_array">[docs]</a>    <span class="k">def</span> <span class="nf">delete_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes the data belonging to one key</span>
<span class="sd">        from all tables (at every protein in each modes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">tbl</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="Screening.norm_all"><a class="viewcode-back" href="../../index.html#emese.main.Screening.norm_all">[docs]</a>    <span class="k">def</span> <span class="nf">norm_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates table with all the profiles normalized</span>
<span class="sd">        Keys:</span>
<span class="sd">        - &#39;no&#39;: normalized profiles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_profiles</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">])</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    END: pipeline elements</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Distance metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="Screening.profiles_corr"><a class="viewcode-back" href="../../index.html#emese.main.Screening.profiles_corr">[docs]</a>    <span class="k">def</span> <span class="nf">profiles_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">prfx</span><span class="p">,</span> <span class="n">pprofs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates custom correlation metric</span>
<span class="sd">        between each feature and the protein profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;a9&#39;</span><span class="p">,</span> <span class="s1">&#39;a10&#39;</span><span class="p">,</span> <span class="s1">&#39;a11&#39;</span><span class="p">,</span> <span class="s1">&#39;a12&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">]</span>
        <span class="n">pprs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pprofs</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pprofs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="n">ppr</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span>
                            <span class="n">pprs</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">frs</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span>
                        <span class="nb">filter</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span>
                                <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_profile</span><span class="p">(</span><span class="n">ppr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;no&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">norm_all</span><span class="p">()</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">v</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prfx</span><span class="p">,</span> <span class="n">pprofs</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">p</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prfx</span><span class="p">,</span> <span class="n">pprofs</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fe</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">]):</span>
                    <span class="c1"># if one feature is not detected</span>
                    <span class="c1"># in any fraction of the sample,</span>
                    <span class="c1"># it will have a nan value:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span>\
                            <span class="n">fe</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>\
                                <span class="p">[</span><span class="n">fr</span> <span class="o">==</span> <span class="mi">1</span> \
                                    <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> \
                                    <span class="k">if</span> <span class="n">fr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                            <span class="p">)]</span>
                        <span class="p">)):</span>
                        <span class="n">vp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vp</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">ppr</span><span class="p">)</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">v</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prfx</span><span class="p">,</span> <span class="n">pprofs</span><span class="p">)][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">p</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prfx</span><span class="p">,</span> <span class="n">pprofs</span><span class="p">)][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Screening.gkgamma"><a class="viewcode-back" href="../../index.html#emese.main.Screening.gkgamma">[docs]</a>    <span class="k">def</span> <span class="nf">gkgamma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls Goodman-Kruskal&#39;s gamma from vcdExtra</span>
<span class="sd">        R package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gkg</span> <span class="o">=</span> <span class="n">rvcd</span><span class="o">.</span><span class="n">GKgamma</span><span class="p">(</span><span class="n">rbase</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">rbase</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">))),</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># gamma, 0.0, C, D, sigma, CIlevel, CI</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">gkg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gkg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span></div>

<div class="viewcode-block" id="Screening.roco"><a class="viewcode-back" href="../../index.html#emese.main.Screening.roco">[docs]</a>    <span class="k">def</span> <span class="nf">roco</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls R function robust correlation coefficient</span>
<span class="sd">        with test from rococo R package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)))]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)))]</span>
        <span class="k">if</span> <span class="n">_x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">_y</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_x</span> <span class="o">==</span> <span class="n">_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">_y</span> <span class="o">==</span> <span class="n">_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">rbase</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="o">*</span><span class="n">_x</span><span class="p">)</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">rbase</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="o">*</span><span class="n">_y</span><span class="p">)</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">rococo</span><span class="o">.</span><span class="n">rococo_test</span><span class="p">(</span> \
            <span class="n">rbase</span><span class="o">.</span><span class="n">as_vector</span><span class="p">(</span><span class="n">rstats</span><span class="o">.</span><span class="n">na_omit</span><span class="p">(</span><span class="n">_x</span><span class="o">.</span><span class="n">rx</span><span class="p">(</span> \
                <span class="n">rbase</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>\
                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="ow">not</span> <span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">rbase</span><span class="o">.</span><span class="n">is_na</span><span class="p">(</span><span class="n">_y</span><span class="p">))))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))))),</span> \
            <span class="n">rbase</span><span class="o">.</span><span class="n">as_vector</span><span class="p">(</span><span class="n">rstats</span><span class="o">.</span><span class="n">na_omit</span><span class="p">(</span><span class="n">_y</span><span class="o">.</span><span class="n">rx</span><span class="p">(</span> \
                <span class="n">rbase</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>\
                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="ow">not</span> <span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">rbase</span><span class="o">.</span><span class="n">is_na</span><span class="p">(</span><span class="n">_x</span><span class="p">))))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))))))</span>
        <span class="k">return</span> <span class="n">rt</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="s1">&#39;sample.gamma&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rt</span><span class="o">.</span><span class="n">slots</span><span class="p">[</span><span class="s1">&#39;p.value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_diff_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for diff_profiles() to return a tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_profiles</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mf">0.0</span>

<div class="viewcode-block" id="Screening.euclidean_dist"><a class="viewcode-back" href="../../index.html#emese.main.Screening.euclidean_dist">[docs]</a>    <span class="k">def</span> <span class="nf">euclidean_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates simple euclidean distance after removing NaN values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)))]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)))]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">euclidean</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Screening.euclidean_dist_norm"><a class="viewcode-back" href="../../index.html#emese.main.Screening.euclidean_dist_norm">[docs]</a>    <span class="k">def</span> <span class="nf">euclidean_dist_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This euclidean distance is normalized by the number of dimensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)))]</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)))]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">euclidean</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Screening.profiles_corrs"><a class="viewcode-back" href="../../index.html#emese.main.Screening.profiles_corrs">[docs]</a>    <span class="k">def</span> <span class="nf">profiles_corrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pprofs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates an array of similarity/correlation</span>
<span class="sd">        metrics between each MS intensity profile and </span>
<span class="sd">        the corresponding protein concentration profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">kendalltau</span><span class="p">,</span> <span class="s1">&#39;kt&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_diff_profiles</span><span class="p">,</span> <span class="s1">&#39;df&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gkgamma</span><span class="p">,</span> <span class="s1">&#39;gk&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roco</span><span class="p">,</span> <span class="s1">&#39;rc&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">euclidean_dist</span><span class="p">,</span> <span class="s1">&#39;eu&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">euclidean_dist_norm</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">,</span> <span class="s1">&#39;pe&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comp_profiles</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">prfx</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Calculating </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profiles_corr</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">prfx</span><span class="p">,</span> <span class="n">pprofs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">inconsistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;en&#39;</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">v&#39;</span><span class="o">%</span><span class="n">metric</span>
        <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">i&#39;</span><span class="o">%</span><span class="n">metric</span>
        <span class="n">sort_alll</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                <span class="n">incs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                <span class="n">inco</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> \
                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">incs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">incs</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">incs</span><span class="p">[:</span><span class="n">i</span><span class="p">]),</span>
                        <span class="n">xrange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">incs</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">de&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span> <span class="n">incs</span><span class="p">),</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">dde&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span> 
                    <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">de&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">])),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">inco</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    END: disctance metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functions for clustering</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eu&#39;</span><span class="p">],</span> <span class="n">with_pprof</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;eu&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;euclidean distance&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">euclidean_dist</span><span class="p">),</span>
            <span class="s1">&#39;en&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;normalized euclidean distance&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">euclidean_dist_norm</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">frs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;a9&#39;</span><span class="p">,</span> <span class="s1">&#39;a10&#39;</span><span class="p">,</span> <span class="s1">&#39;a11&#39;</span><span class="p">,</span> <span class="s1">&#39;a12&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;Calculating </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">with_pprof</span><span class="p">:</span>
                        <span class="n">ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span><span class="p">[</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">frs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> \
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span> \
                                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
                        <span class="n">ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_profile</span><span class="p">(</span><span class="n">ppr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                        <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                        <span class="n">fnum</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># square shape matrix of all features vs all features</span>
                        <span class="k">if</span> <span class="n">with_pprof</span><span class="p">:</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">fnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">fnum</span><span class="p">,</span> <span class="n">fnum</span><span class="p">))</span>
                        <span class="c1"># to keep track the order accross sorting</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">o&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">fnum</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">fnum</span><span class="p">):</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                                    <span class="n">_metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,:])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">with_pprof</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">fnum</span><span class="p">):</span>
                                <span class="n">ppr_dist</span> <span class="o">=</span> <span class="n">_metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:],</span> <span class="n">ppr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppr_dist</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppr_dist</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_metrics</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span><span class="n">ppr</span><span class="p">,</span> <span class="n">ppr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Time elapsed: </span><span class="si">%u</span><span class="s1">s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="Screening.features_clustering"><a class="viewcode-back" href="../../index.html#emese.main.Screening.features_clustering">[docs]</a>    <span class="k">def</span> <span class="nf">features_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;ward&#39;</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Using the distance matrices calculated by</span>
<span class="sd">        `distance_matrix()`, builds clusters using</span>
<span class="sd">        the linkage method given by `method` arg.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> \
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;Calculating clusters&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                    <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span> <span class="o">=</span> <span class="n">fastcluster</span><span class="o">.</span><span class="n">linkage</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">],</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span>
                            <span class="n">preserve_input</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">distance_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="s1">&#39;en&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">dc&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                        <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">][:,</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">][:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> \
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>

    <span class="k">def</span> <span class="nf">fcluster_with_protein</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lin</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">fcluster</span><span class="p">(</span><span class="n">lin</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">criterion</span> <span class="o">=</span> <span class="s1">&#39;distance&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fc</span> <span class="o">==</span> <span class="n">fc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">nodes_in_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lin</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">lin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">lin</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">singletons</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">,</span> <span class="n">nodes</span><span class="p">))</span>
        <span class="n">upper_levels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">singletons</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">upper_levels</span><span class="p">:</span>
            <span class="n">singletons</span> <span class="o">=</span> <span class="n">singletons</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_in_cluster</span><span class="p">(</span><span class="n">lin</span><span class="p">,</span> <span class="n">u</span> <span class="o">-</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">singletons</span>

    <span class="k">def</span> <span class="nf">_get_link_colors_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
        <span class="n">highlight_color</span><span class="p">,</span> <span class="n">base_color</span><span class="p">):</span>
        <span class="n">protein_fc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcluster_with_protein</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span> <span class="o">%</span> <span class="n">dist</span><span class="p">],</span> <span class="n">threshold</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> 
                <span class="n">highlight_color</span> \
                    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_in_cluster</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span> <span class="o">%</span> <span class="n">dist</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span> <span class="o">&lt;=</span> \
                        <span class="n">protein_fc</span> \
                    <span class="k">else</span> <span class="n">base_color</span><span class="p">,</span>
            <span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> \
                <span class="p">[</span><span class="n">highlight_color</span> \
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">protein_fc</span><span class="p">)</span> <span class="o">==</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                    <span class="k">else</span> <span class="n">base_color</span><span class="p">]</span>
        <span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_link_colors_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
        <span class="n">highlight_color</span><span class="p">,</span> <span class="n">base_color</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
            <span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="c1"># 180</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span>
                <span class="s1">&#39;#</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">cc</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%02X</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cc</span><span class="o">*</span><span class="mi">255</span><span class="p">),</span> <span class="n">col</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span> \
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="k">else</span> <span class="n">col</span><span class="p">,</span>
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span>
                    <span class="c1"># color from correlation value:</span>
                    <span class="c1">#&#39;#%s%s00&#39; % (&#39;%02X&#39;%(c*255), &#39;%02X&#39;%(c*255)) \</span>
                    <span class="n">cmap</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="n">base_color</span><span class="p">,</span> <span class="c1"># &#39;#FEFE00&#39;</span>
                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                        <span class="c1"># minimum of these correlations</span>
                        <span class="c1"># for each link:</span>
                        <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">xx</span><span class="p">:</span>
                            <span class="c1"># correlation of distances for one link:</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">dc&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">][</span><span class="n">xx</span><span class="p">],</span> <span class="c1"># 0.9999928, 0.9999871</span>
                            <span class="c1"># nodes for each link:</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">nodes_in_cluster</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span> <span class="o">%</span> <span class="n">dist</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>
                        <span class="p">)),</span>
                        <span class="c1"># all links (rows in linkage matrix):</span>
                        <span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># 45</span>
                    <span class="p">)</span> <span class="o">+</span> \
                    <span class="c1"># this is for the root:</span>
                    <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">dc&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">])]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_dendrogram_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
        <span class="n">highlight_color</span><span class="p">,</span> <span class="n">base_color</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thershold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_cmap</span> <span class="o">=</span> <span class="s1">&#39;inferno&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_cmap</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> \
                    <span class="n">highlight_color</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="k">else</span> <span class="n">base_color</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="p">,</span> <span class="n">cmap</span><span class="p">):</span>
                <span class="n">_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_cmap</span>

    <span class="k">def</span> <span class="nf">_cluster_size_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="n">dist_values</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dist_values</span> <span class="o">=</span> <span class="n">dist_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist_values</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist_values</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dist_values</span><span class="p">)</span>
        <span class="n">_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dist_values</span><span class="p">)</span>
        <span class="n">_lower</span> <span class="o">=</span> <span class="n">_min</span>
        <span class="n">_upper</span> <span class="o">=</span> <span class="n">_max</span>
        <span class="n">_conv</span> <span class="o">=</span> <span class="mi">9999</span>
        <span class="n">_dconvs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">_lower</span> <span class="o">+</span> <span class="n">_upper</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">fcluster</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">],</span> <span class="n">_threshold</span><span class="p">)</span>
            <span class="n">mean_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">_over</span> <span class="o">=</span> <span class="n">mean_size</span> <span class="o">&gt;</span> <span class="n">threshold</span>
            <span class="k">if</span> <span class="n">mean_size</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">_upper</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_upper</span> <span class="o">-</span> <span class="p">(</span><span class="n">_upper</span> <span class="o">-</span> <span class="n">_lower</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mean_size</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">_lower</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_lower</span> <span class="o">+</span> <span class="p">(</span><span class="n">_upper</span> <span class="o">-</span> <span class="n">_lower</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_lower</span> <span class="o">&gt;=</span> <span class="n">_upper</span><span class="p">:</span>
                <span class="n">_upper</span> <span class="o">+=</span> <span class="p">(</span><span class="n">_upper</span> <span class="o">-</span> <span class="n">_lower</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span>
            <span class="n">_dconvs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_conv</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_size</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">))</span>
            <span class="n">_conv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">threshold</span> <span class="o">-</span> <span class="n">mean_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_dconvs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> \
                <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_dconvs</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span> <span class="o">-</span> <span class="n">_dconvs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.005</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_threshold</span>

    <span class="k">def</span> <span class="nf">_inconsistency_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="mi">20</span>
        <span class="n">clustering</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]</span>
        <span class="n">incons</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">inconsistent</span><span class="p">(</span><span class="n">clustering</span><span class="p">)</span>
        <span class="n">maxincons</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">maxinconsts</span><span class="p">(</span><span class="n">clustering</span><span class="p">,</span> <span class="n">incons</span><span class="p">)</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">fcluster</span><span class="p">(</span><span class="n">clustering</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> 
            <span class="n">criterion</span> <span class="o">=</span> <span class="s1">&#39;maxclust_monocrit&#39;</span><span class="p">,</span> <span class="n">monocrit</span> <span class="o">=</span> <span class="n">maxincons</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fc</span> <span class="o">==</span> <span class="n">fc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nodes in same cluster as protein: </span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
        <span class="n">_threshold</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> 
                <span class="n">clustering</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> 
                    <span class="n">nodes_in_cluster</span><span class="p">(</span><span class="n">clustering</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nodes</span><span class="p">,</span>
                    <span class="n">xrange</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_threshold</span>

    <span class="k">def</span> <span class="nf">_dendrogram_get_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">threshold_type</span><span class="p">):</span>
        <span class="n">dist_values</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span>
            <span class="c1"># _threshold = dist_values.max() * threshold / tbl[&#39;%sc&#39;%dist].shape[0]</span>
            <span class="n">_threshold</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dist_values</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">*</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;quantile&#39;</span><span class="p">:</span>
            <span class="n">_threshold</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dist_values</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist_values</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)],</span> <span class="n">threshold</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;clsize&#39;</span><span class="p">:</span>
            <span class="n">_threshold</span> <span class="o">=</span> <span class="n">_cluster_size_threshold</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;incons&#39;</span><span class="p">:</span>
            <span class="n">_threshold</span> <span class="o">=</span> <span class="n">_inconsistency_threshold</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_threshold</span>

    <span class="k">def</span> <span class="nf">plot_heatmaps_dendrograms_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Screening.plot_heatmaps_dendrograms"><a class="viewcode-back" href="../../index.html#emese.main.Screening.plot_heatmaps_dendrograms">[docs]</a>    <span class="k">def</span> <span class="nf">plot_heatmaps_dendrograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span> 
        <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">highlight_color</span> <span class="o">=</span> <span class="s1">&#39;#FFAA00&#39;</span><span class="p">,</span> <span class="n">base_color</span> <span class="o">=</span> <span class="s1">&#39;#000000&#39;</span><span class="p">,</span>
        <span class="n">coloring</span> <span class="o">=</span> <span class="s1">&#39;corr&#39;</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">threshold_type</span> <span class="o">=</span> <span class="s1">&#39;percent&#39;</span><span class="p">,</span>
        <span class="n">save_selection</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pca</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each protein plots heatmaps and dendrograms.</span>
<span class="sd">        Thanks to http://stackoverflow.com/a/3011894/854988</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_hgs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">all_hgs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
        <span class="n">hg_cols</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span> 
            <span class="p">(</span><span class="n">hg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_hgs</span><span class="p">)))</span>
        <span class="p">))</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;features_clustering-</span><span class="si">%s%s%s</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">coloring</span><span class="p">,</span> 
                <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">threshold_type</span> <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-</span><span class="si">%02f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">threshold</span> <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> \
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname</span>
        <span class="k">if</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;corr&#39;</span><span class="p">:</span>
            <span class="n">_cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dendrogram_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
                <span class="n">highlight_color</span><span class="p">,</span> <span class="n">base_color</span><span class="p">)</span>
        <span class="n">frs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;a9&#39;</span><span class="p">,</span> <span class="s1">&#39;a10&#39;</span><span class="p">,</span> <span class="s1">&#39;a11&#39;</span><span class="p">,</span> <span class="s1">&#39;a12&#39;</span><span class="p">,</span> <span class="s1">&#39;b1&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">mpl</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_pdf</span><span class="o">.</span><span class="n">PdfPages</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> \
                <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;Plotting heatmaps with dendrograms&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                    <span class="n">ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span><span class="p">[</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">frs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> \
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span> \
                            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
                    <span class="n">ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_profile</span><span class="p">(</span><span class="n">ppr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                        <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;dist&#39;</span><span class="p">:</span>
                            <span class="n">_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dendrogram_get_threshold</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span>
                                <span class="n">threshold</span><span class="p">,</span> <span class="n">threshold_type</span><span class="p">)</span>
                        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">o&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">protein</span><span class="p">]</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">oi</span><span class="p">:</span>
                            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                                <span class="n">hg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                                    <span class="n">hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">pn</span><span class="p">]</span> <span class="ow">and</span> <span class="n">hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">pn</span><span class="p">],</span>
                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">oi</span><span class="p">)])</span>
                                <span class="p">)</span>
                            <span class="p">)))</span> <span class="ow">or</span> <span class="n">oi</span><span class="p">,</span>
                            <span class="n">labels</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">protein</span><span class="p">]</span>
                        
                        
                        <span class="k">if</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;corr&#39;</span><span class="p">:</span>
                            <span class="n">_link_colors</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">_get_link_colors_corr</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">_cmap</span><span class="p">,</span>
                                <span class="n">threshold</span><span class="p">,</span> <span class="n">highlight_color</span><span class="p">,</span> <span class="n">base_color</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">coloring</span> <span class="o">==</span> <span class="s1">&#39;dist&#39;</span><span class="p">:</span>
                            <span class="n">_link_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_link_colors_dist</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span>
                                <span class="n">_threshold</span><span class="p">,</span> <span class="n">highlight_color</span><span class="p">,</span> <span class="n">base_color</span><span class="p">)</span>
                        <span class="n">protein_fc</span> <span class="o">=</span> \
                            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcluster_with_protein</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span> <span class="o">%</span> <span class="n">dist</span><span class="p">],</span>
                            <span class="n">_threshold</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">save_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">oi2i</span> <span class="o">=</span> \
                                <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="n">save_selection</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">oi</span><span class="p">:</span>
                                    <span class="n">oi2i</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">oi</span><span class="p">]</span> <span class="ow">in</span> <span class="n">protein_fc</span><span class="p">,</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        
                        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
                        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
                        <span class="n">cvs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_pdf</span><span class="o">.</span><span class="n">FigureCanvasPdf</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                        <span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> 
                            <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
                        
                        <span class="c1"># First dendrogram</span>
                        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">Z1</span> <span class="o">=</span> <span class="n">hc</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">],</span>
                            <span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
                            <span class="n">labels</span> <span class="o">=</span> <span class="n">names</span><span class="p">,</span>
                            <span class="n">leaf_rotation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">,</span>
                            <span class="n">link_color_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">_link_colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;symlog&#39;</span><span class="p">)</span>
                        <span class="n">null</span> <span class="o">=</span> <span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span> \
                            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()]</span>
                        <span class="n">null</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tl</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">hg_cols</span><span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">_text</span><span class="p">]),</span>
                                <span class="n">tl</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">))</span> \
                            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()</span> \
                                <span class="k">if</span> <span class="n">tl</span><span class="o">.</span><span class="n">_text</span> <span class="ow">in</span> <span class="n">hg_cols</span><span class="p">]</span>
                        <span class="n">null</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tl</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">highlight_color</span><span class="p">),</span>
                                <span class="n">tl</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">),</span>
                                <span class="n">tl</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> \
                            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()</span> <span class="k">if</span> <span class="n">tl</span><span class="o">.</span><span class="n">_text</span> <span class="o">==</span> <span class="n">protein</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">_threshold</span><span class="p">,</span>
                                <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#FFAA00&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
                        
                        <span class="c1"># Compute and plot second dendrogram.</span>
                        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">Z2</span> <span class="o">=</span> <span class="n">hc</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">c&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">],</span> 
                            <span class="n">labels</span> <span class="o">=</span> <span class="n">names</span><span class="p">,</span>
                            <span class="n">leaf_rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax2</span><span class="p">,</span>
                            <span class="c1">#color_threshold = _threshold)</span>
                            <span class="n">link_color_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">_link_colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;symlog&#39;</span><span class="p">)</span>
                        <span class="n">null</span> <span class="o">=</span> <span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span> \
                            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()]</span>
                        <span class="n">null</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tl</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">hg_cols</span><span class="p">[</span><span class="n">tl</span><span class="o">.</span><span class="n">_text</span><span class="p">]),</span>
                                <span class="n">tl</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">))</span> \
                            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> \
                                <span class="k">if</span> <span class="n">tl</span><span class="o">.</span><span class="n">_text</span> <span class="ow">in</span> <span class="n">hg_cols</span><span class="p">]</span>
                        <span class="n">null</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tl</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">highlight_color</span><span class="p">),</span> 
                                <span class="n">tl</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s1">&#39;bold&#39;</span><span class="p">),</span>
                                <span class="n">tl</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> \
                            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="k">if</span> <span class="n">tl</span><span class="o">.</span><span class="n">_text</span> <span class="o">==</span> <span class="n">protein</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">_threshold</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#FFAA00&#39;</span><span class="p">,</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
                        
                        <span class="c1"># Plot distance matrix.</span>
                        <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">idx1</span> <span class="o">=</span> <span class="n">Z1</span><span class="p">[</span><span class="s1">&#39;leaves&#39;</span><span class="p">]</span>
                        <span class="n">idx2</span> <span class="o">=</span> <span class="n">Z2</span><span class="p">[</span><span class="s1">&#39;leaves&#39;</span><span class="p">]</span>
                        <span class="n">D</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">d&#39;</span><span class="o">%</span><span class="n">dist</span><span class="p">][</span><span class="n">idx1</span><span class="p">,:]</span>
                        <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:,</span><span class="n">idx2</span><span class="p">]</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                            <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Blues&#39;</span><span class="p">))</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                        <span class="n">ax3</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                        
                        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> mode</span><span class="se">\n</span><span class="s1">&#39;</span>\
                            <span class="s1">&#39;clustering valid features; &#39;</span>\
                            <span class="s1">&#39;features in highlighted cluster: </span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">protein_fc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#AA0000&#39;</span> <span class="k">if</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">onepfraction</span> <span class="k">else</span> <span class="s1">&#39;#000000&#39;</span><span class="p">)</span>
                        
                        <span class="n">cvs</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span> <span class="o">=</span> <span class="mf">0.90</span><span class="p">)</span>
                        
                        <span class="n">cvs</span><span class="o">.</span><span class="n">print_figure</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                        
                        <span class="k">if</span> <span class="n">pca</span><span class="p">:</span>
                            <span class="n">oi2i</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span>
                                <span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                            <span class="n">pca</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">decomposition</span><span class="o">.</span><span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
                            <span class="n">fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">][</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">oi</span><span class="p">:</span>
                                    <span class="n">oi2i</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">oi</span><span class="p">)],</span>
                                    <span class="n">labels</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="p">),:],</span> <span class="n">ppr</span><span class="p">))</span>
                            <span class="n">col</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                                <span class="n">highlight_color</span> \
                                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">protein_fc</span> <span class="k">else</span> <span class="n">base_color</span><span class="p">,</span>
                                <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;#3383BE&#39;</span><span class="p">]</span>
                            <span class="n">fe</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fe</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span>
                            <span class="n">coo</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span>
                            <span class="n">fig</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
                            <span class="n">cvs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_pdf</span><span class="o">.</span><span class="n">FigureCanvasPdf</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">coo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> 
                                <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> mode :: PCA&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pn</span><span class="p">),</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#AA0000&#39;</span> \
                                    <span class="k">if</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">onepfraction</span> <span class="k">else</span> <span class="s1">&#39;#000000&#39;</span><span class="p">)</span>
                            <span class="n">cvs</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                            <span class="n">cvs</span><span class="o">.</span><span class="n">print_figure</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
                            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            
            <span class="n">pdfinf</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">infodict</span><span class="p">()</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Features clustering&#39;</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;Author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Dénes Türei&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Clustering MS1 features &#39;</span>\
                <span class="s1">&#39;based on Euclidean distances&#39;</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lipid transfer protein, protein,&#39;</span>\
                <span class="s1">&#39; lipidomics, mass spectrometry&#39;</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;CreationDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;ModDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Time elapsed: </span><span class="si">%u</span><span class="s1">s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Plots saved to </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    END: Clustering</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">plot_increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">onepfraction</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;increments.pdf&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mpl</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_pdf</span><span class="o">.</span><span class="n">PdfPages</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
                    <span class="n">cvs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_pdf</span><span class="o">.</span><span class="n">FigureCanvasPdf</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">i&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">i&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#FCCC06&#39;</span><span class="p">,</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Inconsistency&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">de&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">de&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;1st derivate&#39;</span><span class="p">,</span>
                        <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">de&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">dde&#39;</span><span class="o">%</span><span class="n">metric</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;2nd derivate&#39;</span><span class="p">,</span>
                        <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> mode :: distance increments&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pn</span><span class="p">),</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#AA0000&#39;</span> <span class="k">if</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">onepfraction</span> <span class="k">else</span> <span class="s1">&#39;#000000&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">])</span>
                    <span class="n">cvs</span><span class="o">.</span><span class="n">print_figure</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            
            <span class="n">pdfinf</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">infodict</span><span class="p">()</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Features distance increment&#39;</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;Author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Dénes Türei&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Features distance increment&#39;</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lipid transfer protein, protein,&#39;</span>\
                <span class="s1">&#39; lipidomics, mass spectrometry&#39;</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;CreationDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
            <span class="n">pdfinf</span><span class="p">[</span><span class="s1">&#39;ModDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">kmeans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">pprofs</span><span class="p">,</span> <span class="n">fractions</span><span class="p">):</span>
        <span class="n">cfracs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;c0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valids</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;Calculating k-means&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
            <span class="n">ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pprofs</span><span class="p">[</span><span class="n">protein</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">cfracs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> \
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein</span><span class="p">])</span> <span class="k">if</span> <span class="n">fr</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">ppr</span> <span class="o">=</span> <span class="n">norm_profile</span><span class="p">(</span><span class="n">ppr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">with_protein</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">],</span> <span class="n">ppr</span><span class="p">)</span>
                <span class="n">whitened</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">vq</span><span class="o">.</span><span class="n">whiten</span><span class="p">(</span><span class="n">with_protein</span><span class="p">)</span>
                <span class="n">code_book</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">vq</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span><span class="n">whitened</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># tbl[&#39;km&#39;] = </span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

<div class="viewcode-block" id="Screening.read_positives"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_positives">[docs]</a>    <span class="k">def</span> <span class="nf">read_positives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;manual_positive.csv&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads manually annotated positive hits</span>
<span class="sd">        from file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">_result</span> <span class="o">=</span> <span class="p">[[</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)]</span> \
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">uniqList</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_result</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Screening.spec_sens"><a class="viewcode-back" href="../../index.html#emese.main.Screening.spec_sens">[docs]</a>    <span class="k">def</span> <span class="nf">spec_sens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">asc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates specificity, sensitivity, precision,</span>
<span class="sd">        false discovery rate as a function of critical</span>
<span class="sd">        values of a score, for one LTP for one mode.</span>
<span class="sd">        Returns dict of lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;sens&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;prec&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;fdr&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">ioffset</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="mi">6</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_std&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sort_all</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">asc</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_std&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">metric</span><span class="p">]):</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_std&#39;</span><span class="p">]])</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> \
                    <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_std&#39;</span><span class="p">]])</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_std&#39;</span><span class="p">]])</span>
                <span class="n">tn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> \
                    <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_std&#39;</span><span class="p">]])</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tn</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sens&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;prec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fdr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">))</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sort_all</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="s1">&#39;mz&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Screening.evaluate_scores"><a class="viewcode-back" href="../../index.html#emese.main.Screening.evaluate_scores">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stdltps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates specificity, sensitivity, precision,</span>
<span class="sd">        false discovery rate as a function of critical</span>
<span class="sd">        values of each scores, for all LTPs with manual</span>
<span class="sd">        positive annotations, for all modes.</span>
<span class="sd">        Returns 4x embedded dicts of</span>
<span class="sd">        LTPs/modes/metrics/performance metrics.</span>
<span class="sd">        E.g. result[&#39;STARD10&#39;][&#39;pos&#39;][&#39;ktv&#39;][&#39;sens&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">std_proteins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_binders_detected</span> <span class="k">if</span> <span class="n">std_proteins</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">std_proteins</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">{}})</span> <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">std_proteins</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> \
            <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;Kendall</span><span class="se">\&#39;</span><span class="s1">s tau&#39;</span><span class="p">,</span> <span class="s1">&#39;ktv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Spearman corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;spv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Pearson corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;pev&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Euclidean dist.&#39;</span><span class="p">,</span> <span class="s1">&#39;euv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Robust corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;rcv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Goodman-Kruskal</span><span class="se">\&#39;</span><span class="s1">s gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;gkv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;dfv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="p">]</span> <span class="k">if</span> <span class="n">tasks</span> <span class="o">==</span> <span class="s1">&#39;old&#39;</span> <span class="k">else</span> \
            <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;Euclidean, +0 mcl&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Euclidean, +15 mcl&#39;</span><span class="p">,</span> <span class="s1">&#39;env15&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Euclidean, +45 mcl&#39;</span><span class="p">,</span> <span class="s1">&#39;env45&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;Peak ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;prs&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">std_proteins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">][</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">spec_sens</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores_eval</span> <span class="o">=</span> <span class="n">result</span></div>
    
    <span class="k">def</span> <span class="nf">known_binders_as_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;known_binder&#39;</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;known_binder&#39;</span><span class="p">])])</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

<div class="viewcode-block" id="Screening.count_threshold_filter"><a class="viewcode-back" href="../../index.html#emese.main.Screening.count_threshold_filter">[docs]</a>    <span class="k">def</span> <span class="nf">count_threshold_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">threshold_type</span> <span class="o">=</span> <span class="s1">&#39;fix&#39;</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a boolean array whether the values of a score fall below</span>
<span class="sd">        or above certain critical value. The critical value can be defined</span>
<span class="sd">        as a fix value,</span>
<span class="sd">        or as a fraction of the minimum or maximum value of the score.</span>
<span class="sd">        Threshold type is either `fix`, `relative` or `best_fraction`.</span>
<span class="sd">        </span>
<span class="sd">        - fix: values below or equal this number if lower is the better, otherwise</span>
<span class="sd">            values above or equal will be selected</span>
<span class="sd">        </span>
<span class="sd">        - relative: threshold will be set the minimum value (if ordered ascending)</span>
<span class="sd">            or maximum value multiplied by the threshold</span>
<span class="sd">        </span>
<span class="sd">        - best_fraction: opposite way as at the `relative`, at ascending order</span>
<span class="sd">            the maximum, at descending the minimum will be multiplied by the</span>
<span class="sd">            threshold</span>
<span class="sd">        </span>
<span class="sd">        - count: the absolute maximum number of selected instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sort_alll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">limScore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">])</span> \
                    <span class="k">if</span> <span class="n">asc</span> <span class="ow">and</span> <span class="n">threshold_type</span> <span class="o">==</span><span class="s1">&#39;relative&#39;</span> <span class="ow">or</span> \
                        <span class="ow">not</span> <span class="n">asc</span> <span class="ow">and</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;best_fraction&#39;</span> \
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">])</span> \
                    <span class="k">if</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;mean_relative&#39;</span> \
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">])</span> \
                    <span class="k">if</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;median_relative&#39;</span> \
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">])</span>
                <span class="n">_threshold</span> <span class="o">=</span> <span class="n">limScore</span> <span class="o">*</span> <span class="n">threshold</span> \
                    <span class="k">if</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;relative&#39;</span> <span class="ow">or</span> \
                        <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;best_fraction&#39;</span> <span class="ow">or</span> \
                        <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;mean_relative&#39;</span> <span class="ow">or</span> \
                        <span class="n">threshold_type</span> <span class="o">==</span> <span class="s1">&#39;median_relative&#39;</span> \
                    <span class="k">else</span> <span class="n">threshold</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">boolArray</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">]))</span> <span class="k">if</span> <span class="n">asc</span> \
                    <span class="k">else</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">boolArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">count</span> <span class="ow">or</span> <span class="n">asc</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_threshold</span> <span class="ow">or</span> \
                        <span class="ow">not</span> <span class="n">asc</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_threshold</span><span class="p">:</span>
                        <span class="n">boolArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">boolArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;bool_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">score</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boolArray</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">scores_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
        <span class="n">score_name</span> <span class="o">=</span> <span class="s1">&#39;Euclidean distance&#39;</span><span class="p">,</span> <span class="n">pdfname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">onepfraction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hlines</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
        <span class="n">derivates</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">pdfname</span> <span class="o">=</span> <span class="s1">&#39;scores_</span><span class="si">%s</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="n">score</span> <span class="k">if</span> <span class="n">pdfname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pdfname</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="n">sort_alll</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="n">asc</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">bool_score</span> <span class="o">=</span> <span class="s1">&#39;bool_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">score</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">),</span> <span class="s1">&#39;Plotting scores&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)):</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
            <span class="n">proteinname</span> <span class="o">=</span> <span class="n">proteins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;#CC0000&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;#0000CC&#39;</span>
                <span class="n">scoreMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">score</span><span class="p">])</span> <span class="k">if</span> <span class="n">asc</span> \
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">score</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">score</span><span class="p">])),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">score</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">derivates</span><span class="p">:</span>
                    <span class="n">xd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">score</span><span class="p">]))</span>
                    <span class="n">yd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">score</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">score</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xd</span><span class="p">])</span>
                    <span class="n">yd</span> <span class="o">=</span> <span class="n">yd</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">yd</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">asc</span><span class="p">:</span>
                        <span class="n">yd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">yd</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xd</span><span class="p">,</span> <span class="n">yd</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
                <span class="n">_xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">_ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
                <span class="n">best_ones</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> \
                    <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">bool_score</span><span class="p">])</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span>
                <span class="n">xbreak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">best_ones</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_ones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="n">ybreak</span> <span class="o">=</span> <span class="n">valids</span><span class="p">[</span><span class="n">proteinname</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">score</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">xbreak</span><span class="p">)]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xbreak</span><span class="p">],</span> <span class="p">[</span><span class="n">ybreak</span><span class="p">],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                    <span class="n">markerfacecolor</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xbreak</span><span class="p">),</span> 
                        <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">xbreak</span><span class="p">,</span> <span class="n">ybreak</span><span class="p">),</span> 
                        <span class="c1">#xytext = (xbreak + (20.0 if pn == &#39;pos&#39; else 0.0), </span>
                        <span class="c1">#ybreak + (0.5 if pn == &#39;neg&#39; else 0.0)), </span>
                        <span class="c1">#xycoords = &#39;data&#39;,</span>
                        <span class="c1">#textcoords = &#39;offset points&#39;,</span>
                        <span class="c1">#ha = &#39;center&#39;, va = &#39;bottom&#39;, </span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span>
                        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="s1">&#39;xx-small&#39;</span><span class="p">,</span>
                        <span class="n">arrowprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
                            <span class="n">connectionstyle</span> <span class="o">=</span> <span class="s1">&#39;arc,rad=.0&#39;</span><span class="p">,</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> 
                            <span class="n">visible</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">),</span> 
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hlines</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">hlines</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">scoreMin</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> 
                            <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">_xlim</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">_ylim</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">proteinname</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#CC0000&#39;</span> \
                <span class="k">if</span> <span class="n">onepfraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">proteinname</span> <span class="ow">in</span> <span class="n">onepfraction</span> <span class="k">else</span> <span class="s1">&#39;#000000&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">score_name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Features (ordered </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> \
                <span class="s1">&#39;ascending&#39;</span> <span class="k">if</span> <span class="n">asc</span> <span class="k">else</span> <span class="s1">&#39;descending&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdfname</span><span class="p">)</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fractions_barplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">highlight</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">highlight2</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pdfname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pdfname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pdfname</span> <span class="o">=</span> <span class="s1">&#39;pp</span><span class="si">%s</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;_features&#39;</span><span class="p">)</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span><span class="p">))))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">n</span><span class="p">))</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">),</span> <span class="s1">&#39;Plotting profiles&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)):</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n</span><span class="p">]</span>
            <span class="n">protein_name</span> <span class="o">=</span> <span class="n">proteins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fractions</span><span class="p">(</span><span class="n">protein_name</span><span class="p">)</span>
            <span class="c1">#sorted(self.pprofs[protein_name].keys(),</span>
            <span class="c1">#               key = lambda i: (i[0], int(i[1:])))</span>
            <span class="n">ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pprofs</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">fracs</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pprofs_original&#39;</span><span class="p">):</span>
                <span class="n">ppr_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pprofs_original</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> \
                    <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">fracs</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ppr_o</span> <span class="o">=</span> <span class="n">ppr</span>
            <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
                <span class="n">ppmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ppr_o</span><span class="p">)</span>
                <span class="n">ppmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">ppr_o</span><span class="p">)</span>
                <span class="n">ppr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppr</span> <span class="o">-</span> <span class="n">ppmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ppmax</span> <span class="o">-</span> <span class="n">ppmin</span><span class="p">)</span>
                <span class="n">ppr</span><span class="p">[</span><span class="n">ppr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">ppr_o</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppr_o</span> <span class="o">-</span> <span class="n">ppmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ppmax</span> <span class="o">-</span> <span class="n">ppmin</span><span class="p">)</span>
            <span class="c1">#B6B7B9 gray (not measured)</span>
            <span class="c1">#6EA945 mantis (protein sample)</span>
            <span class="c1">#007B7F teal (control/void)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#6EA945&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> \
                    <span class="s1">&#39;#B6B7B9&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                    <span class="s1">&#39;#007B7F&#39;</span> \
                <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">fracs</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">)),</span> <span class="n">ppr_o</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">)),</span> <span class="n">ppr</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">features</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">fi</span><span class="p">,</span> <span class="n">fe</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;no&#39;</span><span class="p">]):</span>
                        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.20</span>
                        <span class="n">lwd</span> <span class="o">=</span> <span class="mf">0.1</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                        <span class="n">plot_this</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#FFCCCC&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;#CCCCFF&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">def</span> <span class="nf">_feg</span><span class="p">(</span><span class="n">fe</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">fei</span> <span class="ow">in</span> <span class="n">fe</span><span class="p">:</span>
                                    <span class="k">yield</span> <span class="n">fei</span>
                            <span class="n">feg</span> <span class="o">=</span> <span class="n">_feg</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">highlight2</span> <span class="ow">and</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">highlight2</span><span class="p">][</span><span class="n">fi</span><span class="p">]:</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#FF0000&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;#0000FF&#39;</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.15</span>
                                <span class="n">lwd</span> <span class="o">=</span> <span class="mf">0.4</span>
                                <span class="n">lst</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
                                <span class="n">plot_this</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">highlight</span> <span class="ow">and</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">highlight</span><span class="p">][</span><span class="n">fi</span><span class="p">]:</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#FF0000&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;#0000FF&#39;</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.75</span>
                                <span class="n">lwd</span> <span class="o">=</span> <span class="mf">0.4</span>
                                <span class="n">lst</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                                <span class="n">plot_this</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">all_features</span> <span class="ow">or</span> <span class="n">plot_this</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">feg</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> \
                                        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span> \
                                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fractions</span><span class="p">(</span><span class="n">protein_name</span><span class="p">)]),</span>
                                    <span class="n">linewidth</span> <span class="o">=</span> <span class="n">lwd</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mf">0.07</span><span class="p">,</span>
                                    <span class="n">linestyle</span> <span class="o">=</span> <span class="n">lst</span><span class="p">,</span> 
                                    <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unequal length dimensions: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="n">protein_name</span><span class="p">,</span> <span class="n">pn</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">fracs</span><span class="p">,</span> <span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> protein conc.&#39;</span><span class="o">%</span><span class="n">protein_name</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdfname</span><span class="p">)</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">fractions_barplot2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">highlight</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">highlight2</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pdfname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pdfname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pdfname</span> <span class="o">=</span> <span class="s1">&#39;pp</span><span class="si">%s</span><span class="s1">3.pdf&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">features</span> <span class="k">else</span> <span class="s1">&#39;_features&#39;</span><span class="p">)</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">),</span> <span class="s1">&#39;Plotting profiles&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)):</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
            <span class="n">protein_name</span> <span class="o">=</span> <span class="n">proteins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">offset</span><span class="p">),</span> <span class="n">label</span> <span class="ow">in</span> \
                <span class="nb">zip</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">]):</span>
                <span class="n">ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pprofs</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>\
                    <span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">])</span>
                <span class="n">ppr_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pprofs_original</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span>\
                    <span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
                    <span class="n">ppmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ppr_o</span><span class="p">)</span>
                    <span class="n">ppmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">ppr_o</span><span class="p">)</span>
                    <span class="n">ppr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppr</span> <span class="o">-</span> <span class="n">ppmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ppmax</span> <span class="o">-</span> <span class="n">ppmin</span><span class="p">)</span>
                    <span class="n">ppr</span><span class="p">[</span><span class="n">ppr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">ppr_o</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppr_o</span> <span class="o">-</span> <span class="n">ppmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ppmax</span> <span class="o">-</span> <span class="n">ppmin</span><span class="p">)</span>
                <span class="c1">#B6B7B9 gray (not measured)</span>
                <span class="c1">#6EA945 mantis (protein sample)</span>
                <span class="c1">#007B7F teal (control/void)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#6EA945&#39;</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> \
                        <span class="s1">&#39;#B6B7B9&#39;</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                        <span class="s1">&#39;#007B7F&#39;</span> \
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">ppr_o</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">ppr</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">features</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">fi</span><span class="p">,</span> <span class="n">fe</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="s1">&#39;no&#39;</span><span class="p">]):</span>
                        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.20</span>
                        <span class="n">lwd</span> <span class="o">=</span> <span class="mf">0.1</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                        <span class="n">plot_this</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#FFCCCC&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;#CCCCFF&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">def</span> <span class="nf">_feg</span><span class="p">(</span><span class="n">fe</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">fei</span> <span class="ow">in</span> <span class="n">fe</span><span class="p">:</span>
                                    <span class="k">yield</span> <span class="n">fei</span>
                            <span class="n">feg</span> <span class="o">=</span> <span class="n">_feg</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">highlight2</span> <span class="ow">and</span> \
                                <span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">highlight2</span><span class="p">][</span><span class="n">fi</span><span class="p">]:</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#FF0000&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;#0000FF&#39;</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.15</span>
                                <span class="n">lwd</span> <span class="o">=</span> <span class="mf">0.4</span>
                                <span class="n">lst</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
                                <span class="n">plot_this</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">highlight</span> <span class="ow">and</span> \
                                <span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="n">pn</span><span class="p">][</span><span class="n">highlight</span><span class="p">][</span><span class="n">fi</span><span class="p">]:</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#FF0000&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;#0000FF&#39;</span>
                                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.75</span>
                                <span class="n">lwd</span> <span class="o">=</span> <span class="mf">0.4</span>
                                <span class="n">lst</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                                <span class="n">plot_this</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">all_features</span> <span class="ow">or</span> <span class="n">plot_this</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">feg</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> \
                                        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span> \
                                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fractions</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]),</span>
                                    <span class="n">linewidth</span> <span class="o">=</span> <span class="n">lwd</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mf">0.07</span><span class="p">,</span>
                                    <span class="n">linestyle</span> <span class="o">=</span> <span class="n">lst</span><span class="p">,</span> 
                                    <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unequal length dimensions: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="n">protein_name</span><span class="p">,</span> <span class="n">pn</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.4</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fracs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> protein conc.&#39;</span><span class="o">%</span><span class="n">protein_name</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdfname</span><span class="p">)</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">peak_ratios_histo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">pdfname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">lower</span>
        <span class="k">if</span> <span class="n">pdfname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pdfname</span> <span class="o">=</span> <span class="s1">&#39;peak_ratios.pdf&#39;</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">),</span> <span class="s1">&#39;Plotting peak ratios&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)):</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>
            <span class="n">protein_name</span> <span class="o">=</span> <span class="n">proteins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ipr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein_name</span><span class="p">]</span>\
                    <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]))</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ipr&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x1</span><span class="p">)]</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;ipr&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x2</span><span class="p">)]</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ppr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#DA0025&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lower</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#DA0025&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-.&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">upper</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#DA0025&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-.&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.50</span><span class="p">))</span>
                <span class="n">x1a</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&lt;</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">upper</span><span class="p">))]</span>
                <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span>
                <span class="n">std1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span>
                <span class="n">x2a</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">x2</span> <span class="o">&gt;</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x2</span> <span class="o">&lt;</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">upper</span><span class="p">))]</span>
                <span class="n">m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2a</span><span class="p">)</span>
                <span class="n">std2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x2a</span><span class="p">)</span>
                <span class="n">x3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x1a</span><span class="p">)</span>
                <span class="n">x3</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x2a</span><span class="p">))</span>
                <span class="n">m3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>
                <span class="n">std3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>
                
                <span class="c1"># positive: mean, 1SD, 2SD</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m1</span> <span class="o">+</span> <span class="n">std1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m1</span> <span class="o">-</span> <span class="n">std1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="c1">#ax.axvline(x = m1 + 2 * std1, c = &#39;#6EA945&#39;, linewidth = 0.2, alpha = 0.5, linestyle = &#39;:&#39;)</span>
                <span class="c1">#ax.axvline(x = m1 - 2 * std1, c = &#39;#6EA945&#39;, linewidth = 0.2, alpha = 0.5, linestyle = &#39;:&#39;)</span>
                
                <span class="c1"># negative: mean, 1SD, 2SD</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m2</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m2</span> <span class="o">+</span> <span class="n">std2</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m2</span> <span class="o">-</span> <span class="n">std2</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="c1">#ax.axvline(x = m2 + 2 * std2, c = &#39;#007B7F&#39;, linewidth = 0.2, alpha = 0.5, linestyle = &#39;:&#39;)</span>
                <span class="c1">#ax.axvline(x = m2 - 2 * std2, c = &#39;#007B7F&#39;, linewidth = 0.2, alpha = 0.5, linestyle = &#39;:&#39;)</span>
                
                <span class="c1"># both: mean, 1SD, 2SD</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m3</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#996A44&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m3</span> <span class="o">+</span> <span class="n">std3</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#996A44&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">m3</span> <span class="o">-</span> <span class="n">std3</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#996A44&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> int. peak ratios&#39;</span><span class="o">%</span><span class="n">protein_name</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdfname</span><span class="p">)</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
<div class="viewcode-block" id="Screening.lookup_nans"><a class="viewcode-back" href="../../index.html#emese.main.Screening.lookup_nans">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_nans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks up those features having too many NaNs or zeros</span>
<span class="sd">        among the protein containing fractions.</span>
<span class="sd">        Stores result under key `na`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">pfe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcont_columns</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;fe&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">permit_profile_end_nan</span><span class="p">:</span>
                    
                    <span class="n">hasnans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pfe</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pfe</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span>
                                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                            <span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pfe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="n">pfe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pfe</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]),</span>
                                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pfe</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span>
                                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                            <span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pfe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span>
                                <span class="n">pfe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    
                    <span class="n">hasnans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pfe</span><span class="p">),</span>
                                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pfe</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span>
                                    <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                            <span class="p">)</span>
                
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;na&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hasnans</span></div>
    
<div class="viewcode-block" id="Screening.peak_ratio_score"><a class="viewcode-back" href="../../index.html#emese.main.Screening.peak_ratio_score">[docs]</a>    <span class="k">def</span> <span class="nf">peak_ratio_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the difference between the mean intensity peak ratio</span>
<span class="sd">        expressef in number of standard deviations.</span>
<span class="sd">        The mean and the SD calculated in the range of the expected</span>
<span class="sd">        ratio minus lower plus upper.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_ratio_score_bandwidth</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">lower</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">def</span> <span class="nf">get_score</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">fkey</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
            <span class="c1"># the expected value of the peak ratio:</span>
            <span class="n">ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">fkey</span><span class="p">]</span>
            <span class="c1"># all intensity peak ratios:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ipr&#39;</span><span class="p">][:,</span><span class="n">col</span><span class="p">]</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;ipr&#39;</span><span class="p">][:,</span><span class="n">col</span><span class="p">]</span>
            <span class="n">na</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
            <span class="c1"># all intensity peak ratios:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pa</span><span class="p">,</span> <span class="n">na</span><span class="p">))</span>
            <span class="c1"># range considering fraction offsets, having tolerance</span>
            <span class="c1"># -/+ upper/lower</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">ppr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">ppr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">upper</span><span class="p">))]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="c1"># scores: difference from mean in SD</span>
            <span class="n">scp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span>
            <span class="n">scn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span>
            <span class="k">return</span> <span class="n">scp</span><span class="p">,</span> <span class="n">scn</span>
        
        <span class="k">def</span> <span class="nf">scores_array</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span>
            
            <span class="k">return</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span>
                        <span class="nb">tuple</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">fk</span><span class="p">:</span>
                                    <span class="n">scores</span><span class="p">[</span><span class="n">fk</span><span class="p">],</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">fk</span><span class="p">:</span>
                                        <span class="n">fk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="nb">sorted</span><span class="p">(</span>
                                        <span class="n">iteritems</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ipri&#39;</span><span class="p">]</span>
                                        <span class="p">),</span>
                                        <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">fk</span><span class="p">:</span> <span class="n">fk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)):</span>
            
            <span class="n">protein_name</span> <span class="o">=</span> <span class="n">proteins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ipr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                
                <span class="n">scoresp</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">scoresn</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">fracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_containing_fractions</span><span class="p">(</span><span class="n">protein_name</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fracs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fracs</span><span class="p">)):</span>
                        
                        <span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span> <span class="o">=</span> <span class="n">fracs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fracs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">fkey</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac1</span><span class="p">,</span> <span class="n">frac2</span><span class="p">)</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ipri&#39;</span><span class="p">][</span><span class="n">fkey</span><span class="p">]</span>
                        
                        <span class="n">scoresp</span><span class="p">[</span><span class="n">fkey</span><span class="p">],</span> <span class="n">scoresn</span><span class="p">[</span><span class="n">fkey</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">get_score</span><span class="p">(</span><span class="n">protein_name</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">fkey</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;prsa&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">scores_array</span><span class="p">(</span><span class="n">protein_name</span><span class="p">,</span> <span class="n">scoresp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;prsa&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">scores_array</span><span class="p">(</span><span class="n">protein_name</span><span class="p">,</span> <span class="n">scoresn</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;prsa&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ipr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;prsa&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;ipr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span>
                    <span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.combine_peak_ratio_scores"><a class="viewcode-back" href="../../index.html#emese.main.Screening.combine_peak_ratio_scores">[docs]</a>    <span class="k">def</span> <span class="nf">combine_peak_ratio_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Peak ratio scores calculated for each pairs of protein containing</span>
<span class="sd">        fractions. Here we take their mean and select the scores for the</span>
<span class="sd">        first and highest fraction pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">fkeyf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
                <span class="n">fkeyh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
                
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prsa&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># mean score</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;na&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prsf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prsa&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">][</span><span class="n">fkeyf</span><span class="p">]]</span> <span class="c1"># score for first</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prsa&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ipri&#39;</span><span class="p">][</span><span class="n">fkeyh</span><span class="p">]]</span> <span class="c1"># highest diff.</span></div>
    
<div class="viewcode-block" id="Screening.peak_ratio_score_hist"><a class="viewcode-back" href="../../index.html#emese.main.Screening.peak_ratio_score_hist">[docs]</a>    <span class="k">def</span> <span class="nf">peak_ratio_score_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdfname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots a histogram for peak ratio scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pdfname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pdfname</span> <span class="o">=</span> <span class="s1">&#39;peak_ratios_hist.pdf&#39;</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="n">gridsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">))))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">gridsize</span><span class="p">,</span> <span class="n">gridsize</span><span class="p">,</span>
                                <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">gridsize</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">gridsize</span> <span class="o">+</span> <span class="mi">12</span><span class="p">))</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">),</span> <span class="s1">&#39;Plotting peak ratio scores&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)):</span>
            
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="n">gridsize</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="n">gridsize</span><span class="p">]</span>
            <span class="n">protein_name</span> <span class="o">=</span> <span class="n">proteins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;prs&#39;</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein_name</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;prs&#39;</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> p/r scores&#39;</span> <span class="o">%</span> <span class="n">protein_name</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdfname</span><span class="p">)</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    
    <span class="k">def</span> <span class="nf">peak_ratio_score_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_ratio_score_threshold</span>
    
    <span class="c1"># Screening().fractions_barplot(fractions_upper, pprofs)</span>
    
    <span class="k">def</span> <span class="nf">plot_score_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perf</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Kendall</span><span class="se">\&#39;</span><span class="s1">s tau&#39;</span><span class="p">,</span> <span class="s1">&#39;ktv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Spearman corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;spv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Pearson corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;pev&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Euclidean dist.&#39;</span><span class="p">,</span> <span class="s1">&#39;euv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Robust corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;rcv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Goodman-Kruskal</span><span class="se">\&#39;</span><span class="s1">s gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;gkv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;dfv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">perfmetrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;sens&#39;</span><span class="p">,</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="s1">&#39;Sensitivity&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span> <span class="s1">&#39;#FCCC06&#39;</span><span class="p">,</span> <span class="s1">&#39;Specificity&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;prec&#39;</span><span class="p">,</span> <span class="s1">&#39;#DA0025&#39;</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;fdr&#39;</span><span class="p">,</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="s1">&#39;FDR&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="c1"># plt.gca().set_color_cycle([&#39;red&#39;, &#39;green&#39;, &#39;blue&#39;, &#39;yellow&#39;])</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d1</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">perf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">d2</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d1</span><span class="p">):</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">sharex</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Performance of scores :: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="n">perfmetrics</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">],</span> <span class="n">d2</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">pm</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                            <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.33</span><span class="p">,</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">pm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">pm</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">leg</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Performance</span><span class="se">\n</span><span class="s1">metrics&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> value&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;score_performance_</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">.pdf&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">plot_roc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perf</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Kendall</span><span class="se">\&#39;</span><span class="s1">s tau&#39;</span><span class="p">,</span> <span class="s1">&#39;ktv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Spearman corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;spv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Pearson corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;pev&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Euclidean dist.&#39;</span><span class="p">,</span> <span class="s1">&#39;euv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Robust corr.&#39;</span><span class="p">,</span> <span class="s1">&#39;rcv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Goodman-Kruskal</span><span class="se">\&#39;</span><span class="s1">s gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;gkv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;dfv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">def</span> <span class="nf">colors</span><span class="p">():</span>
            <span class="n">_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="s1">&#39;#FCCC06&#39;</span><span class="p">,</span> <span class="s1">&#39;#DA0025&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="s1">&#39;#454447&#39;</span><span class="p">,</span> <span class="s1">&#39;#996A44&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_colors</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">c</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">sharex</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Reciever operating characteristics&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">colors</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d1</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">perf</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">d2</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d1</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;spec&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;sens&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.33</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> n = </span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">d2</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;n&#39;</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.33</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#777777&#39;</span><span class="p">)</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sensitivity&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;1 - Specificity&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC :: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;roc.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">plot_roc2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Euclidean, +0 mcl&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Euclidean, +15 mcl&#39;</span><span class="p">,</span> <span class="s1">&#39;env15&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Euclidean, +45 mcl&#39;</span><span class="p">,</span> <span class="s1">&#39;env45&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Peak ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;prs&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">def</span> <span class="nf">colors</span><span class="p">():</span>
            <span class="n">_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="s1">&#39;#FCCC06&#39;</span><span class="p">,</span> <span class="s1">&#39;#DA0025&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="s1">&#39;#454447&#39;</span><span class="p">,</span> <span class="s1">&#39;#996A44&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_colors</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">c</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="n">nplots</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
                    <span class="nb">len</span><span class="p">(</span>
                        <span class="nb">filter</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">mode</span><span class="p">:</span>
                                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;_std&#39;</span><span class="p">]),</span>
                            <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">known_binders_detected</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nplots</span><span class="p">)))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrows</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">*</span> <span class="mi">5</span><span class="p">),</span>
            <span class="n">sharex</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Reciever operating characteristics&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_binders_detected</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;_std&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                    <span class="c1">#</span>
                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cutoff_coo</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scores_eval</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;prs&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">colors</span><span class="p">()</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">nrows</span><span class="p">][</span><span class="n">i</span><span class="o">%</span><span class="n">nrows</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_eval</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;spec&#39;</span><span class="p">]),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;sens&#39;</span><span class="p">]),</span>
                            <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.33</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">x1</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Peak ratio score = 1.0&#39;</span><span class="p">,</span> <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.33</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#777777&#39;</span><span class="p">)</span>
                    <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sensitivity&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;1 - Specificity&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC :: </span><span class="si">%s</span><span class="s1"> :: </span><span class="si">%s</span><span class="s1"> :: n = </span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;roc2.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_cutoff_coo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sens&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
    
    <span class="k">def</span> <span class="nf">best_combined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ubiquity_treshold</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">sorted_scores</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
                    <span class="n">oi_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">tbl</span><span class="p">[</span><span class="n">sc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()])</span>
                    <span class="k">if</span> <span class="n">sc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">sorted_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oi_sorted</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sorted_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oi_sorted</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">all_ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])))</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_scores</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">si</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scs</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">oi</span> <span class="o">==</span> <span class="n">sc</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cpv&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="ow">or</span> \
                                    <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">tbl</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">])</span>
                                    <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>\
                                        <span class="s1">&#39;ubi&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="ow">and</span> \
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ubi&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ubiquity_treshold</span>
                                    <span class="p">):</span>
                                    <span class="n">all_ranks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">all_ranks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span>
                <span class="n">combined_ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_ranks</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">best_oi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">combined_ranks</span><span class="p">)][:</span><span class="n">best</span><span class="p">]</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;best</span><span class="si">%u</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">best</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_oi</span>

    <span class="k">def</span> <span class="nf">best_gk_eu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">best_combined</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;gkv&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;euv&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)],</span> <span class="n">best</span> <span class="o">=</span> <span class="n">best</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">best_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;m/z&#39;</span><span class="p">,</span> <span class="s1">&#39;Database_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Level&#39;</span><span class="p">,</span> <span class="s1">&#39;Full_name&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Formula&#39;</span><span class="p">,</span> <span class="s1">&#39;Adduct&#39;</span><span class="p">,</span> <span class="s1">&#39;Database_m/z&#39;</span><span class="p">,</span> <span class="s1">&#39;Adduct_m/z&#39;</span><span class="p">]</span>
        <span class="n">sort_alll</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="s1">&#39;mz&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;best</span><span class="si">%u</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">best</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">oi</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">mz</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">lip</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%.08f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mz</span><span class="p">]</span> <span class="o">+</span> \
                                <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">lip</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%.08f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mz</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="p">[</span><span class="s1">&#39;unknown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Screening.true_positives"><a class="viewcode-back" href="../../index.html#emese.main.Screening.true_positives">[docs]</a>    <span class="k">def</span> <span class="nf">true_positives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">stdpos</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For one protein having known binders looks up these</span>
<span class="sd">        among the valid features either in positive OR</span>
<span class="sd">        negative mode. (So you need to run twice, once</span>
<span class="sd">        for +, once for -.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ioffset</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="mi">6</span>
        <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fe</span> <span class="ow">in</span> <span class="n">stdpos</span><span class="p">[</span><span class="n">protein</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">fe</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">ioffset</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">mz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fe</span><span class="p">[</span><span class="n">ioffset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
                <span class="n">iu</span> <span class="o">=</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">iu</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">]):</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span> <span class="o">&lt;=</span> <span class="n">tolerance</span><span class="p">:</span>
                        <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iu</span> <span class="o">+</span> <span class="n">u</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">iu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">][</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">iu</span> <span class="o">-</span><span class="n">l</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tolerance</span><span class="p">:</span>
                        <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iu</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
                        <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">identify_feature</span><span class="p">(</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span> <span class="n">fe</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ioffset</span><span class="p">)</span></div>

<div class="viewcode-block" id="Screening.identify_feature"><a class="viewcode-back" href="../../index.html#emese.main.Screening.identify_feature">[docs]</a>    <span class="k">def</span> <span class="nf">identify_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ioffset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For one feature looks up if the lipid database ID</span>
<span class="sd">        and the adduct do match.</span>
<span class="sd">        Adds the matching record from the gold standard</span>
<span class="sd">        to lists in the `std` dict. There can be accessed</span>
<span class="sd">        by the original index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">fe</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ioffset</span><span class="p">],</span> \
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">fe</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">ioffset</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]:</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Feature </span><span class="si">%.05f</span><span class="s1"> matched, lipid &#39;</span>\
                <span class="s1">&#39;ID hasn</span><span class="se">\&#39;</span><span class="s1">t been found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">fe</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">ioffset</span><span class="p">],</span> <span class="n">fe</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ioffset</span><span class="p">]))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="Screening.sortby_score"><a class="viewcode-back" href="../../index.html#emese.main.Screening.sortby_score">[docs]</a>    <span class="k">def</span> <span class="nf">sortby_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns sorted views of normalized features,</span>
<span class="sd">        m/z&#39;s and the attribute the sorting carried</span>
<span class="sd">        out by.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sorted_no</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">]),:]</span>
        <span class="n">sorted_mz</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">])]</span>
        <span class="n">sorted_attr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">asc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sorted_no</span><span class="p">,</span> <span class="n">sorted_mz</span><span class="p">,</span> <span class="n">sorted_attr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sorted_no</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sorted_mz</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sorted_attr</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_sort_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sorts all arrays in one table by one specified </span>
<span class="sd">        attribute.</span>
<span class="sd">        Either ascending or descending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">attr</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dim</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">asc</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ind</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">asc</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ind</span><span class="p">,:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">ind</span><span class="p">,:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">asc</span><span class="p">:</span>
            <span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">attr</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="Screening.sort_alll"><a class="viewcode-back" href="../../index.html#emese.main.Screening.sort_alll">[docs]</a>    <span class="k">def</span> <span class="nf">sort_alll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sorts all arrays in all tables by one specified </span>
<span class="sd">        attribute.</span>
<span class="sd">        Either ascending or descending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sort_all</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">asc</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_scored_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="n">val_ubi_prf_rpr_hits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ubiquity</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="n">profile_best</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">)</span>
        <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> \
            <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">hits</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vv</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">hits_upper</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span> \
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">hits</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">hits</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">hits_upper</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">pn</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">hits_upper</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">pn</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span>
        <span class="k">return</span> <span class="n">hits_upper</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MS1 lipid identification</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Screening.lipid_lookup"><a class="viewcode-back" href="../../index.html#emese.main.Screening.lipid_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lipid_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage0</span><span class="p">,</span> <span class="n">runtime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtains full SwissLipids data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pAdducts</span><span class="p">,</span> <span class="n">nAdducts</span> <span class="o">=</span> <span class="n">get_swisslipids</span><span class="p">(</span>
            <span class="n">adducts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;[M+H]+&#39;</span><span class="p">,</span> <span class="s1">&#39;[M+NH4]+&#39;</span><span class="p">,</span> <span class="s1">&#39;[M-H]-&#39;</span><span class="p">],</span>
            <span class="n">formiate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">lipids</span> <span class="o">=</span> <span class="n">find_lipids</span><span class="p">(</span><span class="n">stage0</span><span class="p">,</span> <span class="n">pAdducts</span><span class="p">,</span> <span class="n">nAdducts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runtime</span><span class="p">:</span>
            <span class="n">runtime</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span>
                <span class="s1">&#39;find_lipids(final_hits, pAdducts, nAdducts)&#39;</span><span class="p">,</span>
                <span class="n">setup</span> <span class="o">=</span> <span class="s1">&#39;from __main__ import find_lipids, final_hits,&#39;</span>\
                <span class="s1">&#39;pAdducts, nAdducts&#39;</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pAdducts</span><span class="p">,</span> <span class="n">nAdducts</span><span class="p">,</span> <span class="n">lipids</span><span class="p">,</span> <span class="n">runtime</span></div>

<div class="viewcode-block" id="Screening.lipid_lookup_exact"><a class="viewcode-back" href="../../index.html#emese.main.Screening.lipid_lookup_exact">[docs]</a>    <span class="k">def</span> <span class="nf">lipid_lookup_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches data from SwissLipids and LipidMaps</span>
<span class="sd">        if not given.</span>
<span class="sd">        Looks up lipids based on exact masses (but</span>
<span class="sd">        taking into account the adducts).</span>
<span class="sd">        Writes hits into arrays in `lip` dict, having</span>
<span class="sd">        original indices as keys.</span>
<span class="sd">        Returns an array of lipid databases with exact</span>
<span class="sd">        masses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exacts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_swisslipids_exact</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lipidmaps_exact</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_nonidet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_lipids_exact</span><span class="p">(</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">,</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span><span class="p">)</span></div>

<div class="viewcode-block" id="Screening.evaluate_results"><a class="viewcode-back" href="../../index.html#emese.main.Screening.evaluate_results">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage0</span><span class="p">,</span> <span class="n">stage2</span><span class="p">,</span> <span class="n">lipids</span><span class="p">,</span> <span class="n">fractions_upper</span><span class="p">,</span>
        <span class="n">letter</span> <span class="o">=</span> <span class="s1">&#39;e&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tracks the number of features/lipids along stages.</span>
<span class="sd">        Does some plotting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stage3</span> <span class="o">=</span> <span class="p">[(</span>
                <span class="n">l</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> 
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">])],</span> 
                <span class="nb">len</span><span class="p">(</span><span class="n">stage2</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">upper</span><span class="p">()]),</span> 
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">stage0</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">stage0</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])],</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fractions_upper</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
            <span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> \
            <span class="k">else</span> <span class="p">(</span>
                <span class="n">l</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fractions_upper</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
            <span class="p">)</span> \
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">lipids</span><span class="p">)]</span>
        <span class="c1">#</span>
        <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span><span class="p">]</span>
        <span class="nb">sum</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="n">font_family</span> <span class="o">=</span> <span class="s1">&#39;Helvetica Neue LT Std&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FCCC06&#39;</span><span class="p">,</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">],</span> <span class="p">[</span><span class="n">yy</span><span class="p">,</span> <span class="n">yy</span><span class="p">],</span> <span class="n">lw</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#CCCCCC&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Lipids (square: --; dot: +)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Lipids matching (square: -; dot: +)&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;hits-1-1000-</span><span class="si">%s</span><span class="s1">.pdf&#39;</span><span class="o">%</span><span class="n">letter</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FCCC06&#39;</span><span class="p">,</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">ya</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">],</span> <span class="p">[</span><span class="n">ya</span><span class="p">,</span> <span class="n">yb</span><span class="p">],</span> <span class="n">lw</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#CCCCCC&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Num of m/z`s (green: --; yellow: +)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Lipids (green: --; yellow: +)&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;hits-2-1000-</span><span class="si">%s</span><span class="s1">.pdf&#39;</span><span class="o">%</span><span class="n">letter</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># </span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FCCC06&#39;</span><span class="p">,</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="s1">&#39;#007B7F&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xa</span><span class="p">,</span> <span class="n">xb</span><span class="p">],</span> <span class="p">[</span><span class="n">yy</span><span class="p">,</span> <span class="n">yy</span><span class="p">],</span> <span class="n">lw</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#CCCCCC&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Num of m/z`s (square: --; dot: +)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Lipids matching (square: -; dot: +)&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;hits-5-1000-</span><span class="si">%s</span><span class="s1">.pdf&#39;</span><span class="o">%</span><span class="n">letter</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">flatList</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">flatList</span><span class="p">([[</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#6ea945&#39;</span><span class="p">,</span> <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fractions in sample&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;M/z min(pos, neg)&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;hits-3-150-</span><span class="si">%s</span><span class="s1">.pdf&#39;</span><span class="o">%</span><span class="n">letter</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stage3</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;#6ea945&#39;</span><span class="p">,</span> <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fractions in sample&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Lipids matched (pos, neg)&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;hits-4-1000-</span><span class="si">%s</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="n">letter</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stage3</span><span class="p">)),</span>
            <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">stage3</span><span class="p">,</span>
                <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)],</span>
            <span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#6EA945&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Lipid transfer protein&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of valid lipid matches</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;(with no filtering based on profiles)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stage3</span><span class="p">))</span> <span class="o">+</span> <span class="o">.</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> \
                <span class="nb">sorted</span><span class="p">(</span><span class="n">stage3</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)],</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;lipid-matches-3000-</span><span class="si">%s</span><span class="s1">.pdf&#39;</span><span class="o">%</span><span class="n">letter</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Screening.ms1_headgroups"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms1_headgroups">[docs]</a>    <span class="k">def</span> <span class="nf">ms1_headgroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies headgroups by keywords and fatty acids</span>
<span class="sd">        from database record names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">lips</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">]):</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">lips</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">lip</span> <span class="ow">in</span> <span class="n">lips</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">lip</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">: &#39;</span>\
                                        <span class="s1">&#39;found </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                        <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="n">lip</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                                <span class="n">posAdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span><span class="p">[</span><span class="n">lip</span><span class="p">[</span><span class="mi">7</span><span class="p">]][</span><span class="s1">&#39;pos_adduct&#39;</span><span class="p">]</span>
                                <span class="n">negAdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span><span class="p">[</span><span class="n">lip</span><span class="p">[</span><span class="mi">7</span><span class="p">]][</span><span class="s1">&#39;neg_adduct&#39;</span><span class="p">]</span>
                                <span class="n">thisModeAdd</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span><span class="p">[</span><span class="n">lip</span><span class="p">[</span><span class="mi">7</span><span class="p">]][</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_adduct&#39;</span><span class="o">%</span><span class="n">pn</span><span class="p">]</span>
                                <span class="n">hg</span> <span class="o">=</span> <span class="n">lip</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                                <span class="n">fa</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lip</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">lip</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> \
                                    <span class="k">if</span> <span class="n">lip</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">posAdd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">negAdd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
                                    <span class="n">thisModeAdd</span> <span class="o">==</span> <span class="n">lip</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">accepting &#39;</span>\
                                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> for&#39;</span>\
                                            <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                            <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">lip</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">protein</span><span class="p">,</span> <span class="n">pn</span><span class="p">))</span>
                                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">fa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                            <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">discarding </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span>\
                                            <span class="s1">&#39; for </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
                                            <span class="s1">&#39; in </span><span class="si">%s</span><span class="s1"> mode&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                <span class="n">lip</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                                                <span class="n">lip</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                                <span class="n">protein</span><span class="p">,</span>
                                                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is the main adduct&#39;</span> <span class="o">%</span> \
                                                    <span class="n">thisModeAdd</span> \
                                                    <span class="k">if</span> <span class="n">thisModeAdd</span> \
                                                        <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                                                    <span class="k">else</span> \
                                                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not&#39;</span>\
                                                        <span class="s1">&#39; ionize&#39;</span> <span class="o">%</span> \
                                                        <span class="n">lip</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                                <span class="n">pn</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="Screening.headgroups_by_fattya"><a class="viewcode-back" href="../../index.html#emese.main.Screening.headgroups_by_fattya">[docs]</a>    <span class="k">def</span> <span class="nf">headgroups_by_fattya</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Limits the number of possible headgroups based on detected</span>
<span class="sd">        MS2 fatty acids.</span>
<span class="sd">        Creates dict `hgfa`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ms2fa</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">hg</span><span class="p">,</span> <span class="n">ms1fa</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">ms2fa</span> <span class="ow">in</span> <span class="n">ms1fa</span><span class="p">:</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s1"> is among &#39;</span>\
                                        <span class="s1">&#39;possible fat&#39;</span>\
                                        <span class="s1">&#39;ty acids (</span><span class="si">%s</span><span class="s1">) for </span><span class="si">%s</span><span class="s1"> based on MS1, &#39;</span>\
                                        <span class="s1">&#39;for feature </span><span class="si">%u</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                        <span class="p">(</span><span class="n">ms2fa</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ms1fa</span><span class="p">)),</span> 
                                            <span class="n">hg</span><span class="p">,</span> <span class="n">oi</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mod</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s1"> not among &#39;</span>\
                                        <span class="s1">&#39;possible fat&#39;</span>\
                                        <span class="s1">&#39;ty acids (</span><span class="si">%s</span><span class="s1">) for </span><span class="si">%s</span><span class="s1"> based on MS1, &#39;</span>\
                                        <span class="s1">&#39;for feature </span><span class="si">%u</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                        <span class="p">(</span><span class="n">ms2fa</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ms1fa</span><span class="p">)),</span> 
                                            <span class="n">hg</span><span class="p">,</span> <span class="n">oi</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mod</span><span class="p">))</span></div>

<div class="viewcode-block" id="Screening.identity_combined"><a class="viewcode-back" href="../../index.html#emese.main.Screening.identity_combined">[docs]</a>    <span class="k">def</span> <span class="nf">identity_combined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combined identification based on MS1 database lookup,</span>
<span class="sd">        MS2 headgroup fragments and MS2 fatty acids.</span>
<span class="sd">        Creates dicts `combined_hg` and `combined_fa`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_hg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_fa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                    <span class="n">hgs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">hgs</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]):</span>
                            <span class="n">hgs</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">hgs</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">|</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hgs</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]):</span>
                        <span class="n">hgs</span> <span class="o">=</span> <span class="n">hgs</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hgs</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgs</span>
                    <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">hgs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                            <span class="c1"># currently only the most certain cases:</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span></div>
                            <span class="c1"># maybe later we need those with less evidence</span>

<div class="viewcode-block" id="Screening.identity_combined_ms2"><a class="viewcode-back" href="../../index.html#emese.main.Screening.identity_combined_ms2">[docs]</a>    <span class="k">def</span> <span class="nf">identity_combined_ms2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combined identification based on MS1 database lookup,</span>
<span class="sd">        MS2 headgroup fragments and MS2 fatty acids.</span>
<span class="sd">        Creates dicts `combined_hg` and `combined_fa`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_hg_ms2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_hg_ms2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]:</span>
                        <span class="n">hgs</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hgs</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]):</span>
                        <span class="n">hgs</span> <span class="o">=</span> <span class="n">hgs</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_hg_ms2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">hgs</span></div>

    <span class="k">def</span> <span class="nf">ms1_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">):</span>
        <span class="n">proteins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># collecting primary and secondary column names</span>
        <span class="c1"># and cell values</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">]):</span>
                <span class="n">_np</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span> <span class="k">else</span> <span class="s1">&#39;neg&#39;</span>
                <span class="n">nptbl</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">_np</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="n">include</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">lip</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                                <span class="n">hg</span> <span class="o">=</span> <span class="n">lip</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">hg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">fa</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lip</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> \
                                        <span class="k">if</span> <span class="n">lip</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span>
                                    <span class="c1"># colnames</span>
                                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                                        <span class="n">colnames</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                                    <span class="n">colnames</span><span class="p">[</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fa</span><span class="p">)</span>
                                    <span class="c1"># cells</span>
                                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]:</span>
                                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="k">if</span> <span class="n">fa</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">]:</span>
                                        <span class="c1"># 3 bool values: +, -,</span>
                                        <span class="c1"># both + &amp; - at same exact mass</span>
                                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">]</span> <span class="o">=</span> \
                                            <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
                                    <span class="c1"># cell values</span>
                                    <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
                                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">elif</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>
                                        <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">for</span> <span class="n">_oi</span><span class="p">,</span> <span class="n">pnlips</span> <span class="ow">in</span> \
                                        <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_lip&#39;</span><span class="o">%</span><span class="n">_np</span><span class="p">][</span><span class="n">oi</span><span class="p">]):</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> \
                                            <span class="n">pnlips</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">pnlip</span> <span class="ow">in</span> <span class="n">pnlips</span><span class="p">:</span>
                                                <span class="n">pfa</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                                    <span class="nb">tuple</span><span class="p">(</span><span class="n">pnlip</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> \
                                                    <span class="k">if</span> <span class="n">pnlip</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                                                    <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span>
                                                <span class="n">nfa</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                                    <span class="nb">tuple</span><span class="p">(</span><span class="n">pnlip</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> \
                                                    <span class="k">if</span> <span class="n">pnlip</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                                                    <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span>
                                                <span class="k">if</span> <span class="n">pfa</span> <span class="o">==</span> <span class="n">fa</span> <span class="ow">and</span> <span class="n">nfa</span> <span class="o">==</span> <span class="n">fa</span> <span class="ow">and</span> \
                                                    <span class="n">pnlip</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="n">hg</span> <span class="ow">and</span> \
                                                    <span class="n">pnlip</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">==</span> <span class="n">hg</span><span class="p">:</span>
                                                    <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> \
                                                        <span class="kc">True</span>
                                                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">today</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">ms1_table_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;results_</span><span class="si">%s</span><span class="s1">_ms1.html&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> \
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">filename</span>
        <span class="n">colnames</span><span class="p">,</span> <span class="n">ms1tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_table</span><span class="p">(</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Binding specificities of LTPs detected in MS1&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablehcell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;th&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tableshcell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;th colspan=&quot;</span><span class="si">%u</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablecell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">th1</span> <span class="o">=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="s1">&#39;&#39;</span>
        <span class="n">th2</span> <span class="o">=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="s1">&#39;LTP&#39;</span>
        <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">th1</span> <span class="o">+=</span> <span class="n">tableshcell</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="n">hg</span><span class="p">]),</span> <span class="n">hg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="n">hg</span><span class="p">]):</span>
                <span class="n">th2</span> <span class="o">+=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="n">fa</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">th1</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">th2</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;rowname&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">protein</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="n">hg</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fa</span> <span class="ow">in</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;matching&#39;</span><span class="p">,</span> 
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) detected in &#39;</span>\
                                <span class="s1">&#39;Positive &amp; Negative modes at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">protein</span><span class="p">),</span>
                                <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) detected in &#39;</span>\
                                <span class="s1">&#39;Positive &amp; Negative modes at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">protein</span><span class="p">),</span>
                                <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) detected &#39;</span>\
                                <span class="s1">&#39;in Positive mode at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">protein</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;negative&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) detected &#39;</span>\
                                <span class="s1">&#39;in Negative mode at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">protein</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) not detected at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">fa</span><span class="p">,</span> <span class="n">protein</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">row</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html_table_template</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>

<div class="viewcode-block" id="Screening.ms1_table_html_simple"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms1_table_html_simple">[docs]</a>    <span class="k">def</span> <span class="nf">ms1_table_html_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs a HTML table proteins vs lipid classes (headgroups)</span>
<span class="sd">        based on MS1 identifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;results_</span><span class="si">%s</span><span class="s1">_ms1hg.html&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> \
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">filename</span>
        <span class="n">colnames</span><span class="p">,</span> <span class="n">ms1tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_table</span><span class="p">(</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Binding specificities of proteins by headgroups detected in MS1&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablehcell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;th&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablecell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">th1</span> <span class="o">=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="s1">&#39;LTP&#39;</span>
        <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">th1</span> <span class="o">+=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="n">hg</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">th1</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;rowname&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">protein</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="n">hg</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fa</span> <span class="ow">in</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">neg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos_neg</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;matching&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> detected in Positive &amp; &#39;</span>\
                        <span class="s1">&#39;Negative modes&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> detected in Positive &#39;</span>\
                        <span class="s1">&#39;mode&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> detected in Negative &#39;</span>\
                        <span class="s1">&#39;mode&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not detected&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">row</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html_table_template</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="Screening.ms1_table_latex_simple"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms1_table_latex_simple">[docs]</a>    <span class="k">def</span> <span class="nf">ms1_table_latex_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;ms1headgroups.tex&#39;</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">,</span> <span class="n">break_half</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs a LaTeX table LTPs vs lipid classes (headgroups)</span>
<span class="sd">        based on MS1 identifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colnames</span><span class="p">,</span> <span class="n">ms1tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_table</span><span class="p">(</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tabular}</span><span class="s1">{l</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\\\\\n</span><span class="s1">&#39;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="s1">&#39;&amp; &#39;</span>
        <span class="n">hdr</span> <span class="o">+=</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                        <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">rot{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span>
                    <span class="n">colnames</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hdr</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">fa</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="n">hg</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fa</span> <span class="ow">in</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">ms1tab</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">fa</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">neg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos_neg</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblyellow!75}&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblgreen!75}&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblpetrol!75}&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">break_half</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">):</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{tabular}</span><span class="se">\n\\</span><span class="s1">quad</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tabular}</span><span class="s1">{l</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hdr</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{tabular}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    END: MS1 lipid identification</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Screening.ms2_table_html_simple"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_table_html_simple">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_table_html_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs a HTML table LTPs vs lipid classes (headgroups)</span>
<span class="sd">        based on MS2 identifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;results_</span><span class="si">%s</span><span class="s1">_ms2hg.html&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> \
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">filename</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Binding specificities of LTPs by headgroups detected in MS2&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablehcell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;th&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablecell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">th1</span> <span class="o">=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="s1">&#39;protein&#39;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">colnames</span> <span class="o">=</span> <span class="n">colnames</span> <span class="o">|</span> <span class="n">hg</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="n">th1</span> <span class="o">+=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="n">hg</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">th1</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;rowname&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">protein</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_same_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">ms2hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">ms2hg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms2hg</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
                                <span class="n">pos</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2hg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">pos_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>
                                <span class="n">neg</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2hg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="ow">and</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos_unambig</span> <span class="ow">or</span> <span class="n">neg_unambig</span><span class="p">:</span>
                    <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">ms2hgs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ms2hg_neg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">ms2hg</span> <span class="ow">in</span> <span class="n">ms2hgs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms2hg</span><span class="p">:</span>
                            <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2hg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos_neg_same</span><span class="p">:</span>
                    <span class="n">unambig</span> <span class="o">=</span> <span class="s1">&#39;UA&#39;</span> <span class="k">if</span> <span class="n">pos_neg_same_unambig</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                    <span class="n">unambig2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unambiguous at least once&#39;</span> \
                        <span class="k">if</span> <span class="n">pos_neg_same_unambig</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Only ambiguous&#39;</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;matching&#39;</span><span class="p">,</span> <span class="s1">&#39;Detected in Positive &amp;&#39;</span>\
                        <span class="s1">&#39; Negative modes,</span><span class="se">\n</span><span class="s1">at same exact mass</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>\
                        <span class="n">unambig2</span><span class="p">,</span> <span class="n">unambig</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pos_neg</span><span class="p">:</span>
                    <span class="n">unambig</span> <span class="o">=</span> <span class="s1">&#39;UA&#39;</span> <span class="k">if</span> <span class="n">pos_neg_unambig</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                    <span class="n">unambig2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unambiguous at least once&#39;</span> \
                        <span class="k">if</span> <span class="n">pos_neg_unambig</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Only ambiguous&#39;</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="s1">&#39;Detected in Positive &amp;&#39;</span>\
                        <span class="s1">&#39; Negative modes,</span><span class="se">\n</span><span class="s1">at different exact mass</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>\
                        <span class="n">unambig2</span><span class="p">,</span> <span class="n">unambig</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">unambig2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unambiguous at least once&#39;</span> <span class="k">if</span> <span class="n">pos_unambig</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Only ambiguous&#39;</span>
                    <span class="n">unambig</span> <span class="o">=</span> <span class="s1">&#39;UA&#39;</span> <span class="k">if</span> <span class="n">pos_unambig</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Detected in Positive mode</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="n">unambig2</span><span class="p">,</span> <span class="n">unambig</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">unambig2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unambiguous at least once&#39;</span> <span class="k">if</span> <span class="n">neg_unambig</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Only ambiguous&#39;</span>
                    <span class="n">unambig</span> <span class="o">=</span> <span class="s1">&#39;UA&#39;</span> <span class="k">if</span> <span class="n">neg_unambig</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;negative&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Detected in Negative mode</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>\
                        <span class="n">unambig2</span><span class="p">,</span> <span class="n">unambig</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;Not detected&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">row</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html_table_template</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span></div>

<div class="viewcode-block" id="Screening.ms2_table_latex_simple"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms2_table_latex_simple">[docs]</a>    <span class="k">def</span> <span class="nf">ms2_table_latex_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;ms2headgroups.tex&#39;</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">,</span> <span class="n">break_half</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs a LaTeX table LTPs vs lipid classes (headgroups)</span>
<span class="sd">        based on MS2 identifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">colnames</span> <span class="o">=</span> <span class="n">colnames</span> <span class="o">|</span> <span class="n">hg</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\\\\\n</span><span class="s1">&#39;</span>
        <span class="n">colnames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tabular}</span><span class="s1">{l</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&amp; &#39;</span>
        <span class="n">hdr</span> <span class="o">+=</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                    <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">rot{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span>
                <span class="n">colnames</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hdr</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_same_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">ms2hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">ms2hg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms2hg</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
                                <span class="n">pos</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2hg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">pos_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>
                                <span class="n">neg</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2hg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="ow">and</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos_unambig</span> <span class="ow">or</span> <span class="n">neg_unambig</span><span class="p">:</span>
                    <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">ms2hgs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;ms2hg_neg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">ms2hg</span> <span class="ow">in</span> <span class="n">ms2hgs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms2hg</span><span class="p">:</span>
                            <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2hg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos_neg_same</span> <span class="ow">or</span> <span class="n">pos_neg</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblyellow!75}&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblgreen!75}&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblpetrol!75}&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">break_half</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">):</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{tabular}</span><span class="se">\n\\</span><span class="s1">quad</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tabular}</span><span class="s1">{l</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hdr</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{tabular}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>

<div class="viewcode-block" id="Screening.ms1_ms2_table_html_simple"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms1_ms2_table_html_simple">[docs]</a>    <span class="k">def</span> <span class="nf">ms1_ms2_table_html_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs a HTML table LTPs vs lipid classes (headgroups)</span>
<span class="sd">        based on MS1 and MS2 identifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;results_</span><span class="si">%s</span><span class="s1">_ms1ms2hg.html&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> \
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">filename</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Binding specificities of LTPs by headgroups&#39;</span>\
            <span class="s1">&#39; detected in MS1 and MS2&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablehcell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;th&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablecell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">th1</span> <span class="o">=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="s1">&#39;LTP&#39;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">hgs</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">hg</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">hgs</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">hg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]):</span>
                            <span class="n">colnames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
        <span class="c1"># header row (lipid species)</span>
        <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="n">th1</span> <span class="o">+=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="n">hg</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">th1</span>
        <span class="c1"># rows by protein</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;rowname&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">protein</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_same_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">include</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]:</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                        <span class="n">this_hg</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]:</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]:</span>
                                <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">for</span> <span class="n">noi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span>\
                                        <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">]:</span>
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                            <span class="p">[</span><span class="n">noi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> \
                                                <span class="ow">and</span> \
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                            <span class="p">[</span><span class="n">noi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]:</span>
                                            <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                                    <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hg</span> \
                                                            <span class="ow">and</span> \
                                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> \
                                                            <span class="ow">and</span> \
                                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">],</span>
                                                    <span class="n">iteritems</span><span class="p">(</span>
                                                        <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span>\
                                                        <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                                        <span class="p">[</span><span class="n">noi</span><span class="p">])</span>
                                                <span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                                <span class="n">pos_neg_same_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                    <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hg</span> <span class="ow">and</span> <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> \
                                        <span class="ow">and</span> <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">],</span>
                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
                                <span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">pos_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">include</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]:</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                        <span class="n">this_hg</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]:</span>
                            <span class="n">neg</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]:</span>
                                <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">for</span> <span class="n">noi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>\
                                        <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">]:</span>
                                        <span class="k">if</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                            <span class="p">[</span><span class="n">noi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                                <span class="p">[</span><span class="n">noi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]:</span>
                                            <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                                    <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hg</span> <span class="ow">and</span> \
                                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> \
                                                            <span class="ow">and</span> \
                                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">],</span>
                                                    <span class="n">iteritems</span><span class="p">(</span>
                                                        <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>\
                                                        <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                                        <span class="p">[</span><span class="n">noi</span><span class="p">])</span>
                                                <span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                                <span class="n">pos_neg_same_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                    <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hg</span> <span class="ow">and</span> <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> \
                                        <span class="ow">and</span> <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">],</span>
                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
                                <span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos_unambig</span> <span class="ow">and</span> <span class="n">neg_unambig</span><span class="p">:</span>
                    <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos_neg_same</span><span class="p">:</span>
                    <span class="n">unambig</span> <span class="o">=</span> <span class="s1">&#39;UA&#39;</span> <span class="k">if</span> <span class="n">pos_neg_same_unambig</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                    <span class="n">unambig2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unambiguous at least once&#39;</span> \
                        <span class="k">if</span> <span class="n">pos_neg_same_unambig</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Only ambiguous&#39;</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;matching&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> detected in Positive &amp;&#39;</span>\
                        <span class="s1">&#39; Negative modes,</span><span class="se">\n</span><span class="s1">at same exact mass</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>\
                        <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">unambig2</span><span class="p">),</span> <span class="n">unambig</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pos_neg</span><span class="p">:</span>
                    <span class="n">unambig</span> <span class="o">=</span> <span class="s1">&#39;UA&#39;</span> <span class="k">if</span> <span class="n">pos_neg_unambig</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                    <span class="n">unambig2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unambiguous at least once&#39;</span> \
                        <span class="k">if</span> <span class="n">pos_neg_unambig</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Only ambiguous&#39;</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> detected in Positive &amp;&#39;</span>\
                        <span class="s1">&#39; Negative modes,</span><span class="se">\n</span><span class="s1">at different exact mass</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">unambig2</span><span class="p">),</span> <span class="n">unambig</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">unambig2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unambiguous at least once&#39;</span> <span class="k">if</span> <span class="n">pos_unambig</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Only ambiguous&#39;</span>
                    <span class="n">unambig</span> <span class="o">=</span> <span class="s1">&#39;UA&#39;</span> <span class="k">if</span> <span class="n">pos_unambig</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> detected in Positive mode</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">unambig2</span><span class="p">),</span> <span class="n">unambig</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">unambig2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unambiguous at least once&#39;</span> <span class="k">if</span> <span class="n">neg_unambig</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Only ambiguous&#39;</span>
                    <span class="n">unambig</span> <span class="o">=</span> <span class="s1">&#39;UA&#39;</span> <span class="k">if</span> <span class="n">neg_unambig</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;negative&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> detected in Negative mode</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">unambig2</span><span class="p">),</span> <span class="n">unambig</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not detected&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">row</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html_table_template</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="Screening.ms1_ms2_table_latex_simple"><a class="viewcode-back" href="../../index.html#emese.main.Screening.ms1_ms2_table_latex_simple">[docs]</a>    <span class="k">def</span> <span class="nf">ms1_ms2_table_latex_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;ms1ms2headgroups.tex&#39;</span><span class="p">,</span>
        <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">,</span> <span class="n">break_half</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs a LaTeX table LTPs vs lipid classes (headgroups)</span>
<span class="sd">        based on MS1 and MS2 identifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">hgs</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">hg</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">hgs</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">hg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]):</span>
                            <span class="n">colnames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
        <span class="n">colnames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\\\\\n</span><span class="s1">&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tabular}</span><span class="s1">{l</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&amp; &#39;</span>
        <span class="n">hdr</span> <span class="o">+=</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                    <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">rot{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span>
                <span class="n">colnames</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hdr</span>
        <span class="c1"># rows by LTP</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">neg_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_same_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">include</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]:</span>
                    
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                        
                        <span class="n">this_hg</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span>
                        
                        <span class="k">if</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]:</span>
                            
                            <span class="n">pos</span> <span class="o">=</span> <span class="kc">True</span>
                            
                            <span class="k">if</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]:</span>
                                
                                <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">for</span> <span class="n">noi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    
                                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span>\
                                        <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">]:</span>
                                        
                                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                            <span class="p">[</span><span class="n">noi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> \
                                                <span class="ow">and</span> \
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                            <span class="p">[</span><span class="n">noi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]:</span>
                                            
                                            <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                                            
                                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                                    <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hg</span> \
                                                            <span class="ow">and</span> \
                                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> \
                                                            <span class="ow">and</span> \
                                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">],</span>
                                                    <span class="n">iteritems</span><span class="p">(</span>
                                                        <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span>\
                                                        <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                                        <span class="p">[</span><span class="n">noi</span><span class="p">]</span>
                                                    <span class="p">)</span>
                                                <span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                                
                                                <span class="n">pos_neg_same_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                            
                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                    <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hg</span> <span class="ow">and</span> <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> \
                                        <span class="ow">and</span> <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">],</span>
                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
                                <span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">pos_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">include</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]:</span>
                    
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                        
                        <span class="n">this_hg</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span>
                        
                        <span class="k">if</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]:</span>
                            
                            <span class="n">neg</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">this_hg</span><span class="p">[</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]:</span>
                                
                                <span class="n">pos_neg_same</span> <span class="o">=</span> <span class="kc">True</span>
                                
                                <span class="k">for</span> <span class="n">noi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    
                                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>\
                                        <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">noi</span><span class="p">]:</span>
                                        
                                        <span class="k">if</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                            <span class="p">[</span><span class="n">noi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                            <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                                <span class="p">[</span><span class="n">noi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]:</span>
                                            
                                            <span class="n">pos_neg</span> <span class="o">=</span> <span class="kc">True</span>
                                            
                                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                                    <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hg</span> <span class="ow">and</span> \
                                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> \
                                                            <span class="ow">and</span> \
                                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">],</span>
                                                    <span class="n">iteritems</span><span class="p">(</span>
                                                        <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>\
                                                        <span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span>\
                                                        <span class="p">[</span><span class="n">noi</span><span class="p">]</span>
                                                    <span class="p">)</span>
                                                <span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                                
                                                <span class="n">pos_neg_same_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                            
                            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                    <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hg</span> <span class="ow">and</span> <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> \
                                        <span class="ow">and</span> <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">],</span>
                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
                                <span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">if</span> <span class="n">pos_unambig</span> <span class="ow">and</span> <span class="n">neg_unambig</span><span class="p">:</span>
                    <span class="n">pos_neg_unambig</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">if</span> <span class="n">pos_neg_unambig</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblyellow!75}&#39;</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">pos_neg</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblyellow!75}&#39;</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblgreen!75}&#39;</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblpetrol!75}&#39;</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">break_half</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">):</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{tabular}</span><span class="se">\n\\</span><span class="s1">quad</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tabular}</span><span class="s1">{l</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hdr</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{tabular}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">identities_latex_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;ms1ms2hcheadgroups2.tex&#39;</span><span class="p">,</span> <span class="n">break_half</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">):</span>
        <span class="n">allhgs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2results</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">hg</span><span class="p">,</span> <span class="n">ms2result</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ms2results</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">ms2result</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">allhgs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">allhgs</span><span class="p">))</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\\\\\n</span><span class="s1">&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tabular}</span><span class="s1">{l</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&amp; &#39;</span>
        <span class="n">hdr</span> <span class="o">+=</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                    <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">rot{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span>
                <span class="n">colnames</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hdr</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="n">detected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;ms2i3&#39;</span><span class="p">]:</span>
                            <span class="n">ms2results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;ms2i3&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">include</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="n">include</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms2results</span><span class="p">:</span>
                                    <span class="n">detected</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">detected</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="n">detected</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblyellow!75}&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">detected</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblpetrol!75}&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">detected</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cellcolor{emblgreen!75}&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">break_half</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">):</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{tabular}</span><span class="se">\n\\</span><span class="s1">quad</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{tabular}</span><span class="s1">{l</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
                <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hdr</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{tabular}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
    
<div class="viewcode-block" id="Screening.feature_identity_table"><a class="viewcode-back" href="../../index.html#emese.main.Screening.feature_identity_table">[docs]</a>    <span class="k">def</span> <span class="nf">feature_identity_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates dictionaries named `identity`, having</span>
<span class="sd">        original IDs as keys and 4 element dictionaries</span>
<span class="sd">        as values with keys ms1_pos, ms2_pos, ms1_neg, ms2_neg,</span>
<span class="sd">        each having a boolean value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_alll</span><span class="p">(</span><span class="s1">&#39;mz&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">opp_mode</span> <span class="o">=</span> <span class="s1">&#39;neg&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;pos&#39;</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">ms1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                    <span class="n">ms2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span> \
                        <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
                    <span class="n">ms1_opp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="n">ms2_opp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                    <span class="k">for</span> <span class="n">opp_oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="n">opp_mode</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">opp_oi</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">opp_mode</span><span class="p">][</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">]:</span>
                            <span class="n">ms1_opp</span> <span class="o">=</span> <span class="n">ms1_opp</span> <span class="o">|</span> <span class="n">d</span><span class="p">[</span><span class="n">opp_mode</span><span class="p">][</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">opp_oi</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">opp_oi</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">opp_mode</span><span class="p">][</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                            <span class="n">d</span><span class="p">[</span><span class="n">opp_mode</span><span class="p">][</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">opp_oi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ms2_opp</span> <span class="o">=</span> <span class="n">ms2_opp</span> <span class="o">|</span> <span class="n">d</span><span class="p">[</span><span class="n">opp_mode</span><span class="p">][</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">opp_oi</span><span class="p">]</span>
                    <span class="n">hg_all</span> <span class="o">=</span> <span class="n">ms1</span> <span class="o">|</span> <span class="n">ms2</span> <span class="o">|</span> <span class="n">ms1_opp</span> <span class="o">|</span> <span class="n">ms2_opp</span>
                    <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">hg_all</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;ms1_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">pn</span><span class="p">:</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms1</span><span class="p">,</span>
                            <span class="s1">&#39;ms2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">pn</span><span class="p">:</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms2</span><span class="p">,</span>
                            <span class="s1">&#39;ms1_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">opp_mode</span><span class="p">:</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms1_opp</span><span class="p">,</span>
                            <span class="s1">&#39;ms2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">opp_mode</span><span class="p">:</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">ms2_opp</span>
                        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">feature_identity_html_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">bindprop</span><span class="p">,</span>
        <span class="n">fits_pprop</span> <span class="o">=</span> <span class="s1">&#39;cl5pct&#39;</span><span class="p">,</span>
        <span class="n">outf</span> <span class="o">=</span> <span class="s1">&#39;identities.html&#39;</span><span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LTP&#39;</span><span class="p">,</span> <span class="s1">&#39;m/z&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;fits protein +&#39;</span><span class="p">,</span> <span class="s1">&#39;fits protein -&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;headgroup&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1+&#39;</span><span class="p">,</span> <span class="s1">&#39;MS2+&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1-&#39;</span><span class="p">,</span> <span class="s1">&#39;MS2-&#39;</span><span class="p">]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Identities for all features&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablehcell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;th&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablecell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">hrow</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">coln</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">:</span>
            <span class="n">hrow</span> <span class="o">+=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="n">coln</span>
        <span class="n">hrow</span> <span class="o">=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hrow</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">hrow</span>
        <span class="n">empty_ids</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ms2_pos&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
            <span class="s1">&#39;ms1_neg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ms2_neg&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">_np</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span> <span class="k">else</span> <span class="s1">&#39;neg&#39;</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">hg</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">((</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> \
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                        <span class="k">else</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">empty_ids</span><span class="p">)):</span>
                        <span class="n">this_row</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;rowname&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="p">)</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%.05f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                        <span class="n">fits_pos</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">fits_pprop</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> \
                            <span class="nb">bool</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_i</span><span class="p">:</span> <span class="n">_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_i</span><span class="p">:</span> 
                                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> 
                                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="n">fits_pprop</span><span class="p">])</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">))</span>
                        <span class="n">fits_neg</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">fits_pprop</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">pn</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span> <span class="k">else</span> \
                            <span class="nb">bool</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_i</span><span class="p">:</span> <span class="n">_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_i</span><span class="p">:</span> 
                                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> 
                                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="n">fits_pprop</span><span class="p">])</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">))</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">fits_pos</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Positive mode fits well on protein profile&#39;</span> \
                                <span class="k">if</span> <span class="n">fits_pos</span> \
                                <span class="k">else</span> <span class="s1">&#39;Positive mode does not fit well on&#39;</span>\
                                    <span class="s1">&#39; protein profile or not available&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">fits_neg</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Negative mode fits well on protein profile&#39;</span> \
                                <span class="k">if</span> <span class="n">fits_neg</span> \
                                <span class="k">else</span> <span class="s1">&#39;Negative mode does not fit well on&#39;</span>\
                                    <span class="s1">&#39; protein profile or not available&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is known binder of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">protein</span><span class="p">)</span> \
                                <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> \
                                <span class="k">else</span> <span class="s1">&#39;No literature data &#39;</span>\
                                    <span class="s1">&#39;about </span><span class="si">%s</span><span class="s1"> binding </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">hg</span><span class="p">),</span>
                            <span class="n">hg</span><span class="p">)</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Identified in MS1 positive mode&#39;</span> \
                                <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">]</span> \
                                <span class="k">else</span> <span class="s1">&#39;Not identified in MS1 positive mode&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Identified in MS2 positive mode&#39;</span> \
                                <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms2_pos&#39;</span><span class="p">]</span> \
                                <span class="k">else</span> <span class="s1">&#39;Not identified in MS2 positive mode&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Identified in MS1 negative mode&#39;</span> \
                                <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms1_neg&#39;</span><span class="p">]</span> \
                                <span class="k">else</span> <span class="s1">&#39;Not identified in MS1 negative mode&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">this_row</span> <span class="o">+=</span> <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Identified in MS2 negative mode&#39;</span> \
                                <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;ms2_neg&#39;</span><span class="p">]</span> \
                                <span class="k">else</span> <span class="s1">&#39;Not identified in MS2 negative mode&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">this_row</span> <span class="o">=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">this_row</span>
                        <span class="n">table</span> <span class="o">+=</span> <span class="n">this_row</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_table_template</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">known_binders_enrichment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">bindprop</span><span class="p">,</span> <span class="n">classif</span> <span class="o">=</span> <span class="s1">&#39;cl5pct&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pn</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;enr&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">classif</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">]:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;tp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ioi</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="n">classif</span><span class="p">][</span><span class="n">ioi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">and</span> \
                            <span class="nb">len</span><span class="p">(</span><span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">&amp;</span> \
                                <span class="nb">set</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">ioi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ioi</span><span class="p">:</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="n">classif</span><span class="p">][</span><span class="n">ioi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">and</span> \
                            <span class="nb">len</span><span class="p">(</span><span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">&amp;</span> \
                                <span class="nb">set</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">ioi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;tn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ioi</span><span class="p">:</span>
                        <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="n">classif</span><span class="p">][</span><span class="n">ioi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">and</span> \
                            <span class="nb">len</span><span class="p">(</span><span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">&amp;</span> \
                                <span class="nb">set</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">ioi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ioi</span><span class="p">:</span>
                        <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="n">classif</span><span class="p">][</span><span class="n">ioi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">and</span> \
                            <span class="nb">len</span><span class="p">(</span><span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">&amp;</span> \
                                <span class="nb">set</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">ioi</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;or&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="nb">float</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;tp&#39;</span><span class="p">]</span> <span class="o">*</span> \
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;tn&#39;</span><span class="p">])</span> <span class="o">/</span> \
                        <span class="nb">float</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fp&#39;</span><span class="p">]</span> <span class="o">*</span> \
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fn&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;or&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;contab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="p">[</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;tp&#39;</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fp&#39;</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fn&#39;</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;tn&#39;</span><span class="p">]]])</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fisher&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">fisher_exact</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;contab&#39;</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">enrichment_barplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">classif</span> <span class="o">=</span> <span class="s1">&#39;cl5pct&#39;</span><span class="p">,</span> 
        <span class="n">outf</span> <span class="o">=</span> <span class="s1">&#39;known_binders_enrichment.pdf&#39;</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.45</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
            <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;tp&#39;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fn&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> \
            <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;tp&#39;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fn&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">))</span>
        <span class="n">ppvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
            <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fisher&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">labels</span>
        <span class="p">)</span>
        <span class="n">npvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
            <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fisher&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">labels</span>
        <span class="p">)</span>
        <span class="n">pors</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
            <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">][</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fisher&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">labels</span>
        <span class="p">)</span>
        <span class="n">nors</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
            <span class="s1">&#39;</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">][</span><span class="s1">&#39;enr&#39;</span><span class="p">][</span><span class="n">classif</span><span class="p">][</span><span class="s1">&#39;fisher&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">labels</span>
        <span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">cvs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_pdf</span><span class="o">.</span><span class="n">FigureCanvasPdf</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span> <span class="n">pors</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#97BE73&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">nors</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;#49969A&#39;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;symlog&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;LTPs&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Enrichment (odds ratio)&#39;</span><span class="p">)</span>
        <span class="n">cvs</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">cvs</span><span class="o">.</span><span class="n">print_figure</span><span class="p">(</span><span class="n">outf</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">identification_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span> <span class="o">=</span> <span class="s1">&#39;STARD10&#39;</span><span class="p">,</span>
        <span class="n">hg</span> <span class="o">=</span> <span class="s1">&#39;PC&#39;</span><span class="p">,</span> <span class="n">classif</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([]),</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([])}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MS1 &amp; MS2 both +/-&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;MS1 &amp; MS2 only +&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1 &amp; MS2 only -&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MS1 both +/-, no MS2&#39;</span><span class="p">,</span> <span class="s1">&#39;MS2 both +/-, no MS1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MS1 + and MS2 -&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1 - and MS2 +&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Only MS1 +&#39;</span><span class="p">,</span> <span class="s1">&#39;Only MS1 -&#39;</span><span class="p">,</span> <span class="s1">&#39;Only MS2 +&#39;</span><span class="p">,</span> <span class="s1">&#39;Only MS2 -&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MS1 both +/-, MS2 +&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1 both +/-, MS2 -&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MS1 +, MS2 both +/-&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1 -, MS2 both +/-&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;Non </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span>
            <span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="s1">&#39;+/- Total&#39;</span><span class="p">,</span> <span class="s1">&#39;Only + Total&#39;</span><span class="p">,</span> <span class="s1">&#39;Only - Total&#39;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)))</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">}</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ms1_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;ms1_neg&#39;</span><span class="p">,</span> <span class="s1">&#39;ms2_neg&#39;</span><span class="p">]</span>
        <span class="n">combinations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;MS1 &amp; MS2 both +/-&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;MS1 &amp; MS2 only +&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;MS1 &amp; MS2 only -&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;MS1 both +/-, no MS2&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;MS2 both +/-, no MS1&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;MS1 + and MS2 -&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;MS1 - and MS2 +&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;Only MS1 +&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;Only MS1 -&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;Only MS2 +&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;Only MS2 -&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;MS1 both +/-, MS2 +&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;MS1 both +/-, MS2 -&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;MS1 +, MS2 both +/-&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;MS1 -, MS2 both +/-&#39;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">opp_mod</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">)]:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
            <span class="n">opp_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">opp_mod</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="n">classif</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tbl</span><span class="p">[</span><span class="n">classif</span><span class="p">][</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">visited</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oi</span><span class="p">)</span>
                    <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">opp_indices</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">opp_oi</span><span class="p">:</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">opp_tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">opp_oi</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">opp_class</span> <span class="o">=</span> <span class="n">classif</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">opp_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> \
                        <span class="nb">sum</span><span class="p">(</span><span class="n">opp_tbl</span><span class="p">[</span><span class="n">classif</span><span class="p">][</span><span class="n">opp_indices</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">opp_class</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;+/- Total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">for</span> <span class="n">opp_oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">classif</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> \
                            <span class="nb">any</span><span class="p">(</span><span class="n">opp_tbl</span><span class="p">[</span><span class="n">classif</span><span class="p">][</span><span class="n">opp_indices</span><span class="p">]):</span>
                                <span class="n">visited</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opp_oi</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Only </span><span class="si">%s</span><span class="s1"> Total&#39;</span><span class="o">%</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">hg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span>\
                        <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">and</span> \
                        <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms1_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mode</span><span class="p">]</span> <span class="ow">and</span> \
                        <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="s1">&#39;ms2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mode</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">hg</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Non </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">hg</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;Nothing&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">comb</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> 
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;identity&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> 
                            <span class="n">keys</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">opp_class</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">opp_mod</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span>
                                <span class="n">comb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">comb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">comb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">comb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">comb</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">combinations</span><span class="p">[</span><span class="n">comb</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">values</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    {&#39;MS1 both +/-, MS2 +&#39;: 7, &#39;Only MS2 -&#39;: 0, &#39;MS1 - and MS2 +&#39;: 2,</span>
<span class="sd">     &#39;MS1 both +/-, MS2 -&#39;: 1, &#39;MS1 +, MS2 both +/-&#39;: 0, &#39;+/- Total&#39;: 46,</span>
<span class="sd">     &#39;MS2 both +/-, no MS1&#39;: 0, &#39;Non PC&#39;: 79, &#39;Nothing&#39;: 221,</span>
<span class="sd">     &#39;MS1 &amp; MS2 only +&#39;: 12, &#39;MS1 &amp; MS2 both +/-&#39;: 8,</span>
<span class="sd">     &#39;MS1 &amp; MS2 only -&#39;: 0, &#39;Only + Total&#39;: 298, &#39;Only MS1 -&#39;: 9,</span>
<span class="sd">     &#39;MS1 + and MS2 -&#39;: 0, &#39;MS1 both +/-, no MS2&#39;: 17,</span>
<span class="sd">     &#39;MS1 -, MS2 both +/-&#39;: 1, &#39;Total&#39;: 448, &#39;Only - Total&#39;: 104,</span>
<span class="sd">     &#39;Only MS1 +&#39;: 68, &#39;Only MS2 +&#39;: 23}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">plot_identification_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idlevels</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">hg</span><span class="p">,</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-classes.pdf&#39;</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">hg</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">idlevels</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#97BE73&#39;</span><span class="p">,</span> <span class="s1">&#39;#49969A&#39;</span><span class="p">,</span> <span class="s1">&#39;#996A44&#39;</span><span class="p">,</span> <span class="s1">&#39;#FDD73F&#39;</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MS1 &amp; MS2 both +/-&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;MS1 &amp; MS2 only +&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1 &amp; MS2 only -&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MS1 both +/-, no MS2&#39;</span><span class="p">,</span> <span class="s1">&#39;MS2 both +/-, no MS1&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;MS1 + and MS2 -&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1 - and MS2 +&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Only MS1 +&#39;</span><span class="p">,</span> <span class="s1">&#39;Only MS1 -&#39;</span><span class="p">,</span> <span class="s1">&#39;Only MS2 +&#39;</span><span class="p">,</span> <span class="s1">&#39;Only MS2 -&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;MS1 both +/-, MS2 +&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1 both +/-, MS2 -&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MS1 +, MS2 both +/-&#39;</span><span class="p">,</span> <span class="s1">&#39;MS1 -, MS2 both +/-&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;Non </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">hg</span><span class="p">,</span>
            <span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="s1">&#39;+/- Total&#39;</span><span class="p">,</span> <span class="s1">&#39;Only + Total&#39;</span><span class="p">,</span> <span class="s1">&#39;Only - Total&#39;</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">cvs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_pdf</span><span class="o">.</span><span class="n">FigureCanvasPdf</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">idlevels</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> 
                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">idlevels</span><span class="p">[</span><span class="n">lab</span><span class="p">][</span><span class="n">l</span><span class="p">],</span> <span class="n">labels</span><span class="p">),</span> 
                <span class="n">w</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">lhandles</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ilab</span><span class="p">:</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">ilab</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ilab</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">idlevels</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        
        <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span> <span class="o">=</span> <span class="n">lhandles</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Identification levels&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of features&#39;</span><span class="p">)</span>
        <span class="n">cvs</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">cvs</span><span class="o">.</span><span class="n">print_figure</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">find_known_binders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;PA&#39;</span><span class="p">,</span> <span class="s1">&#39;PC&#39;</span><span class="p">,</span> <span class="s1">&#39;PE&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;PS&#39;</span><span class="p">,</span> <span class="s1">&#39;PI&#39;</span><span class="p">,</span> <span class="s1">&#39;SM&#39;</span><span class="p">,</span> <span class="s1">&#39;Cer&#39;</span><span class="p">])</span>
        <span class="n">having_binders</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">classes</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">having_known_binders</span> <span class="o">=</span> <span class="n">having_binders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">known_binders_detected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">having_known_binders</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">is_known_binder</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">]:</span>
                        <span class="n">is_known_binder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">binders</span> <span class="o">=</span> \
                            <span class="nb">set</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                        <span class="n">_hg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="nb">filter</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">_hg</span><span class="p">:</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
                                                <span class="k">lambda</span> <span class="n">ms2is</span><span class="p">:</span>
                                                    <span class="n">ms2is</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                <span class="n">_hg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="p">)),</span>
                                        <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="n">is_known_binder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binders</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">])))</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;known_binder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">is_known_binder</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">is_known_binder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">known_binders_detected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
    
<div class="viewcode-block" id="Screening.mz_report"><a class="viewcode-back" href="../../index.html#emese.main.Screening.mz_report">[docs]</a>    <span class="k">def</span> <span class="nf">mz_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks up an m/z value and prints a report about the closest one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_alll</span><span class="p">(</span><span class="s1">&#39;mz&#39;</span><span class="p">)</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ui</span> <span class="k">if</span> <span class="n">ui</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">ui</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span> <span class="o">&lt;</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">oi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ifracs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction_indices</span><span class="p">(</span><span class="n">protein</span><span class="p">)),</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            
            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: Looking up </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> </span><span class="si">%s</span><span class="s1">8</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- The closest m/z found is </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Current index is </span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Original index is </span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- MS1 headgroups identified: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- MS2 headgroups identified: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- MS1 fatty acids identified: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- MS2 fatty acids identified: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Headgroups based on fatty acids: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Combined identity: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> </span><span class="si">%s</span><span class="s1">8</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- RT range: </span><span class="si">%.02f</span><span class="s1">--</span><span class="si">%.02f</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Peak size: </span><span class="si">%.02f</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Avg. area: </span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Protein containing fractions intensities:</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Control fractions intensities:</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
             <span class="n">mz</span><span class="p">,</span>
             <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
             <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
             <span class="n">i</span><span class="p">,</span>
             <span class="n">oi</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])))</span> \
                <span class="k">if</span> <span class="s1">&#39;ms1hg&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])))</span> \
                <span class="k">if</span> <span class="s1">&#39;ms2hg&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="ow">and</span> \
                    <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="nb">type</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">set</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">hgfa</span><span class="p">:</span> 
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hgfa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hgfa</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span> 
                    <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;ms1fa&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]))</span> \
                <span class="k">if</span> <span class="s1">&#39;ms2fa&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="ow">and</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fa&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;hgfa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]))</span> \
                <span class="k">if</span> <span class="s1">&#39;hgfa&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]))</span> \
                <span class="k">if</span> <span class="s1">&#39;combined_hg&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                 <span class="n">ifracs</span><span class="p">))),</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                          <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ifracs</span><span class="p">))),</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="n">fr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="ow">not</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                 <span class="n">ifracs</span><span class="p">))),</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;fe&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
                          <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fr</span><span class="p">:</span> <span class="ow">not</span> <span class="n">fr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ifracs</span><span class="p">))),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>
    
    <span class="k">def</span> <span class="nf">protein_name_upper2mixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">):</span>
        <span class="n">protein_original</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">protein_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">protein_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">protein</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">protein_name</span><span class="p">]:</span>
                        <span class="n">protein_original</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">protein_name</span>
        <span class="k">return</span> <span class="n">protein_original</span>
    
    <span class="k">def</span> <span class="nf">mz_report_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mz</span><span class="p">):</span>
        <span class="n">protein</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_name_upper2mixed</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
        <span class="n">protein</span> <span class="o">=</span> <span class="n">protein</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span>
        <span class="n">du</span> <span class="o">=</span> <span class="mf">999.0</span> <span class="k">if</span> <span class="n">ui</span> <span class="o">==</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">ui</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="mf">999.0</span> <span class="k">if</span> <span class="n">ui</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ui</span> <span class="k">if</span> <span class="n">du</span> <span class="o">&lt;</span> <span class="n">dl</span> <span class="k">else</span> <span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: Looking up </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- The closest m/z found is </span><span class="si">%.08f</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Original index is </span><span class="si">%u</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Retention time range is </span><span class="si">%.02f</span><span class="s1">--</span><span class="si">%.02f</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Protein containing fractions intensities:</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Control fractions intensities:</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Peak size:</span><span class="se">\t</span><span class="si">%.02f</span><span class="se">\t</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Avg. area:</span><span class="se">\t</span><span class="si">%u</span><span class="se">\t</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Quality:</span><span class="se">\t</span><span class="si">%.02f</span><span class="se">\t</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> -- Charge:</span><span class="se">\t</span><span class="si">%u</span><span class="se">\t</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span>
                <span class="n">mz</span><span class="p">,</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:])),</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ctr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:])),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;are&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qly&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;crg&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_database_details_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lip</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">lip</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
            <span class="s1">&#39;⚫ </span><span class="si">%s</span><span class="se">\t</span><span class="si">%.04f</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="n">lip</span>
        <span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_fragment_details_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms2r</span><span class="p">,</span> <span class="n">ms2files</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">fractions</span> <span class="o">=</span> <span class="p">{</span><span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;A09&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;A10&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;A11&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;A12&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;B01&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">ms2r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sort</span> <span class="o">=</span> <span class="n">ms2r</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ms2r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
            <span class="s1">&#39;⚫ </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%.02f</span><span class="s1">)</span><span class="se">\n</span><span class="s1">    @ file: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">    @ scan no. </span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">ms2r</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ms2r</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                    <span class="n">ms2files</span><span class="p">[</span><span class="n">fractions</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ms2r</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">])]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:],</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">ms2r</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">])),</span>
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">ms2r</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
                <span class="n">sort</span>
            <span class="p">)</span>
        <span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_features_table_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">oi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fits_profile</span><span class="p">,</span> <span class="n">drift</span><span class="p">):</span>
        <span class="n">tablecell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tableccell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span>\
            <span class="s1">&#39; onclick=&quot;showTooltip(event);&quot;&gt;&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">original_mz</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">drift</span>
        <span class="c1"># m/z</span>
        <span class="n">marco</span> <span class="o">=</span> <span class="s1">&#39;marco&#39;</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;marco&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">denes</span> <span class="o">=</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">aaa_threshold</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
                <span class="p">))</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">5.0</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">(</span>   <span class="s1">&#39;both&#39;</span> \
                <span class="k">if</span> <span class="n">marco</span> <span class="ow">and</span> <span class="n">denes</span> \
                <span class="k">else</span> <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">denes</span> \
                <span class="k">else</span> <span class="s1">&#39;negative&#39;</span> <span class="k">if</span> <span class="n">marco</span> \
                <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;m/z measured; </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> mode; raw: </span><span class="si">%.07f</span><span class="s1">, &#39;</span>\
                <span class="s1">&#39;recalibrated: </span><span class="si">%.07f</span><span class="s1">; original index: </span><span class="si">%u</span><span class="s1">; </span><span class="si">%s%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span>
                    <span class="n">protein</span><span class="p">,</span>
                    <span class="s1">&#39;negative&#39;</span> <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span> <span class="k">else</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span>
                    <span class="n">original_mz</span><span class="p">,</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">oi</span><span class="p">,</span>
                    <span class="s1">&#39;This feature has </span><span class="si">%s</span><span class="s1"> intensity (</span><span class="si">%u</span><span class="s1">) than&#39;</span>\
                        <span class="s1">&#39; the threshold in </span><span class="si">%s</span><span class="s1"> mode (</span><span class="si">%u</span><span class="s1">), &#39;</span> <span class="o">%</span> \
                        <span class="p">(</span>
                            <span class="s1">&#39;larger&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">aaa_threshold</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">aaa_threshold</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span>
                        <span class="p">),</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> MS2 confirmed identification.&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="s1">&#39;but&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aaa_threshold</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> \
                            <span class="k">else</span> <span class="s1">&#39;and&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;has&#39;</span> \
                            <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> \
                            <span class="k">else</span> <span class="s1">&#39;does not have&#39;</span>
                        <span class="p">),</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">n Marco</span><span class="se">\&#39;</span><span class="s1">s standards.&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="s1">&#39;I&#39;</span> <span class="k">if</span> <span class="n">marco</span> <span class="k">else</span> <span class="s1">&#39;Not i&#39;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1"> (</span><span class="si">%.04f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">original_mz</span><span class="p">)))</span>
        <span class="c1"># RT</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Retention time range (mean): </span><span class="si">%.02f</span><span class="s1">-</span><span class="si">%.02f</span><span class="s1"> (</span><span class="si">%.02f</span><span class="s1">)&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,])),</span>
                <span class="s1">&#39;</span><span class="si">%.02f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,])</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># intensity</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s1">&#39;nothing&#39;</span> \
                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">aaa_threshold</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> \
                    <span class="k">else</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Average intensity: </span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tableccell</span> <span class="o">%</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;nothing clickable&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_database_details_list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]),</span>
                <span class="s1">&#39;see DB records&#39;</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                        <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                    <span class="k">else</span> \
            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Lookup of this m/z resulted no records&#39;</span><span class="p">,</span>
                <span class="s1">&#39;No DB records&#39;</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;Possible headgroups based on database records&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])))</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">((</span><span class="s1">&#39;nothing ms2cell&quot; ms2spectra=&quot;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">html_table_b64</span><span class="p">(),</span>
                    <span class="s1">&#39;Click to open MS2 spectra in pop-up viewer&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;see MS2 frags.&#39;</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2r&#39;</span><span class="p">]</span> <span class="k">else</span> \
            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;No MS2 results for this feature&#39;</span><span class="p">,</span> <span class="s1">&#39;No MS2&#39;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;Possible MS2 headgroups based on fragmets lookup&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]))</span> \
                <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;MS2 headroups and fatty acids identified based on &#39;</span>\
                <span class="s1">&#39;MS1 and MS2 new rule sets.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mod</span><span class="p">][</span><span class="s1">&#39;ms2f&#39;</span><span class="p">]</span> \
                <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mod</span><span class="p">][</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
        <span class="p">))</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Possible fatty acids based on database records&#39;</span><span class="p">,</span>
            <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">hgfa</span><span class="p">:</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hgfa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hgfa</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
                <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span>
            <span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Fatty acids identified in MS2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]))</span> \
                <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fa&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Combined identity (MS1, MS2, fatty acids)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]))</span> \
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;Peaksize = </span><span class="si">%.02f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
            <span class="s1">&#39;Peaksize &gt; 2.0--5.0: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim05&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
            <span class="s1">&#39;Peaksize &gt; 2.0--10.0: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim10&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
            <span class="s1">&#39;Peaksize &gt; 5.0--10.0: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim510&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
            <span class="p">(</span><span class="s1">&#39;nothing clickable&#39;</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span>
                <span class="s1">&#39;!&#39;</span> <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim05&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim10&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> \
                    <span class="ow">not</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;pslim510&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Only one protein containing fraction, &#39;</span>\
                    <span class="s1">&#39;could not calculate peak ratio.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--&#39;</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="n">fits_profile</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> protein profile. Peak size ratio score: </span><span class="si">%.04f</span><span class="s1">. &#39;</span>\
                <span class="s1">&#39;Peak ratio</span><span class="si">%s</span><span class="s1"> in expected range.&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="s1">&#39;Fits&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="n">fits_profile</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Does not fit&#39;</span><span class="p">,</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39; not&#39;</span><span class="p">),</span>
                <span class="s1">&#39;Yes</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="n">fits_profile</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> \
                    <span class="k">else</span> <span class="s1">&#39;No</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">features_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fits_profile</span> <span class="o">=</span> <span class="s1">&#39;prs1&#39;</span><span class="p">):</span>
        
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">),</span>
                                <span class="s1">&#39;Generating HTML tables&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+m/z&#39;</span><span class="p">,</span> <span class="s1">&#39;RT&#39;</span><span class="p">,</span> <span class="s1">&#39;Int&#39;</span><span class="p">,</span> <span class="s1">&#39;+Database&#39;</span><span class="p">,</span> <span class="s1">&#39;+MS1 HGs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;+MS2 frags&#39;</span><span class="p">,</span> <span class="s1">&#39;+MS2 HGs&#39;</span><span class="p">,</span> <span class="s1">&#39;+ID&#39;</span><span class="p">,</span>
            <span class="s1">&#39;+MS1 FAs&#39;</span><span class="p">,</span> <span class="s1">&#39;+MS2 FAs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;+MS1&amp;2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;+Psize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;+Fits protein&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-m/z&#39;</span><span class="p">,</span> <span class="s1">&#39;RT&#39;</span><span class="p">,</span> <span class="s1">&#39;Int&#39;</span><span class="p">,</span> <span class="s1">&#39;-Database&#39;</span><span class="p">,</span> <span class="s1">&#39;-MS1 HGs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-MS2 frags&#39;</span><span class="p">,</span> <span class="s1">&#39;-MS2 HGs&#39;</span><span class="p">,</span> <span class="s1">&#39;-ID&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-MS1 FAs&#39;</span><span class="p">,</span> <span class="s1">&#39;-MS2 FAs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-MS1&amp;2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-Psize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-Fits protein&#39;</span><span class="p">]</span>
        
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;results_</span><span class="si">%s</span><span class="s1">_identities_details&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> \
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">filename</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablehcell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;th&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablecell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        
        <span class="c1"># navigation html</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">navigation</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.html&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Identification details of all features&#39;</span>
        <span class="n">navhtml</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">navcnum</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">navrnum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span> <span class="o">/</span> <span class="n">navcnum</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ltps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">navrnum</span><span class="p">):</span>
            <span class="n">thisRow</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">navcnum</span><span class="p">):</span>
                <span class="n">thisRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> \
                    <span class="p">((</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;See identifications for all features of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">proteins</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="n">navrnum</span> <span class="o">+</span> <span class="n">i</span><span class="p">]),</span>
                    <span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.html&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> 
                        <span class="n">proteins</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="n">navrnum</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">proteins</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="n">navrnum</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span>
                    <span class="p">)</span> <span class="k">if</span> <span class="n">j</span><span class="o">*</span><span class="n">navrnum</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="n">navhtml</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">thisRow</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">navigation</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html_table_template</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">navhtml</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: identities for all features, detailed&#39;</span> <span class="o">%</span> <span class="n">protein</span>
            <span class="n">thisFilename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.html&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">protein</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">hrow</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">coln</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">:</span>
                <span class="n">hrow</span> <span class="o">+=</span> <span class="n">tablehcell</span> <span class="o">%</span> <span class="n">coln</span>
            <span class="n">hrow</span> <span class="o">=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="n">hrow</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">hrow</span>
            <span class="n">visited</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([]),</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([])}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort_alll</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">opp_mod</span> <span class="o">=</span> <span class="s1">&#39;neg&#39;</span> <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;pos&#39;</span>
                <span class="n">drift</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span> \
                    <span class="ow">or</span> <span class="s1">&#39;recalibrated&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span> \
                    <span class="ow">or</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span> \
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppm2ratio</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mod</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="p">))</span>
                <span class="n">opp_drift</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span> \
                    <span class="ow">or</span> <span class="s1">&#39;recalibrated&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span> \
                    <span class="ow">or</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span> \
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppm2ratio</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">opp_mod</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">[</span><span class="n">mod</span><span class="p">]:</span>
                        <span class="n">thisRow</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                        <span class="n">visited</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oi</span><span class="p">)</span>
                        <span class="n">thisRow</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_features_table_row</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span>
                                <span class="n">oi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fits_profile</span><span class="p">,</span> <span class="n">drift</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">thisRow</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                                    <span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                    <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                                <span class="p">)]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">opp_oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="n">opp_row</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="n">visited</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opp_oi</span><span class="p">)</span>
                                    <span class="n">opp_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">==</span> \
                                        <span class="n">opp_oi</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">thisRow</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_features_table_row</span><span class="p">(</span>
                                            <span class="n">protein</span><span class="p">,</span> <span class="n">opp_mod</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">opp_mod</span><span class="p">],</span>
                                            <span class="n">opp_oi</span><span class="p">,</span> <span class="n">opp_i</span><span class="p">,</span> <span class="n">fits_profile</span><span class="p">,</span>
                                            <span class="n">opp_drift</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">opp_mod</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">pos_row</span> <span class="ow">in</span> <span class="n">thisRow</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">neg_row</span> <span class="ow">in</span> <span class="n">thisRow</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]:</span>
                                <span class="c1">#try:</span>
                                <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pos_row</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">neg_row</span><span class="p">)))</span>
                                <span class="c1">#except TypeError:</span>
                                    <span class="c1">#print(pos_row)</span>
                                    <span class="c1">#print(neg_row)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">thisFilename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">html_table_template</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">combined_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;headgroups_combined.html&#39;</span><span class="p">,</span>
        <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">,</span> <span class="n">identity</span> <span class="o">=</span> <span class="s1">&#39;combined_hg&#39;</span><span class="p">):</span>
        <span class="n">tablecell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tableccell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;td class=&quot;</span><span class="si">%s</span><span class="s1">&quot; title=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span>\
            <span class="s1">&#39; onclick=&quot;showTooltip(event);&quot;&gt;&#39;</span>\
            <span class="s1">&#39;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablerow</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t\t</span><span class="s1">&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tablehcell</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;th&gt;</span><span class="se">\n\t\t\t\t</span><span class="si">%s</span><span class="se">\n\t\t\t</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Headgroups, combined identification&#39;</span>
        <span class="n">sort_alll</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="s1">&#39;mz&#39;</span><span class="p">)</span>
        <span class="n">all_hgs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="n">include</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">all_hgs</span> <span class="o">=</span> <span class="n">all_hgs</span> <span class="o">|</span> <span class="n">tbl</span><span class="p">[</span><span class="n">identity</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span>
        <span class="n">all_hgs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_hgs</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
                <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="p">[]),</span> 
                    <span class="n">all_hgs</span>
                <span class="p">))),</span>
                <span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">))</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="n">include</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="n">identity</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                            <span class="n">adds</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uniqList</span><span class="p">(</span>\
                                <span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span>\
                                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][:,</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">hg</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span>\
                                <span class="p">])</span>\
                            <span class="p">))</span>
                            <span class="n">fa</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]))</span> \
                                <span class="k">if</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;combined_fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="k">else</span> \
                                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2fas&#39;</span><span class="p">]</span> <span class="k">else</span> \
                                <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]))</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">adds</span><span class="p">,</span> <span class="n">fa</span><span class="p">]</span>
                            <span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
            <span class="n">tablehcell</span> <span class="o">%</span> <span class="n">hg</span><span class="p">,</span>
            <span class="n">all_hgs</span>
        <span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tablehcell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">hdr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">thisRow</span> <span class="o">=</span> <span class="p">[</span><span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;rowname&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">protein</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">all_hgs</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="fm">__len__</span><span class="p">():</span>
                    <span class="n">thisRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tablecell</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">thisRow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tableccell</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="s1">&#39;positive clickable&#39;</span> \
                            <span class="k">if</span> <span class="s1">&#39;neg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span> <span class="k">else</span> \
                        <span class="s1">&#39;negative clickable&#39;</span> \
                            <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span> <span class="k">else</span> \
                        <span class="s1">&#39;both clickable&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="s1">&#39;⚫ </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;     &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">),</span>
                            <span class="n">c</span>
                        <span class="p">))),</span>
                        <span class="s1">&#39;&#39;</span>
                    <span class="p">))</span>
            <span class="n">table</span> <span class="o">+=</span> <span class="n">tablerow</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">thisRow</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_table_template</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">i2oi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> \
            <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">]))</span> \
            <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">oi2i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">oi</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">oi</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">ppratios_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;protein_peak_ratios.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;Protein&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Fractions&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Lower&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Upper&#39;</span>
            <span class="p">]))</span>
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fracs</span><span class="p">,</span> <span class="n">prs</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">pr</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                        <span class="n">protein</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fracs</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">prs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">prs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">]))</span>
    
    <span class="k">def</span> <span class="nf">pprofs_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">original</span> <span class="o">=</span> <span class="s1">&#39;_original&#39;</span> <span class="k">if</span> <span class="n">original</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">renondigit</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\d]+&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pptable_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;Protein&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Fraction&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Cc_</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;Cc_</span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">]))</span>
            <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">prof</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">(</span><span class="s1">&#39;pprofs</span><span class="si">%s</span><span class="s1">L&#39;</span><span class="o">%</span><span class="n">original</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">frac</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">renondigit</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)))):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                        <span class="n">protein</span><span class="p">,</span>
                        <span class="n">frac</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pprofs</span><span class="si">%s</span><span class="s1">L&#39;</span><span class="o">%</span><span class="n">original</span><span class="p">)[</span><span class="n">protein</span><span class="p">][</span><span class="n">frac</span><span class="p">],</span>
                        <span class="s1">&#39;</span><span class="si">%.04f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pprofs</span><span class="si">%s</span><span class="s1">U&#39;</span><span class="o">%</span><span class="n">original</span><span class="p">)[</span><span class="n">protein</span><span class="p">][</span><span class="n">frac</span><span class="p">]</span>
                    <span class="p">]))</span>
    
    <span class="k">def</span> <span class="nf">ms2identities_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> \
            <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">protein</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="nb">dict</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">_tbl</span><span class="p">:</span>
                                    <span class="p">(</span><span class="n">_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="nb">filter</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                                            <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="nb">map</span><span class="p">(</span>
                                            <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span>
                                                <span class="kc">None</span> \
                                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">identities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> \
                                                <span class="k">else</span> <span class="n">reduce</span><span class="p">(</span>
                                                    <span class="k">lambda</span> <span class="n">ids</span><span class="p">:</span>
                                                        <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">f</span><span class="o">.</span><span class="n">identities</span>
                                                <span class="p">),</span>
                                            <span class="n">_tbl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ms2f&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                        <span class="p">),</span>
                                    <span class="p">)</span>
                                    <span class="p">),</span>
                                <span class="n">iteritems</span><span class="p">(</span><span class="n">protein</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="n">result_str</span> <span class="o">=</span> \
            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
                        <span class="s1">&#39;Protein: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">protein</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">res</span><span class="p">:</span>
                                        <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Mode: </span><span class="si">%s</span><span class="se">\n\t</span><span class="s1">   </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">   &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                <span class="nb">map</span><span class="p">(</span>
                                                    <span class="k">lambda</span> <span class="n">hg</span><span class="p">:</span>
                                                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (detected </span><span class="si">%u</span><span class="s1"> &#39;</span>\
                                                            <span class="s1">&#39;times)&#39;</span> <span class="o">%</span> \
                                                                <span class="p">(</span><span class="n">hg</span><span class="p">,</span>
                                                                <span class="n">collections</span><span class="o">.</span>\
                                                                <span class="n">Counter</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>\
                                                                    <span class="p">[</span><span class="n">hg</span><span class="p">]</span>
                                                                <span class="p">),</span>
                                                    <span class="n">uniqList</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                                <span class="p">),</span>
                                            <span class="p">)</span>
                                        <span class="p">),</span>
                                    <span class="n">iteritems</span><span class="p">(</span><span class="n">protein</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="n">iteritems</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result_str</span>
    
    <span class="k">def</span> <span class="nf">bindprop_latex_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">only_with_ms_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;binding_properties_table.tex&#39;</span><span class="p">):</span>
        <span class="n">allhgs</span> <span class="o">=</span> \
        <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="n">reduce</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">llips</span><span class="p">:</span>
                        <span class="n">llips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">llips</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">lips</span><span class="p">:</span>
                            <span class="n">lips</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="nb">filter</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">lips</span><span class="p">:</span>
                                <span class="ow">not</span> <span class="n">only_with_ms_data</span> <span class="ow">or</span> <span class="n">lips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">,</span>
                            <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bindprop</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;\begin</span><span class="si">{tabular}</span><span class="s2">{l</span><span class="si">%s</span><span class="s2">}</span>
<span class="s2">            &amp; </span><span class="si">%s</span><span class="s2"> \\</span>
<span class="s2">            </span><span class="si">%s</span><span class="s2"> \\</span>
<span class="s2">        \end</span><span class="si">{tabular}</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">colalign</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">allhgs</span><span class="p">)</span>
        <span class="n">rownames</span> <span class="o">=</span> \
        <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
                    <span class="ow">not</span> <span class="n">only_with_ms_data</span> <span class="ow">or</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_upper</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bindprop</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">lip</span><span class="p">:</span>
                    <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">rot{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">lip</span><span class="p">,</span>
                <span class="n">allhgs</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">cells</span> <span class="o">=</span> \
        <span class="s1">&#39;</span><span class="se">\\\\\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">protein</span><span class="p">:</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &amp; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">protein</span><span class="p">,</span>
                        <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">lip</span><span class="p">:</span>
                                    <span class="sa">r</span><span class="s1">&#39;\cellcolor</span><span class="si">{emblgreen}</span><span class="s1">&#39;</span> \
                                    <span class="k">if</span> <span class="n">lip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindprop</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> \
                                    <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">allhgs</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                <span class="n">rownames</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tbl</span> <span class="o">%</span> <span class="p">(</span><span class="n">colalign</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">cells</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">hg_fa_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;headgroups_fattya.tex&#39;</span><span class="p">,</span> <span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;cl70pct&#39;</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{itemize}</span><span class="s1">&#39;</span>
        <span class="n">allhgs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">ms2results</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">hg</span><span class="p">,</span> <span class="n">ms2result</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ms2results</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">ms2result</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">allhgs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
        <span class="n">allhgs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">allhgs</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="n">thisProtein</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="se">\\</span><span class="s1">item </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">protein</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">allhgs</span><span class="p">:</span>
                <span class="n">thisRow</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2i2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">thisRow</span> <span class="o">=</span> <span class="n">thisRow</span> <span class="o">|</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;fattya&#39;</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;fattya&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">hg</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]:</span>
                                        <span class="n">thisRow</span> <span class="o">=</span> <span class="n">thisRow</span> <span class="o">|</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1fa&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">][</span><span class="n">hg</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thisRow</span><span class="p">):</span>
                    <span class="n">thisRow</span> <span class="o">=</span> <span class="s1">&#39;    </span><span class="se">\\</span><span class="s1">item </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">thisRow</span><span class="p">))))</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisRow</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                <span class="n">thisProtein</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  </span><span class="se">\\</span><span class="s1">begin</span><span class="si">{itemize}</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">  </span><span class="se">\\</span><span class="s1">end</span><span class="si">{itemize}</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">thisProtein</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">end</span><span class="si">{itemize}</span><span class="s1">&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Screening.colw_scale"><a class="viewcode-back" href="../../index.html#emese.main.Screening.colw_scale">[docs]</a>    <span class="k">def</span> <span class="nf">colw_scale</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scales column widths for xlsxwriter output.</span>
<span class="sd">        Below are empirical values to adjust the column widths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mf">0.1705710377055909</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.24899187310525259</span></div>
    
<div class="viewcode-block" id="Screening.add_sheet"><a class="viewcode-back" href="../../index.html#emese.main.Screening.add_sheet">[docs]</a>    <span class="k">def</span> <span class="nf">add_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xls</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">colws</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a table to xls worksheet, with formatting.</span>
<span class="sd">        </span>
<span class="sd">        :param xls: xlsxwriter workbook</span>
<span class="sd">        :param list tbl: table as list of lists</span>
<span class="sd">        :param str name: worksheet name</span>
<span class="sd">        :param list colws: column widths, list of floats</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="n">xls</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">plain</span> <span class="o">=</span> <span class="n">xls</span><span class="o">.</span><span class="n">add_format</span><span class="p">({})</span>
        <span class="n">bold</span> <span class="o">=</span> <span class="n">xls</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="c1">#&#39;rotation&#39;: 90</span>
                                <span class="p">})</span>
        <span class="n">green</span> <span class="o">=</span> <span class="n">xls</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#A9C98B&#39;</span><span class="p">})</span>
        <span class="c1">#sheet.set_row(row = 0, height = 115.0)</span>
        <span class="n">sheet</span><span class="o">.</span><span class="n">freeze_panes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">bold</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                        <span class="n">style</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">content</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">style</span> <span class="o">=</span> <span class="n">plain</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">:: Could not write row to xlsx:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">coln</span><span class="p">,</span> <span class="n">colw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">colws</span><span class="p">):</span>
                <span class="n">sheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">coln</span><span class="p">,</span> <span class="n">coln</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colw_scale</span><span class="p">(</span><span class="n">colw</span><span class="p">))</span></div>
        <span class="c1">#sheet.set_row(row = 0, height = 115.0)</span>
    
    <span class="k">def</span> <span class="nf">std_layout_tables_xlsx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_deltart</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">one_table</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="n">proteins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">make_xls</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">xls</span><span class="p">):</span>
            <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_layout_table_all</span> <span class="k">if</span> <span class="n">protein</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="k">else</span> \
                     <span class="bp">self</span><span class="o">.</span><span class="n">std_layout_table</span>
            <span class="n">_argsp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">protein</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">_argsn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">protein</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">]</span>
            <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;colws&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;check_deltart&#39;</span><span class="p">:</span> <span class="n">check_deltart</span><span class="p">}</span>
            <span class="n">tbl</span><span class="p">,</span> <span class="n">colw</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">_argsp</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="n">xls</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_positive&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">,</span> <span class="n">colw</span><span class="p">)</span>
            <span class="n">tbl</span><span class="p">,</span> <span class="n">colw</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">_argsn</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="n">xls</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_negative&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">,</span> <span class="n">colw</span><span class="p">)</span>
            <span class="n">_kwargs</span><span class="p">[</span><span class="s1">&#39;only_best&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tbl</span><span class="p">,</span> <span class="n">colw</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">_argsp</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="n">xls</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_positive_best&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">,</span> <span class="n">colw</span><span class="p">)</span>
            <span class="n">tbl</span><span class="p">,</span> <span class="n">colw</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">_argsn</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="n">xls</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_negative_best&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">,</span> <span class="n">colw</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">proteins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">xlsdir</span> <span class="o">=</span> <span class="s1">&#39;top_features&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xlsdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">xlsdir</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">xlsdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xlsdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_original_average_area</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort_alll</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort_alll</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">,</span> <span class="n">asc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">one_table</span><span class="p">:</span>
            
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: Exporting xlsx table...&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            
            <span class="n">xlsname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xlsdir</span><span class="p">,</span> <span class="s1">&#39;all_top_features.xlsx&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xlsname</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">xlsname</span><span class="p">)</span>
            
            <span class="n">xls</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">xlsname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;constant_memory&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                <span class="s1">&#39;nan_inf_to_errors&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="n">make_xls</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">xls</span><span class="p">)</span>
            <span class="n">xls</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; Ready.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">),</span>
                                        <span class="s1">&#39;Exporting xlsx tables&#39;</span><span class="p">,</span>
                                        <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">proteins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proteins</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">xlsname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xlsdir</span><span class="p">,</span>
                                       <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_top_features.xlsx&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">)</span>
                <span class="n">xls</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">xlsname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;constant_memory&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                    <span class="s1">&#39;nan_inf_to_errors&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                <span class="n">make_xls</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">xls</span><span class="p">)</span>
                <span class="n">xls</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">std_layout_table_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="n">allrows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_layout_table</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;colws&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;colws&#39;</span><span class="p">]:</span>
                <span class="n">colw</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">colw</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">]</span> <span class="o">+</span> <span class="n">colw</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Protein&#39;</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdr</span><span class="p">]</span>
            
            <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">allrows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        
        <span class="n">allrows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">allrows</span> <span class="o">=</span> <span class="n">hdr</span> <span class="o">+</span> <span class="n">allrows</span>
        
        <span class="k">if</span> <span class="s1">&#39;colws&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;colws&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">allrows</span><span class="p">,</span> <span class="n">colw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">allrows</span>
    
    <span class="k">def</span> <span class="nf">std_layout_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
                         <span class="n">only_best</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">colws</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">check_deltart</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Quality&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Significance&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;m/z&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Has MS2&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RT range&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RT mean&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RT (MS2 closest)&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;dRT&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Protein Ratio&#39;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;[M+H]+ Lipids&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;[M-H]- Lipids&#39;</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;[M+NH4]+ Lipids&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;[M+HCOO]- Lipids&#39;</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;[M+Na]+ Lipids&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;Nothing&#39;</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Avg. Area&#39;</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;m/z corrected&#39;</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;SwissLipids Identification&#39;</span><span class="p">,</span> <span class="mf">10.77</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Confirmed by MS2&#39;</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Comment&#39;</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MS2 precursor mass&#39;</span><span class="p">,</span> <span class="mf">1.86</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;1 MS2 Ion Mass (intensity)&#39;</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;1 MS2 Fragment (mass)&#39;</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;2 MS2 Ion Mass (intensity)&#39;</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;2 MS2 Fragment (mass)&#39;</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;3 MS2 Ion Mass (intensity)&#39;</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;3 MS2 Fragment (mass)&#39;</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;4 MS2 Ion Mass (intensity)&#39;</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;4 MS2 Fragment (mass)&#39;</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;5 MS2 Ion Mass (intensity)&#39;</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;5 MS2 Fragment (mass)&#39;</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MS2 File&#39;</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Scan num.&#39;</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MS2 All Fragments&#39;</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Protein Ratio OK&#39;</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Lipid Intensity Ratio&#39;</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Protein Ratio Limit </span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">2.12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Protein Ratio Limit </span><span class="si">%.03f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fr_offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">2.12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Protein Ratio from Fractions&#39;</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Protein Ratio Score&#39;</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Peaksize&#39;</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MS1 Headgroups (automatic identification)&#39;</span><span class="p">,</span> <span class="mf">1.48</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;MS2 Headgroups (automatic identification)&#39;</span><span class="p">,</span> <span class="mf">1.48</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Identity (automatically assigned)&#39;</span><span class="p">,</span> <span class="mf">3.62</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;[M+H]+ Lipids (LipidMaps)&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="s1">&#39;[M-H]- Lipids (LipidMaps)&#39;</span><span class="p">,</span> <span class="mf">3.31</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;[M+NH4]+ Lipids (LipidMaps)&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="s1">&#39;[M+HCOO]- Lipids (LipidMaps)&#39;</span><span class="p">,</span> <span class="mf">3.31</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;[M+Na]+ Lipids (LipidMaps)&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="s1">&#39;Nothing&#39;</span><span class="p">,</span> <span class="mf">3.31</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Present in all protein containing fractions&#39;</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="n">colw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hdr</span><span class="p">))</span>
        
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdr</span><span class="p">)))</span>
        
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
        <span class="n">drift</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span> \
                    <span class="ow">or</span> <span class="s1">&#39;recalibrated&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span> \
                    <span class="ow">or</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;recalibrated&#39;</span><span class="p">]</span> \
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppm2ratio</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proteins_drifts</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="p">))</span>
        
        <span class="k">def</span> <span class="nf">lipid_name</span><span class="p">(</span><span class="n">lip</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">lip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">name</span>
        
        <span class="k">def</span> <span class="nf">get_lipids</span><span class="p">(</span><span class="n">lips</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">lips</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">uniqList</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span>
                                <span class="n">lipid_name</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> \
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">marco_lipnames_from_db</span> <span class="k">else</span> \
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="s1">&#39;O-&#39;</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                               <span class="n">r</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> \
                                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                            <span class="nb">filter</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span>
                                    <span class="p">(</span>
                                        <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">marco_lipnames_from_db</span> <span class="ow">and</span> \
                                        <span class="n">r</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                                            <span class="ow">or</span> \
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_lipnames_from_db</span> <span class="ow">and</span> \
                                        <span class="p">(</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">db</span><span class="p">))</span>
                                    <span class="p">)</span> \
                                    <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">add</span><span class="p">,</span>
                                <span class="n">lips</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="n">min_ms2_mz</span> <span class="o">=</span> <span class="mf">70.0</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span> <span class="k">else</span> <span class="mf">135.0</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]):</span>
            
            <span class="n">ms2_best</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">best_scan</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">best_scan</span>
            
            <span class="n">ms2_rt</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span> \
                <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span>
            <span class="n">delta_rt</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span> \
                <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">deltart</span>
            <span class="n">lips1</span> <span class="o">=</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M+H]+&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M-H]-&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span>
            <span class="n">lips2</span> <span class="o">=</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M+NH4]+&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span>
            <span class="n">lips3</span> <span class="o">=</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M+Na]+&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            
            <span class="n">lips1l</span> <span class="o">=</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M+H]+&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M-H]-&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span>
            <span class="n">lips2l</span> <span class="o">=</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M+NH4]+&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span>
            <span class="n">lips3l</span> <span class="o">=</span> <span class="n">get_lipids</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;lip&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">],</span> <span class="s1">&#39;[M+Na]+&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> \
                <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            
            <span class="n">ms2_mz</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span> <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
            
            <span class="n">ms2i1</span><span class="p">,</span> <span class="n">ms2f1</span> <span class="o">=</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">get_by_rank</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_ms2_mz</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ms2i2</span><span class="p">,</span> <span class="n">ms2f2</span> <span class="o">=</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">get_by_rank</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">min_ms2_mz</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ms2i3</span><span class="p">,</span> <span class="n">ms2f3</span> <span class="o">=</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">get_by_rank</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_ms2_mz</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ms2i4</span><span class="p">,</span> <span class="n">ms2f4</span> <span class="o">=</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">get_by_rank</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_ms2_mz</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ms2i5</span><span class="p">,</span> <span class="n">ms2f5</span> <span class="o">=</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">get_by_rank</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_ms2_mz</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="n">ms2_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">ms2_file</span>
            
            <span class="n">ms2_scan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">scan_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">ms2_full</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">ms2_best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">_scans</span><span class="p">[</span><span class="n">ms2_best</span><span class="p">]</span><span class="o">.</span><span class="n">full_list_str</span><span class="p">()</span>
            
            <span class="n">mz_original</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">drift</span>
            
            <span class="n">ms2_style</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2_full</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">delta_rt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span>
            
            <span class="n">oi</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            
            <span class="n">aaa</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_original_average_area</span> <span class="k">else</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;aaa&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            
            <span class="n">good</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">5.0</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">aaa</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_threshold</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">deltart</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">abs</span><span class="p">,</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2f&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span><span class="o">.</span><span class="n">deltart</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">&lt;=</span> <span class="mf">1.0</span> <span class="ow">or</span> \
                        <span class="ow">not</span> <span class="n">check_deltart</span><span class="p">)))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;na&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            
            <span class="n">_good</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">5.0</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> \
                <span class="p">((</span><span class="n">aaa</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_threshold</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="p">[</span><span class="n">lips1</span><span class="p">,</span> <span class="n">lips2</span><span class="p">,</span> <span class="n">lips3</span><span class="p">,</span> <span class="n">lips1l</span><span class="p">,</span> <span class="n">lips2l</span><span class="p">,</span> <span class="n">lips3l</span><span class="p">]))))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">oi</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;na&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">only_best</span> <span class="ow">or</span> <span class="n">good</span><span class="p">:</span>
                
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;qua&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">mz_original</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">_good</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    
                    <span class="p">(</span><span class="s1">&#39;yes&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms2_full</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="s1">&#39;</span><span class="si">%.02f</span><span class="s1"> - </span><span class="si">%.02f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rtm&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="c1"># &#39;%u:%u&#39; % (int(tbl[&#39;rtm&#39;][i]) / 60, tbl[&#39;rtm&#39;][i] % 60),</span>
                    <span class="n">ms2_rt</span><span class="p">,</span>
                    <span class="n">delta_rt</span><span class="p">,</span>
                    <span class="s1">&#39;Inf&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">else</span> \
                        <span class="s1">&#39;NA&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> \
                            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">lips1</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">lips2</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips2</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">lips3</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips3</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">aaa</span><span class="p">,</span>
                    <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">aaa</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_threshold</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> \
                        <span class="k">else</span> <span class="s1">&#39;plain&#39;</span>
                    <span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> /// </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="s1">&#39;[M+H]+&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;[M-H]-&#39;</span><span class="p">,</span>
                        <span class="n">lips1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips1</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;[M+NH4]+&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;[M+HCOO]-&#39;</span><span class="p">,</span>
                        <span class="n">lips2</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips2</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span> <span class="k">else</span> <span class="s1">&#39; /// (</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="s1">&#39;[M+Na]+&#39;</span><span class="p">,</span> <span class="n">lips3</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips3</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;nothing&#39;</span><span class="p">))</span> \
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips1</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips2</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips3</span><span class="p">)</span> \
                            <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips1</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips2</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips3</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    <span class="c1"># 3 empty cols to be filled manually</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># Class</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># Confirmed by MS2</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># Comment</span>
                    <span class="p">(</span><span class="n">ms2_mz</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2i1</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2f1</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2i2</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2f2</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2i3</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2f3</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2i4</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2f4</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2i5</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2f5</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="p">(</span><span class="n">ms2_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2_scan</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">ms2_full</span><span class="p">,</span> <span class="n">ms2_style</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;NA&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                        <span class="s1">&#39;OK&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;NOT_OK&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;plain&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prr&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> \
                        <span class="k">else</span> <span class="s1">&#39;green&#39;</span>
                    <span class="p">),</span>
                    <span class="s1">&#39;NA&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> \
                        <span class="k">else</span> <span class="s1">&#39;Inf&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> \
                        <span class="k">else</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;iprf&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="s1">&#39;NA&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                        <span class="s1">&#39;Inf&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;NA&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> \
                        <span class="s1">&#39;Inf&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">ppratios</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;NA&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">],</span>
                    <span class="p">(</span><span class="s1">&#39;NA&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> \
                        <span class="k">else</span> <span class="s1">&#39;Inf&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> \
                        <span class="k">else</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="s1">&#39;plain&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_ratio</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> \
                        <span class="ow">or</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;prs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> \
                        <span class="k">else</span> <span class="s1">&#39;green&#39;</span>
                    <span class="p">),</span>
                    <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;green&#39;</span> \
                        <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;peaksize&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">5.0</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="k">else</span> \
                        <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms1hg&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]))),</span> <span class="s1">&#39;green&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">])</span> <span class="k">else</span> \
                        <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;ms2hg2&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">]))),</span> <span class="s1">&#39;green&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">oi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])</span> <span class="k">else</span> \
                        <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">][</span><span class="n">oi</span><span class="p">])),</span> <span class="s1">&#39;green&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">lips1l</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips1l</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">lips2l</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips2l</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">lips3l</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lips3l</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;plain&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;missing values&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;na&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;no missing values&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;plain&#39;</span> <span class="k">if</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;na&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
                <span class="p">])</span>
        <span class="k">if</span> <span class="n">colws</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">colw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rows</span>
    
    <span class="k">def</span> <span class="nf">std_layout_table_stripped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">only_best</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_layout_table</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">only_best</span> <span class="o">=</span> <span class="n">only_best</span><span class="p">)</span>
        <span class="n">tbl</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span>
                                    <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="k">else</span> <span class="n">c</span><span class="p">,</span>
                                <span class="n">l</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="n">tbl</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span>
    
    <span class="k">def</span> <span class="nf">marco_standards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">fname</span><span class="p">:</span>
                <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">tbl2mzs</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">,</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="n">tbl</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">def</span> <span class="nf">mzs2ois</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mzs</span><span class="p">):</span>
            <span class="n">ois</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mzs</span><span class="p">:</span>
                <span class="n">oi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz2oi</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mz</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">:: m/z not found: </span><span class="si">%.05f</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ois</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ois</span>
        <span class="k">def</span> <span class="nf">ois2attr</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ois</span><span class="p">):</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span>
            <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;marco&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                            <span class="n">i</span> <span class="ow">in</span> <span class="n">ois</span><span class="p">,</span>
                        <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">protein</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="n">pos_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">sheet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">neg_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">sheet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pos_mzs</span> <span class="o">=</span> <span class="n">tbl2mzs</span><span class="p">(</span><span class="n">pos_table</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">neg_mzs</span> <span class="o">=</span> <span class="n">tbl2mzs</span><span class="p">(</span><span class="n">neg_table</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">pos_ois</span> <span class="o">=</span> <span class="n">mzs2ois</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">pos_mzs</span><span class="p">)</span>
            <span class="n">neg_ois</span> <span class="o">=</span> <span class="n">mzs2ois</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="n">neg_mzs</span><span class="p">)</span>
            <span class="n">ois2attr</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">pos_ois</span><span class="p">)</span>
            <span class="n">ois2attr</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="n">neg_ois</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">read_marco_standards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">xlsfiles</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">fname</span><span class="p">:</span>
                <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">csvfiles</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">fname</span><span class="p">:</span>
                <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">xlsfiles</span><span class="p">:</span>
            <span class="n">protein</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">xls</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                                         <span class="n">read_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xls</span><span class="o">.</span><span class="n">worksheets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">mode</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">sheet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">sheet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">sheet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">csvfiles</span><span class="p">:</span>
            <span class="n">protein</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))),</span> <span class="n">f</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">marco_std_data</span> <span class="o">=</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">standards_crosscheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;crosscheck.log&#39;</span><span class="p">,</span> <span class="n">only_best</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="n">logf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">lookup_column</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">colname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span>
        
        <span class="k">def</span> <span class="nf">get_mmzs</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
            <span class="n">mzcol</span> <span class="o">=</span> <span class="n">lookup_column</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="s1">&#39;m.z&#39;</span><span class="p">)</span>
            <span class="n">mzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">mz</span><span class="p">:</span> <span class="n">mz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mzcol</span><span class="p">])),</span>
                            <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">))))</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mz</span><span class="p">:</span> <span class="n">mz</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span>
        
        <span class="k">def</span> <span class="nf">get_dmzs</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">))),</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mz</span><span class="p">:</span> <span class="n">mz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">))))</span>
        
        <span class="k">def</span> <span class="nf">mz_lookup</span><span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
            <span class="n">ui</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span>
            <span class="n">du</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dl</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">ui</span> <span class="o">&lt;</span> <span class="n">lst</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">lst</span><span class="p">[</span><span class="n">ui</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                    <span class="n">du</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">ui</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span>
            <span class="k">if</span> <span class="n">ui</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">lst</span><span class="p">[</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                    <span class="n">dl</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">lst</span><span class="p">[</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">du</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">du</span> <span class="o">&lt;</span> <span class="n">dl</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ui</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">du</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ui</span>
            <span class="k">elif</span> <span class="n">dl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">colname</span><span class="p">,</span> <span class="n">dcol</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span>
                    <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">dfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">):</span>
            <span class="n">mcol</span> <span class="o">=</span> <span class="n">lookup_column</span><span class="p">(</span><span class="n">mtbl</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">[ !! ] Column `</span><span class="si">%s</span><span class="s1">` could not be found at Marco&#39;</span> <span class="o">%</span> <span class="n">colname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">mcol</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">dcol</span><span class="p">])</span>
                <span class="n">mval</span> <span class="o">=</span> <span class="n">mfun</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">mcol</span><span class="p">])</span>
                <span class="n">dval</span> <span class="o">=</span> <span class="n">dfun</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">dcol</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">mval</span><span class="p">,</span> <span class="n">dval</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">mval</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">dval</span><span class="p">))</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">fun</span><span class="p">((</span><span class="n">mval</span><span class="p">,</span> <span class="n">dval</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">[ OK ] </span><span class="si">%s</span><span class="s1"> is the same at Marco &amp; Denes&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">[ !! ] </span><span class="si">%s</span><span class="s1"> mismatch: </span><span class="si">%s</span><span class="s1"> at Marco, </span><span class="si">%s</span><span class="s1"> at Denes&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mval</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dval</span><span class="p">)))</span>
        
        <span class="n">logf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marco_std_data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mtbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">log</span><span class="p">(</span><span class="s1">&#39;===[ </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> mode ]=======================================8&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span><span class="p">))</span>
                <span class="n">dtbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_layout_table_stripped</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">only_best</span> <span class="o">=</span> <span class="n">only_best</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                
                <span class="n">reccol</span> <span class="o">=</span> <span class="n">lookup_column</span><span class="p">(</span><span class="n">mtbl</span><span class="p">,</span> <span class="s1">&#39;m.z_corrected&#39;</span><span class="p">)</span>
                
                <span class="n">mmzs</span> <span class="o">=</span> <span class="n">get_mmzs</span><span class="p">(</span><span class="n">mtbl</span><span class="p">)</span>
                <span class="n">dmzs</span> <span class="o">=</span> <span class="n">get_dmzs</span><span class="p">(</span><span class="n">dtbl</span><span class="p">)</span>
                <span class="n">allmzs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mmzs</span><span class="p">):</span>
                    <span class="n">allmzs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mmzs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmzs</span><span class="p">):</span>
                    <span class="n">allmzs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dmzs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">allmzs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">allmzs</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">allmzs</span><span class="p">:</span>
                    <span class="n">di</span> <span class="o">=</span> <span class="n">mz_lookup</span><span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">dmzs</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmzs</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">mi</span> <span class="o">=</span> <span class="n">mz_lookup</span><span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">mmzs</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mmzs</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">mi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">[ !! ] m/z </span><span class="si">%.04f</span><span class="s1"> present only at Denes&#39;</span> <span class="o">%</span> <span class="n">mz</span><span class="p">)</span>
                        <span class="n">dii</span> <span class="o">=</span> <span class="n">dmzs</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># something to tell about features missing from Marco</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">di</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">[ !! ] m/z </span><span class="si">%.04f</span><span class="s1"> present only at Marco&#39;</span> <span class="o">%</span> <span class="n">mz</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">[ OK ] m/z </span><span class="si">%.04f</span><span class="s1"> present at both Marco &amp; Denes&#39;</span> <span class="o">%</span> <span class="n">mz</span><span class="p">)</span>
                    <span class="n">mii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mmzs</span><span class="p">[</span><span class="n">mi</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">dii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dmzs</span><span class="p">[</span><span class="n">di</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;m.z_corrected&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;recalibrated m/z&#39;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.005</span><span class="p">,</span>
                            <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    
                    <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;RT.mean&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;RT mean&#39;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;protein_peak_ratio&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
                            <span class="s1">&#39;Lipid intensity ratio&#39;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;NA&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                            <span class="n">dfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;NA&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;Avg..Area&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;Average area&#39;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                            <span class="n">dfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span>
                            <span class="s1">&#39;lipid_.M.H.&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;lipid_.M.H..&#39;</span><span class="p">,</span>
                            <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;[M+H]+ lipids&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;[M-H]- lipids&#39;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)))),</span>
                            <span class="n">dfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))))</span>
                        <span class="p">)</span>
                    
                    <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span>
                            <span class="s1">&#39;lipid_.M.NH4.&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;lipid_.M.COOH..&#39;</span><span class="p">,</span>
                            <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;[M+NH4]+ lipids&#39;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="s1">&#39;[M+HCOO]- lipids&#39;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)))),</span>
                            <span class="n">dfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))))</span>
                        <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">:</span>
                        <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span>
                            <span class="s1">&#39;lipid_.M.Na.&#39;</span><span class="p">,</span>
                            <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;[M+Na]+ lipids&#39;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)))),</span>
                            <span class="n">dfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))))</span>
                        <span class="p">)</span>
                    
                    <span class="n">mms2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">][</span><span class="n">lookup_column</span><span class="p">(</span><span class="n">mtbl</span><span class="p">,</span> <span class="s1">&#39;Scan&#39;</span><span class="p">)])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">dms2</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">][</span><span class="mi">31</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">int</span>
                    
                    <span class="k">if</span> <span class="n">mms2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dms2</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">[ !! ] MS2 missing from Denes. Scan num at Marco is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">][</span><span class="n">lookup_column</span><span class="p">(</span><span class="n">mtbl</span><span class="p">,</span> <span class="s1">&#39;Scan&#39;</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="n">dms2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mms2</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">[ !! ] MS2 missing from Marco. Scan num at Denes is </span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">][</span><span class="mi">31</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">mms2</span> <span class="ow">and</span> <span class="n">dms2</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">[ OK ] MS2 data both at Marco (scan </span><span class="si">%u</span><span class="s1">) &amp; Denes (scan </span><span class="si">%u</span><span class="s1">)&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">][</span><span class="n">lookup_column</span><span class="p">(</span><span class="n">mtbl</span><span class="p">,</span> <span class="s1">&#39;Scan&#39;</span><span class="p">)])),</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">][</span><span class="mi">31</span><span class="p">]))</span>
                        <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;Peptide.Mass&#39;</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;MS2 precursor mass&#39;</span><span class="p">,</span>
                                <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.0005</span><span class="p">,</span>
                                <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                        <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;Retention.Time..mins.secs.&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
                                <span class="s1">&#39;closest MS2 scan RT&#39;</span><span class="p">,</span>
                                <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span>
                                <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                        <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;delta_RT&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;delta RT&#39;</span><span class="p">,</span>
                                <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span>
                                <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                        <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;Scan&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;Best scan No.&#39;</span><span class="p">,</span>
                                <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                            <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;MS2.Ion.</span><span class="si">%u</span><span class="s1">.Mass.Intensity.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">19</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                                    <span class="s1">&#39;MS2 ion #</span><span class="si">%u</span><span class="s1"> mass&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">,</span>
                                    <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                                    <span class="n">dfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
                            <span class="n">compare</span><span class="p">(</span><span class="n">mtbl</span><span class="p">[</span><span class="n">mii</span><span class="p">],</span> <span class="n">dtbl</span><span class="p">[</span><span class="n">dii</span><span class="p">],</span> <span class="s1">&#39;MS2.Ion.</span><span class="si">%u</span><span class="s1">.Mass.Intensity.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">19</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                                    <span class="s1">&#39;MS2 ion #</span><span class="si">%u</span><span class="s1"> intensity&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">mfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">dfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">logf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1">#</span>
    <span class="c1"># Processing manually curated results</span>
    <span class="c1">#</span>
    
<div class="viewcode-block" id="Screening.read_manual"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_manual">[docs]</a>    <span class="k">def</span> <span class="nf">read_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads adequate columns from manually annotated tables.</span>
<span class="sd">        Provides data in `Screening().manual` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="n">reclass</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(^[IV]*\.?[0-9]?).*&#39;</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">read_line</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">13</span><span class="p">]):</span>
                <span class="k">return</span> \
                    <span class="p">[</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">13</span><span class="p">]),</span>
                        <span class="n">reclass</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">l</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span>
                        <span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span>
                        <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">12</span><span class="p">]))</span>
                    <span class="p">]</span>
        
        <span class="k">def</span> <span class="nf">read_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
            <span class="k">return</span> \
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">l</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="n">read_line</span><span class="p">,</span>
                            <span class="n">tbl</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">fnames</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;final.xlsx&#39;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manualdir</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">protein</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xlsname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manualdir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">tblneg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="n">xlsname</span><span class="p">,</span>
                                   <span class="n">sheet</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_negative_best&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">)</span>
            <span class="n">tblpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="n">xlsname</span><span class="p">,</span>
                                   <span class="n">sheet</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_positive_best&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_table</span><span class="p">(</span><span class="n">tblneg</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">data</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_table</span><span class="p">(</span><span class="n">tblpos</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="o">=</span> <span class="n">data</span></div>
    
<div class="viewcode-block" id="Screening.read_manual2"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_manual2">[docs]</a>    <span class="k">def</span> <span class="nf">read_manual2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;All_results_v04.xlsx&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads manually annotated results from Marco&#39;s final table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">reclass</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(^[IV]*\.?[0-9]?).*&#39;</span><span class="p">)</span>
        
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">sheet</span> <span class="o">=</span> <span class="s1">&#39;final data&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tbl</span><span class="p">:</span>
            
            <span class="n">protein</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">]:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Qual&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">result</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">15</span><span class="p">]),</span> <span class="c1"># m/z corrected</span>
                <span class="n">reclass</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">19</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="c1"># result class</span>
                <span class="n">l</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;−&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="c1"># SwissLipids name</span>
                <span class="n">l</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;−&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="c1"># main headgroup class</span>
                <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">14</span><span class="p">])),</span> <span class="c1"># intensity</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="c1"># m/z original</span>
                <span class="n">protein</span><span class="p">,</span> <span class="c1"># protein name</span>
                <span class="n">mode</span><span class="p">,</span> <span class="c1"># ion mode</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span> <span class="c1"># RT mean</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;NA&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="c1"># RT MS2 closest</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="c1"># RT lower</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># RT greater</span>
            <span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="o">=</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="Screening.manual_df"><a class="viewcode-back" href="../../index.html#emese.main.Screening.manual_df">[docs]</a>    <span class="k">def</span> <span class="nf">manual_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a pandas dataframe from manual results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">shgs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Monoalkylmonoacylglycerol-O&#39;</span><span class="p">:</span> <span class="s1">&#39;DAG-O&#39;</span><span class="p">,</span>
            <span class="s1">&#39;hydroquinone?&#39;</span><span class="p">:</span> <span class="s1">&#39;HQ&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Ganglioside GM3&#39;</span><span class="p">:</span> <span class="s1">&#39;GM3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alpha-tocopherol metabolite&#39;</span><span class="p">:</span> <span class="s1">&#39;VE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alpha-tocopherol&#39;</span><span class="p">:</span> <span class="s1">&#39;VE&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;Retinol {calculated as -H2O adduct &#39;</span>\
                <span class="sa">r</span><span class="s1">&#39;is not in applied database}&#39;</span><span class="p">:</span> <span class="s1">&#39;VA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;docosapentaenoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;octacosatetraenoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;octacosapentaenoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;octadecatetraenoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;octatriacontatetraenoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tetracosapentaenoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;hexacosatetraenoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;hexacosanoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dotriacontapentaenoate&#39;</span><span class="p">:</span> <span class="s1">&#39;PUFA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Sterol ester&#39;</span><span class="p">:</span> <span class="s1">&#39;SE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nothing&#39;</span><span class="p">:</span> <span class="s1">&#39;NA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;unknown&#39;</span><span class="p">:</span> <span class="s1">&#39;NA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Monoalkylglycerol-O&#39;</span><span class="p">:</span> <span class="s1">&#39;MAG-O&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Monoalkyldiacylglycerol-O&#39;</span><span class="p">:</span> <span class="s1">&#39;TAG-O&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Dihexosyldiacylglycerol&#39;</span><span class="p">:</span> <span class="s1">&#39;HexDAG&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Monohexosyldiacylglycerol&#39;</span><span class="p">:</span> <span class="s1">&#39;HexDAG&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Monoalkylmonoacylglycerol-O&#39;</span><span class="p">:</span> <span class="s1">&#39;DAG-O&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Monoalkyldiacylglycerol-O&#39;</span><span class="p">:</span> <span class="s1">&#39;TAG-O&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Monoalkylmonoacylglycerol&#39;</span><span class="p">:</span> <span class="s1">&#39;DAG-O&#39;</span><span class="p">,</span>
            <span class="s1">&#39;24-Hydroxy-19-norgeminivitamin D3&#39;</span><span class="p">:</span> <span class="s1">&#39;VD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NP40&#39;</span><span class="p">:</span> <span class="s1">&#39;P40&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Cer1P&#39;</span><span class="p">:</span> <span class="s1">&#39;CerP&#39;</span>
        <span class="p">}</span>
        
        <span class="n">shgs2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Ganglioside&#39;</span><span class="p">:</span> <span class="s1">&#39;GM&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Vit.A1&#39;</span><span class="p">:</span> <span class="s1">&#39;VA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Vit. E metabolite&#39;</span><span class="p">:</span> <span class="s1">&#39;VE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SulfohexCer&#39;</span><span class="p">:</span> <span class="s1">&#39;SHexCer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SulfoHexCer&#39;</span><span class="p">:</span> <span class="s1">&#39;SHexCer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SulfodihexCer&#39;</span><span class="p">:</span> <span class="s1">&#39;SHex2Cer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;DiHexCer-OH&#39;</span><span class="p">:</span> <span class="s1">&#39;Hex2Cer-OH&#39;</span><span class="p">,</span>
            <span class="s1">&#39;DiHexCer&#39;</span><span class="p">:</span> <span class="s1">&#39;Hex2Cer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PI2xP&#39;</span><span class="p">:</span> <span class="s1">&#39;PIP2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MAMAG&#39;</span><span class="p">:</span> <span class="s1">&#39;DAG-O&#39;</span>
        <span class="p">}</span>
        
        <span class="n">uhgs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Hex2Cer&#39;</span><span class="p">:</span> <span class="s1">&#39;Hex2Cer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Hex2Cer-OH&#39;</span><span class="p">:</span> <span class="s1">&#39;Hex2Cer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GM3&#39;</span><span class="p">:</span> <span class="s1">&#39;GM&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Detergent&#39;</span><span class="p">:</span> <span class="s1">&#39;P40&#39;</span>
        <span class="p">}</span>
        
        <span class="k">def</span> <span class="nf">get_names</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extracts the lipid names and carbon counts</span>
<span class="sd">            from the SwissLipids IDs field.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lips</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;///&#39;</span><span class="p">):</span>
                
                <span class="n">add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readd</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lips</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">add</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">add</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                
                <span class="k">for</span> <span class="n">lip</span> <span class="ow">in</span> <span class="n">lips</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                    
                    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="n">lyso</span> <span class="o">=</span> <span class="s1">&#39;Lyso&#39;</span> <span class="k">if</span> <span class="s1">&#39;lyso&#39;</span> <span class="ow">in</span> <span class="n">lip</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    
                    <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headgroup_from_lipid_name</span><span class="p">([</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lip</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">cl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cl</span> <span class="o">=</span> <span class="n">lip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">:</span>
                            <span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    
                    <span class="c1"># fixing typos and inconsequent naming:</span>
                    <span class="n">clm</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">clls</span> <span class="o">=</span> <span class="n">clm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="n">clls</span> <span class="o">==</span> <span class="s1">&#39;ambiguous&#39;</span> <span class="ow">or</span> <span class="n">clls</span> <span class="o">==</span> <span class="s1">&#39;ambigous&#39;</span><span class="p">:</span>
                        <span class="n">clm</span> <span class="o">=</span> <span class="s1">&#39;ambiguous&#39;</span>
                    
                    <span class="k">if</span> <span class="n">clls</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span> <span class="ow">or</span> <span class="n">clls</span> <span class="o">==</span> <span class="s1">&#39;unkown&#39;</span><span class="p">:</span>
                        <span class="n">clm</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">clls</span><span class="p">):</span>
                        <span class="n">clm</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
                    
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lyso</span><span class="p">):</span>
                        <span class="n">clm</span> <span class="o">=</span> <span class="n">clm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;yso-&#39;</span><span class="p">,</span> <span class="s1">&#39;yso&#39;</span><span class="p">)</span>
                    <span class="c1"># :done</span>
                    
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lyso</span><span class="p">)</span>
                    
                    <span class="n">cc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recount1</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc1</span><span class="p">):</span>
                        
                        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">cc1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
                    
                    <span class="n">cc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recount2</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc2</span><span class="p">):</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
                                    <span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]),</span>
                                    <span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">],</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">])</span> \
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">])</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">])</span> \
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">])</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
                    
                    <span class="c1"># a full headgroup name:</span>
                    <span class="n">fullhg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">lyso</span><span class="p">,</span>
                        <span class="n">cl</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;-O&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                    
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fullhg</span><span class="p">)</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clm</span><span class="p">)</span>
                    
                    <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">counts</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_manual2</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lipnames&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_lipid_names</span><span class="p">()</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manual</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
                    
                    <span class="n">counts</span> <span class="o">=</span> <span class="n">get_names</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">shgs2</span><span class="p">:</span>
                        <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">shgs2</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                    
                    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> \
                        <span class="n">l</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
                    
                    <span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                        <span class="n">res1</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:]</span>
                        
                        <span class="k">if</span> <span class="n">cnt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
                            <span class="n">cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-O&#39;</span> <span class="o">%</span> <span class="n">cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        
                        <span class="k">if</span> <span class="n">cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">shgs</span><span class="p">:</span>
                            <span class="n">cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">shgs</span><span class="p">[</span><span class="n">cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                        
                        <span class="n">cnt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        
                        <span class="k">for</span> <span class="n">hgi</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                            
                            <span class="k">if</span> <span class="n">cnt</span><span class="p">[</span><span class="n">hgi</span><span class="p">]</span> <span class="ow">in</span> <span class="n">shgs</span><span class="p">:</span>
                                <span class="n">cnt</span><span class="p">[</span><span class="n">hgi</span><span class="p">]</span> <span class="o">=</span> <span class="n">shgs</span><span class="p">[</span><span class="n">cnt</span><span class="p">[</span><span class="n">hgi</span><span class="p">]]</span>
                            <span class="k">if</span> <span class="n">cnt</span><span class="p">[</span><span class="n">hgi</span><span class="p">]</span> <span class="ow">in</span> <span class="n">shgs2</span><span class="p">:</span>
                                <span class="n">cnt</span><span class="p">[</span><span class="n">hgi</span><span class="p">]</span> <span class="o">=</span> <span class="n">shgs2</span><span class="p">[</span><span class="n">cnt</span><span class="p">[</span><span class="n">hgi</span><span class="p">]]</span>
                        
                        <span class="n">uhg</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">uhg</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;ambiguous&#39;</span><span class="p">,</span> <span class="s1">&#39;adduct&#39;</span><span class="p">]):</span>
                            <span class="n">uhg</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                        
                        <span class="k">if</span> <span class="n">uhg</span> <span class="ow">in</span> <span class="n">uhgs</span><span class="p">:</span>
                            <span class="n">uhg</span> <span class="o">=</span> <span class="n">uhgs</span><span class="p">[</span><span class="n">uhg</span><span class="p">]</span>
                        
                        <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uhg</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                            <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">cnt</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
                                <span class="n">cnt</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                <span class="n">cnt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                            <span class="p">))</span>
                            <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">cnt</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>
                            <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>
                        
                        <span class="n">facc</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                                <span class="n">facc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cnt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cnt</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                        
                        <span class="n">facc</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">cc</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">:</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cc</span><span class="p">,</span>
                                            <span class="nb">sorted</span><span class="p">(</span><span class="n">facc</span><span class="p">)))</span>
                        
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">facc</span><span class="p">):</span>
                            <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cnt</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">facc</span><span class="p">))</span>
                            <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">facc</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>
                            <span class="n">cnt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NA&#39;</span><span class="p">)</span>
                        
                        
                        <span class="n">res1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
                        
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pmanual</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
                                   <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                                       <span class="s1">&#39;protein&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;ionm&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;id&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;mz&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;mzcorr&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;intensity&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;cls&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;headgroup1&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;rtmean&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;rtms2&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;rtlow&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;rtup&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;headgroup&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;lyso&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;pref&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;carb&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;unsat&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa1p&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa1c&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa1u&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa2p&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa2c&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa2u&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa3p&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa3c&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fa3u&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;fullhgroup&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;mhgroup&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;uhgroup&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;hgcc&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;cc&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;hgfa&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;ccfa&#39;</span>
                                    <span class="p">])</span></div>
    
    <span class="k">def</span> <span class="nf">bubble_altair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">],</span>
                      <span class="n">subtitle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">main_title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        
        <span class="n">smodes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">}</span>
        <span class="c1"># select the classes</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmanual</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pmanual</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">classes</span><span class="p">)]</span>
        
        <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ionm</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">subplot_titles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">allhgs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">headgroup</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">unsat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unsat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unsat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">carb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">carb</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">carb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">inte</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="p">))</span>
        <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">unsat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">unsat</span><span class="p">)]</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">carb</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">carb</span><span class="p">)]</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;ionm&#39;</span><span class="p">])</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="n">altair</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">mark_point</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">row</span> <span class="o">=</span> <span class="s1">&#39;protein&#39;</span><span class="p">,</span>
            <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;ionm&#39;</span><span class="p">,</span>
            <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;Intensity:average(intensity)&#39;</span><span class="p">,</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">altair</span><span class="o">.</span><span class="n">X</span><span class="p">(</span><span class="s1">&#39;unsat&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">altair</span><span class="o">.</span><span class="n">Axis</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Unsaturated count&#39;</span><span class="p">)),</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">altair</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="s1">&#39;carb&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">altair</span><span class="o">.</span><span class="n">Axis</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Carbon count&#39;</span><span class="p">))</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">a</span>
    
<div class="viewcode-block" id="Screening.export_manual"><a class="viewcode-back" href="../../index.html#emese.main.Screening.export_manual">[docs]</a>    <span class="k">def</span> <span class="nf">export_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;final_results.csv&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exports the results from manual curation to csv.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pmanual&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmanual</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manual_df</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;sep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;na_rep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;na_rep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pmanual</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">bubble_plotly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">],</span>
                     <span class="n">subtitle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">main_title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        
        <span class="n">smodes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">}</span>
        <span class="c1"># select the classes</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmanual</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pmanual</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">classes</span><span class="p">)]</span>
        
        <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ionm</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">subplot_titles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">allhgs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">headgroup</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">unsat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unsat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unsat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">carb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">carb</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">carb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">inte</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="p">))</span>
        <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">unsat</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">unsat</span><span class="p">)]</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">carb</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">carb</span><span class="p">)]</span>
        
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">protein</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="n">nrows</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ionm</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
                
                <span class="n">subplot_titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">protein</span><span class="p">,</span>
                     <span class="n">smodes</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
                     <span class="s1">&#39;, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subtitle</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subtitle</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="p">)</span>
                
                <span class="n">this_data</span> <span class="o">=</span> \
                    <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">protein</span> <span class="o">==</span> <span class="n">protein</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ionm</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)]</span>
                
                <span class="n">vals</span> <span class="o">=</span> <span class="n">this_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;carb&#39;</span><span class="p">,</span> <span class="s1">&#39;unsat&#39;</span><span class="p">])[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="c1">#print(list(iteritems(vals)))</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">inte</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">vals</span><span class="p">)))</span>
                
                <span class="c1">#print(protein, x, y, s)</span>
                
                <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span>
                                         <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                                         <span class="n">marker</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">sizemode</span> <span class="o">=</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">sizeref</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">),</span>
                                         <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">smodes</span><span class="p">[</span><span class="n">mode</span><span class="p">]),</span> <span class="n">fill</span> <span class="o">=</span> <span class="s1">&#39;#333333&#39;</span><span class="p">,</span> <span class="n">showlegend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="n">xaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">range</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">),</span>
                                         <span class="n">yaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">range</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">))</span>
                                    <span class="p">)</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>
                                         <span class="n">cols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                                         <span class="n">print_grid</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="n">subplot_titles</span><span class="o">=</span><span class="n">subplot_titles</span>
                                        <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">height</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">main_title</span><span class="p">,</span>
                             <span class="n">xaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">range</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">),</span> <span class="n">yaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">range</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">))</span>
        
        <span class="n">pl</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">show_link</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    
<div class="viewcode-block" id="Screening.piecharts_plotly"><a class="viewcode-back" href="../../index.html#emese.main.Screening.piecharts_plotly">[docs]</a>    <span class="k">def</span> <span class="nf">piecharts_plotly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by_class</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">main_title</span> <span class="o">=</span> <span class="s1">&#39;Lipid classes by protein&#39;</span><span class="p">,</span> <span class="n">result_classes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots piecharts of detected lipids for each protein based on manually</span>
<span class="sd">        annotated results.</span>
<span class="sd">        Uses plotly, output accessible in Jupyter notebook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">get_names</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">by_class</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
            
            <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">lips</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;///&#39;</span><span class="p">):</span>
                
                <span class="k">for</span> <span class="n">lip</span> <span class="ow">in</span> <span class="n">lips</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                    
                    <span class="k">if</span> <span class="s1">&#39;nothing&#39;</span> <span class="ow">in</span> <span class="n">lip</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">lip</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="k">continue</span>
                    
                    <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headgroup_from_lipid_name</span><span class="p">([</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lip</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">cl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cl</span> <span class="o">=</span> <span class="n">lip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">:</span>
                            <span class="n">cl</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="n">by_class</span><span class="p">:</span>
                        <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recount2</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recount1</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">lip</span><span class="p">)</span>
                        
                        <span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;?&#39;</span>
                    
                    <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="k">else</span> <span class="n">cl</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">counts</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_manual</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lipnames&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_lipid_names</span><span class="p">()</span>
        
        <span class="n">main_title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (class </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">main_title</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result_classes</span><span class="p">))))</span>
        
        <span class="n">modes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="s1">&#39;negative&#39;</span><span class="p">}</span>
        <span class="n">smodes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="p">}</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manual</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">nrows</span>
        <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;layout&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">main_title</span><span class="p">,</span>
                <span class="s1">&#39;annotations&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;autosize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
                <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#fig = plotly.tools.make_subplots(rows=nrows, cols=2, print_grid = False)</span>
                          <span class="c1">#subplot_titles=(&#39;First Subplot&#39;,&#39;Second Subplot&#39;, &#39;Third Subplot&#39;))</span>
        
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manual</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            
            <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">]:</span>
                
                
                <span class="n">this_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">this_anno</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span> <span class="s1">&#39;showarrow&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                <span class="n">lab_val</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">]:</span>
                    
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">result_classes</span><span class="p">:</span>
                        
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_names</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">by_class</span> <span class="o">=</span> <span class="n">by_class</span><span class="p">))</span>
                        
                        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lab_val</span><span class="p">:</span>
                            <span class="n">lab_val</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        
                        <span class="n">lab_val</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    
                <span class="n">this_data</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span> <span class="n">this_data</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">lab_val</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> \
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lab_val</span><span class="p">)</span> <span class="k">else</span> <span class="p">([</span><span class="s1">&#39;None&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">this_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">, </span><span class="se">\n</span><span class="s1">sum of intensities&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>
                <span class="n">this_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pie&#39;</span>
                <span class="n">this_data</span><span class="p">[</span><span class="s1">&#39;hole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span>
                <span class="n">this_data</span><span class="p">[</span><span class="s1">&#39;hoverinfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;label+percent+name&#39;</span>
                <span class="n">this_data</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                        <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">0.5</span>
                    <span class="p">],</span>
                    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.48</span> <span class="o">/</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.003</span><span class="p">),</span>
                        <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.48</span> <span class="o">/</span> <span class="n">nrows</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.003</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">}</span>
                <span class="n">this_pie</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span><span class="o">**</span><span class="n">this_data</span><span class="p">)</span>
                <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_pie</span><span class="p">)</span>
                
                <span class="c1"># print(&#39;%s: n = %u,   %s&#39; % (protein, n, str(this_data[&#39;domain&#39;])))</span>
                
                <span class="c1"># fig.append_trace(this_pie, int(n % 2 + 1), int(np.floor(n / 2.0) + 1))</span>
                <span class="n">this_anno</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">smodes</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>
                <span class="n">this_anno</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">0.25</span>
                <span class="n">this_anno</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.48</span> <span class="o">/</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.48</span> <span class="o">/</span> <span class="n">nrows</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
                <span class="n">this_anno</span><span class="p">[</span><span class="s1">&#39;xanchor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
                <span class="n">this_anno</span><span class="p">[</span><span class="s1">&#39;yanchor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;middle&#39;</span>
                
                <span class="n">param</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_data</span><span class="p">)</span>
                <span class="n">param</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_anno</span><span class="p">)</span>
                
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">],</span>
                        <span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">main_title</span><span class="p">,</span>
                        <span class="c1">#width = 600, autosize = False</span>
                        <span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">traces</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="n">layout</span><span class="p">)</span>
        <span class="c1"># print(param)</span>
        <span class="c1">#fig[&#39;layout&#39;].update(showlegend = True, title = &#39;Lipid classes by protein&#39;)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">show_link</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></div>
    
    <span class="c1">#</span>
    <span class="c1"># Methods for preparing a diff between 2 sets of xls outputs</span>
    <span class="c1">#</span>
    
    <span class="k">def</span> <span class="nf">features_xls_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir1</span><span class="p">,</span> <span class="n">dir2</span><span class="p">,</span>
                          <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;top_features_diff&#39;</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="mf">0.0005</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">get_xls</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">read_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">get_header</span><span class="p">(</span><span class="n">xls</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns values in header row of one sheet</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sheet</span> <span class="o">=</span> <span class="n">xls</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">())))</span>
        
        <span class="k">def</span> <span class="nf">index_sheet</span><span class="p">(</span><span class="n">sheet</span><span class="p">):</span>
            
            <span class="k">def</span> <span class="nf">table_cell_attr</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">strip_header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">tbl</span> <span class="o">=</span> \
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span>
                                <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">fun</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">r</span><span class="p">)),</span>
                            <span class="n">sheet</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">strip_header</span><span class="p">:</span>
                    <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">return</span> <span class="n">tbl</span>
            
            <span class="n">content</span> <span class="o">=</span> <span class="n">table_cell_attr</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">table_cell_attr</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fill</span><span class="o">.</span><span class="n">bgColor</span><span class="o">.</span><span class="n">rgb</span><span class="p">)[:</span><span class="mi">6</span><span class="p">])</span>
            
            <span class="n">index</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                                <span class="c1"># [n, n, n] from (n, (n, n))</span>
                                <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span>
                            <span class="nb">enumerate</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span>
                                        <span class="c1"># m/z and intensity</span>
                                        <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">12</span><span class="p">])),</span>
                                    <span class="n">content</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">index</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
            
            <span class="k">return</span> <span class="n">content</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">index</span>
        
        <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">xls1</span><span class="p">,</span> <span class="n">xls2</span><span class="p">):</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xls1</span><span class="o">.</span><span class="n">sheetnames</span><span class="p">):</span>
                
                <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xls2</span><span class="o">.</span><span class="n">sheetnames</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Sheet `</span><span class="si">%s</span><span class="s1">` missing!</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
                
                <span class="n">sheet1</span> <span class="o">=</span> <span class="n">xls1</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">sheet2</span> <span class="o">=</span> <span class="n">xls2</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdiff</span><span class="p">(</span><span class="n">sheet1</span><span class="p">,</span> <span class="n">sheet2</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">def</span> <span class="nf">sdiff</span><span class="p">(</span><span class="n">sheet1</span><span class="p">,</span> <span class="n">sheet2</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns rows in 1 missing from 2.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">dat1</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">index_sheet</span><span class="p">(</span><span class="n">sheet1</span><span class="p">)</span>
            <span class="n">dat2</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">index_sheet</span><span class="p">(</span><span class="n">sheet2</span><span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">i1</span><span class="p">:</span>
                <span class="n">ui</span> <span class="o">=</span> <span class="n">i2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">ui</span> <span class="o">&lt;</span> <span class="n">i2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i2</span><span class="p">[</span><span class="n">ui</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="n">ui</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i2</span><span class="p">[</span><span class="n">ui</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            
            <span class="n">nmissg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmissg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="c1"># ordering by intensities desc</span>
            
            <span class="n">missing</span> <span class="o">=</span> <span class="n">missing</span><span class="p">[</span><span class="n">missing</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            
            <span class="c1"># ordering all outputs the same way</span>
            <span class="k">return</span> \
                <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">dat1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                         <span class="n">missing</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))),</span> \
                <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">col1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                         <span class="n">missing</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))),</span> \
                      <span class="n">i1</span><span class="p">[</span><span class="n">missing</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),]</span>
        
        <span class="c1"># starting with empty outdir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        
        <span class="c1"># column widths as set in the original method:</span>
        <span class="n">colws</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">,</span>
            <span class="mf">2.83</span><span class="p">,</span> <span class="mf">10.77</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">,</span> <span class="mf">1.86</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">,</span>
            <span class="mf">8.60</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">,</span> <span class="mf">8.60</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">,</span> <span class="mf">2.83</span><span class="p">,</span> <span class="mf">4.29</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">,</span>
            <span class="mf">2.12</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">,</span> <span class="mf">2.12</span><span class="p">,</span> <span class="mf">1.48</span><span class="p">,</span> <span class="mf">1.48</span><span class="p">,</span> <span class="mf">3.62</span><span class="p">,</span> <span class="mf">3.31</span><span class="p">,</span> <span class="mf">3.31</span><span class="p">,</span> <span class="mf">3.31</span>
        <span class="p">]</span>
        
        
        
        <span class="n">fnames1</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_top_features.xlsx&#39;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="n">prg</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">Progress</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fnames1</span><span class="p">),</span>
                                <span class="s1">&#39;Compiling diffs, generating xls&#39;</span><span class="p">,</span>
                                <span class="mi">1</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># old +, new +, + new, + false, </span>
        <span class="c1"># old best +, new best +, ...</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;hdr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;old +&#39;</span><span class="p">,</span> <span class="s1">&#39;new +&#39;</span><span class="p">,</span> <span class="s1">&#39;+ new&#39;</span><span class="p">,</span> <span class="s1">&#39;+ false&#39;</span><span class="p">,</span>
                <span class="s1">&#39;old best +&#39;</span><span class="p">,</span> <span class="s1">&#39;new best +&#39;</span><span class="p">,</span> <span class="s1">&#39;best + new&#39;</span><span class="p">,</span> <span class="s1">&#39;best + false&#39;</span><span class="p">,</span>
                <span class="s1">&#39;old -&#39;</span><span class="p">,</span> <span class="s1">&#39;new -&#39;</span><span class="p">,</span> <span class="s1">&#39;- new&#39;</span><span class="p">,</span> <span class="s1">&#39;- false&#39;</span><span class="p">,</span>
                <span class="s1">&#39;old best -&#39;</span><span class="p">,</span> <span class="s1">&#39;new best -&#39;</span><span class="p">,</span> <span class="s1">&#39;best - new&#39;</span><span class="p">,</span> <span class="s1">&#39;best - false&#39;</span>
            <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames1</span><span class="p">:</span>
            
            <span class="n">prg</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            
            <span class="n">protein</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xls1</span> <span class="o">=</span> <span class="n">get_xls</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">xls2</span> <span class="o">=</span> <span class="n">get_xls</span><span class="p">(</span><span class="n">dir2</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">nhdr</span> <span class="o">=</span> <span class="n">get_header</span><span class="p">(</span><span class="n">xls1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_negative&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">)</span>
            <span class="n">phdr</span> <span class="o">=</span> <span class="n">get_header</span><span class="p">(</span><span class="n">xls1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_positive&#39;</span> <span class="o">%</span> <span class="n">protein</span><span class="p">)</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="n">protein</span><span class="p">]</span>
            <span class="c1"># new records in recent tables:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">xls2</span><span class="p">,</span> <span class="n">xls1</span><span class="p">)</span>
            <span class="c1"># false records in old tables:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">xls1</span><span class="p">,</span> <span class="n">xls2</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;negative&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_best&#39;</span><span class="p">]:</span>
                    
                    <span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
                    <span class="n">nums</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                        <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xls1</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]</span><span class="o">.</span><span class="n">max_row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xls2</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]</span><span class="o">.</span><span class="n">max_row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">])</span>
            
            <span class="n">stats</span><span class="p">[</span><span class="n">protein</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span>
            
            <span class="n">difffname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_diff.xlsx&#39;</span> <span class="o">%</span> <span class="n">protein</span>
            <span class="n">difffname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">difffname</span><span class="p">)</span>
            
            <span class="n">xls</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">difffname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;constant_memory&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            
            <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="n">old</span><span class="p">)]:</span>
                
                <span class="k">for</span> <span class="n">sh</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    
                    <span class="n">tbl</span> <span class="o">=</span> \
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span>
                                    <span class="nb">list</span><span class="p">(</span>
                                        <span class="nb">map</span><span class="p">(</span>
                                            <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span>
                                                <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;plain&#39;</span><span class="p">)</span> \
                                                    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;000000&#39;</span> <span class="k">else</span> \
                                                <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;green&#39;</span><span class="p">),</span>
                                            <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="p">)</span>
                                    <span class="p">),</span>
                                <span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">sh</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">sh</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    
                    <span class="n">sheet_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span>
                    <span class="n">hdr</span> <span class="o">=</span> <span class="n">nhdr</span> <span class="k">if</span> <span class="s1">&#39;negative&#39;</span> <span class="ow">in</span> <span class="n">sheet_name</span> <span class="k">else</span> <span class="n">phdr</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="n">xls</span><span class="p">,</span> <span class="p">[</span><span class="n">hdr</span><span class="p">]</span> <span class="o">+</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">colws</span><span class="p">)</span>
            
            <span class="n">xls</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">prg</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;diff_stats.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;hdr&#39;</span><span class="p">]))</span>
            <span class="k">del</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;hdr&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">protein</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">protein</span><span class="p">]))</span>
    
<div class="viewcode-block" id="Screening.to_uniprot"><a class="viewcode-back" href="../../index.html#emese.main.Screening.to_uniprot">[docs]</a>    <span class="k">def</span> <span class="nf">to_uniprot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the UniProt from LTP name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_uniprots</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniprots</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;uniprot&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniprots</span> <span class="k">else</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="Screening.get_family"><a class="viewcode-back" href="../../index.html#emese.main.Screening.get_family">[docs]</a>    <span class="k">def</span> <span class="nf">get_family</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protein</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the lipid binding domain family from LTP name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_uniprots</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniprots</span><span class="p">[</span><span class="n">protein</span><span class="p">][</span><span class="s1">&#39;family&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="n">protein</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniprots</span> <span class="k">else</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="Screening.get_name"><a class="viewcode-back" href="../../index.html#emese.main.Screening.get_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uniprot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the LTP name from its UniProt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_uniprots</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">uniprot</span><span class="p">]</span> \
            <span class="k">if</span> <span class="n">uniprot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="k">else</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="Screening.read_uniprots"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_uniprots">[docs]</a>    <span class="k">def</span> <span class="nf">read_uniprots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reread</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the UniProt IDs and domain families of LTPs.</span>
<span class="sd">        Result stored in `uniprots` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniprots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reread</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ltplistf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uniprots</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;uniprot&#39;</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">),</span>
                            <span class="n">f</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> \
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span>
                            <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;uniprot&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uniprots</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span></div>
    
<div class="viewcode-block" id="Screening.get_comppi_localizations"><a class="viewcode-back" href="../../index.html#emese.main.Screening.get_comppi_localizations">[docs]</a>    <span class="k">def</span> <span class="nf">get_comppi_localizations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Downloads localization data from ComPPI.</span>
<span class="sd">        Results stored in `ulocs` and `locs` attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comppi_url</span>
        <span class="n">post</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fDlSet&#39;</span><span class="p">:</span> <span class="s1">&#39;protnloc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fDlSpec&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fDlMloc&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fDlSubmit&#39;</span><span class="p">:</span> <span class="s1">&#39;Download&#39;</span>
        <span class="p">}</span>
        
        <span class="n">c</span> <span class="o">=</span> <span class="n">_curl</span><span class="o">.</span><span class="n">Curl</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">post</span><span class="p">,</span>
                        <span class="n">large</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">compr</span> <span class="o">=</span> <span class="s1">&#39;gz&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">read_uniprots</span><span class="p">()</span>
        
        <span class="n">ultps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;uniprot&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniprots</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ulocs</span> <span class="o">=</span> \
            <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                        <span class="p">(</span>
                            <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="nb">dict</span><span class="p">(</span>
                                <span class="nb">map</span><span class="p">(</span>
                                    <span class="k">lambda</span> <span class="n">loc</span><span class="p">:</span>
                                        <span class="p">(</span>
                                            <span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="p">),</span>
                                    <span class="nb">map</span><span class="p">(</span>
                                        <span class="k">lambda</span> <span class="n">loc</span><span class="p">:</span>
                                            <span class="n">loc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">),</span>
                                        <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">),</span>
                        <span class="nb">filter</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                <span class="n">l</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ultps</span> <span class="ow">or</span> <span class="n">l</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ultps</span><span class="p">,</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">result</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">locs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                             <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ulocs</span><span class="p">)))</span></div>
    
<div class="viewcode-block" id="Screening.read_membrane_constitutions"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_membrane_constitutions">[docs]</a>    <span class="k">def</span> <span class="nf">read_membrane_constitutions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads membrane lipid constitutions from Charlotte.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="Screening.read_manual_localizations"><a class="viewcode-back" href="../../index.html#emese.main.Screening.read_manual_localizations">[docs]</a>    <span class="k">def</span> <span class="nf">read_manual_localizations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads localization data from our manual collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abbrev</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s1">&#39;golgi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ER&#39;</span><span class="p">:</span> <span class="s1">&#39;ER&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LE/LY&#39;</span><span class="p">:</span> <span class="s1">&#39;late endosome, lysosome&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Cy&#39;</span><span class="p">:</span> <span class="s1">&#39;cytosol&#39;</span><span class="p">,</span>
            
        <span class="p">}</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_xls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localizationf</span><span class="p">,</span> <span class="n">sheet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl</span></div>
    
<div class="viewcode-block" id="Screening.get_go_goa"><a class="viewcode-back" href="../../index.html#emese.main.Screening.get_go_goa">[docs]</a>    <span class="k">def</span> <span class="nf">get_go_goa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">organism</span><span class="o">=</span><span class="s1">&#39;human&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Downloads GO annotation from UniProt GOA.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">add_annot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">8</span><span class="p">]]:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">8</span><span class="p">]][</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">8</span><span class="p">]][</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goa_url</span> <span class="o">%</span> <span class="p">(</span><span class="n">organism</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">organism</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_curl</span><span class="o">.</span><span class="n">Curl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">large</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="n">_</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">add_annot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">result</span><span class="p">),</span>
                    <span class="nb">filter</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;!&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">),</span>
                        <span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                                <span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">result</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Screening.get_go_quick"><a class="viewcode-back" href="../../index.html#emese.main.Screening.get_go_quick">[docs]</a>    <span class="k">def</span> <span class="nf">get_go_quick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">organism</span><span class="o">=</span><span class="mi">9606</span><span class="p">,</span> <span class="n">slim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">names_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads GO terms and annotations from QuickGO.</span>
<span class="sd">        Returns 2 dicts: `names` are GO terms by their IDs,</span>
<span class="sd">        `terms` are proteins GO IDs by UniProt IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">add_term</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">names_only</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">names_only</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]]:</span>
                    <span class="n">terms</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
                <span class="n">terms</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">names</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">termuse</span> <span class="o">=</span> <span class="s1">&#39;slim&#39;</span> <span class="k">if</span> <span class="n">slim</span> <span class="ow">or</span> <span class="n">slim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;ancestor&#39;</span>
        <span class="n">goslim</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">termuse</span> <span class="o">==</span> <span class="s1">&#39;ancestor&#39;</span> \
            <span class="k">else</span> <span class="s1">&#39;&amp;goid=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_goslim</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">slim</span><span class="p">))</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickgo_url</span> <span class="o">%</span> <span class="p">(</span><span class="n">goslim</span><span class="p">,</span> <span class="n">termuse</span><span class="p">,</span> <span class="n">organism</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_curl</span><span class="o">.</span><span class="n">Curl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">large</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        
        <span class="n">_</span> <span class="o">=</span> \
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                        <span class="n">add_term</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">names_only</span><span class="p">),</span>
                    <span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">),</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">result</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;terms&#39;</span><span class="p">:</span> <span class="n">terms</span><span class="p">,</span> <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">names</span><span class="p">}</span></div>
    
<div class="viewcode-block" id="Screening.count_nonzero_features"><a class="viewcode-back" href="../../index.html#emese.main.Screening.count_nonzero_features">[docs]</a>    <span class="k">def</span> <span class="nf">count_nonzero_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outf</span> <span class="o">=</span> <span class="s1">&#39;nonzero_counts.tab&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of nonzero features for each fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;fr&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;peak&#39;</span><span class="p">,</span> <span class="s1">&#39;cnt&#39;</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hdr</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">protein</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">):</span>
            
            <span class="n">ifracs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_indices</span><span class="p">(</span><span class="n">protein</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;valids&#39;</span><span class="p">,</span> <span class="s1">&#39;fe&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)]:</span>
                    
                    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    
                    <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ifracs</span><span class="p">):</span>
                        
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)[</span>
                                <span class="n">protein</span><span class="p">][</span><span class="n">mode</span><span class="p">][</span><span class="n">key</span><span class="p">][:,</span><span class="n">fi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>
                            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
                        
                        <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnt</span>
                        
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">protein</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span>
                                       <span class="n">attr</span><span class="p">,</span>
                                       <span class="s1">&#39;peak&#39;</span> <span class="k">if</span> <span class="n">fi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;non-peak&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cnt</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">nonzero_features</span> <span class="o">=</span> <span class="n">result</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Dénes Türei.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>